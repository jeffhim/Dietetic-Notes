<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Notes of Dietitian Jeffrey</title>
<!-- PWA Meta Tags -->
<meta name="application-name" content="Dietitian Jeffrey">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Dietitian Jeffrey">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0B6E63" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#0F1115" media="(prefers-color-scheme: dark)">
<meta name="description" content="Clinical nutrition knowledge base for Dietitian Jeffrey">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- Firebase SDKs (compat) -->
<script src="https://cdn.jsdelivr.net/npm/firebase@10.12.2/firebase-app-compat.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/firebase@10.12.2/firebase-auth-compat.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/firebase@10.12.2/firebase-firestore-compat.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/firebase@10.12.2/firebase-storage-compat.min.js"></script>
<style>
:root {
  --bg: #FAF8F5;
  --surface: #FFFFFF;
  --surface-hover: #F5F2EE;
  --primary: #0B6E63;
  --primary-light: #E2F3F0;
  --primary-dark: #094F47;
  --accent: #D96E4B;
  --accent-light: #FDF0EC;
  --text: #1D1D1F;
  --text-secondary: #6B7280;
  --text-tertiary: #9CA3AF;
  --border: #E5E2DB;
  --border-light: #F0EDE8;
  --shadow: rgba(0,0,0,0.06);
  --shadow-md: rgba(0,0,0,0.1);
  --danger: #DC2626;
  --danger-light: #FEF2F2;
  --sidebar-w: 380px;
  --radius: 12px;
  --radius-sm: 8px;
  --font-body: 'DM Sans', -apple-system, 'PingFang TC', 'Microsoft YaHei', sans-serif;
}
html.dark {
  --bg: #0F1115;
  --surface: #1A1D24;
  --surface-hover: #22262F;
  --primary: #34C6AF;
  --primary-light: #1A2F2C;
  --primary-dark: #28A08C;
  --accent: #F0956C;
  --accent-light: #2A2019;
  --text: #E8E8EC;
  --text-secondary: #9CA3AF;
  --text-tertiary: #6B7280;
  --border: #2C2C32;
  --border-light: #222228;
  --shadow: rgba(0,0,0,0.2);
  --shadow-md: rgba(0,0,0,0.35);
  --danger: #F87171;
  --danger-light: #2A1A1A;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; overflow: hidden; }
body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--text);
  font-size: 15px;
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
}
input, textarea, select, button { font-family: var(--font-body); font-size: 16px; }
button { cursor: pointer; border: none; background: none; color: var(--text); }
a { color: var(--primary); text-decoration: none; }

/* ===== LAYOUT ===== */
#app { display: flex; height: 100vh; width: 100vw; overflow: hidden; position: relative; }
#sidebar {
  width: var(--sidebar-w); flex-shrink: 0; height: 100vh;
  display: flex; flex-direction: column; background: var(--bg);
  border-right: 1px solid var(--border); z-index: 10; position: relative;
}
#main {
  flex: 1; height: 100vh; overflow-y: auto; background: var(--bg);
  display: flex; flex-direction: column;
}

/* ===== SIDEBAR HEADER ===== */
.sidebar-header {
  padding: 20px 20px 12px; display: flex; align-items: center;
  justify-content: space-between; flex-shrink: 0;
}
.logo { display: flex; align-items: center; gap: 10px; }
.logo-icon {
  width: 36px; height: 36px; border-radius: 50%;
  overflow: hidden; flex-shrink: 0;
}
.logo-icon img {
  width: 100%; height: 100%; object-fit: cover; object-position: center top;
}
.logo h1 {
  font-family: var(--font-body); font-size: 18px; font-weight: 600;
  letter-spacing: -0.01em; color: var(--text); white-space: nowrap;
}
.header-actions { display: flex; gap: 4px; }
.icon-btn {
  width: 36px; height: 36px; border-radius: var(--radius-sm);
  display: flex; align-items: center; justify-content: center;
  color: var(--text-secondary); transition: all 0.15s;
  font-size: 15px;
}
.icon-btn:hover { background: var(--surface-hover); color: var(--text); }
.icon-btn.primary-btn { background: var(--primary); color: #fff; }
.icon-btn.primary-btn:hover { background: var(--primary-dark); }

/* ===== SEARCH ===== */
.search-wrap { padding: 0 16px 12px; flex-shrink: 0; }
.search-box {
  display: flex; align-items: center; gap: 8px; background: var(--surface);
  border: 1px solid var(--border); border-radius: var(--radius);
  padding: 0 12px; transition: border-color 0.2s;
}
.search-box:focus-within { border-color: var(--primary); }
.search-box i { color: var(--text-tertiary); font-size: 14px; }
.search-box input {
  flex: 1; border: none; outline: none; background: none; color: var(--text);
  padding: 10px 0; font-size: 16px;
}
.search-box input::placeholder { color: var(--text-tertiary); }
.search-box .clear-search {
  display: none; width: 20px; height: 20px; border-radius: 50%;
  background: var(--border); color: var(--text-secondary); font-size: 10px;
  align-items: center; justify-content: center;
}
.search-box .clear-search.show { display: flex; }

/* ===== TWO-LAYER SIDEBAR ===== */
.sidebar-content { flex: 1; overflow: hidden; position: relative; }
.sidebar-content::-webkit-scrollbar { width: 4px; }
.sidebar-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

/* Slide container for page transitions */
.sidebar-slider {
  display: flex; width: 200%; height: 100%;
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.sidebar-slider.show-notes { transform: translateX(-50%); }
.sidebar-slider > .slide-panel {
  width: 50%; height: 100%; overflow-y: auto; flex-shrink: 0;
}
.slide-panel::-webkit-scrollbar { width: 4px; }
.slide-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

/* Layer 1: Specialties list */
.specialties-layer { padding: 4px 12px 80px; }
.specialty-item {
  display: flex; align-items: center; padding: 12px 16px;
  border-radius: var(--radius); cursor: pointer; transition: all 0.15s;
  margin-bottom: 2px; border: 1px solid transparent;
  animation: fadeSlideUp 0.3s ease both;
}
.specialty-item:hover { background: var(--surface-hover); }
.specialty-item .spec-icon {
  width: 36px; height: 36px; border-radius: var(--radius-sm);
  background: var(--primary-light); color: var(--primary);
  display: flex; align-items: center; justify-content: center;
  font-size: 15px; flex-shrink: 0; margin-right: 12px;
}
.specialty-item .spec-info { flex: 1; min-width: 0; }
.specialty-item .spec-name {
  font-weight: 600; font-size: 15px; white-space: nowrap;
  overflow: hidden; text-overflow: ellipsis;
}
.specialty-item .spec-count {
  font-size: 12px; color: var(--text-tertiary); margin-top: 1px;
}
.specialty-item .spec-reorder {
  display: flex; flex-direction: column; gap: 0; margin-left: 4px; opacity: 0;
  transition: opacity 0.15s;
}
.specialty-item:hover .spec-reorder { opacity: 1; }
.spec-reorder-btn {
  width: 24px; height: 18px; border-radius: 4px; display: flex;
  align-items: center; justify-content: center; font-size: 10px;
  color: var(--text-tertiary); transition: all 0.12s;
}
.spec-reorder-btn:hover { background: var(--primary-light); color: var(--primary); }
.specialty-item .spec-chevron {
  color: var(--text-tertiary); font-size: 12px; margin-left: 4px;
}

/* Add specialty button */
.add-specialty-btn {
  display: flex; align-items: center; gap: 10px; padding: 12px 16px;
  border-radius: var(--radius); cursor: pointer; transition: all 0.15s;
  margin: 4px 0; color: var(--text-tertiary); font-size: 14px; font-weight: 500;
  border: 2px dashed var(--border);
}
.add-specialty-btn:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
.add-specialty-btn i { width: 36px; text-align: center; font-size: 14px; }

/* Layer 2: Notes under a specialty */
.notes-layer { padding: 0 12px 80px; }
.notes-layer-header {
  display: flex; align-items: center; padding: 8px 4px 8px 4px;
  margin-bottom: 4px; flex-shrink: 0; gap: 4px;
}
.notes-layer-back {
  width: 32px; height: 32px; border-radius: var(--radius-sm);
  display: flex; align-items: center; justify-content: center;
  color: var(--primary); font-size: 14px; transition: all 0.15s;
  flex-shrink: 0;
}
.notes-layer-back:hover { background: var(--primary-light); }
.notes-layer-title {
  font-weight: 700; font-size: 17px; flex: 1; min-width: 0;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  color: var(--primary);
}
.notes-layer-actions {
  display: flex; gap: 2px; flex-shrink: 0;
}
.notes-layer-actions .icon-btn { width: 32px; height: 32px; font-size: 13px; }

/* Note cards in layer 2 */
.notes-list { padding: 0; }
.note-card {
  padding: 14px 16px; border-radius: var(--radius); cursor: pointer;
  transition: all 0.15s; margin-bottom: 2px; border: 1px solid transparent;
  display: flex; align-items: flex-start; gap: 8px;
}
.note-card:hover { background: var(--surface-hover); }
.note-card.active { background: var(--primary-light); border-color: var(--primary); }
.note-card-body { flex: 1; min-width: 0; }
.note-card-title {
  font-weight: 600; font-size: 15px; margin-bottom: 4px;
  display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;
}
.note-card-meta {
  display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-tertiary);
}
.note-card-cat {
  background: var(--primary-light); color: var(--primary); padding: 1px 8px;
  border-radius: 10px; font-weight: 500; font-size: 11px;
}
.note-card-preview {
  font-size: 13px; color: var(--text-secondary); margin-top: 6px;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}
.note-reorder {
  display: flex; flex-direction: column; gap: 0; opacity: 0;
  transition: opacity 0.15s; flex-shrink: 0; padding-top: 2px;
}
.note-card:hover .note-reorder { opacity: 1; }
.note-reorder-btn {
  width: 24px; height: 18px; border-radius: 4px; display: flex;
  align-items: center; justify-content: center; font-size: 10px;
  color: var(--text-tertiary); transition: all 0.12s;
}
.note-reorder-btn:hover { background: var(--primary-light); color: var(--primary); }

/* Search results layer */
.search-results-layer { padding: 4px 12px 80px; }
.search-results-heading {
  padding: 8px 4px; font-size: 13px; font-weight: 600;
  color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em;
}

/* ===== SIDEBAR FOOTER ===== */
.sidebar-footer {
  padding: 12px 16px; border-top: 1px solid var(--border);
  display: flex; gap: 8px; flex-shrink: 0; background: var(--bg);
  flex-wrap: wrap;
}
.sidebar-footer button {
  flex: 1; padding: 10px; border-radius: var(--radius-sm); font-size: 13px;
  font-weight: 500; display: flex; align-items: center; justify-content: center;
  gap: 6px; background: var(--surface); border: 1px solid var(--border);
  color: var(--text-secondary); transition: all 0.15s;
  min-width: 0;
}
.sidebar-footer button:hover { border-color: var(--primary); color: var(--primary); }

/* Cloud sync bar above footer */
.sync-bar {
  padding: 8px 16px; border-top: 1px solid var(--border-light);
  display: flex; align-items: center; gap: 8px; flex-shrink: 0; background: var(--bg);
  font-size: 12px; color: var(--text-tertiary);
}
.sync-bar .sync-status-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
}
.sync-bar .sync-status-dot.offline { background: var(--text-tertiary); }
.sync-bar .sync-status-dot.synced { background: #22C55E; }
.sync-bar .sync-status-dot.syncing { background: #F59E0B; animation: pulse 1s infinite; }
.sync-bar .sync-status-dot.error { background: var(--danger); }
.sync-bar .sync-label { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.sync-bar .sync-btn {
  padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 500;
  background: var(--primary); color: #fff; border: none; white-space: nowrap;
}
.sync-bar .sync-btn:hover { background: var(--primary-dark); }
.sync-bar .sync-btn.signout {
  background: var(--surface); color: var(--text-secondary); border: 1px solid var(--border);
}
.sync-bar .sync-btn.signout:hover { border-color: var(--danger); color: var(--danger); }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

/* ===== MAIN CONTENT ===== */
.main-empty {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  justify-content: center; color: var(--text-tertiary); gap: 12px; padding: 40px;
}
.main-empty i { font-size: 48px; opacity: 0.3; }
.main-empty p { font-size: 16px; text-align: center; }

/* ===== NOTE VIEWER ===== */
.note-view { flex: 1; overflow-y: auto; padding: 32px 40px 60px; max-width: 800px; margin: 0 auto; width: 100%; }
.note-view-header { margin-bottom: 28px; }
.note-view-back {
  display: none; margin-bottom: 16px; font-size: 14px; color: var(--primary);
  align-items: center; gap: 6px; font-weight: 500; padding: 6px 0;
}
.note-view-title {
  font-family: var(--font-body); font-size: 32px; font-weight: 700;
  line-height: 1.2; letter-spacing: -0.02em; margin-bottom: 12px;
}
.note-view-meta {
  display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 14px;
}
.note-view-meta .cat-badge {
  background: var(--primary-light); color: var(--primary); padding: 4px 14px;
  border-radius: 20px; font-weight: 500; font-size: 13px;
}
.note-view-meta .date { font-size: 13px; color: var(--text-tertiary); }
.note-view-keywords { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 4px; }
.keyword-tag {
  background: var(--accent-light); color: var(--accent); padding: 3px 10px;
  border-radius: 6px; font-size: 12px; font-weight: 500;
}
.note-view-actions { display: flex; gap: 8px; margin-top: 16px; }
.btn {
  padding: 9px 20px; border-radius: var(--radius-sm); font-size: 14px;
  font-weight: 500; display: inline-flex; align-items: center; gap: 7px;
  transition: all 0.15s;
}
.btn-outline { border: 1px solid var(--border); color: var(--text-secondary); background: var(--surface); }
.btn-outline:hover { border-color: var(--primary); color: var(--primary); }
.btn-danger { border: 1px solid var(--danger); color: var(--danger); background: var(--danger-light); }
.btn-danger:hover { background: var(--danger); color: #fff; }
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-dark); }

/* ===== NOTE SECTIONS ===== */
.note-section { margin-bottom: 24px; }
.note-section-title {
  font-size: 18px; font-weight: 700; color: var(--primary);
  padding-bottom: 8px; margin-bottom: 12px;
  border-bottom: 2px solid var(--primary-light);
  cursor: pointer; display: flex; align-items: center; gap: 8px;
}
.note-section-title i { font-size: 12px; transition: transform 0.2s; color: var(--text-tertiary); }
.note-section-title i.collapsed { transform: rotate(-90deg); }
.note-section-content {
  font-size: 15px; line-height: 1.75; color: var(--text);
  overflow: hidden; transition: max-height 0.3s ease;
}
.note-section-content ul, .note-section-content ol { padding-left: 24px; }
.note-section-content li { margin-bottom: 4px; }
.note-section-content p { margin-bottom: 8px; }
.note-section-content strong { color: var(--text); font-weight: 600; }
.note-section-content img { max-width: 100%; height: auto; border-radius: var(--radius-sm); margin: 8px 0; display: block; }
.note-section-content table { width: 100%; border-collapse: collapse; margin: 12px 0; }
.note-section-content table td, .note-section-content table th {
  border: 1px solid var(--border); padding: 8px 12px; text-align: left;
}
.note-section-content table th { background: var(--primary-light); font-weight: 600; }

/* ===== BLANK NOTE VIEW (HTML) ===== */
.note-blank-content {
  font-size: 15px; line-height: 1.8;
}
.note-blank-content p { margin-bottom: 8px; }
.note-blank-content img { max-width: 100%; height: auto; border-radius: var(--radius-sm); margin: 8px 0; display: block; }
.note-blank-content table {
  width: 100%; border-collapse: collapse; margin: 12px 0;
}
.note-blank-content table td,
.note-blank-content table th {
  border: 1px solid var(--border); padding: 8px 12px; text-align: left;
}
.note-blank-content table th {
  background: var(--primary-light); font-weight: 600;
}

/* ===== EDITOR ===== */
.editor { flex: 1; overflow-y: auto; padding: 24px 32px 80px; max-width: 800px; margin: 0 auto; width: 100%; }
.editor-top {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 20px; gap: 12px;
}
.editor-top-back {
  display: none; font-size: 14px; color: var(--text-secondary);
  align-items: center; gap: 6px;
}
.editor-title-label {
  font-family: var(--font-body); font-size: 20px; font-weight: 600;
}
.editor-actions { display: flex; gap: 8px; }

.field-group { margin-bottom: 20px; }
.field-label { font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.05em; }
.field-input {
  width: 100%; padding: 10px 14px; border-radius: var(--radius-sm);
  border: 1px solid var(--border); background: var(--surface); color: var(--text);
  font-size: 16px; outline: none; transition: border-color 0.2s;
}
.field-input:focus { border-color: var(--primary); }
.field-input::placeholder { color: var(--text-tertiary); }
textarea.field-input { resize: vertical; min-height: 100px; line-height: 1.6; }
.field-row { display: flex; gap: 12px; }
.field-row .field-group { flex: 1; }
select.field-input {
  appearance: none; -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236B7280' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 12px center;
  padding-right: 32px; cursor: pointer;
}

.type-toggle {
  display: flex; background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-sm); overflow: hidden; margin-bottom: 20px;
}
.type-toggle button {
  flex: 1; padding: 10px; font-size: 14px; font-weight: 500;
  color: var(--text-secondary); transition: all 0.15s;
  display: flex; align-items: center; justify-content: center; gap: 6px;
}
.type-toggle button.active { background: var(--primary); color: #fff; }

.sections-editor { margin-top: 8px; }
.section-card {
  border: 1px solid var(--border); border-radius: var(--radius);
  padding: 16px; margin-bottom: 12px; background: var(--surface);
  transition: box-shadow 0.2s;
}
.section-card:hover { box-shadow: 0 2px 8px var(--shadow); }
.section-card-header {
  display: flex; align-items: center; gap: 8px; margin-bottom: 10px;
}
.section-card-header input {
  flex: 1; border: none; outline: none; background: none;
  font-size: 16px; font-weight: 600; color: var(--text); padding: 4px 0;
  border-bottom: 2px solid transparent;
}
.section-card-header input:focus { border-bottom-color: var(--primary); }
.section-card-header input::placeholder { color: var(--text-tertiary); }
.section-card-actions { display: flex; gap: 2px; }
.section-card-actions button {
  width: 30px; height: 30px; border-radius: 6px; display: flex;
  align-items: center; justify-content: center; font-size: 13px;
  color: var(--text-tertiary); transition: all 0.15s;
}
.section-card-actions button:hover { background: var(--surface-hover); color: var(--text); }
.section-card-actions button.del:hover { color: var(--danger); background: var(--danger-light); }

/* Section mini toolbar */
.section-toolbar {
  display: flex; align-items: center; gap: 4px; padding: 4px 0; margin-bottom: 4px;
}
.st-btn {
  display: inline-flex; align-items: center; gap: 5px; padding: 5px 10px;
  border-radius: 6px; font-size: 12px; font-weight: 500;
  color: var(--text-tertiary); border: 1px solid var(--border-light);
  background: var(--bg); transition: all 0.15s; cursor: pointer;
}
.st-btn:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
.st-btn i { font-size: 12px; }

/* Image Upload UI */
.img-upload-tabs { display: flex; gap: 0; margin-bottom: 16px; border-radius: var(--radius-sm); overflow: hidden; border: 1px solid var(--border); }
.img-upload-tab { flex: 1; padding: 10px 12px; font-size: 13px; font-weight: 600; border: none; cursor: pointer;
  background: var(--bg); color: var(--text-secondary); transition: all 0.15s; font-family: var(--font-body); }
.img-upload-tab.active { background: var(--primary); color: #fff; }
.img-upload-tab:hover:not(.active) { background: var(--surface-hover); }
.img-upload-panel { display: none; }
.img-upload-panel.active { display: block; }
.file-drop-zone { border: 2px dashed var(--border); border-radius: var(--radius-sm); padding: 28px 16px; text-align: center;
  cursor: pointer; transition: all 0.2s; background: var(--bg); position: relative; }
.file-drop-zone:hover, .file-drop-zone.dragover { border-color: var(--primary); background: var(--primary-light); }
.file-drop-zone i { font-size: 28px; color: var(--primary); margin-bottom: 8px; display: block; }
.file-drop-zone p { font-size: 13px; color: var(--text-secondary); margin: 4px 0 0; }
.file-drop-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
.upload-progress { margin-top: 12px; display: none; }
.upload-progress.show { display: block; }
.upload-progress-bar { height: 6px; border-radius: 3px; background: var(--border-light); overflow: hidden; }
.upload-progress-fill { height: 100%; border-radius: 3px; background: var(--primary); transition: width 0.3s; width: 0%; }
.upload-progress-text { font-size: 12px; color: var(--text-secondary); margin-top: 6px; text-align: center; }
.upload-preview { margin-top: 12px; text-align: center; display: none; }
.upload-preview.show { display: block; }
.upload-preview img { max-width: 100%; max-height: 150px; border-radius: var(--radius-sm); border: 1px solid var(--border); }

.section-card textarea {
  width: 100%; border: 1px solid var(--border-light); border-radius: var(--radius-sm);
  padding: 10px 12px; background: var(--bg); color: var(--text); font-size: 16px;
  min-height: 80px; resize: vertical; outline: none; line-height: 1.6;
}
.section-card textarea:focus { border-color: var(--primary); }

.add-section-btn {
  width: 100%; padding: 14px; border: 2px dashed var(--border);
  border-radius: var(--radius); color: var(--text-tertiary); font-size: 14px;
  font-weight: 500; display: flex; align-items: center; justify-content: center;
  gap: 8px; transition: all 0.2s;
}
.add-section-btn:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }

/* ===== RICH TEXT TOOLBAR ===== */
.rt-toolbar {
  display: flex; align-items: center; gap: 2px; padding: 6px 8px;
  background: var(--surface); border: 1px solid var(--border);
  border-bottom: none; border-radius: var(--radius-sm) var(--radius-sm) 0 0;
  flex-wrap: wrap;
}
.rt-toolbar .sep {
  width: 1px; height: 22px; background: var(--border); margin: 0 4px;
}
.rt-btn {
  width: 34px; height: 34px; border-radius: 6px; display: flex;
  align-items: center; justify-content: center; font-size: 14px;
  color: var(--text-secondary); transition: all 0.12s; position: relative;
}
.rt-btn:hover { background: var(--surface-hover); color: var(--text); }
.rt-btn.active { background: var(--primary-light); color: var(--primary); }
.rt-btn[title]:hover::after {
  content: attr(title); position: absolute; bottom: -28px; left: 50%;
  transform: translateX(-50%); font-size: 11px; white-space: nowrap;
  background: var(--text); color: var(--bg); padding: 3px 8px;
  border-radius: 4px; pointer-events: none; z-index: 10;
}

/* ===== RICH TEXT EDITOR AREA ===== */
.rt-editor {
  min-height: 300px; padding: 14px 16px; font-size: 16px; line-height: 1.7;
  border: 1px solid var(--border); border-radius: 0 0 var(--radius-sm) var(--radius-sm);
  background: var(--bg); color: var(--text); outline: none;
  overflow-y: auto;
  font-family: var(--font-body);
}
.rt-editor:focus { border-color: var(--primary); }
.rt-editor img { max-width: 100%; height: auto; border-radius: var(--radius-sm); margin: 8px 0; display: block; }
.rt-editor table {
  width: 100%; border-collapse: collapse; margin: 8px 0;
}
.rt-editor table td,
.rt-editor table th {
  border: 1px solid var(--border); padding: 6px 10px; min-width: 60px;
  text-align: left; vertical-align: top;
}
.rt-editor table th {
  background: var(--primary-light); font-weight: 600;
}
.rt-editor ul, .rt-editor ol { padding-left: 24px; }
.rt-editor p { margin-bottom: 4px; }
.rt-editor:empty::before {
  content: 'Start writing...';
  color: var(--text-tertiary);
  pointer-events: none;
}

/* ===== TABLE INSERT POPUP ===== */
.table-popup {
  position: absolute; top: 100%; left: 0; background: var(--surface);
  border: 1px solid var(--border); border-radius: var(--radius-sm);
  padding: 14px 16px; box-shadow: 0 8px 24px var(--shadow-md);
  z-index: 50; display: none; min-width: 200px;
}
.table-popup.show { display: block; }
.table-popup label { font-size: 13px; font-weight: 500; color: var(--text-secondary); display: block; margin-bottom: 4px; }
.table-popup input[type="number"] {
  width: 100%; padding: 8px 10px; border: 1px solid var(--border);
  border-radius: 6px; font-size: 16px; background: var(--bg); color: var(--text);
  outline: none; margin-bottom: 10px;
}
.table-popup input[type="number"]:focus { border-color: var(--primary); }
.table-popup .tp-actions { display: flex; gap: 8px; }
.table-popup .tp-actions button {
  flex: 1; padding: 8px; border-radius: 6px; font-size: 13px; font-weight: 500;
}
.table-popup .tp-cancel { background: var(--surface-hover); color: var(--text-secondary); border: 1px solid var(--border); }
.table-popup .tp-insert { background: var(--primary); color: #fff; }

/* ===== MODAL ===== */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 100;
  display: flex; align-items: center; justify-content: center; padding: 20px;
  opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
.modal-overlay.show { opacity: 1; pointer-events: auto; }
.modal {
  background: var(--surface); border-radius: var(--radius); padding: 28px;
  max-width: 440px; width: 100%; box-shadow: 0 20px 60px var(--shadow-md);
  transform: translateY(16px); transition: transform 0.2s;
}
.modal-overlay.show .modal { transform: translateY(0); }
.modal h3 { font-size: 18px; font-weight: 600; margin-bottom: 10px; }
.modal p { font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; line-height: 1.5; }
.modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
.modal-actions button { padding: 10px 20px; border-radius: var(--radius-sm); font-weight: 500; font-size: 14px; }
.modal-actions .cancel-btn { background: var(--surface-hover); color: var(--text-secondary); border: 1px solid var(--border); }
.modal-actions .cancel-btn:hover { background: var(--border); }
.modal-actions .confirm-btn { background: var(--danger); color: #fff; }
.modal-actions .confirm-btn:hover { opacity: 0.9; }
.modal-actions .primary-confirm-btn { background: var(--primary); color: #fff; }
.modal .modal-input {
  width: 100%; padding: 10px 14px; border-radius: var(--radius-sm);
  border: 1px solid var(--border); background: var(--bg); color: var(--text);
  font-size: 16px; outline: none; margin-bottom: 16px;
}
.modal .modal-input:focus { border-color: var(--primary); }

/* ===== FIREBASE CONFIG MODAL ===== */
.firebase-config-fields { margin-bottom: 16px; }
.firebase-config-fields .field-group { margin-bottom: 12px; }
.firebase-config-fields .field-label { font-size: 12px; margin-bottom: 4px; }
.firebase-config-fields .field-input { font-size: 14px; padding: 8px 10px; }
.firebase-help { font-size: 12px; color: var(--text-tertiary); line-height: 1.5; margin-bottom: 16px; }
.firebase-help a { color: var(--primary); }

/* ===== TOAST ===== */
.toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 200; display: flex; flex-direction: column; gap: 8px; }
.toast {
  padding: 12px 20px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 500;
  box-shadow: 0 8px 24px var(--shadow-md); display: flex; align-items: center; gap: 8px;
  animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
  background: var(--surface); border: 1px solid var(--border); color: var(--text);
}
.toast.success { border-color: var(--primary); }
.toast.success i { color: var(--primary); }
.toast.error { border-color: var(--danger); }
.toast.error i { color: var(--danger); }
@keyframes toastIn { from { opacity:0; transform: translateY(12px); } to { opacity:1; transform: translateY(0); } }
@keyframes toastOut { from { opacity:1; } to { opacity:0; transform: translateY(-8px); } }

/* ===== IMPORT PANEL ===== */
.import-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
.import-option {
  padding: 16px; border: 1px solid var(--border); border-radius: var(--radius);
  display: flex; align-items: center; gap: 14px; cursor: pointer;
  transition: all 0.15s;
}
.import-option:hover { border-color: var(--primary); background: var(--primary-light); }
.import-option i { font-size: 22px; color: var(--primary); width: 32px; text-align: center; }
.import-option-text strong { display: block; font-size: 14px; margin-bottom: 2px; }
.import-option-text span { font-size: 12px; color: var(--text-secondary); }

/* ===== LOADING OVERLAY ===== */
.loading-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 150;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 16px; color: #fff; opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
.loading-overlay.show { opacity: 1; pointer-events: auto; }
.spinner {
  width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.2);
  border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { font-size: 16px; font-weight: 500; }

/* ===== EMPTY STATE ===== */
.empty-notes { padding: 40px 20px; text-align: center; color: var(--text-tertiary); }
.empty-notes i { font-size: 40px; margin-bottom: 12px; opacity: 0.4; display: block; }
.empty-notes p { font-size: 14px; }

/* ===== ANIMATIONS ===== */
.note-card { animation: fadeSlideUp 0.3s ease both; }
@keyframes fadeSlideUp { from { opacity:0; transform: translateY(8px); } to { opacity:1; transform: translateY(0); } }

/* ===== MOBILE ===== */
@media (max-width: 768px) {
  :root { --sidebar-w: 100%; }
  #sidebar { width: 100%; border-right: none; }
  #main {
    position: fixed; inset: 0; z-index: 20; background: var(--bg);
    transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
  }
  #main.open { transform: translateX(0); }
  .note-view { padding: 20px 20px 60px; }
  .note-view-back { display: flex; }
  .note-view-title { font-size: 28px; }
  .editor { padding: 20px 16px 80px; }
  .editor-top-back { display: flex; }
  .field-row { flex-direction: column; gap: 0; }
  .toast-container { bottom: 16px; right: 16px; left: 16px; }
  .rt-btn[title]:hover::after { display: none; }
  .specialty-item .spec-reorder { opacity: 1; }
  .note-card .note-reorder { opacity: 1; }
}

/* ===== SCROLLBAR ===== */
#main::-webkit-scrollbar { width: 6px; }
#main::-webkit-scrollbar-thumb { background: var(--border); border-radius: 6px; }

/* ===== KEYWORD INPUT ===== */
.keywords-input-wrap {
  display: flex; flex-wrap: wrap; gap: 6px; padding: 8px 10px;
  border: 1px solid var(--border); border-radius: var(--radius-sm);
  background: var(--surface); min-height: 44px; align-items: center;
  cursor: text; transition: border-color 0.2s;
}
.keywords-input-wrap:focus-within { border-color: var(--primary); }
.keywords-input-wrap .kw-tag {
  background: var(--accent-light); color: var(--accent); padding: 3px 8px 3px 10px;
  border-radius: 6px; font-size: 13px; font-weight: 500;
  display: flex; align-items: center; gap: 4px;
}
.keywords-input-wrap .kw-tag button {
  width: 18px; height: 18px; border-radius: 50%; font-size: 10px;
  display: flex; align-items: center; justify-content: center;
  color: var(--accent); transition: all 0.15s;
}
.keywords-input-wrap .kw-tag button:hover { background: var(--accent); color: #fff; }
.keywords-input-wrap input {
  border: none; outline: none; background: none; color: var(--text);
  font-size: 16px; flex: 1; min-width: 80px; padding: 2px 0;
}
.keywords-input-wrap input::placeholder { color: var(--text-tertiary); }

/* ===== SEARCH HIGHLIGHT ===== */
mark { background: #FBBF24; color: #1D1D1F; padding: 0 2px; border-radius: 2px; }
html.dark mark { background: #B45309; color: #fff; }
</style>
</head>
<body>

<div id="app">
  <!-- SIDEBAR -->
  <div id="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <div class="logo-icon"><img src="https://pfst.cf2.poecdn.net/base/image/bbef7fb2fad7dca649ca8ee04dc8dadfb12deabbf00a9bbff9d3255e0006759d?w=72&h=108" alt="Jeffrey"></div>
        <h1>Notes of Dietitian Jeffrey</h1>
      </div>
      <div class="header-actions">
        <button class="icon-btn primary-btn" onclick="openNewNote()" title="New Note"><i class="fa-solid fa-plus"></i></button>
      </div>
    </div>
    <div class="search-wrap">
      <div class="search-box">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="search" id="searchInput" placeholder="Search notes..." oninput="handleSearch()" autocomplete="off">
        <button class="clear-search" id="clearSearch" onclick="clearSearch()"><i class="fa-solid fa-xmark"></i></button>
      </div>
    </div>
    <div class="sidebar-content" id="sidebarContent"></div>
    <!-- Cloud Sync Bar -->
    <div class="sync-bar" id="syncBar">
      <div class="sync-status-dot offline" id="syncDot"></div>
      <span class="sync-label" id="syncLabel">Cloud: Not connected</span>
      <button class="sync-btn" id="syncBtn" onclick="handleSyncAction()"><i class="fa-solid fa-cloud"></i> Setup</button>
    </div>
    <div class="sidebar-footer">
      <button onclick="showImportModal()"><i class="fa-solid fa-file-import"></i> Import</button>
      <button onclick="exportJSON()"><i class="fa-solid fa-file-export"></i> Export</button>
    </div>
  </div>

  <!-- MAIN -->
  <div id="main">
    <div class="main-empty" id="mainEmpty">
      <i class="fa-solid fa-book-medical"></i>
      <p>Select a note or create a new one</p>
    </div>
    <div class="note-view" id="noteView" style="display:none;"></div>
    <div class="editor" id="editorView" style="display:none;"></div>
  </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modalContent"></div>
</div>

<!-- LOADING -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Processing...</div>
</div>

<!-- TOAST -->
<div class="toast-container" id="toastContainer"></div>

<!-- HIDDEN FILE INPUTS -->
<input type="file" id="jsonFileInput" accept=".json" style="display:none;" onchange="handleJSONImport(event)">
<input type="file" id="pdfFileInput" accept=".pdf" style="display:none;" onchange="handlePDFImport(event)" multiple>

<script>
/* ===== DARK MODE ===== */
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
  document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
  document.documentElement.classList.toggle('dark', e.matches);
});

/* ===== PWA: INLINE MANIFEST + ICON + SERVICE WORKER ===== */
(function setupPWA() {
  /* 1. Generate app icon as SVG data URL */
  var iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">' +
    '<rect width="512" height="512" rx="96" fill="#0B6E63"/>' +
    '<text x="256" y="200" text-anchor="middle" font-size="160" font-family="Arial,sans-serif" font-weight="700" fill="#fff">DJ</text>' +
    '<text x="256" y="340" text-anchor="middle" font-size="60" font-family="Arial,sans-serif" font-weight="400" fill="#A7F3D0">Dietitian</text>' +
    '<text x="256" y="410" text-anchor="middle" font-size="60" font-family="Arial,sans-serif" font-weight="400" fill="#A7F3D0">Notes</text>' +
    '</svg>';
  var iconDataUrl = 'data:image/svg+xml;base64,' + btoa(iconSvg);

  /* Inject apple-touch-icon and favicon */
  var linkIcon = document.createElement('link');
  linkIcon.rel = 'icon'; linkIcon.type = 'image/svg+xml'; linkIcon.href = iconDataUrl;
  document.head.appendChild(linkIcon);
  var linkApple = document.createElement('link');
  linkApple.rel = 'apple-touch-icon'; linkApple.href = iconDataUrl;
  document.head.appendChild(linkApple);

  /* 2. Inline Web App Manifest via data URL */
  var manifest = {
    name: 'Notes of Dietitian Jeffrey',
    short_name: 'DJ Notes',
    description: 'Clinical nutrition knowledge base',
    start_url: './',
    display: 'standalone',
    background_color: '#FAF8F5',
    theme_color: '#0B6E63',
    orientation: 'any',
    icons: [
      { src: iconDataUrl, sizes: 'any', type: 'image/svg+xml', purpose: 'any' }
    ]
  };
  var manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
  var manifestUrl = URL.createObjectURL(manifestBlob);
  var linkManifest = document.createElement('link');
  linkManifest.rel = 'manifest'; linkManifest.href = manifestUrl;
  document.head.appendChild(linkManifest);

  /* 3. Register Service Worker for offline caching */
  if ('serviceWorker' in navigator) {
    var swCode = [
      "var CACHE_NAME = 'dj-notes-v1';",
      "var URLS_TO_CACHE = [",
      "  './',",
      "  'https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap',",
      "  'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css',",
      "  'https://cdn.jsdelivr.net/npm/marked/marked.min.js',",
      "  'https://cdn.jsdelivr.net/npm/firebase@10.12.2/firebase-app-compat.min.js',",
      "  'https://cdn.jsdelivr.net/npm/firebase@10.12.2/firebase-auth-compat.min.js',",
      "  'https://cdn.jsdelivr.net/npm/firebase@10.12.2/firebase-firestore-compat.min.js',",
      "  'https://cdn.jsdelivr.net/npm/firebase@10.12.2/firebase-storage-compat.min.js'",
      "];",
      "",
      "self.addEventListener('install', function(e) {",
      "  e.waitUntil(",
      "    caches.open(CACHE_NAME).then(function(cache) {",
      "      return cache.addAll(URLS_TO_CACHE);",
      "    })",
      "  );",
      "  self.skipWaiting();",
      "});",
      "",
      "self.addEventListener('activate', function(e) {",
      "  e.waitUntil(",
      "    caches.keys().then(function(names) {",
      "      return Promise.all(",
      "        names.filter(function(n) { return n !== CACHE_NAME; })",
      "              .map(function(n) { return caches.delete(n); })",
      "      );",
      "    })",
      "  );",
      "  self.clients.claim();",
      "});",
      "",
      "self.addEventListener('fetch', function(e) {",
      "  e.respondWith(",
      "    fetch(e.request).then(function(response) {",
      "      if (response && response.status === 200) {",
      "        var clone = response.clone();",
      "        caches.open(CACHE_NAME).then(function(cache) {",
      "          cache.put(e.request, clone);",
      "        });",
      "      }",
      "      return response;",
      "    }).catch(function() {",
      "      return caches.match(e.request);",
      "    })",
      "  );",
      "});"
    ].join('\n');
    var swBlob = new Blob([swCode], { type: 'application/javascript' });
    var swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl, { scope: './' }).catch(function() {
      /* SW registration may fail in iframe/Poe â€” that is okay */
    });
  }
})();

/* ===== MARKED CONFIG ===== */
marked.setOptions({ breaks: true, gfm: true });

/* ===== DEFAULT SECTIONS ===== */
var DEFAULT_SECTIONS = [
  'Pathophysiology',
  'Risk Factors',
  'Prevalence',
  'Clinical Presentations',
  'Medical Treatments',
  'Dietetic Assessment',
  'Dietetic Intervention',
  'Keywords'
];

/* ===== SPECIALTY ICONS MAP ===== */
function getSpecialtyIcon() {
  return 'fa-folder';
}

/* ===== DATA ===== */
var specialties = [];
var notes = [];
var activeNoteId = null;
var activeSpecialty = null;
var sidebarLayer = 'specialties';
var searchQuery = '';
var currentView = 'list';

function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).substring(2, 8);
}

function stripHtml(html) {
  var tmp = document.createElement('div');
  tmp.innerHTML = html;
  return tmp.textContent || tmp.innerText || '';
}

function getPreview(note) {
  if (note.type === 'blank') return stripHtml(note.content || '');
  if (note.sections && note.sections.length > 0) {
    return note.sections.map(function(s){ return s.content; }).join(' ');
  }
  return '';
}

function formatDate(d) {
  if (!d) return '';
  var date = new Date(d);
  return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
}

function getNotesForSpecialty(specName) {
  return notes.filter(function(n) {
    return n.category === specName;
  }).sort(function(a, b) {
    return (a.sortOrder || 0) - (b.sortOrder || 0);
  });
}

function ensureSpecialty(catName) {
  if (!catName) return;
  var exists = specialties.some(function(s) { return s.name === catName; });
  if (!exists) {
    specialties.push({
      id: generateId(),
      name: catName,
      sortOrder: specialties.length
    });
  }
}

function reindexSortOrders(arr, field) {
  arr.forEach(function(item, i) {
    item[field || 'sortOrder'] = i;
  });
}

/* =============================================
   INDEXEDDB LOCAL STORAGE
   ============================================= */
var DB_NAME = 'DietitianJeffreyDB';
var DB_VERSION = 1;
var STORE_DATA = 'appData';
var STORE_CONFIG = 'config';

function openIDB() {
  return new Promise(function(resolve, reject) {
    var request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onupgradeneeded = function(e) {
      var db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_DATA)) {
        db.createObjectStore(STORE_DATA);
      }
      if (!db.objectStoreNames.contains(STORE_CONFIG)) {
        db.createObjectStore(STORE_CONFIG);
      }
    };
    request.onsuccess = function(e) { resolve(e.target.result); };
    request.onerror = function(e) { reject(e.target.error); };
  });
}

function saveToIDB(storeName, key, value) {
  return openIDB().then(function(db) {
    return new Promise(function(resolve, reject) {
      var tx = db.transaction(storeName, 'readwrite');
      var store = tx.objectStore(storeName);
      store.put(value, key);
      tx.oncomplete = function() { resolve(); };
      tx.onerror = function(e) { reject(e.target.error); };
    });
  });
}

function loadFromIDB(storeName, key) {
  return openIDB().then(function(db) {
    return new Promise(function(resolve, reject) {
      var tx = db.transaction(storeName, 'readonly');
      var store = tx.objectStore(storeName);
      var request = store.get(key);
      request.onsuccess = function() { resolve(request.result); };
      request.onerror = function(e) { reject(e.target.error); };
    });
  });
}

/* Persist current data to IndexedDB */
function persistLocal() {
  var data = {
    specialties: specialties,
    notes: notes
  };
  return saveToIDB(STORE_DATA, 'mainData', data).catch(function(err) {
    console.log('IndexedDB save error: ' + (err ? err.message : 'unknown'));
  });
}

/* Load data from IndexedDB */
function loadLocal() {
  return loadFromIDB(STORE_DATA, 'mainData').then(function(data) {
    if (data && data.notes) {
      return data;
    }
    return null;
  }).catch(function() {
    return null;
  });
}

/* Save Firebase config to IndexedDB */
function saveFirebaseConfig(config) {
  return saveToIDB(STORE_CONFIG, 'firebaseConfig', config).catch(function() {
    /* silently fail */
  });
}

/* Load Firebase config from IndexedDB */
function loadFirebaseConfig() {
  return loadFromIDB(STORE_CONFIG, 'firebaseConfig').catch(function() {
    return null;
  });
}

/* =============================================
   FIREBASE CLOUD STORAGE
   ============================================= */
var firebaseApp = null;
var firebaseAuth = null;
var firebaseDb = null;
var firebaseStorage = null;
var firebaseUser = null;
var firestoreUnsubscribe = null;
var syncStatus = 'offline'; /* offline | syncing | synced | error */
var isCloudPulling = false; /* Prevent save loops during cloud pull */

function updateSyncUI() {
  var dot = document.getElementById('syncDot');
  var label = document.getElementById('syncLabel');
  var btn = document.getElementById('syncBtn');

  dot.className = 'sync-status-dot ' + syncStatus;

  if (!firebaseApp) {
    label.textContent = 'Cloud: Not configured';
    btn.innerHTML = '<i class="fa-solid fa-gear"></i> Setup';
    btn.className = 'sync-btn';
    btn.onclick = handleSyncAction;
  } else if (!firebaseUser) {
    label.textContent = 'Cloud: Signed out';
    btn.innerHTML = '<i class="fa-solid fa-right-to-bracket"></i> Sign In';
    btn.className = 'sync-btn';
    btn.onclick = handleSyncAction;
  } else {
    var displayName = firebaseUser.displayName || firebaseUser.email || 'User';
    if (syncStatus === 'syncing') {
      label.textContent = 'Syncing...';
    } else if (syncStatus === 'synced') {
      label.textContent = 'Synced: ' + displayName;
    } else if (syncStatus === 'error') {
      label.textContent = 'Sync error';
    } else {
      label.textContent = 'Cloud: ' + displayName;
    }
    btn.innerHTML = '<i class="fa-solid fa-right-from-bracket"></i> Out';
    btn.className = 'sync-btn signout';
    btn.onclick = handleSignOut;
  }
}

function handleSyncAction() {
  if (!firebaseApp) {
    showFirebaseConfigModal();
  } else if (!firebaseUser) {
    signInWithGoogle();
  }
}

function handleSignOut() {
  if (!firebaseAuth) return;
  if (firestoreUnsubscribe) {
    firestoreUnsubscribe();
    firestoreUnsubscribe = null;
  }
  firebaseAuth.signOut().then(function() {
    firebaseUser = null;
    syncStatus = 'offline';
    updateSyncUI();
    showToast('Signed out', 'success');
  }).catch(function(err) {
    showToast('Sign out error: ' + err.message, 'error');
  });
}

function initFirebase(config) {
  try {
    if (firebaseApp) {
      /* Already initialized, update config requires page reload */
      return;
    }
    firebaseApp = firebase.initializeApp(config);
    firebaseAuth = firebase.auth();
    firebaseDb = firebase.firestore();
    firebaseStorage = firebase.storage();

    /* Listen for auth state changes */
    firebaseAuth.onAuthStateChanged(function(user) {
      firebaseUser = user;
      if (user) {
        syncStatus = 'synced';
        updateSyncUI();
        startFirestoreListener();
      } else {
        syncStatus = 'offline';
        if (firestoreUnsubscribe) {
          firestoreUnsubscribe();
          firestoreUnsubscribe = null;
        }
        updateSyncUI();
      }
    });

    saveFirebaseConfig(config);
    updateSyncUI();
  } catch (err) {
    showToast('Firebase init error: ' + err.message, 'error');
  }
}

function signInWithGoogle() {
  if (!firebaseAuth) {
    showToast('Firebase not configured', 'error');
    return;
  }
  var provider = new firebase.auth.GoogleAuthProvider();
  firebaseAuth.signInWithPopup(provider).then(function(result) {
    firebaseUser = result.user;
    syncStatus = 'synced';
    updateSyncUI();
    showToast('Signed in as ' + (result.user.displayName || result.user.email), 'success');
    /* Push local data to cloud on first sign-in */
    pushToCloud();
  }).catch(function(err) {
    if (err.code !== 'auth/popup-closed-by-user') {
      showToast('Sign-in error: ' + err.message, 'error');
    }
  });
}

function pushToCloud() {
  if (!firebaseDb || !firebaseUser) return Promise.resolve();
  syncStatus = 'syncing';
  updateSyncUI();

  var docRef = firebaseDb.collection('users').doc(firebaseUser.uid);
  var data = {
    specialties: JSON.parse(JSON.stringify(specialties)),
    notes: JSON.parse(JSON.stringify(notes)),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  return docRef.set(data, { merge: true }).then(function() {
    syncStatus = 'synced';
    updateSyncUI();
  }).catch(function(err) {
    syncStatus = 'error';
    updateSyncUI();
    console.log('Cloud push error: ' + (err ? err.message : 'unknown'));
  });
}

function pullFromCloud() {
  if (!firebaseDb || !firebaseUser) return Promise.resolve();

  var docRef = firebaseDb.collection('users').doc(firebaseUser.uid);
  return docRef.get().then(function(doc) {
    if (doc.exists) {
      var data = doc.data();
      if (data.notes && Array.isArray(data.notes)) {
        isCloudPulling = true;
        specialties = data.specialties || [];
        notes = data.notes || [];
        renderSidebar();
        /* Also save to local IDB */
        persistLocal();
        /* Re-render current view if a note is open */
        if (activeNoteId) {
          var note = notes.find(function(n) { return n.id === activeNoteId; });
          if (note) {
            renderNoteView(note);
          } else {
            activeNoteId = null;
            showView('empty');
          }
        }
        isCloudPulling = false;
      }
    }
  }).catch(function(err) {
    console.log('Cloud pull error: ' + (err ? err.message : 'unknown'));
  });
}

function startFirestoreListener() {
  if (!firebaseDb || !firebaseUser) return;
  if (firestoreUnsubscribe) firestoreUnsubscribe();

  var docRef = firebaseDb.collection('users').doc(firebaseUser.uid);
  firestoreUnsubscribe = docRef.onSnapshot(function(doc) {
    if (!doc.exists) {
      /* No cloud data yet; push local data up */
      pushToCloud();
      return;
    }
    var data = doc.data();
    if (data.notes && Array.isArray(data.notes)) {
      isCloudPulling = true;
      specialties = data.specialties || [];
      notes = data.notes || [];
      renderSidebar();
      persistLocal();
      if (activeNoteId) {
        var note = notes.find(function(n) { return n.id === activeNoteId; });
        if (note && currentView === 'view') {
          renderNoteView(note);
        } else if (!note) {
          activeNoteId = null;
          showView('empty');
        }
      }
      syncStatus = 'synced';
      updateSyncUI();
      isCloudPulling = false;
    }
  }, function(err) {
    syncStatus = 'error';
    updateSyncUI();
    console.log('Firestore listener error: ' + (err ? err.message : 'unknown'));
  });
}

/* Combined persist: save to IndexedDB + push to cloud */
function persistData() {
  if (isCloudPulling) return; /* Don't re-push while pulling from cloud */
  persistLocal();
  pushToCloud();
}

/* ===== FIREBASE CONFIG MODAL ===== */
function showFirebaseConfigModal() {
  var html = '<h3><i class="fa-solid fa-cloud" style="color:var(--primary);margin-right:8px;"></i>Firebase Cloud Setup</h3>';
  html += '<div class="firebase-help">To enable cloud sync, create a Firebase project at <a href="https://console.firebase.google.com" target="_blank" rel="noopener">console.firebase.google.com</a>, enable <strong>Authentication</strong> (Google sign-in) and <strong>Cloud Firestore</strong>, then paste your config values below.</div>';
  html += '<div class="firebase-config-fields">';
  html += '<div class="field-group"><div class="field-label">API Key</div><input class="field-input" id="fb-apiKey" placeholder="AIza..."></div>';
  html += '<div class="field-group"><div class="field-label">Auth Domain</div><input class="field-input" id="fb-authDomain" placeholder="myapp.firebaseapp.com"></div>';
  html += '<div class="field-group"><div class="field-label">Project ID</div><input class="field-input" id="fb-projectId" placeholder="my-project-id"></div>';
  html += '<div class="field-group"><div class="field-label">Storage Bucket</div><input class="field-input" id="fb-storageBucket" placeholder="myapp.appspot.com"></div>';
  html += '<div class="field-group"><div class="field-label">Messaging Sender ID</div><input class="field-input" id="fb-messagingSenderId" placeholder="123456789"></div>';
  html += '<div class="field-group"><div class="field-label">App ID</div><input class="field-input" id="fb-appId" placeholder="1:123456789:web:abc123"></div>';
  html += '</div>';
  html += '<div class="modal-actions">';
  html += '<button class="cancel-btn" onclick="closeModal()">Cancel</button>';
  html += '<button class="primary-confirm-btn" id="fbSaveBtn">Connect</button>';
  html += '</div>';

  document.getElementById('modalContent').innerHTML = html;
  document.getElementById('modalOverlay').classList.add('show');

  /* Pre-fill if config exists */
  loadFirebaseConfig().then(function(config) {
    if (config) {
      var fields = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
      fields.forEach(function(f) {
        var el = document.getElementById('fb-' + f);
        if (el && config[f]) el.value = config[f];
      });
    }
  });

  document.getElementById('fbSaveBtn').onclick = function() {
    var config = {
      apiKey: document.getElementById('fb-apiKey').value.trim(),
      authDomain: document.getElementById('fb-authDomain').value.trim(),
      projectId: document.getElementById('fb-projectId').value.trim(),
      storageBucket: document.getElementById('fb-storageBucket').value.trim(),
      messagingSenderId: document.getElementById('fb-messagingSenderId').value.trim(),
      appId: document.getElementById('fb-appId').value.trim()
    };

    if (!config.apiKey || !config.projectId) {
      showToast('API Key and Project ID are required', 'error');
      return;
    }

    closeModal();
    initFirebase(config);
    showToast('Firebase configured! Click Sign In to connect.', 'success');
  };
}

/* ===== RENDERING ===== */
/* ===== SIDEBAR SWIPE GESTURES ===== */
var sidebarSwipe = { startX: 0, startY: 0, tracking: false };

function initSidebarSwipe(container) {
  if (container._swipeInit) return;
  container._swipeInit = true;

  container.addEventListener('touchstart', function(e) {
    var t = e.touches[0];
    sidebarSwipe.startX = t.clientX;
    sidebarSwipe.startY = t.clientY;
    sidebarSwipe.tracking = true;
  }, { passive: true });

  container.addEventListener('touchmove', function() {
    /* Let the browser handle scroll â€” we only check on touchend */
  }, { passive: true });

  container.addEventListener('touchend', function(e) {
    if (!sidebarSwipe.tracking) return;
    sidebarSwipe.tracking = false;
    var t = e.changedTouches[0];
    var dx = t.clientX - sidebarSwipe.startX;
    var dy = t.clientY - sidebarSwipe.startY;
    /* Only count horizontal swipes (dx large, dy small) */
    if (Math.abs(dx) < 50 || Math.abs(dy) > Math.abs(dx) * 0.7) return;

    if (dx > 0 && sidebarLayer === 'notes') {
      /* Swipe right on notes panel â†’ go back to specialties */
      goBackToSpecialties();
    }
  }, { passive: true });
}

function renderSidebar() {
  var container = document.getElementById('sidebarContent');

  if (searchQuery) {
    renderSearchResults(container);
    return;
  }

  // Build the two-panel slider if not already present
  var slider = container.querySelector('.sidebar-slider');
  if (!slider) {
    container.innerHTML = '<div class="sidebar-slider"><div class="slide-panel" id="panelSpecialties"></div><div class="slide-panel" id="panelNotes"></div></div>';
    slider = container.querySelector('.sidebar-slider');
  }
  initSidebarSwipe(container);

  renderSpecialtiesPanel();
  renderNotesPanel();

  if (sidebarLayer === 'notes') {
    slider.classList.add('show-notes');
  } else {
    slider.classList.remove('show-notes');
  }
}

function renderSpecialtiesPanel() {
  var panel = document.getElementById('panelSpecialties');
  if (!panel) return;
  var html = '<div class="specialties-layer">';
  var sorted = specialties.slice().sort(function(a, b) {
    return (a.sortOrder || 0) - (b.sortOrder || 0);
  });

  sorted.forEach(function(spec, i) {
    var count = getNotesForSpecialty(spec.name).length;
    var iconClass = getSpecialtyIcon(spec.name);
    html += '<div class="specialty-item" onclick="openSpecialty(\'' + escapeAttr(spec.name) + '\')" style="animation-delay:' + (i * 0.03) + 's">';
    html += '<div class="spec-icon"><i class="fa-solid ' + iconClass + '"></i></div>';
    html += '<div class="spec-info">';
    html += '<div class="spec-name">' + escapeHtml(spec.name) + '</div>';
    html += '<div class="spec-count">' + count + ' note' + (count !== 1 ? 's' : '') + '</div>';
    html += '</div>';
    html += '<div class="spec-reorder">';
    if (i > 0) {
      html += '<button class="spec-reorder-btn" onclick="event.stopPropagation(); moveSpecialty(\'' + spec.id + '\', -1)" title="Move up"><i class="fa-solid fa-chevron-up"></i></button>';
    }
    if (i < sorted.length - 1) {
      html += '<button class="spec-reorder-btn" onclick="event.stopPropagation(); moveSpecialty(\'' + spec.id + '\', 1)" title="Move down"><i class="fa-solid fa-chevron-down"></i></button>';
    }
    html += '</div>';
    html += '<div class="spec-chevron"><i class="fa-solid fa-chevron-right"></i></div>';
    html += '</div>';
  });

  html += '<button class="add-specialty-btn" onclick="addSpecialtyPrompt()">';
  html += '<i class="fa-solid fa-plus"></i> Add Specialty';
  html += '</button>';
  html += '</div>';
  panel.innerHTML = html;
}

function renderNotesPanel() {
  var panel = document.getElementById('panelNotes');
  if (!panel || !activeSpecialty) { if (panel) panel.innerHTML = ''; return; }

  var specNotes = getNotesForSpecialty(activeSpecialty);
  var html = '<div class="notes-layer">';

  html += '<div class="notes-layer-header">';
  html += '<button class="notes-layer-back" onclick="goBackToSpecialties()"><i class="fa-solid fa-chevron-left"></i></button>';
  html += '<div class="notes-layer-title">' + escapeHtml(activeSpecialty) + '</div>';
  html += '<div class="notes-layer-actions">';
  html += '<button class="icon-btn" onclick="renameSpecialtyPrompt(\'' + escapeAttr(activeSpecialty) + '\')" title="Rename"><i class="fa-solid fa-pen"></i></button>';
  html += '<button class="icon-btn" onclick="confirmDeleteSpecialty(\'' + escapeAttr(activeSpecialty) + '\')" title="Delete specialty"><i class="fa-solid fa-trash"></i></button>';
  html += '</div>';
  html += '</div>';

  html += '<div class="notes-list">';
  if (specNotes.length === 0) {
    html += '<div class="empty-notes"><i class="fa-solid fa-folder-open"></i><p>No notes in this specialty</p></div>';
  } else {
    specNotes.forEach(function(note, i) {
      var preview = escapeHtml(getPreview(note).substring(0, 120));
      html += '<div class="note-card ' + (note.id === activeNoteId ? 'active' : '') + '" onclick="viewNote(\'' + note.id + '\')" style="animation-delay:' + (i * 0.03) + 's">';
      html += '<div class="note-card-body">';
      html += '<div class="note-card-title">' + escapeHtml(note.title) + '</div>';
      html += '<div class="note-card-meta">';
      html += '<span>' + formatDate(note.updatedAt) + '</span>';
      html += '</div>';
      if (preview) html += '<div class="note-card-preview">' + preview + '</div>';
      html += '</div>';
      html += '<div class="note-reorder">';
      if (i > 0) {
        html += '<button class="note-reorder-btn" onclick="event.stopPropagation(); moveNoteInSpecialty(\'' + note.id + '\', -1)" title="Move up"><i class="fa-solid fa-chevron-up"></i></button>';
      }
      if (i < specNotes.length - 1) {
        html += '<button class="note-reorder-btn" onclick="event.stopPropagation(); moveNoteInSpecialty(\'' + note.id + '\', 1)" title="Move down"><i class="fa-solid fa-chevron-down"></i></button>';
      }
      html += '</div>';
      html += '</div>';
    });
  }
  html += '</div></div>';
  panel.innerHTML = html;
}

function renderSearchResults(container) {
  var filtered = getFilteredNotes();
  var html = '<div class="search-results-layer">';
  html += '<div class="search-results-heading">' + filtered.length + ' result' + (filtered.length !== 1 ? 's' : '') + '</div>';

  if (filtered.length === 0) {
    html += '<div class="empty-notes"><i class="fa-solid fa-magnifying-glass"></i><p>No results found</p></div>';
  } else {
    html += '<div class="notes-list">';
    filtered.forEach(function(note, i) {
      var preview = getPreview(note).substring(0, 120);
      preview = highlightText(escapeHtml(preview), searchQuery);
      var titleHtml = highlightText(escapeHtml(note.title), searchQuery);
      html += '<div class="note-card ' + (note.id === activeNoteId ? 'active' : '') + '" onclick="viewNote(\'' + note.id + '\')" style="animation-delay:' + (i * 0.03) + 's">';
      html += '<div class="note-card-body">';
      html += '<div class="note-card-title">' + titleHtml + '</div>';
      html += '<div class="note-card-meta">';
      if (note.category) html += '<span class="note-card-cat">' + escapeHtml(note.category) + '</span>';
      html += '<span>' + formatDate(note.updatedAt) + '</span>';
      html += '</div>';
      if (preview) html += '<div class="note-card-preview">' + preview + '</div>';
      html += '</div>';
      html += '</div>';
    });
    html += '</div>';
  }
  html += '</div>';
  container.innerHTML = html;
}

function getFilteredNotes() {
  var result = notes.slice();
  if (searchQuery) {
    var q = searchQuery.toLowerCase();
    result = result.filter(function(n) {
      if (n.title.toLowerCase().indexOf(q) !== -1) return true;
      if (n.keywords && n.keywords.some(function(k){ return k.toLowerCase().indexOf(q) !== -1; })) return true;
      if (n.category && n.category.toLowerCase().indexOf(q) !== -1) return true;
      if (n.type === 'blank') {
        var plainContent = stripHtml(n.content || '');
        if (plainContent.toLowerCase().indexOf(q) !== -1) return true;
      }
      if (n.sections) {
        return n.sections.some(function(s){
          return s.title.toLowerCase().indexOf(q) !== -1 || s.content.toLowerCase().indexOf(q) !== -1;
        });
      }
      return false;
    });
    result.sort(function(a, b) {
      var aTitle = a.title.toLowerCase().indexOf(q) !== -1 ? 0 : 1;
      var bTitle = b.title.toLowerCase().indexOf(q) !== -1 ? 0 : 1;
      if (aTitle !== bTitle) return aTitle - bTitle;
      return new Date(b.updatedAt) - new Date(a.updatedAt);
    });
  } else {
    result.sort(function(a, b) { return new Date(b.updatedAt) - new Date(a.updatedAt); });
  }
  return result;
}

/* ===== SPECIALTY MANAGEMENT ===== */
function openSpecialty(name) {
  activeSpecialty = name;
  sidebarLayer = 'notes';
  // Update notes panel content, then slide over
  renderNotesPanel();
  var slider = document.querySelector('.sidebar-slider');
  if (slider) slider.classList.add('show-notes');
}

function goBackToSpecialties() {
  sidebarLayer = 'specialties';
  // Update specialties counts, then slide back
  renderSpecialtiesPanel();
  var slider = document.querySelector('.sidebar-slider');
  if (slider) slider.classList.remove('show-notes');
  // Clear activeSpecialty after transition
  setTimeout(function() { activeSpecialty = null; }, 300);
}

function moveSpecialty(specId, direction) {
  var sorted = specialties.slice().sort(function(a, b) {
    return (a.sortOrder || 0) - (b.sortOrder || 0);
  });
  var idx = sorted.findIndex(function(s) { return s.id === specId; });
  if (idx === -1) return;
  var newIdx = idx + direction;
  if (newIdx < 0 || newIdx >= sorted.length) return;
  var temp = sorted[idx];
  sorted[idx] = sorted[newIdx];
  sorted[newIdx] = temp;
  reindexSortOrders(sorted, 'sortOrder');
  specialties = sorted;
  renderSidebar();
  persistData();
}

function moveNoteInSpecialty(noteId, direction) {
  var specNotes = getNotesForSpecialty(activeSpecialty);
  var idx = specNotes.findIndex(function(n) { return n.id === noteId; });
  if (idx === -1) return;
  var newIdx = idx + direction;
  if (newIdx < 0 || newIdx >= specNotes.length) return;
  var temp = specNotes[idx];
  specNotes[idx] = specNotes[newIdx];
  specNotes[newIdx] = temp;
  reindexSortOrders(specNotes, 'sortOrder');
  renderSidebar();
  persistData();
}

function addSpecialtyPrompt() {
  showInputModal(
    'Add Specialty',
    'Enter the name for the new specialty:',
    '',
    'Add',
    function(name) {
      if (!name.trim()) {
        showToast('Please enter a name', 'error');
        return;
      }
      var exists = specialties.some(function(s) { return s.name.toLowerCase() === name.trim().toLowerCase(); });
      if (exists) {
        showToast('Specialty already exists', 'error');
        return;
      }
      specialties.push({
        id: generateId(),
        name: name.trim(),
        sortOrder: specialties.length
      });
      renderSidebar();
      persistData();
      showToast('Specialty added!', 'success');
    }
  );
}

function renameSpecialtyPrompt(oldName) {
  showInputModal(
    'Rename Specialty',
    'Enter a new name for "' + oldName + '":',
    oldName,
    'Rename',
    function(newName) {
      if (!newName.trim()) {
        showToast('Please enter a name', 'error');
        return;
      }
      if (newName.trim() === oldName) return;
      var exists = specialties.some(function(s) { return s.name.toLowerCase() === newName.trim().toLowerCase() && s.name !== oldName; });
      if (exists) {
        showToast('A specialty with this name already exists', 'error');
        return;
      }
      var spec = specialties.find(function(s) { return s.name === oldName; });
      if (spec) {
        spec.name = newName.trim();
        notes.forEach(function(n) {
          if (n.category === oldName) n.category = newName.trim();
        });
        activeSpecialty = newName.trim();
        renderSidebar();
        persistData();
        showToast('Specialty renamed!', 'success');
      }
    }
  );
}

function confirmDeleteSpecialty(name) {
  var count = getNotesForSpecialty(name).length;
  var message = count > 0
    ? 'This specialty has ' + count + ' note(s). Deleting it will remove the specialty grouping, but the notes will be kept as uncategorized. Continue?'
    : 'Delete the specialty "' + name + '"?';
  showModal(
    'Delete Specialty',
    message,
    'Delete',
    function() {
      specialties = specialties.filter(function(s) { return s.name !== name; });
      notes.forEach(function(n) {
        if (n.category === name) n.category = '';
      });
      reindexSortOrders(specialties.sort(function(a, b) { return (a.sortOrder || 0) - (b.sortOrder || 0); }), 'sortOrder');
      goBackToSpecialties();
      persistData();
      showToast('Specialty deleted', 'success');
    },
    true
  );
}

/* ===== NOTE VIEWER ===== */
function renderNoteView(note) {
  var view = document.getElementById('noteView');
  var html = '<div class="note-view-header">';
  html += '<button class="note-view-back" onclick="goBack()"><i class="fa-solid fa-chevron-left"></i> Back</button>';
  html += '<div class="note-view-title">' + escapeHtml(note.title) + '</div>';
  html += '<div class="note-view-meta">';
  if (note.category) html += '<span class="cat-badge">' + escapeHtml(note.category) + '</span>';
  html += '<span class="date">' + formatDate(note.updatedAt) + '</span>';
  html += '</div>';
  if (note.keywords && note.keywords.length > 0) {
    html += '<div class="note-view-keywords">';
    note.keywords.forEach(function(kw) {
      html += '<span class="keyword-tag">' + escapeHtml(kw) + '</span>';
    });
    html += '</div>';
  }
  html += '<div class="note-view-actions">';
  html += '<button class="btn btn-outline" onclick="editNote(\'' + note.id + '\')"><i class="fa-solid fa-pen"></i> Edit</button>';
  html += '<button class="btn btn-danger" onclick="confirmDelete(\'' + note.id + '\')"><i class="fa-solid fa-trash"></i> Delete</button>';
  html += '</div></div>';

  if (note.type === 'blank') {
    html += '<div class="note-blank-content">' + (note.content || '<p style="color:var(--text-tertiary)">Empty note</p>') + '</div>';
  } else if (note.sections) {
    note.sections.forEach(function(sec) {
      html += '<div class="note-section">';
      html += '<div class="note-section-title" onclick="toggleSection(this)"><i class="fa-solid fa-chevron-down"></i> ' + escapeHtml(sec.title) + '</div>';
      html += '<div class="note-section-content">' + marked.parse(sec.content || '') + '</div>';
      html += '</div>';
    });
  }
  view.innerHTML = html;
}

function toggleSection(el) {
  var icon = el.querySelector('i');
  var content = el.nextElementSibling;
  if (icon.classList.contains('collapsed')) {
    icon.classList.remove('collapsed');
    content.style.maxHeight = content.scrollHeight + 'px';
    setTimeout(function() { content.style.maxHeight = 'none'; }, 300);
  } else {
    content.style.maxHeight = content.scrollHeight + 'px';
    requestAnimationFrame(function() {
      icon.classList.add('collapsed');
      content.style.maxHeight = '0';
    });
  }
}

/* ===== EDITOR ===== */
var editorState = null;

function renderEditor(note) {
  editorState = JSON.parse(JSON.stringify(note));
  var isNew = !notes.find(function(n){ return n.id === note.id; });

  var view = document.getElementById('editorView');
  var html = '<div class="editor-top">';
  html += '<button class="editor-top-back" onclick="cancelEdit()"><i class="fa-solid fa-chevron-left"></i> Cancel</button>';
  html += '<span class="editor-title-label">' + (isNew ? 'New Note' : 'Edit Note') + '</span>';
  html += '<div class="editor-actions">';
  html += '<button class="btn btn-outline" onclick="cancelEdit()">Cancel</button>';
  html += '<button class="btn btn-primary" onclick="saveNote()"><i class="fa-solid fa-check"></i> Save</button>';
  html += '</div></div>';

  html += '<div class="field-group"><div class="field-label">Title</div>';
  html += '<input class="field-input" id="ed-title" placeholder="Note title..." value="' + escapeAttr(note.title) + '"></div>';

  html += '<div class="field-row">';
  html += '<div class="field-group"><div class="field-label">Specialty</div>';
  html += '<select class="field-input" id="ed-category">';
  html += '<option value="">â€” Select specialty â€”</option>';
  var sortedSpecs = specialties.slice().sort(function(a, b) { return (a.sortOrder || 0) - (b.sortOrder || 0); });
  sortedSpecs.forEach(function(s) {
    html += '<option value="' + escapeAttr(s.name) + '"' + (note.category === s.name ? ' selected' : '') + '>' + escapeHtml(s.name) + '</option>';
  });
  html += '<option value="__new__">+ Add new specialty...</option>';
  html += '</select>';
  html += '</div></div>';

  html += '<div class="field-group"><div class="field-label">Keywords</div>';
  html += '<div class="keywords-input-wrap" id="kwWrap" onclick="document.getElementById(\'kwInput\').focus()">';
  if (note.keywords) {
    note.keywords.forEach(function(kw) {
      html += '<span class="kw-tag">' + escapeHtml(kw) + '<button onclick="removeKeyword(this, \'' + escapeAttr(kw) + '\')"><i class="fa-solid fa-xmark"></i></button></span>';
    });
  }
  html += '<input id="kwInput" placeholder="Type & press Enter..." onkeydown="handleKeywordInput(event)">';
  html += '</div></div>';

  html += '<div class="field-label">Page Type</div>';
  html += '<div class="type-toggle">';
  html += '<button class="' + (note.type !== 'blank' ? 'active' : '') + '" onclick="switchType(\'structured\')"><i class="fa-solid fa-list"></i> Structured</button>';
  html += '<button class="' + (note.type === 'blank' ? 'active' : '') + '" onclick="switchType(\'blank\')"><i class="fa-solid fa-file-lines"></i> Blank Page</button>';
  html += '</div>';

  if (note.type === 'blank') {
    html += '<div class="field-group"><div class="field-label">Content</div>';
    html += '<div class="rt-toolbar" id="rtToolbar">';
    html += '<button class="rt-btn" title="Bold" onmousedown="execRT(event,\'bold\')"><i class="fa-solid fa-bold"></i></button>';
    html += '<button class="rt-btn" title="Italic" onmousedown="execRT(event,\'italic\')"><i class="fa-solid fa-italic"></i></button>';
    html += '<button class="rt-btn" title="Underline" onmousedown="execRT(event,\'underline\')"><i class="fa-solid fa-underline"></i></button>';
    html += '<span class="sep"></span>';
    html += '<button class="rt-btn" title="Strikethrough" onmousedown="execRT(event,\'strikeThrough\')"><i class="fa-solid fa-strikethrough"></i></button>';
    html += '<span class="sep"></span>';
    html += '<button class="rt-btn" title="Bullet List" onmousedown="execRT(event,\'insertUnorderedList\')"><i class="fa-solid fa-list-ul"></i></button>';
    html += '<button class="rt-btn" title="Numbered List" onmousedown="execRT(event,\'insertOrderedList\')"><i class="fa-solid fa-list-ol"></i></button>';
    html += '<span class="sep"></span>';
    html += '<button class="rt-btn" title="Heading" onmousedown="execHeading(event)"><i class="fa-solid fa-heading"></i></button>';
    html += '<span class="sep"></span>';
    html += '<div style="position:relative;display:inline-block;">';
    html += '<button class="rt-btn" title="Insert Table" onmousedown="toggleTablePopup(event)"><i class="fa-solid fa-table"></i></button>';
    html += '<div class="table-popup" id="tablePopup">';
    html += '<label>Rows</label><input type="number" id="tblRows" value="3" min="1" max="20">';
    html += '<label>Columns</label><input type="number" id="tblCols" value="3" min="1" max="10">';
    html += '<div class="tp-actions">';
    html += '<button class="tp-cancel" onclick="closeTablePopup()">Cancel</button>';
    html += '<button class="tp-insert" onclick="insertTable()">Insert</button>';
    html += '</div></div></div>';
    html += '<button class="rt-btn" title="Insert Image" onmousedown="showBlankImageInsert(event)"><i class="fa-solid fa-image"></i></button>';
    html += '<span class="sep"></span>';
    html += '<button class="rt-btn" title="Clear Formatting" onmousedown="execRT(event,\'removeFormat\')"><i class="fa-solid fa-eraser"></i></button>';
    html += '</div>';
    html += '<div class="rt-editor" id="rtEditor" contenteditable="true"></div>';
    html += '</div>';
  } else {
    html += '<div class="sections-editor" id="sectionsEditor">';
    if (note.sections) {
      note.sections.forEach(function(sec, idx) {
        html += renderSectionCard(sec, idx, note.sections.length);
      });
    }
    html += '</div>';
    html += '<button class="add-section-btn" onclick="addSection()"><i class="fa-solid fa-plus"></i> Add Section</button>';
  }

  view.innerHTML = html;

  // Populate rich text editor if blank
  if (note.type === 'blank') {
    var rtEditor = document.getElementById('rtEditor');
    if (rtEditor) {
      rtEditor.innerHTML = note.content || '';
      rtEditor.addEventListener('keyup', updateToolbarState);
      rtEditor.addEventListener('mouseup', updateToolbarState);
      rtEditor.addEventListener('click', updateToolbarState);
    }
  }

  // Handle specialty select
  var catSelect = document.getElementById('ed-category');
  if (catSelect) {
    catSelect.addEventListener('change', function() {
      if (this.value === '__new__') {
        this.value = note.category || '';
        showInputModal(
          'New Specialty',
          'Enter the name for the new specialty:',
          '',
          'Add',
          function(name) {
            if (!name.trim()) return;
            ensureSpecialty(name.trim());
            editorState.category = name.trim();
            renderEditor(editorState);
          }
        );
      }
    });
  }
}

/* ===== RICH TEXT COMMANDS ===== */
function execRT(e, command) {
  e.preventDefault();
  document.execCommand(command, false, null);
  updateToolbarState();
  document.getElementById('rtEditor').focus();
}

function execHeading(e) {
  e.preventDefault();
  var sel = window.getSelection();
  if (!sel.rangeCount) return;
  var block = getParentBlock(sel.anchorNode);
  if (block && block.tagName && block.tagName.match(/^H[1-6]$/)) {
    document.execCommand('formatBlock', false, 'p');
  } else {
    document.execCommand('formatBlock', false, 'h3');
  }
  document.getElementById('rtEditor').focus();
}

function getParentBlock(node) {
  while (node && node.nodeType !== 1) {
    node = node.parentNode;
  }
  while (node && node.id !== 'rtEditor') {
    var display = window.getComputedStyle(node).display;
    if (display === 'block' || display === 'list-item') return node;
    node = node.parentNode;
  }
  return null;
}

function updateToolbarState() {
  var toolbar = document.getElementById('rtToolbar');
  if (!toolbar) return;
  var buttons = toolbar.querySelectorAll('.rt-btn');
  buttons.forEach(function(btn) {
    var title = (btn.getAttribute('title') || '').toLowerCase();
    var isActive = false;
    if (title === 'bold') isActive = document.queryCommandState('bold');
    else if (title === 'italic') isActive = document.queryCommandState('italic');
    else if (title === 'underline') isActive = document.queryCommandState('underline');
    else if (title === 'strikethrough') isActive = document.queryCommandState('strikeThrough');
    btn.classList.toggle('active', isActive);
  });
}

/* ===== TABLE INSERT ===== */
function toggleTablePopup(e) {
  e.preventDefault();
  var popup = document.getElementById('tablePopup');
  popup.classList.toggle('show');
}

function closeTablePopup() {
  document.getElementById('tablePopup').classList.remove('show');
}

function insertTable() {
  var rows = parseInt(document.getElementById('tblRows').value) || 3;
  var cols = parseInt(document.getElementById('tblCols').value) || 3;
  rows = Math.max(1, Math.min(rows, 20));
  cols = Math.max(1, Math.min(cols, 10));

  var tableHtml = '<table>';
  tableHtml += '<tr>';
  for (var c = 0; c < cols; c++) {
    tableHtml += '<th>Header ' + (c + 1) + '</th>';
  }
  tableHtml += '</tr>';
  for (var r = 1; r < rows; r++) {
    tableHtml += '<tr>';
    for (var c2 = 0; c2 < cols; c2++) {
      tableHtml += '<td><br></td>';
    }
    tableHtml += '</tr>';
  }
  tableHtml += '</table><p><br></p>';

  var editor = document.getElementById('rtEditor');
  editor.focus();
  document.execCommand('insertHTML', false, tableHtml);
  closeTablePopup();
}

/* ===== BLANK PAGE IMAGE INSERT ===== */
function showBlankImageInsert(e) {
  e.preventDefault();
  /* Save selection so we can restore it after modal */
  var sel = window.getSelection();
  var savedRange = sel.rangeCount > 0 ? sel.getRangeAt(0).cloneRange() : null;

  document.getElementById('modalContent').innerHTML = buildImageModalHTML('blkImg');
  document.getElementById('modalOverlay').classList.add('show');

  wireImageModal('blkImg', function(url, alt) {
    var editor = document.getElementById('rtEditor');
    editor.focus();
    /* Restore selection */
    if (savedRange) {
      var s = window.getSelection();
      s.removeAllRanges();
      s.addRange(savedRange);
    }
    var imgHtml = '<img src="' + url.replace(/"/g, '&quot;') + '" alt="' + alt.replace(/"/g, '&quot;') + '" style="max-width:100%;height:auto;border-radius:8px;margin:8px 0;display:block;"><br>';
    document.execCommand('insertHTML', false, imgHtml);
  });
}

/* ===== SECTION CARD RENDER ===== */
function renderSectionCard(sec, idx, total) {
  var html = '<div class="section-card" data-idx="' + idx + '">';
  html += '<div class="section-card-header">';
  html += '<input value="' + escapeAttr(sec.title) + '" placeholder="Section title..." onchange="updateSectionTitle(' + idx + ', this.value)">';
  html += '<div class="section-card-actions">';
  if (idx > 0) html += '<button title="Move up" onclick="moveSection(' + idx + ', -1)"><i class="fa-solid fa-arrow-up"></i></button>';
  if (idx < total - 1) html += '<button title="Move down" onclick="moveSection(' + idx + ', 1)"><i class="fa-solid fa-arrow-down"></i></button>';
  html += '<button class="del" title="Remove" onclick="removeSection(' + idx + ')"><i class="fa-solid fa-trash"></i></button>';
  html += '</div></div>';
  html += '<div class="section-toolbar">';
  html += '<button class="st-btn" onclick="showSectionTableInsert(' + idx + ')"><i class="fa-solid fa-table"></i> Table</button>';
  html += '<button class="st-btn" onclick="showSectionImageInsert(' + idx + ')"><i class="fa-solid fa-image"></i> Image</button>';
  html += '</div>';
  html += '<textarea id="sec-ta-' + idx + '" placeholder="Section content (supports Markdown)..." onchange="updateSectionContent(' + idx + ', this.value)">' + escapeHtml(sec.content || '') + '</textarea>';
  html += '</div>';
  return html;
}

function switchType(type) {
  syncEditorState();
  editorState.type = type;
  if (type === 'structured' && (!editorState.sections || editorState.sections.length === 0)) {
    editorState.sections = DEFAULT_SECTIONS.map(function(title) {
      return { title: title, content: '' };
    });
  }
  renderEditor(editorState);
}

function syncEditorState() {
  if (!editorState) return;
  var titleEl = document.getElementById('ed-title');
  var catEl = document.getElementById('ed-category');
  if (titleEl) editorState.title = titleEl.value;
  if (catEl && catEl.value !== '__new__') editorState.category = catEl.value;

  var kwWrap = document.getElementById('kwWrap');
  if (kwWrap) {
    var tags = kwWrap.querySelectorAll('.kw-tag');
    editorState.keywords = [];
    tags.forEach(function(tag) {
      var text = tag.childNodes[0].textContent.trim();
      if (text) editorState.keywords.push(text);
    });
  }

  if (editorState.type === 'blank') {
    var rtEditor = document.getElementById('rtEditor');
    if (rtEditor) editorState.content = rtEditor.innerHTML;
  } else {
    var cards = document.querySelectorAll('.section-card');
    if (cards.length > 0 && editorState.sections) {
      cards.forEach(function(card, i) {
        if (editorState.sections[i]) {
          var input = card.querySelector('input');
          var textarea = card.querySelector('textarea');
          if (input) editorState.sections[i].title = input.value;
          if (textarea) editorState.sections[i].content = textarea.value;
        }
      });
    }
  }
}

function updateSectionTitle(idx, val) {
  if (editorState && editorState.sections && editorState.sections[idx]) {
    editorState.sections[idx].title = val;
  }
}

function updateSectionContent(idx, val) {
  if (editorState && editorState.sections && editorState.sections[idx]) {
    editorState.sections[idx].content = val;
  }
}

function addSection() {
  syncEditorState();
  if (!editorState.sections) editorState.sections = [];
  editorState.sections.push({ title: '', content: '' });
  renderEditor(editorState);
  var cards = document.querySelectorAll('.section-card');
  if (cards.length > 0) cards[cards.length - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function removeSection(idx) {
  syncEditorState();
  editorState.sections.splice(idx, 1);
  renderEditor(editorState);
}

function moveSection(idx, dir) {
  syncEditorState();
  var newIdx = idx + dir;
  if (newIdx < 0 || newIdx >= editorState.sections.length) return;
  var temp = editorState.sections[idx];
  editorState.sections[idx] = editorState.sections[newIdx];
  editorState.sections[newIdx] = temp;
  renderEditor(editorState);
}

/* ===== IMAGE UPLOAD TO FIREBASE STORAGE ===== */
function uploadImageToStorage(file, onProgress) {
  return new Promise(function(resolve, reject) {
    if (!firebaseStorage || !firebaseUser) {
      reject(new Error('NOT_SIGNED_IN'));
      return;
    }
    var ext = file.name.split('.').pop() || 'png';
    var safeName = Date.now() + '_' + Math.random().toString(36).substring(2, 8) + '.' + ext;
    var refPath = 'users/' + firebaseUser.uid + '/images/' + safeName;
    var storageRef = firebaseStorage.ref(refPath);
    var uploadTask = storageRef.put(file);

    uploadTask.on('state_changed',
      function(snapshot) {
        var pct = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        if (onProgress) onProgress(pct);
      },
      function(error) { reject(error); },
      function() {
        uploadTask.snapshot.ref.getDownloadURL().then(function(url) {
          resolve(url);
        }).catch(function(err) { reject(err); });
      }
    );
  });
}

/* Build image insert modal HTML (shared by section & blank) */
function buildImageModalHTML(idPrefix) {
  var html = '<h3><i class="fa-solid fa-image" style="color:var(--primary);margin-right:8px;"></i>Insert Image</h3>';

  /* Tabs */
  html += '<div class="img-upload-tabs">';
  html += '<button class="img-upload-tab active" data-tab="upload" id="' + idPrefix + 'TabUpload">Upload File</button>';
  html += '<button class="img-upload-tab" data-tab="url" id="' + idPrefix + 'TabUrl">Paste URL</button>';
  html += '</div>';

  /* Upload panel */
  html += '<div class="img-upload-panel active" id="' + idPrefix + 'PanelUpload">';
  html += '<div class="file-drop-zone" id="' + idPrefix + 'DropZone">';
  html += '<i class="fa-solid fa-cloud-arrow-up"></i>';
  html += '<p><strong>Click or drag & drop</strong> to choose an image</p>';
  html += '<p style="font-size:11px;color:var(--text-tertiary);margin-top:4px;">PNG, JPG, GIF, WebP â€” max 10 MB</p>';
  html += '<input type="file" accept="image/*" id="' + idPrefix + 'FileInput">';
  html += '</div>';
  html += '<div class="upload-preview" id="' + idPrefix + 'Preview"><img id="' + idPrefix + 'PreviewImg" src="" alt="preview"></div>';
  html += '<div class="upload-progress" id="' + idPrefix + 'Progress">';
  html += '<div class="upload-progress-bar"><div class="upload-progress-fill" id="' + idPrefix + 'ProgressFill"></div></div>';
  html += '<div class="upload-progress-text" id="' + idPrefix + 'ProgressText">Uploading...</div>';
  html += '</div>';
  if (!firebaseStorage || !firebaseUser) {
    html += '<p style="font-size:12px;color:var(--accent);margin-top:10px;"><i class="fa-solid fa-triangle-exclamation" style="margin-right:4px;"></i>Sign in to Firebase to enable upload</p>';
  }
  html += '</div>';

  /* URL panel */
  html += '<div class="img-upload-panel" id="' + idPrefix + 'PanelUrl">';
  html += '<div class="firebase-config-fields">';
  html += '<div class="field-group"><div class="field-label">Image URL</div><input class="field-input" id="' + idPrefix + 'Url" placeholder="https://example.com/image.png" style="font-size:16px;"></div>';
  html += '</div>';
  html += '</div>';

  /* Alt text (shared) */
  html += '<div class="firebase-config-fields" style="margin-top:8px;">';
  html += '<div class="field-group"><div class="field-label">Alt Text (optional)</div><input class="field-input" id="' + idPrefix + 'Alt" placeholder="Description of image" style="font-size:16px;"></div>';
  html += '</div>';

  html += '<div class="modal-actions">';
  html += '<button class="cancel-btn" onclick="closeModal()">Cancel</button>';
  html += '<button class="primary-confirm-btn" id="' + idPrefix + 'InsertBtn">Insert</button>';
  html += '</div>';
  return html;
}

/* Wire up tab switching and drag-drop for image modal */
function wireImageModal(idPrefix, onInsertUrl) {
  var tabUpload = document.getElementById(idPrefix + 'TabUpload');
  var tabUrl = document.getElementById(idPrefix + 'TabUrl');
  var panelUpload = document.getElementById(idPrefix + 'PanelUpload');
  var panelUrl = document.getElementById(idPrefix + 'PanelUrl');
  var fileInput = document.getElementById(idPrefix + 'FileInput');
  var dropZone = document.getElementById(idPrefix + 'DropZone');
  var preview = document.getElementById(idPrefix + 'Preview');
  var previewImg = document.getElementById(idPrefix + 'PreviewImg');
  var progressWrap = document.getElementById(idPrefix + 'Progress');
  var progressFill = document.getElementById(idPrefix + 'ProgressFill');
  var progressText = document.getElementById(idPrefix + 'ProgressText');
  var insertBtn = document.getElementById(idPrefix + 'InsertBtn');
  var urlInput = document.getElementById(idPrefix + 'Url');
  var altInput = document.getElementById(idPrefix + 'Alt');

  var selectedFile = null;
  var activeTab = 'upload';

  tabUpload.onclick = function() {
    activeTab = 'upload';
    tabUpload.classList.add('active');
    tabUrl.classList.remove('active');
    panelUpload.classList.add('active');
    panelUrl.classList.remove('active');
  };
  tabUrl.onclick = function() {
    activeTab = 'url';
    tabUrl.classList.add('active');
    tabUpload.classList.remove('active');
    panelUrl.classList.add('active');
    panelUpload.classList.remove('active');
    setTimeout(function() { urlInput.focus(); }, 50);
  };

  function handleFileSelected(file) {
    if (!file || !file.type.startsWith('image/')) {
      showToast('Please select an image file', 'error');
      return;
    }
    if (file.size > 10 * 1024 * 1024) {
      showToast('File too large (max 10 MB)', 'error');
      return;
    }
    selectedFile = file;
    var reader = new FileReader();
    reader.onload = function(e) {
      previewImg.src = e.target.result;
      preview.classList.add('show');
    };
    reader.readAsDataURL(file);
  }

  fileInput.onchange = function() {
    if (fileInput.files && fileInput.files[0]) handleFileSelected(fileInput.files[0]);
  };

  dropZone.ondragover = function(e) { e.preventDefault(); dropZone.classList.add('dragover'); };
  dropZone.ondragleave = function() { dropZone.classList.remove('dragover'); };
  dropZone.ondrop = function(e) {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    if (e.dataTransfer.files && e.dataTransfer.files[0]) handleFileSelected(e.dataTransfer.files[0]);
  };

  insertBtn.onclick = function() {
    var alt = altInput.value.trim() || 'image';

    if (activeTab === 'url') {
      var url = urlInput.value.trim();
      if (!url) { showToast('Please enter an image URL', 'error'); return; }
      closeModal();
      onInsertUrl(url, alt);
    } else {
      /* Upload tab */
      if (!selectedFile) { showToast('Please select an image file', 'error'); return; }
      if (!firebaseStorage || !firebaseUser) {
        showToast('Please sign in to Firebase first', 'error');
        return;
      }
      insertBtn.disabled = true;
      insertBtn.textContent = 'Uploading...';
      progressWrap.classList.add('show');
      progressText.textContent = 'Uploading...';

      uploadImageToStorage(selectedFile, function(pct) {
        progressFill.style.width = pct.toFixed(0) + '%';
        progressText.textContent = 'Uploading... ' + pct.toFixed(0) + '%';
      }).then(function(downloadUrl) {
        progressFill.style.width = '100%';
        progressText.textContent = 'Upload complete!';
        closeModal();
        onInsertUrl(downloadUrl, alt);
        showToast('Image uploaded successfully', 'success');
      }).catch(function(err) {
        insertBtn.disabled = false;
        insertBtn.textContent = 'Insert';
        progressWrap.classList.remove('show');
        showToast('Upload failed: ' + err.message, 'error');
      });
    }
  };
}

/* ===== SECTION TABLE / IMAGE INSERT ===== */
function insertAtCursor(textarea, text) {
  var start = textarea.selectionStart;
  var end = textarea.selectionEnd;
  var before = textarea.value.substring(0, start);
  var after = textarea.value.substring(end);
  /* Ensure newline separation */
  if (before.length > 0 && before[before.length - 1] !== '\n') before += '\n';
  if (after.length > 0 && after[0] !== '\n') text += '\n';
  textarea.value = before + text + after;
  textarea.selectionStart = textarea.selectionEnd = before.length + text.length;
  textarea.focus();
  var evt = new Event('change', { bubbles: true });
  textarea.dispatchEvent(evt);
}

function showSectionTableInsert(idx) {
  var html = '<h3><i class="fa-solid fa-table" style="color:var(--primary);margin-right:8px;"></i>Insert Table</h3>';
  html += '<p>Configure the table dimensions:</p>';
  html += '<div class="firebase-config-fields">';
  html += '<div class="field-group"><div class="field-label">Rows (including header)</div><input class="field-input" id="secTblRows" type="number" value="3" min="2" max="20"></div>';
  html += '<div class="field-group"><div class="field-label">Columns</div><input class="field-input" id="secTblCols" type="number" value="3" min="1" max="10"></div>';
  html += '</div>';
  html += '<div class="modal-actions">';
  html += '<button class="cancel-btn" onclick="closeModal()">Cancel</button>';
  html += '<button class="primary-confirm-btn" id="secTblInsertBtn">Insert</button>';
  html += '</div>';
  document.getElementById('modalContent').innerHTML = html;
  document.getElementById('modalOverlay').classList.add('show');
  setTimeout(function() { document.getElementById('secTblRows').focus(); }, 100);

  document.getElementById('secTblInsertBtn').onclick = function() {
    var rows = parseInt(document.getElementById('secTblRows').value) || 3;
    var cols = parseInt(document.getElementById('secTblCols').value) || 3;
    rows = Math.max(2, Math.min(rows, 20));
    cols = Math.max(1, Math.min(cols, 10));

    var md = '';
    /* Header row */
    var headerCells = [];
    var sepCells = [];
    for (var c = 0; c < cols; c++) {
      headerCells.push(' Header ' + (c + 1) + ' ');
      sepCells.push('----------');
    }
    md += '| ' + headerCells.join(' | ') + ' |\n';
    md += '| ' + sepCells.join(' | ') + ' |\n';
    /* Data rows */
    for (var r = 1; r < rows; r++) {
      var dataCells = [];
      for (var c2 = 0; c2 < cols; c2++) {
        dataCells.push('          ');
      }
      md += '| ' + dataCells.join(' | ') + ' |\n';
    }

    closeModal();
    var ta = document.getElementById('sec-ta-' + idx);
    if (ta) insertAtCursor(ta, md);
  };
}

function showSectionImageInsert(idx) {
  document.getElementById('modalContent').innerHTML = buildImageModalHTML('secImg');
  document.getElementById('modalOverlay').classList.add('show');

  wireImageModal('secImg', function(url, alt) {
    var md = '![' + alt + '](' + url + ')';
    var ta = document.getElementById('sec-ta-' + idx);
    if (ta) insertAtCursor(ta, md);
  });
}

function handleKeywordInput(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    var input = e.target;
    var val = input.value.trim();
    if (!val) return;
    if (!editorState.keywords) editorState.keywords = [];
    if (editorState.keywords.indexOf(val) === -1) {
      editorState.keywords.push(val);
      var tag = document.createElement('span');
      tag.className = 'kw-tag';
      tag.innerHTML = escapeHtml(val) + '<button onclick="removeKeyword(this, \'' + escapeAttr(val) + '\')"><i class="fa-solid fa-xmark"></i></button>';
      input.parentNode.insertBefore(tag, input);
    }
    input.value = '';
  }
}

function removeKeyword(btn, kw) {
  var tag = btn.parentNode;
  tag.remove();
  if (editorState && editorState.keywords) {
    editorState.keywords = editorState.keywords.filter(function(k){ return k !== kw; });
  }
}

/* ===== NAVIGATION ===== */
function showView(viewName) {
  var mainEmpty = document.getElementById('mainEmpty');
  var noteView = document.getElementById('noteView');
  var editorView = document.getElementById('editorView');
  var main = document.getElementById('main');

  mainEmpty.style.display = 'none';
  noteView.style.display = 'none';
  editorView.style.display = 'none';

  if (viewName === 'empty') {
    mainEmpty.style.display = 'flex';
    main.classList.remove('open');
    currentView = 'list';
  } else if (viewName === 'view') {
    noteView.style.display = 'block';
    main.classList.add('open');
    currentView = 'view';
  } else if (viewName === 'edit') {
    editorView.style.display = 'block';
    main.classList.add('open');
    currentView = 'edit';
  }
}

function viewNote(id) {
  activeNoteId = id;
  var note = notes.find(function(n){ return n.id === id; });
  if (!note) return;
  renderNoteView(note);
  renderSidebar();
  showView('view');
}

function editNote(id) {
  var note = notes.find(function(n){ return n.id === id; });
  if (!note) return;
  renderEditor(note);
  showView('edit');
}

function openNewNote() {
  var note = {
    id: generateId(),
    title: '',
    category: activeSpecialty || '',
    keywords: [],
    type: 'structured',
    sortOrder: 999,
    sections: DEFAULT_SECTIONS.map(function(title) {
      return { title: title, content: '' };
    }),
    content: '',
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
  renderEditor(note);
  showView('edit');
}

function saveNote() {
  syncEditorState();
  if (!editorState.title.trim()) {
    showToast('Please enter a title', 'error');
    document.getElementById('ed-title').focus();
    return;
  }
  editorState.updatedAt = new Date().toISOString();

  // Ensure specialty exists
  if (editorState.category) {
    ensureSpecialty(editorState.category);
  }

  var idx = notes.findIndex(function(n){ return n.id === editorState.id; });
  if (idx !== -1) {
    notes[idx] = JSON.parse(JSON.stringify(editorState));
  } else {
    // New note: assign sort order at the end
    var specNotes = getNotesForSpecialty(editorState.category);
    editorState.sortOrder = specNotes.length;
    notes.push(JSON.parse(JSON.stringify(editorState)));
  }

  activeNoteId = editorState.id;
  // Navigate to the note's specialty
  if (editorState.category) {
    activeSpecialty = editorState.category;
    sidebarLayer = 'notes';
  }
  renderSidebar();
  viewNote(editorState.id);
  persistData();
  showToast('Note saved!', 'success');
}

function cancelEdit() {
  if (activeNoteId && notes.find(function(n){ return n.id === activeNoteId; })) {
    viewNote(activeNoteId);
  } else {
    showView('empty');
    activeNoteId = null;
    renderSidebar();
  }
}

function goBack() {
  activeNoteId = null;
  showView('empty');
  renderSidebar();
}

function confirmDelete(id) {
  showModal(
    'Delete Note',
    'Are you sure you want to delete this note? This action cannot be undone.',
    'Delete',
    function() {
      notes = notes.filter(function(n){ return n.id !== id; });
      activeNoteId = null;
      renderSidebar();
      showView('empty');
      persistData();
      showToast('Note deleted', 'success');
    },
    true
  );
}

/* ===== SEARCH ===== */
function handleSearch() {
  searchQuery = document.getElementById('searchInput').value.trim();
  var clearBtn = document.getElementById('clearSearch');
  clearBtn.classList.toggle('show', searchQuery.length > 0);
  renderSidebar();
}

function clearSearch() {
  document.getElementById('searchInput').value = '';
  searchQuery = '';
  document.getElementById('clearSearch').classList.remove('show');
  renderSidebar();
}

function highlightText(text, query) {
  if (!query) return text;
  var escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  var regex = new RegExp('(' + escapedQuery + ')', 'gi');
  return text.replace(regex, '<mark>$1</mark>');
}

/* ===== IMPORT / EXPORT ===== */
function showImportModal() {
  var html = '<h3>Import Notes</h3>';
  html += '<div class="import-options">';
  html += '<div class="import-option" onclick="closeModal(); document.getElementById(\'jsonFileInput\').click();"><i class="fa-solid fa-file-code"></i><div class="import-option-text"><strong>Import JSON</strong><span>Import from a Notes of Dietitian Jeffrey export file</span></div></div>';
  html += '<div class="import-option" onclick="closeModal(); document.getElementById(\'pdfFileInput\').click();"><i class="fa-solid fa-file-pdf"></i><div class="import-option-text"><strong>Import PDF (AI Parse)</strong><span>Upload PDFs and AI will structure them</span></div></div>';
  html += '</div>';
  html += '<div class="modal-actions"><button class="cancel-btn" onclick="closeModal()">Cancel</button></div>';
  document.getElementById('modalContent').innerHTML = html;
  document.getElementById('modalOverlay').classList.add('show');
}

function exportJSON() {
  if (notes.length === 0) {
    showToast('No notes to export', 'error');
    return;
  }
  var data = {
    version: 2,
    exportDate: new Date().toISOString(),
    appName: 'Notes of Dietitian Jeffrey',
    specialties: specialties,
    notes: notes
  };
  var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  var dateStr = new Date().toISOString().split('T')[0];
  a.download = 'dietitian-jeffrey-export-' + dateStr + '.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Exported ' + notes.length + ' notes', 'success');
}

function handleJSONImport(event) {
  var file = event.target.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);
      var importNotes = data.notes || data;
      if (!Array.isArray(importNotes)) throw new Error('Invalid format');

      showModal(
        'Import Notes',
        'Found ' + importNotes.length + ' notes. This will add them to your existing notes.',
        'Import',
        function() {
          // Import specialties if present
          if (data.specialties && Array.isArray(data.specialties)) {
            data.specialties.forEach(function(s) {
              ensureSpecialty(s.name);
            });
          }
          importNotes.forEach(function(n) {
            if (!n.id) n.id = generateId();
            if (notes.find(function(existing){ return existing.id === n.id; })) {
              n.id = generateId();
            }
            // Ensure specialty for each note
            if (n.category) {
              ensureSpecialty(n.category);
            }
            notes.push(n);
          });
          renderSidebar();
          persistData();
          showToast('Imported ' + importNotes.length + ' notes', 'success');
        },
        false
      );
    } catch (err) {
      showToast('Invalid JSON file', 'error');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

/* ===== PDF IMPORT (AI) ===== */
function handlePDFImport(event) {
  var files = Array.from(event.target.files);
  if (files.length === 0) return;
  event.target.value = '';

  if (!window.Poe || !window.Poe.sendUserMessage) {
    showToast('PDF import requires Poe platform', 'error');
    return;
  }

  showLoading('Parsing ' + files.length + ' PDF(s) with AI...');

  var processed = 0;
  var failed = 0;

  window.Poe.registerHandler('pdf-parse-handler', function(result) {
    var msg = result.responses[0];

    if (msg.status === 'error') {
      failed++;
      processed++;
      if (processed >= files.length) finishPDFImport(processed - failed, failed);
      return;
    }

    if (msg.status === 'complete') {
      try {
        var content = msg.content.trim();
        content = content.replace(/^```(?:json)?\s*/i, '').replace(/\s*```$/i, '');
        var parsed = JSON.parse(content);

        var note = {
          id: generateId(),
          title: parsed.title || 'Untitled',
          category: parsed.category || '',
          keywords: parsed.keywords || [],
          type: parsed.type || 'structured',
          sortOrder: 999,
          sections: parsed.sections || [],
          content: parsed.content || '',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };

        if (note.category) ensureSpecialty(note.category);

        editorState = note;
        renderEditor(note);
        showView('edit');
        showToast('PDF parsed! Review and save.', 'success');

      } catch (parseErr) {
        var fallbackNote = {
          id: generateId(),
          title: 'Imported Note',
          category: '',
          keywords: [],
          type: 'blank',
          sortOrder: 999,
          content: '<p>' + escapeHtml(msg.content) + '</p>',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        editorState = fallbackNote;
        renderEditor(fallbackNote);
        showView('edit');
        showToast('Could not structure PDF. Imported as blank.', 'error');
      }
      processed++;
      if (processed >= files.length) hideLoading();
    }
  });

  files.forEach(function(file) {
    var prompt = '@Claude-Sonnet-4.5 Parse this PDF into structured JSON. Return ONLY a JSON object (no code blocks, no explanation) with this structure:\n{\n  "title": "document title",\n  "category": "short category (e.g. GI, Respiratory, Cardiology, Endocrine, Renal, Neurology, Paediatrics, Oncology)",\n  "keywords": ["keyword1", "keyword2"],\n  "type": "structured",\n  "sections": [\n    {"title": "section name", "content": "section content using markdown formatting"}\n  ]\n}\nPreferred section titles: Pathophysiology, Risk Factors, Prevalence, Clinical Presentations, Medical Treatments, Dietetic Assessment, Dietetic Intervention. Use these when applicable but keep original sections if they don\'t fit.\nIf no clear sections exist, use type "blank" with content field instead of sections. Preserve all bullet points, numbered lists, and sub-items using markdown. Return ONLY valid JSON.';

    window.Poe.sendUserMessage(prompt, {
      attachments: [file],
      handler: 'pdf-parse-handler',
      stream: false,
      openChat: false,
      parameters: {}
    }).catch(function() {
      failed++;
      processed++;
      if (processed >= files.length) finishPDFImport(processed - failed, failed);
    });
  });
}

function finishPDFImport(success, fail) {
  hideLoading();
  if (fail > 0) {
    showToast(success + ' imported, ' + fail + ' failed', 'error');
  }
}

/* ===== MODAL ===== */
function showModal(title, message, confirmText, onConfirm, isDanger) {
  var html = '<h3>' + escapeHtml(title) + '</h3>';
  html += '<p>' + escapeHtml(message) + '</p>';
  html += '<div class="modal-actions">';
  html += '<button class="cancel-btn" onclick="closeModal()">Cancel</button>';
  html += '<button class="' + (isDanger ? 'confirm-btn' : 'primary-confirm-btn') + '" id="modalConfirmBtn">' + escapeHtml(confirmText) + '</button>';
  html += '</div>';
  document.getElementById('modalContent').innerHTML = html;
  document.getElementById('modalOverlay').classList.add('show');

  document.getElementById('modalConfirmBtn').onclick = function() {
    closeModal();
    if (onConfirm) onConfirm();
  };
}

function showInputModal(title, message, defaultValue, confirmText, onConfirm) {
  var html = '<h3>' + escapeHtml(title) + '</h3>';
  html += '<p>' + escapeHtml(message) + '</p>';
  html += '<input class="modal-input" id="modalInputField" value="' + escapeAttr(defaultValue || '') + '" placeholder="Enter name...">';
  html += '<div class="modal-actions">';
  html += '<button class="cancel-btn" onclick="closeModal()">Cancel</button>';
  html += '<button class="primary-confirm-btn" id="modalConfirmBtn">' + escapeHtml(confirmText) + '</button>';
  html += '</div>';
  document.getElementById('modalContent').innerHTML = html;
  document.getElementById('modalOverlay').classList.add('show');

  var inputField = document.getElementById('modalInputField');
  setTimeout(function() { inputField.focus(); inputField.select(); }, 100);

  inputField.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      closeModal();
      if (onConfirm) onConfirm(inputField.value);
    }
  });

  document.getElementById('modalConfirmBtn').onclick = function() {
    closeModal();
    if (onConfirm) onConfirm(inputField.value);
  };
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
}

/* ===== TOAST ===== */
function showToast(msg, type) {
  var container = document.getElementById('toastContainer');
  var toast = document.createElement('div');
  toast.className = 'toast ' + (type || '');
  var icon = type === 'success' ? 'fa-circle-check' : 'fa-circle-exclamation';
  toast.innerHTML = '<i class="fa-solid ' + icon + '"></i>' + escapeHtml(msg);
  container.appendChild(toast);
  setTimeout(function() { toast.remove(); }, 3000);
}

/* ===== LOADING ===== */
function showLoading(text) {
  document.getElementById('loadingText').textContent = text || 'Processing...';
  document.getElementById('loadingOverlay').classList.add('show');
}

function hideLoading() {
  document.getElementById('loadingOverlay').classList.remove('show');
}

/* ===== UTILITY ===== */
function escapeHtml(s) {
  if (!s) return '';
  var div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

function escapeAttr(s) {
  if (!s) return '';
  return s.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

/* ===== KEYBOARD SHORTCUTS ===== */
document.addEventListener('keydown', function(e) {
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
    e.preventDefault();
    document.getElementById('searchInput').focus();
  }
  if (e.key === 'Escape') {
    if (document.getElementById('tablePopup') && document.getElementById('tablePopup').classList.contains('show')) {
      closeTablePopup();
    } else if (document.getElementById('modalOverlay').classList.contains('show')) {
      closeModal();
    } else if (currentView === 'edit') {
      cancelEdit();
    } else if (currentView === 'view') {
      goBack();
    }
  }
});

/* Close modal on overlay click */
document.getElementById('modalOverlay').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

/* Close table popup when clicking outside */
document.addEventListener('click', function(e) {
  var popup = document.getElementById('tablePopup');
  if (popup && popup.classList.contains('show')) {
    if (!e.target.closest('.table-popup') && !e.target.closest('[title="Insert Table"]')) {
      closeTablePopup();
    }
  }
});

/* ===== SEED DATA ===== */
function getSeedData() {
  var seedSpecialties = [
    { id: 'seed_diabetes', name: 'Diabetes', sortOrder: 0 },
    { id: 'seed_others', name: 'Others', sortOrder: 1 },
    { id: 'seed_oncology', name: 'Oncology', sortOrder: 2 },
    { id: 'seed_cardiology', name: 'Cardiology', sortOrder: 3 },
    { id: 'seed_endocrinology', name: 'Endocrinology', sortOrder: 4 },
    { id: 'seed_gastroenterology', name: 'Gastroenterology', sortOrder: 5 },
    { id: 'seed_gynecology', name: 'Gynecology', sortOrder: 6 },
    { id: 'seed_haematology', name: 'Haematology', sortOrder: 7 },
    { id: 'seed_immunology', name: 'Immunology', sortOrder: 8 },
    { id: 'seed_neurology', name: 'Neurology', sortOrder: 9 },
    { id: 'seed_metabolism', name: 'Metabolism', sortOrder: 10 },
    { id: 'seed_orthopaedics', name: 'Orthopaedics', sortOrder: 11 },
    { id: 'seed_respiratory', name: 'Respiratory', sortOrder: 12 }
  ];
  var seedNotes = [
    {
      id: 'seed_t1dm',
      title: 'T1DM',
      category: 'Diabetes',
      keywords: ['T1DM', 'Type 1', 'Insulin', 'Carbohydrate exchange'],
      type: 'structured',
      sortOrder: 0,
      sections: [
        { title: 'Dietetic Assessment', content: '1. Insulin regimen: fixed / basal bolus\n2. Insulin unit:CHO ratio\n   - a. Individually recorded data\n     - Eat so that glycemic is satisfactory with baseline insulin requirement\n     - Divide carbs by pre-meal insulin\n   - b. 450 to 500 rule\n     - Regular ratio = 450/TDD\n     - Rapid-acting ratio = 500/TDD\n3. Check with H\'stix to see if coverage is ok' },
        { title: 'Dietetic Intervention', content: '1. Carbohydrates exchange\n2. Adjust insulin dose\n3. High fat/protein adjustment\n4. Alcohol with meal\n\n**Inpatient intervention**\n- If poor intake, supplement ideally at meals but not necessary\n- No need to adjust CHO in admission unless hypo' }
      ],
      content: '',
      createdAt: '2023-03-08T23:19:00',
      updatedAt: '2023-03-08T23:19:00'
    },
    {
      id: 'seed_t2dm',
      title: 'T2DM',
      category: 'Diabetes',
      keywords: ['T2DM', 'Type 2', 'A1c', 'SMBG'],
      type: 'structured',
      sortOrder: 1,
      sections: [
        { title: 'Clinical Presentations', content: '**Targets**\n- Normal: A1c < 7.0\n- Elderly with no comorbidities: A1c < 7.0-7.5\n- Elderly with comorbidities: A1c < 8.0 but no acute symptom\n\n**SMBG target:**\n- Fasting: 4.4-7.2 (ADA) or 4-6 (HA) mmol/dL\n- 2 hour postprandial: <10 mmol/dL (ADA)\n\n**Estimated average glucose (eAG)**\n\n| A1C (%) | mg/dL | mmol/L |\n|---------|-------|--------|\n| 5 | 97 (76-120) | 5.4 (4.2-6.7) |\n| 6 | 126 (100-152) | 7.0 (5.5-8.5) |\n| 7 | 154 (123-185) | 8.6 (6.8-10.3) |\n| 8 | 183 (147-217) | 10.2 (8.1-12.1) |\n| 9 | 212 (170-249) | 11.8 (9.4-13.9) |\n| 10 | 240 (193-282) | 13.4 (10.7-15.7) |\n| 11 | 269 (217-314) | 14.9 (12.0-17.5) |\n| 12 | 298 (240-347) | 16.5 (13.3-19.3) |' },
        { title: 'Dietetic Assessment', content: '1. BW trend\n2. HbA1c, fasting glucose, lipid, HT\n3. Use of DM medications\n4. SMBG\n5. Alcohol\n6. Carbohydrates consistency\n7. Sugary food and food intake\n8. Soup starchy ingredients\n9. Fruit & veg' },
        { title: 'Dietetic Intervention', content: '1. Regular meal pattern + consistent CHO intake\n   - 40-45% carbs\n   - 1.0-1.5g protein/kg/d\n2. Weight loss (5-15%)\n3. Reduce sugar intake\n4. Hypoglycemic management if needed\n5. Encourage SMBG\n6. Brittle DM: avoid hypo + look for private food' }
      ],
      content: '',
      createdAt: '2023-03-09T10:00:00',
      updatedAt: '2023-03-09T10:00:00'
    },
    {
      id: 'seed_gdm',
      title: 'GDM (Gestational Diabetes Mellitus)',
      category: 'Diabetes',
      keywords: ['GDM', 'Gestational', 'Pregnancy', 'OGTT'],
      type: 'structured',
      sortOrder: 2,
      sections: [
        { title: 'Pathophysiology', content: '- Glucose intolerance increased de novo in pregnancy as caused by\n  - Human placental growth hormone, leptin, TNF-alpha\n  - Increased level since 8th weeks and inhibit insulin signalling\n- Usually check in 24-28 weeks of pregnancy\n- Adverse effects:\n  - Macrosomia\n  - Neonatal hypoglycemia\n  - Shoulder dystocia\n  - Trauma during birth\n  - Induction of labour/C-section' },
        { title: 'Risk Factors', content: '1. Obesity\n2. Family history of DM\n3. Age > 25\n4. African, Asian, Latino\n5. Previous large for gestational age\n6. PCOS\n7. Pre-DM' },
        { title: 'Clinical Presentations', content: '**Diagnosis (NICE, 2015)**\n\n75g OGTT result:\n- Fasting: > 5.6 mmol/L\n- 2hr postprandial: > 7.8 mmol/L' },
        { title: 'Dietetic Assessment', content: '1. Pre-pregnancy weight\n2. A1c, RFT (not to use eGFR)\n3. Use of DM medications\n   - Metformin if FG >7 not improve with lifestyle change\n   - Insulin if not respond to metformin\n4. SMBG\n5. Alcohol\n6. Carbohydrates consistency\n7. Maternal formula' },
        { title: 'Dietetic Intervention', content: '1. Energy requirement:\n   - No change for 1st trimester\n   - +340kcal for 2nd trimester\n   - +452kcal for 3rd trimester\n   - +300kcal for twins\n2. Carbohydrates intake\n   - Consistent intake\n   - Aim ~40% energy requirement (min. 175g/d)\n   - DM 1800kcal (5/0/5+2F/1M+2/5+2F/1M+2)\n3. High fibre\n4. Reduce fat, especially saturated fat\n5. Weight reduction after delivery\n   - 5-10% in one year\n6. Monitor SMBG (NICE, 2015)\n   - Before meal: < 5.3 mmol/L\n   - 1hr postprandial: < 7.8 mmol/L\n   - 2hr postprandial: < 6.4 mmol/L' }
      ],
      content: '',
      createdAt: '2023-03-09T10:00:00',
      updatedAt: '2023-03-09T10:00:00'
    },
    {
      id: 'seed_dm_pregnancy',
      title: 'DM and Pregnancy',
      category: 'Diabetes',
      keywords: ['DM', 'Pregnancy', 'Insulin', 'Breastfeeding'],
      type: 'structured',
      sortOrder: 3,
      sections: [
        { title: 'Pathophysiology', content: '- Improved glycemia reduces the risk of miscarriage, congenital malformation and neonatal death\n  - Even with small improvement in A1c\n- Insulin resistance increase since 14-20 weeks:\n  - Increased glucose production by reducing insulin suppression on hepatic gluconeogenesis\n  - Reduced glucose uptake by muscle by reducing translocation of GLUT4 to surface' },
        { title: 'Dietetic Assessment', content: '**Pre-pregnancy**\n\n1. Glycemic control targets\n   - A1c <6\n2. Body weight\n   - BMI <27\n3. Alcohol intake\n4. Hypoglycemia management\n5. Food hygiene and safety\n6. Folate supplement (5mg/d)\n\n**Antenatal**\n\n1. Glycemic control targets\n   - Fasting/pre meal/nocturnal: 3.9-5.3\n   - 1hr-pp: 6.1-7.8mmol/L\n   - 2hr-pp: 5.6-6.7mmol/L\n   - CGM:\n     - Type 1: TIR: >70%\n     - Type 2: T/F, likely higher\n2. Folate supplement (400mg/d)\n3. Nausea and vomiting\n   - Hypoglycemia\n4. Fetal growth\n5. Planned delivery\n   - Meeting target w/o LGA: 39+0-6\n   - Not meeting target w/o LGA: 36-38+6\n   - Estimated fetal weight >4500g: planned CS' },
        { title: 'Dietetic Intervention', content: '**Antenatal**\n\n1. Hypoglycemia management\n   - Hypo if < 3.3 in pregnancy\n2. Insulin\n   - Requirement varies greatly during pregnancy\n   - Sensitivity peaks at 10-14 weeks\n   - Requirement increase by 2-3 folds after 20 weeks\n   - Plateau at 37 weeks\n   - Requirement will be very low for the first 24 hours postpartum\n     - Prone to hypoglycemia\n\n**Breastfeeding**\n\n3. Breastfeeding\n   - Good to reduce risk of obesity and T2DM in infants\n   - But may hypoglycemia during feeding\n   - Recommend to start breastfeed in first 30mins, continue every 2-3h to avoid hypo\n     - Infant H\'stix >2.0 before feeding\n   - Requires additional 60g/d carbohydrates' }
      ],
      content: '',
      createdAt: '2024-12-12T17:24:00',
      updatedAt: '2024-12-12T17:24:00'
    },
    {
      id: 'seed_dm_meds',
      title: 'DM Medications',
      category: 'Diabetes',
      keywords: ['Insulin', 'Diamicron', 'Medications'],
      type: 'structured',
      sortOrder: 4,
      sections: [
        { title: 'Medical Treatments', content: '**Insulin**\n\n| Name | Type | Onset | Peak | Duration |\n|------|------|-------|------|----------|\n| Actrapid | Short acting | 30 mins | 1.5-3.5 h | 7-8 h |\n| Degludec | Long acting | 1-2 h | Nil | >42 h |\n| Humulin N (Isophane) | Intermediate acting | 1 h | 4-10 h | 16-18 h |\n| Humulin R (Neutral) | Short acting | 30 mins | 2-4h | 6-8h |\n| Humulin 70/30 | Short + intermediate acting | 30 mins | 2-4 h + 4-10 h | 24 h |\n| Lantus (Glargine) | Long acting | 1 h | Nil | 24 h |\n| Humalog (Lispro) | Rapid acting | 15 mins | 1 h | 3.5-4.5 h |\n| Mixtard 30/70 | Short + intermediate acting | 30 mins | 2-4 h + 4-10 h | 24 h |\n| Novorapid (Aspart) | Rapid acting | 10-20 mins | 1-3 h | 3-5 h |\n| Protaphane (Isophane) | Intermediate acting | 1.5 h | 4-12 h | 24 h |\n| Ryzodeg 70/30 | Rapid + long acting | 14 mins | 72 mins | >40 h |\n\n**Oral medications**\n\n| Name | Onset | Peak |\n|------|-------|------|\n| Diamicron | Gradual | 4-6h |' },
        { title: 'Keywords', content: '#insulin, #diamicron' },
        { title: 'References', content: '1. https://www.novonordisk.com.au/content/dam/nncorp/au/en/pdfs/ryzodeg-productinformation-13.pdf\n2. https://www.msdmanuals.com/professional/multimedia/table/onset-peak-and-duration-ofaction-of-human-insulin-preparations\n3. https://www.mims.com/hongkong/drug/info/humulin-n-humulin-r/mechanism-of-action\n4. https://www.pcfhk.org/files/36319118.pdf' }
      ],
      content: '',
      createdAt: '2025-04-07T12:24:00',
      updatedAt: '2025-04-07T12:24:00'
    },
    {
      id: 'seed_dehydration',
      title: 'Dehydration',
      category: 'Others',
      keywords: ['Dehydration', 'Hydration', 'Fluid'],
      type: 'structured',
      sortOrder: 0,
      sections: [
        { title: 'Dietetic Assessment', content: '1. RFT\n2. Skin elasticity\n3. Urine colour (avoid transparent/dark yellow)\n4. Fever\n5. Craving for sweetness\n6. Headache that resolve with rehydration' },
        { title: 'Dietetic Intervention', content: '1. Adequate hydration (30-40ml/kg)\n2. Bring a water bottle\n3. Add flavour to water\n   - Fruit juice\n   - Frozen/Fresh chunk of fruit\n4. Sugar-free tea or coffee\n   - Caffeine < 400mg/d is ok\n5. Fresh vegetables and fruits\n6. Drink 30mins before meal\n   - Also good for weight loss\n   - Can drink throughout the meal' }
      ],
      content: '',
      createdAt: '2023-05-06T23:15:00',
      updatedAt: '2023-05-06T23:15:00'
    },
    {
      id: 'seed_sepsis',
      title: 'Sepsis',
      category: 'Others',
      keywords: ['Sepsis', 'Septic shock', 'SOFA', 'Infection'],
      type: 'structured',
      sortOrder: 1,
      sections: [
        { title: 'Pathophysiology', content: '- Organ dysfunction caused by a dysregulated host response to infection\n- Organ dysfunction defined by >=2 points in SOFA score\n- **Septic shock:**\n  - Sepsis with greater risk of mortality e.g.\n    - Require MAP >65mmHg with vasopressor and fluid resuscitation\n    - Lactate > 2mmol/L\n\n**Mechanism:**\n1. Infection of a sterile site by bacteria\n2. Detected by innate immune response (esp. macrophage)\n3. Initiate phagocytosis of bacteria and injured tissue\n4. These actions associate with proinflammatory cytokines and exceed the boundary of infected site\n5. Wide spread of cellular injury ultimately lead to organ failure\n6. Hypotension can be caused by vasodilation and increased capillary permeability or heart failure' },
        { title: 'Clinical Presentations', content: '- Hypotension\n- Tachycardia\n- Fever\n- Leukocytosis (high WBC)\n- Cyanosis\n- AKI\n- Altered mental status' }
      ],
      content: '',
      createdAt: '2023-06-19T23:56:00',
      updatedAt: '2023-06-19T23:56:00'
    },
    {
      id: 'seed_edema',
      title: 'Edema',
      category: 'Others',
      keywords: ['Edema', 'Oedema', 'Fluid overload'],
      type: 'structured',
      sortOrder: 2,
      sections: [
        { title: 'Pathophysiology', content: '1. Alteration in capillary hemodynamics favouring fluid move out to interstitial space\n2. Reduced tissue perfusion due to reduced plasma volume\n3. Increase renal retention of fluid and sodium as compensatory measure\n4. The increased fluid may retain in plasma but most will go to interstitial space due to altered capillary hemodynamics\n5. Apparent edema formed' },
        { title: 'Risk Factors', content: '**Acute bilateral edema**\n- DVT\n- Side effect from med e.g. Ca channel blocker, Hydralazine, Thiazolidinediones, Glucocorticoids, Tamoxifen, Testosterone\n- Acute heart failure\n- Acute nephrotic syndrome\n\n**Chronic bilateral edema**\n- Venous insufficiency\n- Heart failure (left: reduced ejection fraction, Right: pulmonary hypertension)\n- Renal disease\n- Liver cirrhosis\n- Sepsis\n- Na / fluid overload\n- Pregnancy' }
      ],
      content: '',
      createdAt: '2023-03-16T23:30:00',
      updatedAt: '2023-03-16T23:30:00'
    },
    {
      id: 'seed_tls',
      title: 'Tumor Lysis Syndrome',
      category: 'Oncology',
      keywords: ['TLS', 'Tumor lysis', 'Hyperkalemia', 'Uric acid', 'Oncology'],
      type: 'structured',
      sortOrder: 0,
      sections: [
        { title: 'Pathophysiology', content: '- Oncologic emergency that is caused by massive tumor cell lysis\n- Release of large amounts of potassium, phosphate, and uric acid into circulation\n- Deposition of uric acid and/or calcium phosphate crystals in the renal tubules -> AKI\n- Commonly found in high-grade lymphoma / acute lymphoblastic leukemia after cytotoxic treatment\n  - Fludarabine\n  - Rituximab\n  - Lenalidomide\n  - Venetoclax' },
        { title: 'Clinical Presentations', content: '1. Hyperkalemia\n2. Hyperphosphatemia\n3. Hypocalcemia\n4. Nausea\n5. Vomit\n6. Diarrhea\n7. Anorexia\n8. Lethargy\n9. Hematuria\n10. Heart failure\n11. Cardiac dysrhythmias\n12. Seizures\n13. Muscle cramps\n14. Tetany\n15. Syncope' },
        { title: 'Medical Treatments', content: '1. Correction of electrolyte abnormalities\n2. Allopurinol / raburicase / febuxostat to reduce uric acid\n3. RRT' }
      ],
      content: '',
      createdAt: '2023-09-29T23:13:00',
      updatedAt: '2023-09-29T23:13:00'
    },
    {
      id: 'seed_chf',
      title: 'Chronic Heart Failure CHF',
      category: 'Cardiology',
      keywords: ['CHF', 'Heart failure', 'Cardiac cachexia', 'Salt restriction', 'Fluid restriction'],
      type: 'structured',
      sortOrder: 0,
      sections: [
        { title: 'Pathophysiology', content: '- Reduction in ability to pump blood' },
        { title: 'Risk Factors', content: '- Coronary heart disease CHD\n- Valvular heart disease\n- Hypertension\n- Atrial fibrillation\n- Alcohol abuse' },
        { title: 'Clinical Presentations', content: '- Inadequate cardiac output\n- Fluid imbalance\n- Pulmonary and other edema\n- Dyspnea\n- Fatigue' },
        { title: 'Medical Treatments', content: '1. ACEi/ARBs (vasodilator)\n2. Beta-blockers (reduce contraction)\n3. Diuretics\n4. Warfarin (anticoagulation)\n5. Mechanical support cardiac resynchronisation therapy with pacemaker\n6. Heart transplant' },
        { title: 'Dietetic Intervention', content: '**1. Weight loss**\n- Gradual to prevent muscle loss\n- To reduce cardiac workload\n- Not routinely recommended for moderate to severe CHF\n  - Comfortable at rest but symptomatic in less than ordinary activity\n\n**2. Avoid malnutrition**\n- Not desired to increase fat store\n\n**3. Cardiac cachexia**\n- a. Dyspnea\n  - Fatigue to eat\n  - SOB when swallowing\n- b. Edema\n- c. Palatability\n  - Salt restriction\n  - Impaired taste by ACEi\n- d. Drug effect of anorexia\n  - Aspirin\n  - Digoxin\n  - ACEi\n- e. Metabolic disturbance\n  - Hyponatremia\n  - Renal failure\n- f. Depression\n\n**4. Salt restriction**\n- Is more relevant in advanced CHF\n- <2g/d is rarely necessary\n- Go for no added salt first\n- Avoid salt substitute as high in K\n  - Esp. for ACEi & aldactone\n\n**5. Fluid restriction**\n- No concrete guideline\n- Usually 1.5-2L/d\n- Aim weight gain <2kg in 3 days' }
      ],
      content: '',
      createdAt: '2023-08-07T22:43:00',
      updatedAt: '2023-08-07T22:43:00'
    },
    {
      id: 'seed_cardioprotective',
      title: 'Cardioprotective Diet',
      category: 'Cardiology',
      keywords: ['Cardioprotective', 'CVD', 'Omega 3', 'Saturated fat', 'Stanols', 'Sterols'],
      type: 'structured',
      sortOrder: 1,
      sections: [
        { title: 'Pathophysiology', content: '- First line diet to protect against the main CVDs\n- Can be used in primary or secondary prevention in conjunction with specific individual risk factors\n- Targeting on\n  - Reduced coronary arteries injury\n  - Reduced fibrous plaque\n  - Reduced occurrence of thrombosis\n- More effective if followed for >2 years' },
        { title: 'Dietetic Intervention', content: '**1. Saturated fat**\n- <7% of total energy\n- Remove fat and skin from meat\n- Avoid processed meat\n- Avoid deep-fried food\n- Replace butter/ghee/lard with vegetable oil\n- Choose low-fat dairy/soya\n- Fruits and nuts as snacks\n- Aim <1.5g/100g food on label\n\n**2. Trans-fat**\n- <2% of total energy\n- Source: bakery, cake, biscuit, pastries, convenience food\n- Avoid 220 degree Celsius for PUFA\n\n**3. Omega 3 fatty acids**\n- EPA & DHA\n- Anti-inflammatory + antithrombotic\n- Primary prevention\n  - 140g (3.5ex) white fish/week\n  - 140g (3.5ex) oily fish/week\n- Secondary prevention\n  - 280-560g (7-14ex) oily fish/wk\n\n**4. Salt**\n- <6g salt/d (or 2.4g sodium)\n- Use natural spice and herbs\n- Discourage to add salt in cooking/at table\n- Reduce processed food\n- Read label: <0.3g/100g\n\n**5. Stanols and sterols**\n- 1.5-2.4g/d intake for >2-3wks\n- Can lower >10% cholesterol\n- Not recommended for primary prevention in NICE2010\n\n**6. Fruits and vegetables**\n- 5 portions daily\n- No matter tinned/fresh/frozen\n\n**7. Nuts**\n- Best: almond, pecans, walnuts\n- 4 portions per week\n- Choose unsalted ones\n\n**8. Wholegrain**\n- Lower GI for DM or high TG\n\n**9. Soya protein**\n- 1-3 serving to replace meat & dairy\n- Reduce LDL and slight increase HDL\n\n**10. Folic acid, B6, B12**\n- Supplement did not appear to affect CVD events\n- Dietary folate intake >400ug/d' }
      ],
      content: '',
      createdAt: '2023-08-07T23:14:00',
      updatedAt: '2023-08-07T23:14:00'
    },
    {
      id: 'seed_af',
      title: 'AF Atrial Fibrillation',
      category: 'Cardiology',
      keywords: ['AF', 'Atrial fibrillation', 'Arrhythmia'],
      type: 'structured',
      sortOrder: 2,
      sections: [
        { title: 'Pathophysiology', content: '' },
        { title: 'Clinical Presentations', content: '' },
        { title: 'Medical Treatments', content: '' },
        { title: 'Dietetic Assessment', content: '' },
        { title: 'Dietetic Intervention', content: '' }
      ],
      content: '',
      createdAt: '2024-02-24T14:22:00',
      updatedAt: '2024-02-24T14:22:00'
    },
    {
      id: 'seed_chd',
      title: 'Coronary Heart Disease CHD',
      category: 'Cardiology',
      keywords: ['CHD', 'Coronary', 'Angina', 'STEMI', 'NSTEMI', 'CABG', 'PCI'],
      type: 'structured',
      sortOrder: 3,
      sections: [
        { title: 'Clinical Presentations', content: '**Types**\n1. Stable angina\n   - Pain is controlled except on exertion\n2. Sudden death\n3. Heart failure\n4. Acute coronary syndrome\n   - a. STEMI\n     - Lumen of artery blocked by thrombus\n     - Death of cardiac muscle\n   - b. NSTEMI\n     - Lumen of artery narrowed by thrombus or blocked temporarily\n     - Evidenced by troponin increase\n   - c. Unstable angina\n     - Chest pain frequently with little or no exertion' },
        { title: 'Medical Treatments', content: '**Medical**\n1. Antiplatelet\n2. Statins\n3. Beta-blockers\n   - Reduce force and speed of contraction\n4. ACEi\n   - Vasodilator\n\n**Surgical**\n1. Angioplasty - PCI\n2. CABG coronary artery bypass graft\n   - Weight reduction after wound healed (>6 weeks)' },
        { title: 'Dietetic Intervention', content: '1. Cardioprotective diet\n2. Omega 3 fatty acid 1g/d\n   - Up to 4 years post MI\n   - Not to routinely given for MI >3 months earlier\n   - Inhibit thromboxane A2 synthesis to suppress platelet activation\n3. Reduce total fat intake\n   - To reduce postprandial activation of Factor VII (suppress fibrinolysis)\n4. Non-rapid weight loss\n   - Improves fibrinolysis\n   - After CABG wound healed (6wks)\n5. Fruits and vegetables\n   - Reduce oxidative stress\n   - Reduce endothelial damage' }
      ],
      content: '',
      createdAt: '2023-03-09T09:59:00',
      updatedAt: '2023-03-09T09:59:00'
    },
    {
      id: 'seed_postprandial',
      title: 'Postprandial Syndrome',
      category: 'Endocrinology',
      keywords: ['Postprandial', 'Postmeal hypo', 'Non DM hypoglycemia'],
      type: 'structured',
      sortOrder: 0,
      sections: [
        { title: 'Pathophysiology', content: '- Postprandial symptoms suggestive of hypoglycemia but **without concurrent biochemical evidence** of hypoglycemia\n- Usually after ingestion of high carbohydrates\n- Usually resolved with dietary modification' },
        { title: 'Clinical Presentations', content: 'All hypoglycemia signs and symptoms\n\nShould not fit with Whipple\'s triad:\n1. Hypoglycemia symptoms\n2. Low plasma glucose\n3. Relief of symptoms when glucose level is raised' },
        { title: 'Medical Treatments', content: 'Usually treat with dietary modification first\n\nIf symptoms does not improve, may try alpha-glucosidase inhibitor to:\n- Delay carbs digestion and absorption\n- Reduce meal-induced insulin response' },
        { title: 'Dietetic Assessment', content: '1. Time pattern of symptoms occurrence\n2. Frequency of meal\n3. Carbs intake per meal\n4. Veg and protein intake at meal' },
        { title: 'Dietetic Intervention', content: '*Not much research evidence but relied on clinical exp*\n\n1. Small and frequent meal (every 3 hours)\n2. Incorporate high fibre food\n3. Lower glycemic index food\n4. Reduce simple sugar intake' }
      ],
      content: '',
      createdAt: '2025-04-01T18:22:00',
      updatedAt: '2025-04-01T18:22:00'
    },
    {
      id: 'seed_cerebral_salt',
      title: 'Cerebral Salt Wasting',
      category: 'Endocrinology',
      keywords: ['CSW', 'Cerebral salt wasting', 'HypoNa', 'Hyponatremia', 'SAH'],
      type: 'structured',
      sortOrder: 1,
      sections: [
        { title: 'Pathophysiology', content: '1. Acute disease in CNS like SAH\n2. Release of brain natriuretic peptide and/or diminished central sympathetic activity\n3. Impaired sodium reabsorption\n4. Leading to sodium wasting in urine\n5. Leading to hypoNa and ECF depletion\n6. Increase neurological injury' },
        { title: 'Clinical Presentations', content: '1. HypoNa\n2. Low plasma osmolality\n3. Elevated urine osmolality (>100-300 mosmol/kg)\n4. Urine Na > 40 mEq/L\n5. Low serum urate\n\n**To differentiate with SIADH**\n1. *Evidence of ECF depletion*\n   - a. Decreased skin turgor\n   - b. Hypotension\n   - c. +/- Increased hematocrits\n2. *Volume repletion lead to diluted urine*' },
        { title: 'Medical Treatments', content: 'Hypertonic saline 3% to correct hypoNa and volume depletion' }
      ],
      content: '',
      createdAt: '2023-07-09T22:47:00',
      updatedAt: '2023-07-09T22:47:00'
    },
    {
      id: 'seed_siadh',
      title: 'SIADH',
      category: 'Endocrinology',
      keywords: ['SIADH', 'ADH', 'Hyponatremia', 'Fluid restriction'],
      type: 'structured',
      sortOrder: 2,
      sections: [
        { title: 'Pathophysiology', content: '**Syndrome of Inappropriate Secretion of Anti-diuretic Hormone**\n\n- Inability to suppress ADH secretion\n- Leading to reduced urine production\n- When water intake exceeds output\n- Increased TBW will expend ECF and cause increased urinary sodium excretion\n- Hyponatremia\n\n**Subtypes**\n1. Type A: grossly elevated levels of ADH unresponsive to osmotic deviations, common in cancer\n2. Type B: abnormally low osmotic threshold for ADH release\n3. Type C: ADH levels that are persistently in the physiologic range without changes\n4. Type D: normal osmoregulation but the urine is concentrated even if ADH release is suppressed\n5. Type E: decline in plasma ADH as the serum sodium concentration increases during infusion of hypertonic saline' },
        { title: 'Clinical Presentations', content: '- Hyponatremia <135 mEq/L\n- Low serum osmolality <280 mosmol/kg\n- Urine osmolality above 100 mosmol/kg\n- Urine sodium is usually above 40 mEq/L\n- Normal serum K and eGFR>=15\n- Normal am cortisol, TSH\n- No edema\n- Normal acid base balance\n- Low serum uric acid\n\n**Adrenal insufficiency vs SIADH**\n\n| Parameter | Primary Adrenal Insufficiency | SIADH |\n|-----------|-------------------------------|-------|\n| Volume status | Usually hypovolemia | Euvolemia |\n| Serum potassium | Hyperkalemia in significant proportion | Normal |\n| Serum uric acid | Normal or even increased | <4 mg/dl (due to volume expansion) |\n| FE of uric acid | <12% | >12% |\n| Serum urea | Normal or increased | Normal or decreased |\n| FE of urea | <55% | >55% |\n| Arterial blood gases | Metabolic acidosis (plus hyperkalemia) | Within normal limits |\n| Urine ketones | Presence | Absence |' },
        { title: 'Risk Factors', content: '**Etiology**\n1. CNS disturbance\n   - Stroke, haemorrhage, infection\n   - Trauma, psychosis\n2. Malignancy\n   - Esp. small cell carcinoma of lung\n3. Drug\n   - SSRI, carbamazepine\n   - NSAID, PPI\n   - Anti-cancer drug\n4. Surgery\n   - Pain afferent\n   - Damage to pituitary gland\n5. Lung disease\n   - Common: pneumonia\n   - Less common: asthma\n6. Hormone\n   - Hypothyroidism\n   - Hypopituitarism\n   - Vasopressin, desmopressin\n7. HIV infection\n8. Genetics' },
        { title: 'Medical Treatments', content: '*(Rate of correction 4-6 in first 2-4hrs, <8/d)*\n\n1. Treat underlying disease\n   - Infection\n   - Hormone replacement\n   - Cessation of related drugs\n2. Fluid restriction\n   - Not suitable for SAH\n3. IV hypertonic saline\n4. High salt intake (usually by NaCl tab)\n5. Adequate protein intake' }
      ],
      content: '',
      createdAt: '2023-07-09T21:40:00',
      updatedAt: '2023-07-09T21:40:00'
    },
    {
      id: 'seed_milk_alkali',
      title: 'Milk-Alkali Syndrome',
      category: 'Endocrinology',
      keywords: ['Milk-alkali', 'Hypercalcemia', 'Metabolic alkalosis'],
      type: 'structured',
      sortOrder: 3,
      sections: [
        { title: 'Pathophysiology', content: '1. Hypercalcemia (any causes)\n2. Vessel restriction in kidney\n3. Reduced GFR and activate Ca sensor\n4. Natriuresis + volume depletion\n5. Metabolic alkalosis if eat more alkali' },
        { title: 'Clinical Presentations', content: '- Asymptomatic\n- Acute hypercalcemia\n  - N&V\n  - Altered sense\n  - Pruritus' }
      ],
      content: '',
      createdAt: '2023-03-19T14:17:00',
      updatedAt: '2023-03-19T14:17:00'
    },
    {
      id: 'seed_adrenal',
      title: 'Adrenal Insufficiency',
      category: 'Endocrinology',
      keywords: ['Adrenal', 'Cortisol', 'Addison', 'Hypotension', 'Hyperkalemia'],
      type: 'structured',
      sortOrder: 4,
      sections: [
        { title: 'Pathophysiology', content: 'Presence of serum antibodies against the steroidogenic enzymes, mostly P450c21 (CYP21A2, 21-hydroxylase) and less frequently P450scc (CYP11A1, side-chain cleavage enzyme) and P450c17 (CYP17, 17-alpha-hydroxylase).' },
        { title: 'Clinical Presentations', content: '**Acute**\n- Dehydration, hypotension, or shock out of proportion to severity of current illness\n- Nausea and vomiting with a history of weight loss and anorexia\n- Abdominal pain, so-called "acute abdomen"\n- Unexplained hypoglycemia\n- Unexplained fever\n- Hyponatremia, hyperkalemia, azotemia, hypercalcemia, or eosinophilia\n- Hyperpigmentation or vitiligo\n- Other autoimmune endocrine deficiencies, such as hypothyroidism or gonadal failure\n\n**Chronic**\n\n| Symptom | Frequency (%) |\n|---------|---------------|\n| Weakness, tiredness, fatigue | 100 |\n| Anorexia | 100 |\n| Gastrointestinal symptoms | 92 |\n| Nausea | 86 |\n| Vomiting | 75 |\n| Constipation | 33 |\n| Abdominal pain | 31 |\n| Diarrhea | 16 |\n| Salt craving | 16 |\n| Postural dizziness | 12 |\n| Muscle or joint pains | 6 to 13 |\n\n| Sign | Frequency (%) |\n|------|---------------|\n| Weight loss | 100 |\n| Hyperpigmentation | 94 |\n| Hypotension (systolic BP <110 mmHg) | 88 to 94 |\n| Vitiligo | 10 to 20 |\n| Auricular calcification | 5 |\n\n| Laboratory abnormality | Frequency (%) |\n|------------------------|---------------|\n| Electrolyte disturbances | 92 |\n| Hyponatremia | 88 |\n| Hyperkalemia | 64 |\n| Hypercalcemia | 6 |\n| Azotemia | 55 |\n| Anemia | 40 |\n| Eosinophilia | 17 |' },
        { title: 'Medical Treatments', content: '**Diagnosis**\n1. Spot cortisol <18mcg/dL or <500nmol/L\n\n**Treatment**\n1. Cortisol replacement\n2. Treat hypotension\n3. Reverse electrolyte imbalance' }
      ],
      content: '',
      createdAt: '2023-07-10T21:11:00',
      updatedAt: '2023-07-10T21:11:00'
    },
    {
      id: 'seed_hypoglycemia',
      title: 'Hypoglycemia Encephalopathy',
      category: 'Endocrinology',
      keywords: ['Hypoglycemia', 'Hypo', 'Encephalopathy', 'Brain injury'],
      type: 'structured',
      sortOrder: 5,
      sections: [
        { title: 'Pathophysiology', content: '- Occurs when brain utilize TCA cycle substrates > glucose for energy\n- Glutamine and glutamate are particularly used, but deplete quickly\n- Neurotransmitter made from glucose oxidation product also depletes -> neurotransmission failure\n- Severe and prolonged hypoglycemia\n  -> Increased release of glutamate in the brain\n  -> membrane depolarization -> cell death' },
        { title: 'Clinical Presentations', content: '**Mild**\n- Sweating\n- Tachycardia\n- Anxiety\n- Hunger\n\n**Severe**\n- Confusion\n- Lethargy\n- Delirium\n- Coma\n- Seizure\n\n**Prolonged**\n- Brain injury' },
        { title: 'Dietetic Assessment', content: '1. Cause of hypoglycemia\n   - a. DM related\n   - b. Non-DM med (e.g beta blocker, ACEi)\n   - c. Alcohol binge for few days + limited food\n     - Inhibits gluconeogenesis\n   - d. Kidney impairment\n     - Reduced renal gluconeogenesis\n     - Reduced insulin clearance\n   - e. Severe liver disease\n     - Reduced gluconeogenesis\n   - f. Septic shock with glycogen depleted\n   - g. Malnutrition e.g anorexia nervosa\n   - h. Addison disease with cortisol deficiency\n   - i. Adrenal insufficiency\n   - j. Malignancy\n     - Increased IGF-1 by tumor growth\n   - k. Dumping syndrome\n   - l. Endogenous insulin production\n   - m. Autoimmune\n     - Antibodies binding to insulin and lead to increased insulin production\n     - Complex will dissociate in unregulated manner\n     - Leading to hyperinsulinaemia\n2. Exclude postprandial syndrome\n   - See other tab' },
        { title: 'Dietetic Intervention', content: '1. Hypoglycemia management\n   - 15:15 rules\n2. Small and frequent meals' }
      ],
      content: '',
      createdAt: '2025-04-01T13:57:00',
      updatedAt: '2025-04-01T13:57:00'
    },
    {
      id: 'seed_graves',
      title: 'Graves\' Disease (Hyperthyroidism)',
      category: 'Endocrinology',
      keywords: ['Graves', 'Hyperthyroidism', 'T4', 'TPP', 'Thyroid', 'TRAb'],
      type: 'structured',
      sortOrder: 6,
      sections: [
        { title: 'Pathophysiology', content: '- T cells activated by the autoantigen of TSH receptor (TSHR)\n- Activated T cell stimulate B cell to produce autoantibody to the TSH receptor (TRAb)\n- TRAb activated TSHR, thereby stimulating:\n  - Thyroid hormone synthesis\n  - Thyroid hormone secretion\n  - Thyroid growth' },
        { title: 'Clinical Presentations', content: '1. Goiter\n2. Thyroid eye disease\n3. Weight loss or failure to gain weight\n4. Tachycardia and increased cardiac output\n5. Lid lag and stare\n6. Increased GI motility\n7. Proximal muscle weakness, tremor, hyperreflexia\n8. Sleep disturbance, distractibility, and emotional lability\n9. Thyrotoxic Periodic Paralysis (TPP)\n   - a. Caused by: hypokalemia due to increased Na-K-ATPase in muscle with synergistic effects of T4 and increased beta adrenergic sensitivity\n   - b. Precipitated by:\n     - Hyperinsulinemia (increased ATPase)\n     - High salt diet (increased Na)\n     - Testosterone (increased muscle:body ratio)' },
        { title: 'Medical Treatments', content: '1. Carbimazole\n2. Radioactive iodine (RAI)\n3. Partial thyroidectomy' },
        { title: 'Dietetic Assessment', content: '1. Body weight history, look for weight gain after Tx\n2. Thyroid profile including immunoglobulin\n   - a. Increased T3, T4\n   - b. Decreased TSH\n   - c. Thyroid stimulating immunoglobulin (TSI, represents TRAb) usually positive\n3. Episode of TPP\n4. Hyperphagia tendency' },
        { title: 'Dietetic Intervention', content: '**1. Weight management**\n- Avoid overeating â€” Usually hyperphagia with increased energy expenditure and malabsorption caused by increased GI motility leading to no weight gain or even loss\n- Low caloric density choices\n\n**2. TPP management**\n- Avoid high carbohydrates diet\n  - No definite range\n  - ? Use lower end of ADMR (45-65%)\n- Reduce salt intake\n\n**3. Low Iodine diet is not necessary prior to RAI therapy (UpToDate)**\n- Just avoid high dose iodine supplement\n- Limited evidence with no RAI therapy' }
      ],
      content: '',
      createdAt: '2025-04-01T07:53:00',
      updatedAt: '2025-04-01T07:53:00'
    },
    /* ===== GASTROENTEROLOGY ===== */
    {
      id: 'seed_gi_pei',
      title: 'Pancreatic Exocrine Insufficiency',
      category: 'Gastroenterology',
      keywords: ['pancreatic enzyme replacement', 'Creon', 'PERT', 'steatorrhea'],
      type: 'structured',
      sortOrder: 0,
      sections: [
        { title: 'Causes', content: '- Pancreatic Cancer\n- Acute/Chronic pancreatitis\n- Cystic fibrosis' },
        { title: 'Symptoms', content: '- Steatorrhea\n  - Pale, loose, floating stool\n- Maldigestion\n- Malabsorption\n  - Vitamin ADEK\n  - Mg, Ca, Zn, Folate\n- Failure to thrive\n- Weight loss\n- Muscle loss\n- Osteoporosis' },
        { title: 'Assessment', content: '- Blood sugar level\n- Iron profile\n- Blood test for fat-soluble vitamin\n- Surgery (Ripple procedure)\n  - Symptoms can be delayed\n  - May be triggered by chemotherapy\n- Check for food avoidance\n  - Low fat diet\n  - Fibre intake\n- Symptoms associated with meal?\n  - If within 20mins then maybe fat related' },
        { title: 'Treatment', content: '**Pancreatic enzyme replacement therapy (PERT)**\n- Explain the actions\n- Take Creon with the first bite of meal\n- Action time only 20 minutes, may need extra tab if eat longer\n- Main meals: 25000/35000 IU; Snack: 10000 IU\n- No need Creon for carbs only\n- No more than 24 capsules a day\n- Not to take with hot drinks\n\n**Liberalize diet**\n- Avoid low fat\n- Helps to eat out' }
      ],
      content: '',
      createdAt: '2023-04-06T17:23:00',
      updatedAt: '2023-04-06T17:23:00'
    },
    {
      id: 'seed_gi_fodmap',
      title: 'Low FODMAP Diet',
      category: 'Gastroenterology',
      keywords: ['FODMAP', 'IBS', 'elimination', 'fructans', 'lactose', 'polyols'],
      type: 'structured',
      sortOrder: 1,
      sections: [
        { title: 'Keypoints', content: '- Consists of 3 stages:\n  - Elimination\n  - Reintroduction\n  - Personalization\n- Clinical response of 50-80% in IBS patients' },
        { title: 'Mechanism of Different FODMAPs', content: '**1. Fructans**\n- Few fructose with a glucose end\n- Cannot digest B2-1 bond\n- Readily fermented by bacteria\n- Sources: Wheat; Added into cereals, ice cream for prebiotics, fibre, sweet non-caloric, fat substitute\n\n**2. Galacto-oligosaccharide (GOS)**\n- Few galactose with sucrose end\n- Includes raffinose, stachyose, verbascose\n- Cannot digest â€” No a-galactosidase\n- Sources: Pulses, breastmilk/infant formula, lactose free products, prebiotics\n\n**3. Lactose**\n- Lactase deficiency leads to malabsorption\n  - Primary: 70% world, 90% Asian\n  - Secondary: GE, Coeliac Disease\n- Osmotic pull -> draws water to lumen\n- Fermented by gut bacteria\n- Sources: Dairy products, bulking agents, increases browning in baking goods\n\n**4. Fructose**\n- Mainly absorbed via GLUT5 on apical surface\n- Coingestion of glucose enhance absorption via GLUT-2 with 1:1 ratio\n- Sources: Fruits, honey, sweetener (HFCS, fruit concentrate)\n\n**5. Polyols**\n- Sugar alcohols: sorbitol, mannitol, xylitol, erythritol, maltitol, isomalt, lactitol\n- Only absorbed by passive diffusion (affected by gut transit time)\n- Sources: Plums, pears, blackberries; Cauliflower, mushroom; Sweetener in chewing gums; Laxative with sorbitol; Bulking agent' },
        { title: 'Definition of High FODMAP', content: '- Not clearly defined\n- Fructans: >0.2g/portion\n- Lactose: >4g/portion\n- Fructose: >0.5g in excess of glucose per 100g\n- Polyols: >0.3g/portion' },
        { title: 'Stage 1 - Elimination (4-8 weeks)', content: '1. Assess diet for high FODMAP choices\n   - Vegetables, Fruits, Starch, Lactose, Seasonings with garlic and onion, Fructose drinks, Polyol chewing gums, Nuts, Supplement\n2. Explain mechanism of FODMAP in the GI tract\n3. Identify food sources of each FODMAP\n4. Provide alternative for each food group\n5. **Starch:** Rice-based, Potato, Quinoa\n6. **Vegetables & fruits:** Spread out whole day, different food; Vegetables: 3 serves; Fruit: 2 serves\n7. **Nuts & seeds:** Almond and hazelnut need <10pcs; Others are fine\n8. **Dairy:** Almond/hazelnut/macadamia milk; Dairy: lactose <4g/portion\n9. **Drinks:** Green tea, water; NO coconut water, oolong/chai, juice\n10. **Seasonings:** Avoid garlic, onion; Acceptable: Garlic infused oil; 2tbsp: oyster sauce, miso, fish sauce, lemon/lime; 1tbsp: Tamarind paste, all vinegars; Green onion, peanut butter; Baking powder, corn flour, cream of tartar\n11. **Sweetener:** Jam, golden syrup, maple syrup\n12. Look food label\n13. **Eat-out:** Sauces on the side\n14. **Vegetarian protein:** Tofu, tempeh, mycoprotein; Pea protein, spirulina' },
        { title: 'Stage 2 - Reintroduction (6-10 weeks)', content: '1. Explained the purpose of reintroduction\n   - Expand food variety\n   - Test for tolerance of each FODMAP\n   - Achieve optimal health e.g. gut\n2. KEEP low FODMAP diet except challenging food\n3. Test one food for each FODMAP except fructans\n   - Start with 1/3 portion of usual intake\n   - Step up in 3 days\n   - Stop eating if symptom occurs\n   - Record the severity of symptoms\n   - Allow 3 days of washout period between each test\n4. Common choices of challenging food: Lactose, Fructose, Sorbitol, Mannitol, GOS, Fructan (Blueberries)\n5. No need to challenge each group continuously, allow holiday\n6. Avoid eatout during the 3-days challenge\n7. Keep daily caffeine and alcohol intake consistent' },
        { title: 'Stage 3 - Personalization', content: '1. Identify the symptom-triggering FODMAP and tolerance\n2. Promote food variety\n3. Try to include one high FODMAP food at one meal\n4. Avoid frequently eating high FODMAP food\n5. Include problem food as part of a meal\n6. Eating problem food with symptoms occur will not damage gut -> okay to eat' },
        { title: 'Long Term Consideration', content: '1. **Calcium** â€” Supplement and dairy alternatives\n2. Iron and carbs intake are marginally reduced only\n3. Lower protein and fat intake in IBD patient\n4. Fibre intake is usually similar, not contributing to the effect of low FODMAP diet\n\n**Response predictor**\n- VOC of feces â€” Significant difference' }
      ],
      content: '',
      createdAt: '2023-07-25T23:38:00',
      updatedAt: '2023-07-25T23:38:00'
    },
    {
      id: 'seed_gi_ibs',
      title: 'Irritable Bowel Syndrome',
      category: 'Gastroenterology',
      keywords: ['IBS', 'FODMAP', 'IBS-D', 'IBS-C', 'probiotics'],
      type: 'structured',
      sortOrder: 2,
      sections: [
        { title: 'Nature', content: '- Chronic recurring abdominal pain or discomfort associated with disturbed bowel habit in the presence or absence of organic cause\n- Discomfort should be relieved by defaecation\n- Subtypes:\n  - IBS-D (>=25% type 6-7)\n  - IBS-C (>=25% type 1-2)\n  - IBS-M (>50% type 3-5)\n  - IBS-U\n- Pathogenesis related to biological + psychological\n  - Higher sensitivity to stress in all forms' },
        { title: 'Assessment', content: '**1. Red Flags**\n- Unintentional/unexplainable weight loss\n- Rectal bleeding/Anemia\n- Family Hx of bowel/ovarian cancer\n- Age of onset >50\n- Persistent daily diarrhea\n- Recurrent vomiting\n- Nocturnal BO\n- Progressive symptoms\n- Fever\n\n**2. Clinical**\n- Types of symptoms: Major symptom? Symptom changed or stable\n- FGD Symptom questionnaire KCL\n\n**3. Dietary**\n- Any food allergy or atopy\n- Meal pattern and duration\n- **Fibre:** Affect microbiota (Direct interaction e.g. Bifidobacteria reduce pain; Beneficial metabolites; Increase biomass 60%); Improve transit time (Absorb fluid for IBS-D; Mechanical stimulation); SCFA (Luminal pH; Intestinal mucosa); Gas production\n- Fluid intake\n- **Alcohol:** Delayed gastric emptying; Loosen esophageal sphincter; Reduced mixing enzyme; Mucosal inflammation; Intestinal permeability\n- **Caffeine:** Increase stress hormone; Stimulate gut mobility -> may cause pain; Increase gastric secretion\n- **Dairy:** Lactose intolerance; Casein protein A1 & A2 (A1 breaks down to BCM-7, cause abdominal pain)\n- **Spicy food:** More TRPV-1 upregulation; Leading to higher sensitivity; Cross/isolated effects with FODMAP and Fat\n- **Fatty food:** Delay mobility + increase distention\n- Any suspected food triggers\n\n**4. Social** â€” Stressor, Work, Cooking skills, Eatout frequency, Exercise\n\n**5. Suitability** â€” Eating disorder, Malnutrition, Symptoms not suspected to be triggered by diet\n\n**6. Gut microbiome**\n- Activated immune function (More mast cells and lymphocytes)\n- Different composition (Lower microbial richness; Lower methane exhaled; More Bacteroides enterotype)\n- Could be induced with post-infection\n- Gut fermentation (Maybe producing gas more and faster; Or simply higher sensitivity)' },
        { title: 'Medical Treatment', content: '**Diarrhea:** Loperamide, Cholestyramine\n**Constipation:** Magnesium hydroxide, Polyethylene glycol (PEG), Psyllium husk\n**Pain:** Antispasmodics, Tricyclic antidepressant (TCAs), SSRIs\n**Bloating:** Simethicone, Charcoal' },
        { title: 'First Line Treatment', content: '1. **Eating style**\n   - Regular meal time (More frequent for IBS-D; More fasting for IBS-C)\n   - Chew food thoroughly\n   - Avoid late night eating\n2. **Adequate fluid** (35ml/kg) â€” No caffeine (esp. anxiety); No alcohol (if s/s after alcohol); No fizzy drink; No juice\n3. Less spicy food esp. abdominal distention and pain\n4. **Low fat diet** â€” Impairs gas transit + increased distention\n5. **Lactose-free diet** â€” Challenge with 125-250ml milk first; Usually can tolerate some ~50ml\n6. **Fibre**\n   - Psyllium for IBS-D: 6-12g splitted into 2 doses daily, 4 weeks\n   - Ground flaxseed for IBS-C: Start with 1-3tsp; 24g or 2 tbsp ground daily; Taken with fluid 150ml/tbsp; For 6 months\n7. Exercise and coping strategy' },
        { title: 'Second Line Treatment', content: '**1. Probiotics after restrictive diets**\n- Minimum 4 weeks trial; Try one strain each time\n- Dose: 10^8 is better â€” Easier to disperse\n- Aware of inulin, FOS, oligo-fructose\n- **Global:** Lactobacillus plantarum 299v (1x10^9-2x10^10); Streptococcus faecium (6.4x10^7)\n- **Abdominal pain:** Saccharomyces cerevisiae (4x10^9); L. plantarum 299v; S. faecium\n- **Bloating:** L. plantarum 299v (1x10^9); Bifidobacterium infantis 35624 (1x10^8, marginal benefit)\n- **Flatulence:** L. plantarum 299v (2x10^10); B. infantis 35624 (1x10^8, marginal benefit)\n- **Miscellaneous:** B. lactis DN-173010, B. longum, B. bifidum, B. lactis, L. acidophilus, L. rhamnosus, S. thermophilus\n\n**2. Prebiotics** â€” No significant benefits on top of low FODMAP diet; If eager to try: Beta-GOS 1.4g/d; <6g/d non-inulin fructan for flatulence; Better to take tolerable FODMAP for gut microbiome\n\n**3. Low FODMAP diet** (see another page)\n\n**4. Use of enzyme**\n- Lactase\n- Galactosidase (But will affect DM med; Not tested in child, pregnancy)\n- Xylose isomerase (Convert fructose to glucose; weak evidence)\n- FODMAP enzyme mixture (Quatrase Forte; ~$10 for 1 tablet, need 1-3tabs/meal; No evidence; Maybe useful for: frequent eatout, vegetarian/vegan, GOS sensitive patient)' }
      ],
      content: '',
      createdAt: '2023-03-09T23:28:00',
      updatedAt: '2023-03-09T23:28:00'
    },
    {
      id: 'seed_gi_gb_dyskinesia',
      title: 'Gallbladder Dyskinesia',
      category: 'Gastroenterology',
      keywords: ['gallstone', 'gallbladder dyskinesia', 'biliary'],
      type: 'structured',
      sortOrder: 3,
      sections: [
        { title: 'Definition', content: '- Impaired gallbladder emptying\n- Increase risk of cholesterol supersaturated bile and microlithiasis\n- May lead to gallbladder inflammation' },
        { title: 'Symptoms and Signs', content: '- Episodic biliary pain (RUQ)\n- Associated with eating\n- Bloated stomach\n- Nausea and vomiting\n- Abnormal loss of weight' },
        { title: 'Assessment', content: '1. Weight history\n2. Eating pattern\n3. Fibre\n4. Fat\n5. Alcohol' },
        { title: 'Intervention', content: '*Minimize risk of stone formation*\n- Healthy weight with rate of loss <1.5kg/week\n- Regular food intake\n- Minimize intake of refined carbs, saturated fat and trans fat\n- Increase fibre intake\n- Avoid alcohol' }
      ],
      content: '',
      createdAt: '2023-03-09T07:25:00',
      updatedAt: '2023-03-09T07:25:00'
    },
    {
      id: 'seed_gi_func_constipation',
      title: 'Functional Constipation',
      category: 'Gastroenterology',
      keywords: ['constipation', 'fibre', 'linseed', 'FODMAP'],
      type: 'structured',
      sortOrder: 4,
      sections: [
        { title: 'Diagnosis', content: 'Meeting at least two of the following for more than 25% of defecation:\n1. Straining\n2. Stool chart type 1-2\n3. Sensation of incomplete evacuation\n4. Sensation of anorectal obstruction / blockage\n5. Requiring manual maneuver (e.g. digital evacuation, support of pelvic floor)\n6. BO < 3 per week' },
        { title: 'Assessment', content: '1. BO frequency\n2. Any other abdominal symptoms\n3. Previous medication and treatment\n4. Effect of stress on symptoms\n5. Fibre intake\n6. Fluid intake\n7. Meal pattern\n8. Any trigger food / relieving food\n9. Physical activity (how much? Sedentary?)' },
        { title: 'Intervention', content: '1. **Increase fibre intake if baseline is inadequate**\n   - Kiwi\n   - Oat\n   - Linseed (Start with 1-3tsp, aim 2tbsp/d, + 300ml fluid/d)\n     - Ground or whole are both good\n   - Prunes (contains sorbitol -> may increase gas problem)\n2. If other abdominal symptoms are severe, may consider low FODMAP\n3. Increase fluid if dehydration' }
      ],
      content: '',
      createdAt: '2024-10-30T16:48:00',
      updatedAt: '2024-10-30T16:48:00'
    },
    {
      id: 'seed_gi_htg_pancreatitis',
      title: 'Hypertriglyceridemia-induced Acute Pancreatitis',
      category: 'Gastroenterology',
      keywords: ['hypertriglyceridemia', 'pancreatitis', 'TG', 'lipotoxicity'],
      type: 'structured',
      sortOrder: 5,
      sections: [
        { title: 'Introduction', content: '- Breakdown of triglyceride by pancreatic lipase will create toxic fatty acid\n- Causing lipotoxicity\n- Severity of pancreatitis correlate with elevation of TG\n- Common factors:\n  - Familial\n  - Poor DM control (low insulin -> lipolysis)\n  - Hormone supplement and other meds\n  - Pregnancy (unlikely)\n  - Alcohol' },
        { title: 'Assessment', content: '- TG level\n  - 5% risk: TG >11.2 mmol/L\n  - 10-20% risk: TG >22.6 mmol/L\n- Lipase > 3 times of normal range\n- Abdominal pain\n- Nausea and vomiting\n- Eruptive xanthoma over extensor of limbs, buttock and back' },
        { title: 'Dietary Intervention', content: '- Severe fat intake restriction\n  - <5% of calorie requirement\n  - Until TG <11.3 mmol/L' }
      ],
      content: '',
      createdAt: '2024-08-15T17:18:00',
      updatedAt: '2024-08-15T17:18:00'
    },
    {
      id: 'seed_gi_gastroparesis',
      title: 'Gastroparesis',
      category: 'Gastroenterology',
      keywords: ['gastroparesis', 'early satiety', 'regurgitation', 'delayed gastric emptying'],
      type: 'structured',
      sortOrder: 6,
      sections: [
        { title: 'Definition', content: '- Delayed gastric emptying w/o obstruction\n- Caused by loss of gastric pacemaker cell (interstitial cell of Cajal)\n- Caused by disruption of vagus nerve\n- Leading to abnormal gastric motility' },
        { title: 'Symptoms and Signs (usually occur >1hr PP)', content: '1. Nausea and vomiting\n2. Early satiety / postprandial fullness\n3. Abdominal pain\n4. Bloating\n5. Weight loss' },
        { title: 'Assessment', content: '1. Weight loss\n2. Lab (RFT, A1c, Hb, Fe, Folate, B12)\n3. Texture of food tolerated\n4. Timing of eating vs symptom pattern\n5. Content and size of food\n6. Mineral / vitamin deficiency\n7. Glycaemic control (DM is risk factor)\n8. Fluid intake' },
        { title: 'Intervention', content: '1. Texture modification / Chew more\n2. Small and frequent meal 4-5 times/d\n3. Sitting upright at meals\n4. Good glycemic control\n5. Avoid alcohol and fizzy drinks\n6. Use liquid fat\n7. Low fibre diet\n8. Consider liquid supplement as usually tolerated normally' }
      ],
      content: '',
      createdAt: '2023-03-09T07:25:00',
      updatedAt: '2023-03-09T07:25:00'
    },
    {
      id: 'seed_gi_gerd',
      title: 'Gastroesophageal Reflux Disorder',
      category: 'Gastroenterology',
      keywords: ['GERD', 'reflux', 'acid', 'esophageal'],
      type: 'structured',
      sortOrder: 7,
      sections: [
        { title: 'Assessment', content: '1. Overweight/obese\n2. Meal time\n3. Meal portion\n4. Spicy food\n5. Carbonated drinks\n6. Caffeine/Alcohol\n7. Lie down after meal\n8. Tight clothing' },
        { title: 'Intervention', content: '1. Weight management\n2. Small frequent meals\n3. Eat slowly, chew better\n4. Avoid caffeine\n5. Avoid alcohol especially white wine\n6. Avoid carbonated drinks\n7. Avoid tight clothing\n8. Elevate 30 degree when lie down' }
      ],
      content: '',
      createdAt: '2023-03-08T23:19:00',
      updatedAt: '2023-03-08T23:19:00'
    },
    {
      id: 'seed_gi_pancreatic_ca',
      title: 'Pancreatic Cancer',
      category: 'Gastroenterology',
      keywords: ['pancreatic cancer', 'PERT', 'Creon', 'type 3c DM', 'Whipple'],
      type: 'structured',
      sortOrder: 8,
      sections: [
        { title: 'Operation', content: '- LOS double if malnourished\n- Causes: Weight loss, Anorexia\n- Focus: Symptoms control first then nutrition' },
        { title: 'PEI Assessment', content: '- Sarcopenia InBody\n  - Has Asian cutoff\n  - See phase angle, low is bad\n- Maybe hypo in DM\n- Any GI symptoms\n- Steatorrhea is already late stage, only 10% function left\n- Use EORTC, PEI-Q' },
        { title: 'Peri-operative Nutrition', content: '- Immunonutrition 7-10 day for 3 servings\n- Postop routine NJ tube, early oral diet\n- Post GI surgery case usually tolerate non-fibre, MCT and juice supplements' },
        { title: 'Type 3c DM', content: '- Because no glucagon and somatostatin etc.\n- Easier to have brittle DM\n- Must have basal bolus\n- Cannot use intermediate' },
        { title: 'PERT Dose', content: '- 1 Creon = 10000 unit\n- For HK: 1 pill = 15000 unit\n- Only pig is the source\n- If total pancreatectomy, usually 4-6 per meal is enough' }
      ],
      content: '',
      createdAt: '2023-11-17T13:11:00',
      updatedAt: '2023-11-17T13:11:00'
    },
    {
      id: 'seed_gi_hemorrhoids',
      title: 'Hemorrhoids',
      category: 'Gastroenterology',
      keywords: ['hemorrhoids', 'fibre', 'hematochezia', 'constipation'],
      type: 'structured',
      sortOrder: 9,
      sections: [
        { title: 'Introduction', content: '- Normal vascular structures in the anal canal that drains into the superior and inferior hemorrhoidal veins\n- Located in the submucosal layer in the lower rectum and may be external, internal, or mixed\n- Risk factors:\n  - Chronic constipation/diarrhea\n  - Prolonged sitting\n  - Pregnancy/advancing age\n  - Pelvic tumour\n  - Degenerated connective tissue' },
        { title: 'Clinical Presentation', content: '1. Hematochezia (passing fresh blood)\n2. Perianal pruritus\n3. Pain associated with a thrombosed hemorrhoid\n4. Fecal soilage (incontinence of liquid stool)\n5. Mucus discharge\n6. Sensation of fullness at perianus area' },
        { title: 'Clinical Treatment', content: '1. Topical ointment\n2. Rubber band ligation\n   - Up to 3 band at once\n   - 3-4 week interval if need multiple sessions\n3. Sclerotherapy\n   - Sclerosant causes an intense inflammatory reaction, destroying redundant submucosal tissue\n4. Surgical hemorrhoidectomy' },
        { title: 'Assessment', content: '1. Fruit and vegetable intake\n2. Fibre intake\n3. Fluid intake\n4. Iron profile\n5. Hb' },
        { title: 'Dietary Intervention', content: '1. Promote regular soft stool:\n   - 20-30g insoluble fibre intake\n   - 1.5-2L fluid intake\n2. Prevent constipation\n   - Minimize fatty food\n   - Minimize alcohol\n3. Spicy food had no influence on symptoms' }
      ],
      content: '',
      createdAt: '2024-02-06T14:22:00',
      updatedAt: '2024-02-06T14:22:00'
    },
    {
      id: 'seed_gi_diverticular',
      title: 'Diverticular Disease',
      category: 'Gastroenterology',
      keywords: ['diverticulosis', 'diverticulitis', 'fibre', 'colon'],
      type: 'structured',
      sortOrder: 10,
      sections: [
        { title: 'Definition', content: '- Diverticula are acquired herniation of colonic mucosa\n- Protruding through the circular muscle where the blood vessel penetrate through the colonic wall\n- Tends to occur in sigmoid colon but can be pancolonic\n- Rectum is not affected â€” has complete muscle layer' },
        { title: 'Symptoms and Signs (usually occur >1hr PP)', content: '1. Nausea and vomiting\n2. Early satiety / postprandial fullness\n3. Abdominal pain\n4. Bloating\n5. Weight loss' },
        { title: 'Diverticulitis', content: '1. Bleeding\n2. Sudden change in bowel habit\n3. Tenderness at LLQ (or Asian RLQ)' },
        { title: 'Assessment', content: '1. Fibre intake (low fibre increase pressure on colonic wall + altered microbiota)' },
        { title: 'Intervention', content: '1. **High fibre diet**\n   - For diverticulosis\n   - Gradual increase fibre to minimize bloating\n   - Increase fluid intake\n2. **Low fibre diet ??** For diverticulitis\n   - Gradual step up fibre when symptom improves' }
      ],
      content: '',
      createdAt: '2023-03-09T07:25:00',
      updatedAt: '2023-03-09T07:25:00'
    },
    {
      id: 'seed_gi_colostomy',
      title: 'Colostomy',
      category: 'Gastroenterology',
      keywords: ['colostomy', 'stoma', 'low residue'],
      type: 'structured',
      sortOrder: 11,
      sections: [
        { title: 'Types of Colostomy', content: '**1. Loop colostomy**\n- Temporary procedure\n- Colon sutured to abdomen with 2 openings in one stoma\n- One for removing intestinal waste\n- Another one connected to the inactive part\n\n**2. End colostomy**\n- Involves removal of rectosigmoid colon\n- Closure of rectal stump\n\n**3. Double barrel colostomy**\n- Colon is reserved\n- Both ends are brought out onto the abdomen\n- Only the proximal stoma is functioning' },
        { title: 'Intervention', content: '1. **Low residue diet post-operation**\n   - To minimize risk of obstruction caused by GI edema\n   - Reintroduce fibre 6-8 weeks after surgery\n2. **Adequate fluid intake**\n   - 1.5-2L/day' }
      ],
      content: '',
      createdAt: '2023-03-09T07:48:00',
      updatedAt: '2023-03-09T07:48:00'
    },
    {
      id: 'seed_gi_steatocholecystitis',
      title: 'Steatocholecystitis',
      category: 'Gastroenterology',
      keywords: ['gallstone', 'steatocholecystitis', 'gallbladder', 'fatty gallbladder'],
      type: 'structured',
      sortOrder: 12,
      sections: [
        { title: 'Definition', content: '- Lipid deposit to the wall of gallbladder with / without gallstone\n- Fat infiltration provokes a cytokine cascade leading to inflammation\n- Impairs gallbladder ejection\n- Increase risk of gallbladder cancer' },
        { title: 'Assessment', content: '1. Weight history (obesity related)\n2. Eating pattern\n3. Fibre\n4. Fat\n5. Alcohol' },
        { title: 'Intervention', content: '*Minimize risk of stone formation*\n- Healthy weight with rate of loss <1.5kg/week\n- Regular food intake\n- Minimize intake of refined carbs, saturated fat and trans fat\n- Increase fibre intake\n- Avoid alcohol' }
      ],
      content: '',
      createdAt: '2023-03-09T07:25:00',
      updatedAt: '2023-03-09T07:25:00'
    },
    {
      id: 'seed_gi_ileostomy',
      title: 'Ileostomy',
      category: 'Gastroenterology',
      keywords: ['stoma', 'ileostomy', 'odour', 'stoma output'],
      type: 'structured',
      sortOrder: 13,
      sections: [
        { title: 'Types of Ileostomy', content: '**1. Loop ileostomy**\n- Temporary procedure\n- Rectum and colon is in situ\n- Usually reverse in 8-10 weeks\n- Avoid intestinal effluent entering the pouch\n\n**2. End ileostomy**\n- Involves removal of colon and rectum\n- End of small intestine is brought through skin\n\n**3. Continent ileostomy**\n- Colon is reserved\n- No external bag is needed\n- Pouch is created internally with the end of small intestine\n- Ileo-anal pouch instead of catheter usually' },
        { title: 'Assessment', content: '1. Body weight history\n2. Lab: creatinine, Na\n3. Stoma output (750-1500ml / day)\n4. Stool consistency\n5. Stool odour' },
        { title: 'Intervention', content: '1. **Adequate liquid intake**\n   - 1.5-2L/day\n   - Fluid requirement = 1L + stoma output\n   - Loss of fluid: 1200-2000ml --> 400-600ml\n2. **Sodium intake** â€” 1 teaspoon of salt per day if loss is high / hot weather\n3. Small frequent meals\n4. Low residue diet if obstruction is frequent\n5. Avoid problematic food only\n6. Low FODMAP diet' }
      ],
      content: '',
      createdAt: '2023-03-09T07:48:00',
      updatedAt: '2023-03-09T07:48:00'
    },
    {
      id: 'seed_gi_gallstone',
      title: 'Gallstone / Cholecystitis / Cholecystectomy',
      category: 'Gastroenterology',
      keywords: ['gallstone', 'cholecystitis', 'cholecystectomy', 'steatorrhea', 'gallbladder dyskinesia'],
      type: 'structured',
      sortOrder: 14,
      sections: [
        { title: 'Definition', content: '- Type: cholesterol vs bile\n- Involves saturation of the ingredient, crystallization and growth of crystals\n- If block the CBD, may lead to:\n  - Pancreatic exocrine insufficiency\n  - Gallstone pancreatitis' },
        { title: 'Symptoms and Signs', content: '**General**\n- Marginally increased bilirubin, ALT, ALP, CRP\n\n**Acute cholecystitis**\n- Severe pain in the epigastric or right upper abdomen for 2-4 hours\n- Fever\n- Loss of appetite\n\n**Chronic cholecystitis**\n- Vague symptoms\n- Epigastric discomfort after eating\n- Abdominal distention\n- Self-initiated food avoidance (not evidence-based)' },
        { title: 'Assessment', content: '1. Weight history\n2. LFT, CRP\n3. Fat-soluble vitamin serum level\n4. Eating pattern\n5. Fibre\n6. Fat\n7. Alcohol' },
        { title: 'Intervention', content: '**Minimize risk / asymptomatic / dyskinesia**\n- Healthy weight with rate of loss <1.5kg/week\n- Regular food intake\n- Minimize intake of refined carbs and trans fat\n- Increase fibre intake\n- Avoid alcohol\n\n**Acute cholecystitis**\n- Small frequent meal\n- Nutritional support\n\n**Chronic cholecystitis**\n- To minimize further stone formation\n- Do not restrict fat â€” gallbladder contracts to eating\n\n**Post-cholecystectomy**\n- Consumption of carbohydrates-rich drink before surgery (reduce post-op nausea and vomit)\n- No need to delay oral intake after surgery\n- Nutrition support if inadequate intake\n\n**Pancreatic exocrine insufficiency (may lead to steatorrhea)**\n- PERT\n- Vitamin ADEK supplement\n- Do not restrict fat intake\n- MCT / Juice-based supplement if prolong steatorrhea\n\n**CBD injury (biliary leak and fistula)**\n- Correction of fluid and electrolyte imbalance\n- Semi elemental / low fat EN for fat malabsorption\n- Fistula output >500ml/24H: oral rehydration solution + avoid hypotonic fluid + PN' }
      ],
      content: '',
      createdAt: '2023-03-09T07:25:00',
      updatedAt: '2023-03-09T07:25:00'
    },
    {
      id: 'seed_gi_crohns',
      title: 'Crohn\'s Disease',
      category: 'Gastroenterology',
      keywords: ['IBD', 'Crohn disease', 'EEN', 'enteral nutrition'],
      type: 'structured',
      sortOrder: 15,
      sections: [
        { title: 'Definition', content: '*(To be completed)*' },
        { title: 'Symptoms and Signs', content: '*(To be completed)*' },
        { title: 'Assessment', content: '1. **Specific carbohydrates diet**\n   - Avoid starch, sugary food, processed food, legumes, dairy\n   - Not superior to Mediterranean diet\n2. **Crohn\'s elimination diet**\n   - Restrict animal fat, processed food, dairy, wheat, dried fruit\n   - May have partial enteral nutrition' },
        { title: 'Intervention', content: '1. **TPN**\n   - Slow step up in case of unstable CBC\n   - Usually short term for bowel rest\n2. **Exclusive EN**\n   - To induce remission' }
      ],
      content: '',
      createdAt: '2023-03-09T07:25:00',
      updatedAt: '2023-03-09T07:25:00'
    },
    {
      id: 'seed_gi_eoe',
      title: 'Eosinophilic Esophagitis',
      category: 'Gastroenterology',
      keywords: ['SFED', 'elimination diet', 'eosinophilic', 'EoE'],
      type: 'structured',
      sortOrder: 16,
      sections: [
        { title: 'Definition', content: '- Large number of eosinophils present in oesophagus leading to inflammation\n- Maybe caused by food allergy leading to chemotaxis of eosinophils' },
        { title: 'Assessment', content: '1. Weight loss\n2. Dysphagia, obstruction episodes\n3. Food allergy' },
        { title: 'Intervention', content: '**Six food elimination diet with rechallenge**\n(Wheat, egg, fish/shellfish, soy, dairy, peanuts)\n\n- Consider step up or step down approach\n- Usually with OGD in between each stage to see if EoE resolved with current food eliminated' }
      ],
      content: '',
      createdAt: '2023-03-09T07:25:00',
      updatedAt: '2023-03-09T07:25:00'
    },
    {
      id: 'seed_gi_mirizzi',
      title: 'Mirizzi Syndrome',
      category: 'Gastroenterology',
      keywords: ['Mirizzi', 'gallstone', 'CBD', 'jaundice', 'cholestasis'],
      type: 'structured',
      sortOrder: 17,
      sections: [
        { title: 'Pathogenesis', content: '1. **Type 1:** Gallstone impacted in gallbladder infundibulum cause jaundice by extrinsic compression of the CBD\n2. **Type 2:** Gallstone is located in a single cavity formed by gallbladder and CBD' },
        { title: 'Signs and Symptoms', content: '1. Inflammation: Bile back up to liver leading (cholestasis) + bacteria to liver\n2. Jaundice: bilirubin from bile build up in blood\n3. Maldigestion of lipid\n4. Fistula within the biliary system' }
      ],
      content: '',
      createdAt: '2023-04-01T18:19:00',
      updatedAt: '2023-04-01T18:19:00'
    },
    {
      id: 'seed_gi_achalasia',
      title: 'Achalasia',
      category: 'Gastroenterology',
      keywords: ['achalasia', 'dysphagia', 'LES', 'esophageal'],
      type: 'structured',
      sortOrder: 18,
      sections: [
        { title: 'Introduction', content: '- Progressive degeneration of ganglion cells in the myenteric plexus in the esophageal wall\n- Leading to failure of relaxation of the lower esophageal sphincter (LES)\n- Accompanied by a loss of peristalsis in the distal esophagus\n- Etiology is unknown' },
        { title: 'Clinical Manifestation', content: '1. Dysphagia\n2. Regurgitation of undigested food/saliva\n3. Chest pain\n4. Heartburn\n5. Difficulty belching\n6. Late/End-stage:\n   - Esophageal angulation / tortuosity\n   - Severe dilation / megaesophagus (>6cm)' },
        { title: 'Treatment', content: '1. Pneumatic balloon dilation\n2. Peroral endoscopic myotomy (POEM)\n   - Increase risk of post-op reflux\n3. Botulinum toxin\n4. Nitrates: 10-15mins before meal' },
        { title: 'Nutritional Assessment', content: '1. Body weight history correlate with intake drop\n2. Choking/dysphagia/reflux\n3. Types of treatment' },
        { title: 'Nutritional Intervention', content: '1. Small frequent meals\n2. Avoid irritative food' }
      ],
      content: '',
      createdAt: '2024-01-22T19:07:00',
      updatedAt: '2024-01-22T19:07:00'
    },
    {
      id: 'seed_gi_stress_gastritis',
      title: 'Stress-Induced Gastritis',
      category: 'Gastroenterology',
      keywords: ['stress gastritis', 'PPI', 'GI bleeding', 'mucosal damage'],
      type: 'structured',
      sortOrder: 19,
      sections: [
        { title: 'Introduction', content: '- Under stress, defence system tends to decrease bicarbonate secretion leading to reduced pH\n- Stress also reduce blood flow to stomach and lead to breakdown of mucosal lining\n- Both lead to mucosal damage\n- Risk factors:\n  - Massive burn\n  - CNS injury with raised ICP\n  - Sepsis\n  - Multi-organ failure\n  - Mechanical ventilation\n  - Hypotension' },
        { title: 'Clinical Presentations', content: '- Coffee ground vomitus\n- Melena\n- Hematemesis (extreme case)\n- Orthostasis (unusual)' },
        { title: 'Medical Treatment', content: '1. **Histamine 2 receptor blocker**\n   - Famotidine\n2. **Proton pump inhibitor**\n   - Pantoprazole\n3. **Sucralfate**\n   - Bind with positively charged protein to form a lining to protect GI mucosa' }
      ],
      content: '',
      createdAt: '2023-10-29T01:07:00',
      updatedAt: '2023-10-29T01:07:00'
    },
    /* ===== GYNECOLOGY ===== */
    {
      id: 'seed_gyn_ohss',
      title: 'Ovarian Hyperstimulation Syndrome',
      category: 'Gynecology',
      keywords: ['OHSS', 'ovarian', 'HCG', 'fertility'],
      type: 'structured',
      sortOrder: 0,
      sections: [
        { title: 'Introduction', content: '- Exaggerated response to excess hormones\n- Usually occur with women having fertility treatment with injectable hormone, less likely for oral medications\n- Ovarian blood vessels react abnormally to human chorionic gonadotropin (HCG) and begin to leak fluid to uterus or abdomen' },
        { title: 'Clinical Presentation', content: '**Mild** *(should be gone for 1 week, but last for days to weeks if pregnant)*\n- Mild to moderate abdominal pain\n- Abdominal bloating or increased waist size\n- Nausea\n- Vomiting\n- Diarrhea\n- Tenderness in the area of your ovaries\n\n**Severe**\n- Rapid weight gain â€” more than 2.2 pounds (1 kilogram) in 24 hours\n- Severe abdominal pain\n- Severe, persistent nausea and vomiting\n- Blood clots\n- Decreased urination\n- Shortness of breath\n- Tight or enlarged abdomen' },
        { title: 'Medical Treatment', content: '*(To be completed)*' },
        { title: 'Assessment', content: '*(To be completed)*' },
        { title: 'Dietary Intervention', content: '*(To be completed)*' }
      ],
      content: '',
      createdAt: '2025-04-21T17:06:00',
      updatedAt: '2025-04-21T17:06:00'
    },
    {
      id: 'seed_gyn_pcos',
      title: 'Polycystic Ovarian Syndrome',
      category: 'Gynecology',
      keywords: ['PCOS', 'insulin resistance', 'hyperandrogenism', 'metformin'],
      type: 'structured',
      sortOrder: 1,
      sections: [
        { title: 'Introduction', content: '- Consist of at least 2 of 3 items:\n  - a. Oligo-ovulation/anovulation\n  - b. Hyperandrogenism\n  - c. Polycystic ovaries\n- Intrinsic insulin resistance (IR)\n  - Promotes ovarian hyperandrogenism\n  - Reduce hepatic production of sex hormone binding globulin (SHBG)\n- Both IR & hyperandrogenism disrupt follicle development\n  - Leading to menstrual irregularity and infertility\n- Increase risk of T2DM, eating disorder, CVD-related, endometrium cancer' },
        { title: 'Clinical Presentation', content: 'May not to suffered from all of the following:\n- Menstrual irregularity\n- Fertility problems\n- Excess male pattern hair (hirsutism)\n- Male pattern alopecia\n- Acne\n- Central adiposity\n- Insulin resistance\n- Depression' },
        { title: 'Medical Treatment', content: '1. Metformin (GI symptoms)\n2. Oral contraceptives (poor insulin + lipid)' },
        { title: 'Assessment', content: '1. BMI and WC\n2. Diet\n   - a. Binge eating\n   - b. Food craving\n   - c. Fruit and vegetables\n3. SMBG / postprandial hypoglycemia\n4. Exercise\n5. Sleeping' },
        { title: 'Dietary Intervention', content: '1. **Weight reduction by 5-10%**\n   - Could be difficult with food craving / binge eating\n   - Focus on what healthy food to be included\n2. **Mediterranean diet**\n   - Focus on low glycemic index\n   - Antioxidants\n   - Replace saturated fat by MUFA\n   - Minimize alcohol intake\n   - Reduce sugar intake\n3. **Omega 3 fatty acid**\n   - By having oily fish 1-2 times/week\n   - Plant-based: chia, flaxseed, algae, walnut\n4. Exercise even without weight loss (150mins/week)' },
        { title: 'Need More Research', content: '1. **Myoinositol**\n   - Usual dose 1-4g/d, ?upper limit\n   - Help with glycemic control\n   - Slight improvement in reducing testosterone/increase SHBG\n2. **Spearmint tea** 2 cups/d to lower testosterone and facial hair\n   - Only one study but too short period of time\n3. **Vitamin D**\n   - Mixed result on insulin, androgen and lipid profile' }
      ],
      content: '',
      createdAt: '2024-09-06T17:10:00',
      updatedAt: '2024-09-06T17:10:00'
    },
    {
      id: 'seed_gyn_pms',
      title: 'Premenstrual Syndrome',
      category: 'Gynecology',
      keywords: ['PMS', 'premenstrual', 'luteal phase', 'progesterone'],
      type: 'structured',
      sortOrder: 2,
      sections: [
        { title: 'Introduction', content: '- Occurs during the luteal phase (1-2 weeks before menstruation)\n- Symptoms relieves by the onset of or during menstruation\n- Lower threshold to develop PMS with DM, IBS, allergies\n- Probably caused by increased sensitivity to circulating progesterone and its metabolites' },
        { title: 'Clinical Presentation', content: '1. Mood swing\n2. Irritability\n3. Increased appetite of carbohydrates and alcohol\n4. Breast tenderness\n5. Headache\n6. Bloating' },
        { title: 'Assessment', content: '1. Body weight\n2. Glycemic profile, Lipid\n3. Hx of DM, IBS, Allergies\n4. Glycemic index of carbs\n5. Meal pattern\n6. Snacks\n7. BO pattern (?constipation)' },
        { title: 'Dietary Intervention', content: '1. **Low glycemic index diet** (anecdotal)\n   - Hypoglycemia s/s after fast acting carbs\n   - No actual hypoglycemia\n   - ?caused by increased sensitivity to drop in blood sugar\n2. **Ca & Vit D**\n   - Ca 1000mg/d + Vit D 10ug/d\n   - Or >= 2ug Vit D daily\n   - Could be consuming low fat dairy\n3. **Magnesium**\n   - Low plasma level and intake\n   - RDA: 310-320mg/d, 360 if pregnancy\n   - Inadequate evidence\n4. **Vitamin B complex**\n   - B6 needs 50-100mg/d but may cause neuropathy\n   - Having thiamine and riboflavin may help\n5. Encourage fibre intake\n6. Reduce alcohol\n7. Vit E, evening primrose oil and other herbal supplements showed limited evidence' }
      ],
      content: '',
      createdAt: '2025-03-16T22:37:00',
      updatedAt: '2025-03-16T22:37:00'
    },
    /* ===== HAEMATOLOGY ===== */
    {
      id: 'seed_haem_vwd',
      title: 'Von Willebrand Disease (vWD)',
      category: 'Haematology',
      keywords: ['vWD', 'vWF', 'bleeding', 'coagulation'],
      type: 'structured',
      sortOrder: 0,
      sections: [
        { title: 'Nature', content: '- Inherited: type 1 to 3 vs Acquired\n- **Type 1:** vWF production level is reduced + rapid clearance from plasma\n- **Type 2:** vWF plasma level is normal but functionally defective\n- **Type 3:** Recessive mutation causing almost total absence of vWF --> severe vWD\n- **Acquired:** Rapid clearance after forming complex with antibody. Can be seen in aortic stenosis' },
        { title: 'Signs and Symptoms', content: '- Abnormal bleeding\n- Frequent nose bleed >10mins\n- Heavy / long menstrual bleeding\n- Hematuria / Fecal blood\n- Easy bruising' },
        { title: 'Complication', content: '- Anemia (heavy menstruation)\n- Swelling and pain of joints (abnormal bleeding)' }
      ],
      content: '',
      createdAt: '2023-04-02T15:34:00',
      updatedAt: '2023-04-02T15:34:00'
    },
    {
      id: 'seed_haem_mm',
      title: 'Multiple Myeloma',
      category: 'Haematology',
      keywords: ['myeloma', 'CRAB', 'BMT', 'plasma cell'],
      type: 'structured',
      sortOrder: 1,
      sections: [
        { title: 'Introduction', content: '- Neoplastic proliferation of plasma cells producing a monoclonal immunoglobulin\n- Proliferate in the bone marrow leading to skeletal destruction\n- High risk MM:\n  - t(4:14), t(14;20), del17p13, gain 1q by FISH\n  - LDH double of upper limit\n  - Primary plasma cell leukemia' },
        { title: 'Clinical Presentation', content: '1. **CRAB**\n   - a. Calcium elevation (bone)\n   - b. Renal disease (Ca/FLC)\n   - c. Anemia\n   - d. Bone disease\n2. Weight loss\n3. Fatigue\n4. Elevated total protein\n5. Spinal cord compression\n6. Hyperviscosity (IgM)\n7. Infection' },
        { title: 'Medical Intervention', content: '1. **Hematopoietic cell transplant (HCT)**\n   - 3-6 months of chemotherapy\n   - Stem cell collection\n   - HCT or 8-12 months induction chemotherapy\n2. Osteoclast inhibitor\n3. **Systemic therapy**\n   - DVRd: prioritise PFS\n   - VRd: prioritise avoiding cost and toxicity\n   - DRd: for whose intolerate bortezomib\n   - VCd: high risk of AKI and embolism' },
        { title: 'Assessment', content: '1. Weight change\n2. RFT, Ca\n3. Fatigue\n4. Nausea and vomiting\n5. Mucositis (with BMT)\n6. Treatment plan\n7. Ability to self feed' },
        { title: 'Dietary Intervention', content: '1. Clean diet / BMT diet\n2. Nutritional support (aware of Plt and Ca)' }
      ],
      content: '',
      createdAt: '2024-04-12T19:22:00',
      updatedAt: '2024-04-12T19:22:00'
    },
    {
      id: 'seed_haem_aplastic',
      title: 'Aplastic Anemia',
      category: 'Haematology',
      keywords: ['aplastic anemia', 'BMF', 'pancytopenia', 'HSC'],
      type: 'structured',
      sortOrder: 2,
      sections: [
        { title: 'Introduction', content: '- Bone marrow failure (BMF) disorder\n- Pancytopenia with bone marrow hypoplasia / aplasia due to loss of hematopoietic stem cells (HSCs)\n- Most are idiopathic and believed as autoimmune\n- Other causes: toxin, viral infection, drug, etc.' },
        { title: 'Clinical Presentation', content: '1. Fatigue\n2. Dyspnea\n3. Fever\n4. Infection\n5. Bleeding / bruising' },
        { title: 'Assessment', content: '1. Weight history (fatigue)\n2. ANC\n3. Vit B12 and folate' }
      ],
      content: '',
      createdAt: '2024-01-26T19:24:00',
      updatedAt: '2024-01-26T19:24:00'
    },
    {
      id: 'seed_haem_dic',
      title: 'Disseminated Intravascular Coagulation (DIC)',
      category: 'Haematology',
      keywords: ['DIC', 'coagulation', 'fibrinolysis', 'thrombocytopenia'],
      type: 'structured',
      sortOrder: 3,
      sections: [
        { title: 'Nature', content: '- Concurrent presence of widespread coagulation in microvasculature and increasing bleeding tendency' },
        { title: 'Pathogenesis', content: '**Increased coagulation**\n1. Tissue factor (TF) is usually not touching the circulation\n2. With trauma, interleukin, TNF-a and endotoxin, TF will be released\n3. TF interact with coagulation factor and initiate coagulation cascade\n4. Thrombin in excess will cleave fibrinogen and cause fibrin clots\n5. Excessive coagulation lead to multiple organ failure with thrombosis\n6. Coagulation inhibitor will also be consumed and lead to more coagulation\n\n**Increased bleeding tendency**\n1. Reduced level of platelet (thrombocytopenia) + coagulation factors\n2. Excessive thrombin will increase plasmin level --> fibrinolysis\n3. Fibrin degradation products --> strong anticoagulants\n4. Excessive plasmin activates complement + kinin system --> septic shock' }
      ],
      content: '',
      createdAt: '2023-04-02T14:58:00',
      updatedAt: '2023-04-02T14:58:00'
    },
    {
      id: 'seed_haem_nhl',
      title: 'NHL Non-Hodgkin Lymphoma',
      category: 'Haematology',
      keywords: ['NHL', 'lymphoma', 'DLBCL', 'follicular', 'Burkitt', 'rituximab'],
      type: 'structured',
      sortOrder: 4,
      sections: [
        { title: 'Introduction', content: '- Diverse group of hematologic malignancies variously derived from B cell progenitors, T cell progenitors, mature B cells, mature T cells, or (rarely) natural killer cells\n- Pathogenesis involves accumulation of multiple genetic lesions affecting proto-oncogenes and tumor suppressor genes\n- Caused by chromosomal rearrangements, acquired somatic mutations, genome damage, and escape from immune surveillance\n- Occurs in all ages, races, and socioeconomic status\n\n**Aggressive or highly aggressive:**\n- Diffuse large B cell lymphoma\n- Burkitt lymphoma\n- Precursor B and T lymphoblastic leukemia/lymphoma\n- Adult T cell leukemia-lymphoma\n- Certain other peripheral T cell lymphomas\n\n**Indolent:**\n- Follicular lymphoma\n- Chronic lymphocytic leukemia/small lymphocytic lymphoma\n- Splenic marginal zone lymphoma\n- MALT lymphoma' },
        { title: 'Clinical Presentation', content: '**General aggressive**\n1. Fever\n2. Night sweat\n3. Weight loss\n4. Tumor lysis syndrome\n\n**General indolent**\n1. Waxing or waning lymphadenopathy\n2. Cytopenia\n3. Hepatomegaly\n4. Splenomegaly\n\n**Atypical**\n1. Pruritus\n2. Exaggerated response to insect bites\n3. Fever or unknown origin\n4. Ascites\n5. General fatigue\n6. Effusion\n\n**GI origin**\n1. Anorexia / early satiety\n2. Weight loss\n3. Vomiting\n4. Abdominal fullness\n5. Visceral obstruction\n6. Perforation\n7. Hemorrhage\n8. Diarrhea / Constipation\n\n**CNS origin**\n1. Headache\n2. Lethargy\n3. Focal neurologic symptoms\n4. Seizure\n5. Paralysis\n6. Spinal cord compression\n7. Lymphomatous meningitis\n\n**Cutaneous origin**\n1. Wax and wane rash\n2. Cutaneous plague\n3. Cutaneous tumor\n4. Ulcers' },
        { title: 'Medical Treatment', content: '**Follicular lymphoma**\n- Stage IIA: local R/T or watch and wait\n- Advanced stage, asymptomatic: rituximab induction therapy\n- Advanced stage, symptomatic: R-CVP, R-CHOP, R-MCP, R-CHVPi\n- Relapsed / refractory: Rituximab +/- chemotherapy\n- Stem cell transplantation\n\n**Diffuse large B-cell lymphoma**\n- Radiotherapy after first line immunochemotherapy\n- CNS prophylaxis if:\n  - Involve sex organ, adrenal gland or kidney\n  - 2 or more: elevated LDH, >60yo, poor performance, >1 extranodal site, stage 3/4\n- Salvage therapy with multi-agent immunochemotherapy\n- Stem cell transplantation\n\n**Burkitt lymphoma**\n- More intensive immunochemotherapy: R-BFM, R-CODOX-M/R-IVAC, R-hyperCVAD, R-LMB\n- R-CHOP for less intensive if not tolerate intensive\n\n**T-cell lymphoma**\n- 1st line: CHOP for peripheral TCL\n- Stem cell transplantation if at least partially respond to CHOP' },
        { title: 'Assessment', content: '1. Weight loss\n2. Lab\n   - a. Hypercalcaemia (Follicular, DLBCL, HTLV-1)\n   - b. CBC (Plt, ANC)\n   - c. Hyperuricemia' },
        { title: 'Dietary Intervention', content: '1. **Calorie requirement**\n   - 25-30 kcal/kg/d\n   - Increased REE, reduced TEE\n2. **Protein requirement**\n   - 1-1.5g protein/kg/d\n3. **Neutropenic diet**\n   - No evidence support' }
      ],
      content: '',
      createdAt: '2024-02-24T14:22:00',
      updatedAt: '2024-02-24T14:22:00'
    },
    /* ===== IMMUNOLOGY ===== */
    {
      id: 'seed_imm_asthma',
      title: 'Asthma',
      category: 'Immunology',
      keywords: ['asthma', 'airway', 'eosinophil', 'inflammation'],
      type: 'structured',
      sortOrder: 0,
      sections: [
        { title: 'Definition', content: '- Chronic inflammation of airway' },
        { title: 'Risk Factor', content: '- Carpet flooring\n- Damp room\n- Pesticide' },
        { title: 'Protective Factor', content: '- Poultry raising' },
        { title: 'Diagnosis', content: '- High blood eosinophil, if high, more type 2 inflammation more severe' },
        { title: 'Treatment', content: '*(To be completed)*' }
      ],
      content: '',
      createdAt: '2023-05-27T09:55:00',
      updatedAt: '2023-05-27T09:55:00'
    },
    {
      id: 'seed_imm_anaphylaxis',
      title: 'Anaphylaxis',
      category: 'Immunology',
      keywords: ['anaphylaxis', 'IgE', 'epinephrine', 'mast cell'],
      type: 'structured',
      sortOrder: 1,
      sections: [
        { title: 'Definition', content: '**IgE related**\n- IgE cross-linking allergen with mast cell leading to degranulation\n- Release proteases, histamine, Heparin, TNF-a\n- Lead to vascular edema, bronchoconstriction\n\n**Non-IgE related**' },
        { title: 'Common Etiology', content: '- Food' },
        { title: 'Assessment', content: '1. Serum tryptase (15min-3h)\n2. Skin test / IgE test based on history\n3. Challenge test' },
        { title: 'Treatment', content: '**Epinephrine**\n- Act on a and B adrenergic receptor\n  - A: reverse peripheral vasodilation\n  - B-1: Increase heart rate and contraction\n  - B-2: Relax smooth muscle\n- Dose (1:1000 IM)\n  - Adult: 0.3-0.5mg, max 0.5\n  - Child: 0.01mg/kg, max 0.3\n  - Repeat every 5 min/sooner\n  - Keep lying down\n- Hold 10 seconds for Injection and massage' }
      ],
      content: '',
      createdAt: '2023-07-01T10:39:00',
      updatedAt: '2023-07-01T10:39:00'
    },
    {
      id: 'seed_imm_aps',
      title: 'Antiphospholipid Syndrome',
      category: 'Immunology',
      keywords: ['antiphospholipid', 'thrombosis', 'warfarin', 'pregnancy loss'],
      type: 'structured',
      sortOrder: 2,
      sections: [
        { title: 'Pathogenesis', content: '1. Antibody against variety of protein e.g. prothrombin, phosphatidylserine\n2. Thrombosis: pro-inflammatory and pro-coagulation cellular signalling + complement activation\n3. 1st trimester loss: aPL inhibit trophoblast proliferation, viability and invasion leading to loss of anchorage of placenta to uterus\n4. Late term pregnancy loss:\n   - a. Inflammation + complement\n   - b. Inadequate placenta development\n   - c. Fetal growth delay' },
        { title: 'Signs and Symptoms', content: '- Multiple system involvement\n- Usually thrombosis causing infarction and ischemia in different organs leading to damages' },
        { title: 'Treatment', content: 'Anticoagulation therapy including:\n- Warfarin\n- Aspirin' }
      ],
      content: '',
      createdAt: '2023-03-19T22:46:00',
      updatedAt: '2023-03-19T22:46:00'
    },
    {
      id: 'seed_imm_cold_urticaria',
      title: 'Cold Urticaria',
      category: 'Immunology',
      keywords: ['FCAS', 'cold urticaria', 'cryopyrin', 'NLRP-3'],
      type: 'structured',
      sortOrder: 3,
      sections: [
        { title: 'Definition', content: '- Familial cold autoinflammatory syndrome is a cryopyrin associated periodic syndrome\n- Acquired cold urticaria caused by infection-related cold agglutinins or cryoglobulin e.g. HCV, mycoplasma' },
        { title: 'Clinical Presentation (FCAS)', content: '- Burning rash\n- Arthritis\n- Fever\n- Headache' },
        { title: 'Assessment', content: '- NLRP-3 mutation\n- Place ice cube on skin for five minutes\n- Immerse hand in cold water for 4 minutes and check histamine in blood' }
      ],
      content: '',
      createdAt: '2023-07-01T11:44:00',
      updatedAt: '2023-07-01T11:44:00'
    },
    {
      id: 'seed_imm_drug_allergy',
      title: 'Drug Allergy',
      category: 'Immunology',
      keywords: ['drug allergy', 'provocation test', 'SPT', 'intradermal'],
      type: 'structured',
      sortOrder: 4,
      sections: [
        { title: 'Provocation Test', content: '- Gold standard and most sensitive\n- Identify all types of allergy or even other ADRs\n- Need double/single-blinded vs open challenge (placebo/nocebo)\n- But potential risk to patient\n- Need to be ready for anaphylaxis' },
        { title: 'Taking History of Drug Allergy', content: '**1. Is it really allergy?**\n- a. Allergen (likely cause? Clinically plausible?)\n- b. Better explanation? (Urticaria?)\n- c. Clinical feature (typical presentation? Immune-mediated?)\n- d. Duration since index reaction (childhood vs recent allergy?)\n- e. Extra information (serum tryptase)\n\n**2. Is it worth to test?**\n- Severity of allergy\n  - Immediate: airway / cardiovascular compromise / anaphylaxis\n  - Delayed: severe cutaneous adverse reaction\n\n**3. Which test to use**\n- Is it immediate or delayed? + risk if reaction\n  - Immediate: SPT / Intradermal / Challenge\n  - Delayed: Intradermal / Challenge\n  - Unknown: need to exclude both' }
      ],
      content: '',
      createdAt: '2023-07-06T21:31:00',
      updatedAt: '2023-07-06T21:31:00'
    },
    {
      id: 'seed_imm_hsp',
      title: 'Henoch-Schonlein Purpura',
      category: 'Immunology',
      keywords: ['HSP', 'purpura', 'vasculitis', 'IgA'],
      type: 'structured',
      sortOrder: 5,
      sections: [
        { title: 'Nature', content: '- Disorder that cause the small blood vessel to become inflamed and bleed\n- Unknown cause, may be immunological' },
        { title: 'Signs and Symptoms', content: '- Purplish rash, especially in lower legs and buttocks\n- Abdominal pain\n- Painful joints\n- Nausea and vomit\n- Bloody stool\n- Kidney damage (rare)\n- Bowel obstruction (bowel folded into a telescope)' },
        { title: 'Treatment', content: '- Corticosteroid\n- Surgery if bowel has folded in or rupture' }
      ],
      content: '',
      createdAt: '2023-03-19T22:46:00',
      updatedAt: '2023-03-19T22:46:00'
    },
    {
      id: 'seed_imm_alpha_gal',
      title: 'Alpha-gal Syndrome',
      category: 'Immunology',
      keywords: ['alpha-gal', 'tick', 'mammalian meat', 'delayed allergy'],
      type: 'structured',
      sortOrder: 6,
      sections: [
        { title: 'Introduction', content: '- Ticks will inject alpha-gal sugar molecules into blood when biting\n- Body will produce antibodies against alpha-gal\n- Most mammal cells surface has alpha-gal\n- Eating these animals or their products will cause allergic symptoms in 2-6 hours' },
        { title: 'Symptoms and Signs', content: '*(To be completed)*' }
      ],
      content: '',
      createdAt: '2023-12-31T00:10:00',
      updatedAt: '2023-12-31T00:10:00'
    },
    {
      id: 'seed_imm_pemphigus',
      title: 'Pemphigus Vulgaris',
      category: 'Immunology',
      keywords: ['pemphigus', 'autoimmune', 'desmoglein', 'blister'],
      type: 'structured',
      sortOrder: 7,
      sections: [
        { title: 'Pathogenesis', content: '1. IgG autoantibodies attacking keratinocytes\n2. Desmoglein, protein for keratin deposit\n3. Keratinocyte loses cell-cell adhesion\n4. Oral flaccid bullae form and rupture\n5. Rupture causing lesion' },
        { title: 'Signs and Symptoms', content: '1. Blister that are easily rupture\n2. Leading to painful lesion in mouth and throat\n3. Skin will also develop after a few months' },
        { title: 'Treatment', content: '1. Steroid\n2. Immunosuppressant' }
      ],
      content: '',
      createdAt: '2023-03-16T22:50:00',
      updatedAt: '2023-03-16T22:50:00'
    },
    {
      id: 'seed_imm_cmpa',
      title: 'Cow\'s Milk Allergy',
      category: 'Immunology',
      keywords: ['CMPA', 'milk allergy', 'EHF', 'AAF', 'milk ladder', 'IgE'],
      type: 'structured',
      sortOrder: 8,
      sections: [
        { title: 'Introduction', content: '- Allergic to various milk protein (BLG, casein, ALA, bovine lactoferrin)\n- Could be either IgE related or not\n- Usually occurs in first few months of life\n- 85% could be outgrown by the age of 3yo, faster with non-IgE mediated' },
        { title: 'Clinical Presentation', content: '| IgE mediated | Non-IgE mediated | Mixed type |\n| --- | --- | --- |\n| Urticaria | Food protein-induced enterocolitis syndrome | Atopic dermatitis |\n| Angioedema | Food protein-induced proctitis/proctocolitis | Eosinophilic GI disorder |\n| Anaphylaxis | Food protein-induced enteropathy | |\n| | Gastroesophageal reflux | |\n| | Colic | |\n| | Constipation | |\n| | Heiner syndrome (pulmonary hemosiderosis) | |' },
        { title: 'Assessment', content: '1. **Skin prick test**\n   - Good for negative response\n   - Positive response does not mean allergy\n2. **Specific IgE test**\n   - Identify food-specific IgE Ab\n   - Suitable for difficult skin test\n   - IgE range for Dx:\n     - >=2yo: 15.0 KUa/L\n     - <=2yo: 5.0 KUa/L\n3. Diet and symptom history\n   - To identify IgE or non-IgE mediated\n4. Growth curve, look for FTT\n5. BO pattern and any blood\n   - Compared with baseline\n   - Any anal fissures/sores\n6. Signs of dehydration' },
        { title: 'Dietary Intervention - General Principles', content: '**Elimination of cow\'s milk and products**\n1. Maternal diet also restrict if BF and infant has s/s\n2. Label reading skills\n3. +/- supplementation of Ca and Vit D for lactating mothers' },
        { title: 'Dietary Intervention - Before Weaning', content: '**1. Try hypoallergenic formula** (unless EoE or Anaphylaxis)\n- **EHF first** (all 1scp:30ml), 90% clinical tolerance\n  - Pepti Junior (gold brand)\n  - Aptamil ProExpert Allecure (0-12/12-36)\n  - Alfare\n  - Frisolac Gold Allergy Care\n  - Neocate Pepti SYNEO\n  - Nutramigen Lipil LGG\n  - BF baby may not tolerate EHF because beta-lactoglobulin in BF\n- **AAF if no improvement/still FTT**\n  - Avg 10% of IgE-mediated will need AAF\n  - Neocate LCP\n- Hints to introduce:\n  - Offer AF when hungry and thirsty\n  - Try to offer first bottles by non-main carer\n  - Mixing hypoallergenic AF with weaning food e.g. congee\n  - Use baby beaker with free flow (>6 months)\n  - Slightly adding vanilla essence\n  - Avoid flavourings but if else fails, use syrup except honey when <1yo\n\n**2. Soy protein formula should ONLY be used in:**\n- >6 months old (because ?phytoestrogen effect on sex)\n- Failed to take hypoallergenic formula\n- No soy protein allergy\n  - Usually IgE-mediated is less likely allergic to soy\n  - Overall 10-14% CMPA allergic to soy\n- Strong parental preference e.g. alternative for vegan\n\n**3. NOT to use mammalian milk**' },
        { title: 'Dietary Intervention - Over 1 Year Old', content: '- May use other plant-based milk with Ca\n  - Consider protein and calcium and iron\n  - Pea/soy based milk\n  - Oat milk (less preferred) if allergic to legume + needs extra cooking oil' },
        { title: 'Milk Ladder', content: '- **Stage 1:** Crackers, Digestive Biscuits, Pancakes\n- **Stage 2:** Cakes, Muffins, Pizza with cheese, Cooked puddings\n- **Stage 3:** Pasta with cream sauce, Cheese, EHF milk, Pasteurised milk\n- **Stage 4:** Yogurt\n\n**Remarks:**\n1. Always start from stage 1\n2. Try small amount on the first day, gradual increase to normal portion\n3. Try all food in the same stage' },
        { title: 'Oral Milk Challenge for Dx', content: '**Challenge substances:**\n- <12 months old: cow\'s milk based infant formula\n- >12 months old: full cream cow\'s milk\n\n**Challenge protocol (QMH; ASCIA) â€” Day 1:**\n\n| Time | ml of milk |\n| --- | --- |\n| 0 | Drop inside lip |\n| 20mins | 1ml |\n| 40mins | 5ml |\n| 60mins | 15ml |\n| 80mins | 40ml |\n| 100mins | 100ml |\n| Day total | 160ml |\n\nObserve for 2 hours post-challenge\n\n**Day 2:** 160ml/d milk at home\n\n**Day 3-14:** Increase amount as tolerated until all bottles are cow\'s milk based formula or daily amount is 200-300ml (>12 months of age)\n\n*Note: Completely or partly hydrolysed (HA) formula should NOT be used for milk challenges*' },
        { title: 'Common Q&A', content: '**Q1. Can we replace cow\'s milk with other mammalian milk e.g. goat?**\n-> No. 95% CMPA patient is allergic to goat milk also\n\n**Q2. Do we need to avoid beef because also cow\'s protein?**\n-> No. While beef allergy implies CMPA, CMPA usually tolerated beef protein because industrial process may reduce the allergenicity\n\n**Q3. When will the response achieved after starting elimination diet?**\n-> AF baby: 1-2 weeks of IgE-mediated; 2-4 weeks for non-IgE mediated\n-> BF baby: 2-4 weeks after maternal diet excluded any CMP\n\n**Q4. Should we choose AF with pre, pro or post-biotics to improve efficiency?**\n-> Not enough evidence\n\n**Q5. If my child has CMPA, should I delay or avoid CM-derived AF in my newborn?**\n-> No evidence of delay or avoidance of CM-derived AF could change the risk of CMPA in newborn with high risk of allergenic disease' }
      ],
      content: '',
      createdAt: '2025-03-12T17:56:00',
      updatedAt: '2025-03-12T17:56:00'
    },
    {
      id: 'seed_myasthenia_gravis',
      title: 'Myasthenia Gravis',
      category: 'Neurology',
      keywords: ['myasthenia gravis', 'pyridostigmine', 'acetylcholinesterase', 'bulbar', 'dysphagia', 'dysarthria', 'neuromuscular'],
      sections: [
        { title: 'Medical Treatment', content: '1. **Pyridostigmine**\n   - Oral acetylcholinesterase inhibitor\n   - Effective in bulbar symptoms\n     - Dysphagia, dysarthria, fatigue chew\n   - Onset: 15-30 mins\n   - Peak: 2 hr\n   - Lasting: 3-4 hr\n   - Max dose: 120mg Q3-4H' }
      ],
      content: '',
      createdAt: '2025-03-12T18:00:00',
      updatedAt: '2025-03-12T18:00:00'
    },
    {
      id: 'seed_parkinson_disease',
      title: 'Parkinson Disease',
      category: 'Neurology',
      keywords: ['parkinson', 'levodopa', 'dopamine', 'tremor', 'bradykinesia', 'protein redistribution', 'dysphagia', 'neurodegenerative'],
      sections: [
        { title: 'Introduction', content: '- Chronic progressive neurodegenerative disorder\n- Caused by dopamine depletion in brain' },
        { title: 'Symptoms', content: '- **Cognitive-linguistic deficit**\n  - Monotone\n  - Speak very fast/slow\n  - Repeated words\n  - Soft voice\n  - Slurring of speech\n  - Broken sentences\n  - Expressive aphasia\n  - Memory\n- **Dysgraphia/Micrographia** (writing disorder)\n- Cannot read probably\n- **Body language deficiency**\n  - Hypomimia (facial expression)\n  - Reduced gestural movement\n- **Movement**\n  - Postural imbalance\n  - Tremor\n  - Rigidity\n  - Bradykinesia\n- **Gastroparesis**' },
        { title: 'Non Dietary Treatment', content: '1. Levodopa for monotone and soft voice\n   - Usually effective after 0.5 hour\n2. Speech therapy\n3. Alternative and Augmentative Communication\n   - Menu (æºé€šç°¿)\n   - Use mobile to record daily conversation\n   - Use AI to mimic patient\'s voice' },
        { title: 'Assessment', content: '1. Body weight trend and BMI\n2. Dysphagia\n3. Constipation\n4. Cognitive impairment\n5. Lab:\n   - Vitamin D\n   - Folate\n   - Vitamin B12\n6. Side effects of levodopa\n   - e.g. anorexia, N&V, dry mouth' },
        { title: 'Dietetic Treatment', content: '1. **Protein redistribution**\n   - Protein intake will decrease levodopa efficacy\n   - Oral:\n     - Levodopa 30 mins before meal\n     - Lower protein at B&L\n     - More protein at dinner\n   - EN:\n     - Levodopa 1 hour before feed\n     - 30-40 mins post meal\n2. **Texture modification** according to dysphagia\n3. **Fermented milk with probiotics & prebiotics**\n   - No specific strain recommended\n   - Common:\n     - *Bifidobacterium longum*\n     - *Lactobacillus fermentum*\n     - *Lactobacillus acidophilus*\n     - *Lactobacillus plantarum*\n4. **Adequate vitamin D**' }
      ],
      content: '',
      createdAt: '2025-03-12T18:01:00',
      updatedAt: '2025-03-12T18:01:00'
    },
    {
      id: 'seed_eps_syndrome',
      title: 'Extrapyramidal Syndrome (EPS)',
      category: 'Neurology',
      keywords: ['EPS', 'extrapyramidal', 'dystonia', 'akathisia', 'parkinsonism', 'dopamine receptor blocker', 'drug induced'],
      sections: [
        { title: 'Definition', content: '- Extrapyramidal side effect syndrome\n- Drug induced motor disorder\n- Usually caused by dopamine receptor blocker' },
        { title: 'Signs and Symptoms', content: '- **Dystonia** (muscle contract involuntarily)\n- **Akathisia** (inability to stay still physically)\n- **Parkinsonism**' }
      ],
      content: '',
      createdAt: '2025-03-12T18:02:00',
      updatedAt: '2025-03-12T18:02:00'
    },
    {
      id: 'seed_guillain_barre',
      title: 'Guillain-BarrÃ© Syndrome',
      category: 'Neurology',
      keywords: ['guillain barre', 'GBS', 'autoimmune', 'peripheral neuropathy', 'ascending paralysis'],
      sections: [],
      content: '',
      createdAt: '2025-03-12T18:03:00',
      updatedAt: '2025-03-12T18:03:00'
    },
    {
      id: 'seed_stroke',
      title: 'Stroke',
      category: 'Neurology',
      keywords: ['stroke', 'ischemic', 'haemorrhagic', 'CVA', 'cerebrovascular', 'thrombolysis', 'NIHSS', 'antiplatelet'],
      sections: [
        { title: 'Introduction', content: 'Stroke is classified into two major types:\n- **Ischemia (80%)** â€” thrombosis, embolism, or systemic hypoperfusion\n- **Haemorrhage (20%)** â€” ICH or SAH\n\n**Ischemic stroke types:**\n- Large artery atherosclerosis\n  - Intracranial: MCA, Distal ICA, ACA, BA, Distal VA\n  - Extracranial: Proximal ICA, CCA, ECA, Proximal VA\n- Cardioembolism\n  - Caused by: AF, MS, CHF, PFO, cardiomyopathy etc.\n- Small vessel occlusion\n  - Lower mortality but higher risk of vascular dementia\n- Carotid or Vertebral Artery Dissection\n- Embolic of undetermined source' },
        { title: 'Medical Treatment', content: '**Ischemic stroke**\n1. Dual Antiplatelet Therapy (DAPT) e.g. aspirin, clopidogrel (usually <3 mo)\n2. Carotid endarterectomy (CEA): remove plaque from carotid artery\n3. Carotid artery stenting (CAS)\n4. IV thrombolysis\n5. Endovascular thrombectomy\n\n**Haemorrhagic stroke**\n1. BP control: aim 130-150 mmHg SBP, unknown if baseline SBP >220\n2. Reversal of coagulopathies if anticoagulant-associated ICH\n3. Evacuation for cerebellar ICH to avoid hydrocephalus and herniation\n4. Clot evacuation with minimal invasive technique for lobar hemorrhage' },
        { title: 'Assessment', content: '1. Body weight (overweight/obesity)\n2. Labs\n   - A1c, Lipid profile\n   - RFT\n3. Clinical:\n   - Central fever\n   - H\'stix\n   - Ventilator if any\n   - NIHSS for stroke deficit: 0-42 scores (higher = more severe)\n   - MOCA (for diet education)\n   - Type of stroke â†’ possible deficit' }
      ],
      content: '',
      createdAt: '2025-03-12T18:04:00',
      updatedAt: '2025-03-12T18:04:00'
    },
    {
      id: 'seed_als',
      title: 'Amyotrophic Lateral Sclerosis (ALS)',
      category: 'Neurology',
      keywords: ['ALS', 'amyotrophic lateral sclerosis', 'motor neurone', 'bulbar', 'dysphagia', 'respiratory failure', 'ESPEN'],
      sections: [
        { title: 'Introduction', content: '- **First type: Bulbar progressive paresis (25-35%)**\n  - Bulbar onset\n  - Usually develops dysarthria, dysphagia\n- **Second type: Motor neurone injury**\n  - Limbs/periphery onset\n- Average lifespan 3-5 years, only 5-10% > 10 years\n- Primary cause of death:\n  - Respiratory failure\n  - Malnutrition with dehydration' },
        { title: 'Clinical Presentation', content: '1. Chewing and swallowing difficulties\n2. Anorexia\n   - Distress, depression\n   - Polypharmacy\n3. Constipation\n   - Pelvic muscle weakness\n   - Limited activity\n   - Self restricted fluid intake\n   - Lack of fibre\n4. May increase energy requirement\n   - Due to laboured breathing, infections' },
        { title: 'Assessment', content: '1. Body weight trend\n2. Dysphagia, chewing difficulties\n3. Meal duration\n4. Anorexia\n5. BO pattern\n6. Fluid intake\n7. Fibre intake\n8. Cognitive function: dementia?' },
        { title: 'Dietary Intervention (ESPEN 2018)', content: '1. **Energy requirement**\n   - Non-ventilated: ~30 kcal/kg/d (see trend)\n   - Non-invasive ventilation: 25-30 kcal/kg/d\n2. **Weight management**\n   - BMI <25: weight gain\n   - BMI 25-35: weight maintenance\n   - BMI >35: weight loss\n3. **Meal fortification** +/- ONS if prolonged duration\n4. **EN/PN** should be discussed with patient\n   - But no evidence of improved survival rate' }
      ],
      content: '',
      createdAt: '2025-03-12T18:05:00',
      updatedAt: '2025-03-12T18:05:00'
    },
    {
      id: 'seed_melas',
      title: 'MELAS (Mitochondrial Encephalopathy Lactic Acidosis and Stroke-like Episodes)',
      category: 'Metabolism',
      keywords: ['MELAS', 'mitochondrial', 'encephalopathy', 'lactic acidosis', 'stroke-like', 'mtDNA', 'CoQ10', 'L-carnitine'],
      sections: [
        { title: 'Introduction', content: '- Mutation in mitochondrial DNA\n- Only inherited from mother (sperm mtDNA loss)\n- Symptoms varied with uneven distribution of mutated DNA in different organs\n- Build up of lactic acid in blood, brain and spinal fluid' },
        { title: 'Clinical Presentation', content: '1. Seizure\n2. Recurrent headache\n3. Recurrent vomiting\n4. Loss of appetite\n5. Short stature\n6. Fatigue\n7. Temporarily hemiparesis\n   - Altered consciousness\n   - Loss of vision, hearing, motor\n   - Altered intellectual ability/aphasia' },
        { title: 'Medical Treatment', content: '1. Anti-convulsant drug for seizure\n2. Cochlear implant for hearing loss\n3. CoQ10 / L-carnitine may increase energy\n4. Treadmill training to increase aerobic capacity' },
        { title: 'Assessment', content: '1. Body weight history\n2. LFT/RFT\n3. Lactate elevation\n4. Gastric dysmotility\n   - Background of chronic constipation\n   - Intestinal pseudo-obstruction (IPO)\n5. Blood sugar\n   - Higher risk of DM especially with mtDNA mutations\n   - Maybe related to impaired glucose-induced insulin secretion\n     - Impaired ATP-K channel closure\n     - Aging of pancreatic beta cells' },
        { title: 'Nutritional Interventions', content: '1. NG/NJ tube for sedated/encephalopathic patient\n   - Need gradual infusion (gastric dysmotility)\n   - Consider TPN if anticipate long term fasting' },
        { title: 'Further Research', content: '1. ALA\n2. L-carnitine\n3. CoQ10\n4. Riboflavin / folic acid\n5. Arginine' }
      ],
      content: '',
      createdAt: '2025-03-16T18:00:00',
      updatedAt: '2025-03-16T18:00:00'
    },
    {
      id: 'seed_alcohol_withdrawal',
      title: 'Alcohol Withdrawal',
      category: 'Metabolism',
      keywords: ['alcohol', 'withdrawal', 'GABA', 'thiamine', 'refeeding', 'delirium tremens', 'seizure', 'electrolyte'],
      sections: [
        { title: 'Introduction', content: '- Alcohol is a central nervous system depressant\n- Alcohol simultaneously enhances inhibitory tone (via modulation of GABA activity) and inhibits excitatory tone (via modulation of excitatory amino acid activity)\n- Only the constant presence of ethanol preserves homeostasis\n- Abrupt cessation unmasks the adaptive responses to chronic ethanol use, resulting in overactivity of the central nervous system\n- Usually occurs 6-24 hours of reduced/stopped drinking alcohol\n- May occur even with drinking habit for few weeks only' },
        { title: 'Clinical Presentation', content: '**Mild**\n1. Anxiety & agitation\n2. Tremor & palpitation\n3. Insomnia\n4. Headache\n5. LOA, N&V\n\n**Severe**\n1. Hallucination\n2. Seizure\n3. Delirium tremens (autonomic instability)' },
        { title: 'Medical Treatment', content: '*For symptom control and supportive care*\n1. Aim calm but alert sedation\n2. May require mechanical ventilation\n3. Thiamine' },
        { title: 'Assessment', content: '1. Electrolyte imbalance\n   - Low level of K, PO4, Mg\n2. Thiamine deficiency\n3. Refeeding risk\n4. Probable GI impairment for 1-2 days' },
        { title: 'Dietary Intervention', content: '1. Increased requirement due to\n   - Possible long term malnutrition\n   - Excited autonomic activities\n2. Refeeding precaution' }
      ],
      content: '',
      createdAt: '2025-03-16T18:01:00',
      updatedAt: '2025-03-16T18:01:00'
    },
    {
      id: 'seed_prepatellar_bursitis',
      title: 'Prepatellar Bursitis',
      category: 'Orthopaedics',
      keywords: ['prepatellar', 'bursitis', 'bursa', 'knee', 'inflammation', 'corticosteroid'],
      sections: [
        { title: 'Nature', content: '- Inflammation of small fluid filled sac (bursa) near the knee joints\n- Bursa is used to reduce friction and cushion the joints' },
        { title: 'Signs and Symptoms', content: '- Pain in knee\n- Limit mobility' },
        { title: 'Treatment', content: '- Antibiotic if infected\n- Physiotherapy to improve flexibility and muscle strengthening\n- Corticosteroid injection' }
      ],
      content: '',
      createdAt: '2025-03-16T18:10:00',
      updatedAt: '2025-03-16T18:10:00'
    },
    {
      id: 'seed_osteoporosis',
      title: 'Osteoporosis',
      category: 'Orthopaedics',
      keywords: ['osteoporosis', 'calcium', 'vitamin D', 'bone density', 'fracture'],
      sections: [
        { title: 'Dietetic Intervention', content: '1. **Adequate calcium intake**\n   - 1000-1200 mg/d\n   - Not to exceed 2000 mg/d\n   - Preferably from dietary source\n2. **Vitamin D intake**\n   - Aim 800 IU/d\n   - Upper limit: 4000 IU/d\n   - Sun exposure to face, arm, hands\n     - 10-15 minutes for young\n     - May need double of time for elderly' }
      ],
      content: '',
      createdAt: '2025-03-16T18:11:00',
      updatedAt: '2025-03-16T18:11:00'
    },
    {
      id: 'seed_amyloidosis',
      title: 'Amyloidosis',
      category: 'Neurology',
      keywords: ['amyloidosis', 'AL', 'ATTR', 'AA', 'amyloid', 'fibrils', 'malabsorption', 'protein-losing enteropathy', 'CKD'],
      sections: [
        { title: 'Introduction', content: '- Predominantly extracellular tissue deposition of fibrils composed of low molecular weight subunits of a variety of proteins (usually in plasma)\n- Common causes: chronic inflammation, CKD\n- **AL amyloids:**\n  - Plasma cell dyscrasia with immunoglobulin light chains\n- **ATTR amyloids:**\n  - Familial neuropathy / cardiomyopathy\n  - Ageing\n- **AA amyloid:**\n  - Complications from chronic inflammation e.g. RA, IBD, spondyloarthritis\n  - High-level production of serum amyloid A protein' },
        { title: 'Clinical Presentation â€” GI', content: '1. **GI bleeding**\n   - Caused by: Ischemia / infarction / Vascular friability / mucosal lesion\n2. **Malabsorption**\n   - Weight loss, diarrhea, steatorrhea\n   - Anorexia, dizziness, hypotension\n   - Caused by: mucosal infiltration, SIBO, pancreatic insufficiency\n3. **Protein-losing enteropathy**\n   - Diarrhea, edema, ascites\n   - Hypo Alb, pleural/pericardial effusion\n4. **GI dysmotility**\n   - Constipation/diarrhea\n   - N&V, pseudo IO\n   - Bloating, abdominal pain\n5. **Rare**\n   - Dysphagia, lower LES pressure\n   - Cholangitis\n   - Bowel obstruction / perforation' },
        { title: 'Clinical Presentation â€” By Type', content: '**AL**\n- Systemic disorder:\n  - Nephrotic proteinuria, edema, hepatosplenomegaly\n  - Unexplained heart failure, carpal tunnel syndrome\n\n**ATTR**\n- Heart failure (less severe than AL)\n\n**AA**\n- Nephrotic syndrome\n- Cardiac involvement when severe' }
      ],
      content: '',
      createdAt: '2025-03-16T18:20:00',
      updatedAt: '2025-03-16T18:20:00'
    },
    {
      id: 'seed_gout',
      title: 'Gout / Hyperuricemia',
      category: 'Orthopaedics',
      keywords: ['gout', 'uric acid', 'urate', 'UA', 'arthritis', 'hyperuricemia', 'purine', 'allopurinol', 'colchicine'],
      sections: [
        { title: 'Introduction', content: '- Chronic inflammatory arthritis, in one or more joints, most often the big toe\n- Occurs due to a build-up of monosodium urate crystals (a salt made of sodium and uric acid) in the joints\n- Main reason for UA build-up is due to insufficient excretion of UA via the kidneys and the gut\n- Gold standard for gout diagnosis is confirmation of monosodium urate crystals\n- **Risk factors:**\n  - Elderly\n  - Male / menopause\n  - CKD\n  - Beta blocker / diuretics / BP meds\n  - Immunosuppressant' },
        { title: 'Clinical Presentation', content: 'Occurs at joints:\n1. Pain\n2. Swelling\n3. Redness and tenderness' },
        { title: 'Medical Treatment', content: '1. NSAIDs\n2. Colchicine\n3. Allopurinol\n4. Corticosteroid' },
        { title: 'Assessment', content: '1. Weight\n2. A1c, urate, RFT\n3. Blood pressure\n4. Purine intake\n5. Fluid intake\n   - Alcohol' },
        { title: 'Dietary Intervention', content: '1. Weight management\n2. Glycemic, BP control to preserve renal function\n3. Reduce purine food intake\n   - Fish\n   - Red meat (particularly organ meats)\n   - Shellfish\n4. Reduce fructose intake\n5. Reduce alcohol, especially beer\n6. Anti-inflammatory diet\n   - Mediterranean diet\n   - Focus on fruits and vegetables\n7. Adequate fluid\n   - 6-8 cups daily\n8. Probiotics (no strong evidence)\n   - *Lactobacillus brevis* DM9218\n   - *Lactobacillus salivarius* CECT 30632' }
      ],
      content: '',
      createdAt: '2025-03-16T18:21:00',
      updatedAt: '2025-03-16T18:21:00'
    },
    {
      id: 'seed_long_covid',
      title: 'Long COVID',
      category: 'Respiratory',
      keywords: ['long COVID', 'post COVID', 'fatigue', 'alopecia', 'dyspnea', 'cough', 'persistent'],
      sections: [
        { title: 'Definition', content: '- Persistent after clearance of COVID virus\n- Usually 1 month after symptom onset, Dx or admission\n- Can persist >2 months\n- Cannot be explained by alternative Dx' },
        { title: 'Clinical Presentation', content: '- Alopecia\n- Pneumonia\n- GI upset\n  - Nausea\n  - Diarrhea\n- Myalgia/arthralgia\n- Neuropsychiatric manifestations\n  - Poor sleep\n  - Loss of taste and smell\n  - Anxiety\n  - Poor memory\n- Fatigue\n- Respiratory\n  - Cough\n  - Sputum\n  - SOB' }
      ],
      content: '',
      createdAt: '2025-03-16T18:30:00',
      updatedAt: '2025-03-16T18:30:00'
    },
    {
      id: 'seed_ventilator_setting',
      title: 'Ventilator Setting',
      category: 'Respiratory',
      keywords: ['ventilator', 'mechanical ventilation', 'PEEP', 'FiO2', 'tidal volume', 'CPAP', 'SIMV', 'pressure control', 'volume control'],
      sections: [
        { title: 'Primary Variables', content: '- **Volume control (VC):** deliver fixed amount of O2\n  - Variable peak inspiratory pressure depends on patient\'s lung compliance and resistance\n- **Pressure control (PC):** deliver fixed pressure\n  - Variable tidal volume\n  - Good to prevent overinflation & injury' },
        { title: 'Primary Modes', content: '- **Assist/Control (A/C)**\n  - Delivers a minimum number of preset mandatory breaths by the ventilator\n  - Patient can also trigger assisted breaths\n    - Machine will use positive pressure to assist\n  - Keep the patient\'s work of breathing requirement very low\n  - Respiratory alkalosis if over-ventilated\n- **Synchronous Intermittent Mandatory Ventilation (SIMV)**\n  - Delivers a preset minimum number of mandatory breaths\n  - Also allows the patient to initiate spontaneous breaths in between the preset breaths\n  - Indicated when a patient only needs partial ventilatory support\n  - Helps patients maintain their respiratory muscle strength and avoid muscular atrophy' },
        { title: 'Spontaneous Mode', content: '- **Continuous Positive Airway Pressure (CPAP)**\n  - Constant level of pressure above atmospheric pressure throughout the entire breathing cycle\n- **Pressure Support Ventilation (PSV)**\n  - Spontaneous breaths are supported by the ventilator during the inspiratory phase of breathing\n  - Overcome the airway resistance caused by the endotracheal tube\n- **Volume Support (VS)**\n  - Delivers a supported breath to help reach a set tidal volume' },
        { title: 'Other Modes', content: '- **Continuous Mandatory Ventilation (CMV):** ventilator controls both the rate and tidal volume; for fully sedated patients with neuromuscular blocking agents\n- **Airway Pressure Release Ventilation (APRV):** two levels of CPAP with intermittent release phase; to improve oxygenation and treat refractory hypoxemia\n- **Mandatory Minutes Ventilation (MMV):** increase mandatory breath when spontaneous breath reduced\n- **Pressure Regulated Volume Control (PRVC):** volume-controlled breaths with the lowest pressure possible; can be patient or time-triggered\n- **Adaptive Support Ventilation (ASV):** changes mandatory breaths and pressure support level according to how the patient is breathing\n- **Adaptive Pressure Control (APC):** uses variable inflation pressures to deliver a minimum targeted tidal volume\n- **High Frequency Oscillatory Ventilation (HFOV):** delivers very small tidal volumes at extremely fast rate; minimize lung injury' },
        { title: 'Ventilator Parameters', content: '**Tidal volume**\n- Amount of gas inhaled and exhaled from the lungs during normal breathing\n\n**Respiratory rate (RR)**\n- Breathing rate\n- Normal range 10-20/min\n\n**Fraction of inspired oxygen (FiO2)**\n- Concentration of oxygen in inhaled gas\n- Aim to wean down as it may cause intoxication\n  - If prolonged >60% FiO2\n\n**Flow rate**\n- Rate that controls how fast a tidal volume is delivered by the ventilator\n- Normal range: 60 L/min, up to 120 L/min for obstruction\n\n**Inspiration-to-expiration ratio (I:E ratio)**\n- Normal range: 1.2-1.4\n- Larger I:E ratio may be delivered if patient needs longer expiratory time due to air trapping\n\n**Trigger sensitivity**\n- How much effort (negative pressure) the patient must generate to trigger a breath\n- Normal range: between -1 and -2 cmH2O\n\n**Positive End Expiratory Pressure (PEEP)**\n- Positive pressure provided during the expiratory phase\n- Prevent closure of alveoli and allow increased time for oxygen exchange\n- Typically indicated in patients with refractory hypoxemia\n- Normal range: 4-6 cmH2O' }
      ],
      content: '',
      createdAt: '2025-03-16T18:31:00',
      updatedAt: '2025-03-16T18:31:00'
    },
    {
      id: 'seed_copd',
      title: 'Chronic Obstructive Pulmonary Disease (COPD)',
      category: 'Respiratory',
      keywords: ['COPD', 'chronic obstructive', 'pulmonary', 'cachexia', 'smoking', 'bronchodilator', 'exacerbation', 'dyspnea'],
      sections: [
        { title: 'Introduction', content: '- Heterogeneous lung condition characterized by chronic respiratory symptoms due to abnormalities of the airway and/or alveoli that cause persistent, often progressive, airflow obstruction\n- Pulmonary cachexia syndrome in COPD maybe caused by tissue hypoxia, disuse atrophy, malnutrition and change in metabolism\n- **Risk factors:**\n  - Smoking, air pollution\n  - Exposure to biomass\n  - Small / ageing lung\n\n**GOLD Grading:**\n\n| COPD Severity | Lung Function |\n|---|---|\n| GOLD I: mild | FEVâ‚ â‰¥80% predicted |\n| GOLD II: moderate | FEVâ‚ â‰¥50-80% predicted |\n| GOLD III: severe | FEVâ‚ â‰¥30-<50% predicted |\n| GOLD IV: very severe | FEVâ‚ <30% predicted |' },
        { title: 'Clinical Presentation', content: '1. Few complaints but extreme sedentary lifestyle\n2. Exertional breathlessness\n3. Chronic cough (worse in morning)\n4. Regular sputum production\n5. Frequent winter bronchitis\n6. Wheeze\n7. Peripheral edema (severe case)' },
        { title: 'Medical Treatment', content: '1. Smoking cessation\n2. Inhaled therapy\n   - Short-acting bronchodilator\n   - Inhaled corticosteroid\n   - Combined therapy\n3. Oral corticosteroid\n   - Common after exacerbation & cannot wean off\n   - May reduce lung function if >60 mg/d\n4. Oxygen therapy\n5. Antibiotics\n   - Long term can reduce exacerbation for 1 year\n   - But increased antibiotic resistance\n6. Pulmonary rehabilitation' },
        { title: 'Assessment', content: '1. Weight history (esp. BW loss >3 kg)\n2. BMI range (20-25 for COPD NICE)\n   - FFM is more important\n3. Oral intake\n4. Handgrip strength\n5. Glucocorticoid usage' },
        { title: 'Nutritional Intervention', content: '1. Weight reduction for obese if dyspnea\n2. Keep BMI above 21\n   - Need exercise to increase FFM\n3. Energy requirement\n   - 30 kcal/kg for sedentary\n   - May need 45 kcal/kg for weight gain\n4. Protein requirements\n   - 1.0-1.2 g/d for elderly\n   - 1.2-1.5 g/d for malnourished\n5. ?Increase fruit and veg intake\n   - Provide antioxidants\n   - Some meta analysis proved' },
        { title: 'Future Research', content: '1. PUFA and Vit D to reduce inflammation and preserve muscle' }
      ],
      content: '',
      createdAt: '2025-03-16T18:32:00',
      updatedAt: '2025-03-16T18:32:00'
    }
  ];
  return { specialties: seedSpecialties, notes: seedNotes };
}

/* ===== INIT ===== */
(function initApp() {
  /* Try to load from IndexedDB first; if empty, load seed data */
  loadLocal().then(function(data) {
    if (data && (data.notes.length > 0 || data.specialties.length > 0)) {
      specialties = data.specialties || [];
      notes = data.notes || [];
    } else {
      /* No existing data â€” load seed data */
      var seed = getSeedData();
      specialties = seed.specialties;
      notes = seed.notes;
      persistLocal();
    }
    renderSidebar();
    updateSyncUI();

    /* Try to restore Firebase config and auto-connect */
    return loadFirebaseConfig();
  }).then(function(fbConfig) {
    if (fbConfig && fbConfig.apiKey) {
      initFirebase(fbConfig);
    }
  }).catch(function() {
    /* IndexedDB not available (e.g., Poe iframe) â€” load seed data in memory */
    var seed = getSeedData();
    specialties = seed.specialties;
    notes = seed.notes;
    renderSidebar();
    updateSyncUI();
  });
})();
</script>
</body>
</html>
