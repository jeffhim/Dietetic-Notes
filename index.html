<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jeffrey's Dietetics</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
  <style>
    :root {
      --c-primary: #2DD4BF;
      --c-primary-hover: #45E0CC;
      --c-primary-light: #E0FBF6;
      --c-primary-deep: #14B8A6;
      --c-accent: #2DD4BF;
      --c-danger: #EF4444;
      --c-danger-hover: #DC2626;
      --c-bg: #F0F4F3;
      --c-surface: #FFFFFF;
      --c-surface-2: #E6EDEB;
      --c-text: #0F1729;
      --c-text-secondary: #475569;
      --c-text-muted: #94A3B8;
      --c-border: #CBD5E1;
      --c-overlay: rgba(0,0,0,0.45);
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 14px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 18px;
      --font-main: 'Nunito', sans-serif;
      --font-accent: 'Nunito', sans-serif;
      --transition: 0.2s ease;
    }
    html.dark {
      --c-primary: #2DD4BF;
      --c-primary-hover: #45E0CC;
      --c-primary-light: #0D2D2A;
      --c-primary-deep: #14B8A6;
      --c-accent: #2DD4BF;
      --c-bg: #0B1019;
      --c-surface: #141B2D;
      --c-surface-2: #1E293B;
      --c-text: #E2E8F0;
      --c-text-secondary: #94A3B8;
      --c-text-muted: #64748B;
      --c-border: #1E293B;
      --c-overlay: rgba(0,0,0,0.65);
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 14px rgba(0,0,0,0.35);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.45);
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 16px; height: 100%; }
    body { font-family: var(--font-main); background: var(--c-bg); color: var(--c-text); height: 100vh; overflow: hidden; line-height: 1.6; }
    button { font-family: inherit; cursor: pointer; border: none; background: none; }
    input { font-family: inherit; font-size: 16px; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--c-border); border-radius: 3px; }

    /* ── SETUP ─────────────────────────────────────── */
    #setup-screen {
      display: flex; align-items: center; justify-content: center; height: 100vh;
      background: linear-gradient(160deg, #070B14 0%, #0B1019 35%, #0D2D2A 100%);
      overflow: auto; padding: 20px; position: relative;
    }
    html.dark #setup-screen { background: linear-gradient(160deg, #060A12 0%, #0B1019 35%, #0A2420 100%); }
    #setup-screen::before { content:''; position:absolute; width:500px; height:500px; background:radial-gradient(circle,rgba(45,212,191,0.1) 0%,transparent 70%); top:-80px; right:-80px; pointer-events:none; }
    .setup-card { background:rgba(255,255,255,0.06); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,0.1); border-radius:var(--radius-lg); padding:40px 36px; text-align:center; max-width:460px; width:100%; animation:fadeUp .6s ease-out; position:relative; z-index:1; }
    @keyframes fadeUp { from{opacity:0;transform:translateY(24px)} to{opacity:1;transform:translateY(0)} }
    .setup-logo { font-size:48px; margin-bottom:8px; line-height:1; }
    .setup-logo img { width:64px; height:64px; border-radius:50%; object-fit:cover; object-position:center top; border:2px solid rgba(45,212,191,0.4); }
    .setup-card h1 { font-family:var(--font-accent); font-size:28px; color:#E2E8F0; margin-bottom:4px; font-weight:800; }
    .setup-card .subtitle { color:rgba(255,255,255,0.45); font-size:13px; margin-bottom:28px; font-weight:500; }
    .setup-tabs { display:flex; gap:4px; background:rgba(255,255,255,0.06); border-radius:8px; padding:3px; margin-bottom:24px; }
    .setup-tab { flex:1; padding:9px 12px; border-radius:6px; font-size:13px; font-weight:700; color:rgba(255,255,255,0.5); transition:all var(--transition); }
    .setup-tab.active { background:rgba(45,212,191,0.25); color:#2DD4BF; }
    .setup-tab:hover:not(.active) { color:rgba(255,255,255,0.7); }
    .setup-panel { display:none; } .setup-panel.active { display:block; }
    .cfg-field { text-align:left; margin-bottom:12px; }
    .cfg-field label { display:block; font-size:11px; font-weight:700; color:rgba(255,255,255,0.5); margin-bottom:3px; text-transform:uppercase; letter-spacing:.5px; }
    .cfg-field input { width:100%; padding:9px 12px; border:1px solid rgba(255,255,255,0.12); border-radius:var(--radius-sm); background:rgba(0,0,0,0.3); color:#E2E8F0; font-size:14px; outline:none; }
    .cfg-field input:focus { border-color:var(--c-primary); }
    .cfg-field input::placeholder { color:rgba(255,255,255,0.2); }
    .btn-connect { display:flex; align-items:center; justify-content:center; gap:8px; width:100%; margin-top:20px; padding:12px; border-radius:50px; background:var(--c-primary); color:#0B1019; font-size:15px; font-weight:700; transition:all var(--transition); box-shadow:0 4px 20px rgba(45,212,191,0.3); }
    .btn-connect:hover { background:var(--c-primary-hover); transform:translateY(-1px); }
    .demo-desc { color:rgba(255,255,255,0.55); font-size:13.5px; line-height:1.7; margin-bottom:24px; text-align:left; }
    .demo-desc strong { color:rgba(255,255,255,0.8); }
    .btn-demo { display:flex; align-items:center; justify-content:center; gap:8px; width:100%; padding:12px; border-radius:50px; background:rgba(255,255,255,0.08); color:#E2E8F0; font-size:15px; font-weight:700; transition:all var(--transition); border:1px solid rgba(255,255,255,0.12); }
    .btn-demo:hover { background:rgba(255,255,255,0.16); transform:translateY(-1px); }
    .setup-footer { margin-top:24px; font-size:11px; color:rgba(255,255,255,0.25); }
    .setup-error { background:rgba(192,57,43,0.2); color:#F1948A; padding:10px 14px; border-radius:var(--radius-sm); font-size:13px; margin-top:12px; display:none; text-align:left; }
    .setup-error.active { display:block; }

    /* ── LOGIN ─────────────────────────────────────── */
    #login-screen { display:none; align-items:center; justify-content:center; height:100vh; background:linear-gradient(160deg,#070B14 0%,#0B1019 35%,#0D2D2A 100%); }
    html.dark #login-screen { background:linear-gradient(160deg,#060A12 0%,#0B1019 35%,#0A2420 100%); }
    .login-card { background:rgba(255,255,255,0.06); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,0.1); border-radius:var(--radius-lg); padding:48px 40px; text-align:center; max-width:420px; width:90%; animation:fadeUp .5s ease-out; }
    .login-card h1 { font-family:var(--font-accent); font-size:28px; color:#E2E8F0; margin-bottom:4px; font-weight:800; }
    .login-card .subtitle { color:rgba(255,255,255,0.45); font-size:13px; margin-bottom:36px; font-weight:500; }
    .btn-google { display:inline-flex; align-items:center; gap:10px; background:#FFF; color:#333; font-size:15px; font-weight:700; padding:12px 28px; border-radius:50px; transition:all var(--transition); box-shadow:var(--shadow-md); }
    .btn-google:hover { transform:translateY(-1px); box-shadow:var(--shadow-lg); }
    .btn-google svg { width:20px; height:20px; }
    .btn-back-setup { margin-top:16px; font-size:13px; color:rgba(255,255,255,0.4); text-decoration:underline; font-weight:600; }

    /* ── MAIN APP ──────────────────────────────────── */
    #app { display:none; height:100vh; flex-direction:column; overflow:hidden; }
    #app.active { display:flex; }

    /* ── NAV BAR ───────────────────────────────────── */
    .navbar {
      display:flex; align-items:center; gap:10px;
      padding:14px 16px; background:var(--c-surface);
      border-bottom:1px solid var(--c-border); flex-shrink:0;
    }
    .btn-nav-back {
      display:flex; align-items:center; gap:5px;
      padding:6px 12px; border-radius:var(--radius-sm);
      font-size:14px; font-weight:600; color:var(--c-primary);
      transition:all var(--transition);
    }
    .btn-nav-back:hover { background:var(--c-primary-light); }
    .btn-nav-back i { font-size:12px; }
    .nav-avatar { width:34px; height:34px; border-radius:50%; object-fit:cover; object-position:center top; flex-shrink:0; border:2px solid var(--c-primary); }
    .nav-title { flex:1; font-family:var(--font-accent); font-size:18px; font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .nav-subtitle { font-size:12px; color:var(--c-text-muted); margin-left:8px; font-family:var(--font-main); font-weight:400; }
    .mode-chip { padding:3px 10px; border-radius:20px; background:rgba(45,212,191,0.12); color:var(--c-primary); font-size:11px; font-weight:700; flex-shrink:0; }
    .btn-topbar { width:34px; height:34px; border-radius:var(--radius-sm); display:flex; align-items:center; justify-content:center; color:var(--c-text-muted); font-size:14px; transition:all var(--transition); flex-shrink:0; }
    .btn-topbar:hover { background:var(--c-surface-2); color:var(--c-text); }

    /* ── VIEWS ─────────────────────────────────────── */
    .view { display:none; flex:1; flex-direction:column; overflow:hidden; }
    .view.active { display:flex; }

    /* ── LIST VIEW (shared by categories / specs) ─── */
    .list-scroll { flex:1; overflow-y:auto; padding:12px; }
    .list-item {
      display:flex; align-items:center; gap:12px;
      padding:14px 16px; margin-bottom:8px;
      border-radius:var(--radius-md); background:var(--c-surface);
      border:1px solid var(--c-border); cursor:pointer;
      transition:all var(--transition); box-shadow:var(--shadow-sm);
    }
    .list-item:hover { box-shadow:var(--shadow-md); border-color:var(--c-primary); }
    .list-item:active { transform:scale(0.99); }
    .list-item .li-icon {
      width:40px; height:40px; border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      font-size:16px; flex-shrink:0;
    }
    .li-icon.cat-icon { background:rgba(45,212,191,0.1); color:var(--c-primary); }
    .li-icon.spec-icon { background:rgba(45,212,191,0.08); color:var(--c-primary); }
    .list-item .li-body { flex:1; min-width:0; }
    .list-item .li-name { font-weight:700; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .list-item .li-meta { font-size:12px; color:var(--c-text-muted); margin-top:1px; font-weight:500; }
    .list-item .li-arrow { color:var(--c-text-muted); font-size:13px; flex-shrink:0; margin-left:4px; }
    .list-item .li-actions { display:flex; gap:2px; flex-shrink:0; }
    .li-actions .act-btn {
      width:32px; height:32px; border-radius:var(--radius-sm);
      display:flex; align-items:center; justify-content:center;
      color:var(--c-text-muted); font-size:12px; transition:all var(--transition);
    }
    .li-actions .act-btn:hover { background:var(--c-surface-2); color:var(--c-text); }
    .li-actions .act-btn.danger:hover { background:rgba(192,57,43,0.1); color:var(--c-danger); }

    /* ── NOTE CARD (flat, no icon, with tag bubble + preview) ── */
    .note-card {
      padding:18px 20px; margin-bottom:4px; cursor:pointer;
      border-bottom:1px solid var(--c-border);
      transition:background var(--transition);
    }
    .note-card:last-child { border-bottom:none; }
    .note-card:hover { background:var(--c-surface-2); }
    .note-card:active { opacity:0.85; }
    .note-card .nc-title {
      font-weight:700; font-size:16px; margin-bottom:5px;
      color:var(--c-text); line-height:1.35;
    }
    .note-card .nc-row {
      display:flex; align-items:center; gap:8px; margin-bottom:6px; flex-wrap:wrap;
    }
    .nc-tag {
      display:inline-block; padding:2px 10px; border-radius:6px;
      font-size:12px; font-weight:700; line-height:1.6;
      background:rgba(45,212,191,0.15); color:var(--c-primary);
    }
    .nc-date { font-size:13px; color:var(--c-text-muted); font-weight:500; }
    .note-card .nc-preview {
      font-size:14px; color:var(--c-text-secondary); line-height:1.55;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
      overflow:hidden; font-weight:400;
    }
    .note-card .nc-actions {
      display:flex; gap:2px; position:absolute; top:12px; right:12px;
      opacity:0; transition:opacity var(--transition);
    }
    .note-card { position:relative; }
    .note-card:hover .nc-actions { opacity:1; }
    .nc-actions .act-btn {
      width:28px; height:28px; border-radius:6px;
      display:flex; align-items:center; justify-content:center;
      color:var(--c-text-muted); font-size:11px; transition:all var(--transition);
      background:var(--c-surface);
    }
    .nc-actions .act-btn:hover { background:var(--c-surface-2); color:var(--c-text); }
    .nc-actions .act-btn.danger:hover { background:rgba(239,68,68,0.1); color:var(--c-danger); }

    /* ── MOVE DIALOG ──────────────────────────────── */
    .move-overlay { display:none; position:fixed; inset:0; background:var(--c-overlay); z-index:1000; align-items:center; justify-content:center; }
    .move-overlay.active { display:flex; animation:fadeIn .15s ease; }
    .move-box { background:var(--c-surface); border-radius:var(--radius-md); padding:28px; max-width:420px; width:90%; box-shadow:var(--shadow-lg); animation:scaleIn .2s ease; }
    .move-box h3 { font-size:17px; font-weight:700; margin-bottom:4px; }
    .move-box .move-subtitle { font-size:13px; color:var(--c-text-secondary); margin-bottom:20px; line-height:1.4; }
    .move-field { margin-bottom:16px; }
    .move-field label { display:block; font-size:12px; font-weight:700; color:var(--c-text-muted); margin-bottom:6px; text-transform:uppercase; letter-spacing:.4px; }
    .move-field select {
      width:100%; padding:10px 14px; border:1px solid var(--c-border);
      border-radius:var(--radius-sm); font-size:16px; font-family:var(--font-main);
      background:var(--c-bg); color:var(--c-text); outline:none;
      appearance:none; -webkit-appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24'%3E%3Cpath fill='%2394A3B8' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:right 12px center; background-size:16px;
      cursor:pointer;
    }
    .move-field select:focus { border-color:var(--c-primary); }
    .move-field select option { background:var(--c-surface); color:var(--c-text); }
    .move-field .move-empty { font-size:13px; color:var(--c-text-muted); font-style:italic; padding:6px 0; }
    .move-current { display:inline-flex; align-items:center; gap:6px; padding:4px 12px; border-radius:6px; background:rgba(45,212,191,0.1); color:var(--c-primary); font-size:12px; font-weight:700; margin-bottom:16px; }
    .move-current i { font-size:10px; }
    .move-buttons { display:flex; justify-content:flex-end; gap:8px; margin-top:20px; }
    .move-buttons button { padding:9px 20px; border-radius:var(--radius-sm); font-size:14px; font-weight:600; transition:all var(--transition); }
    .btn-move-cancel { color:var(--c-text-secondary); background:var(--c-surface-2); }
    .btn-move-cancel:hover { background:var(--c-border); }
    .btn-move-confirm { color:#0B1019; background:var(--c-primary); }
    .btn-move-confirm:hover { background:var(--c-primary-hover); }
    .btn-move-confirm:disabled { opacity:0.4; cursor:not-allowed; }

    /* ── TEMPLATE EDITOR ─────────────────────────── */
    .tpl-overlay { display:none; position:fixed; inset:0; background:var(--c-overlay); z-index:1000; align-items:center; justify-content:center; }
    .tpl-overlay.active { display:flex; animation:fadeIn .15s ease; }
    .tpl-box { background:var(--c-surface); border-radius:var(--radius-md); padding:28px; max-width:440px; width:90%; max-height:85vh; display:flex; flex-direction:column; box-shadow:var(--shadow-lg); animation:scaleIn .2s ease; }
    .tpl-box h3 { font-size:17px; font-weight:700; margin-bottom:4px; flex-shrink:0; }
    .tpl-box .tpl-subtitle { font-size:13px; color:var(--c-text-secondary); margin-bottom:16px; line-height:1.4; flex-shrink:0; }
    .tpl-sections { overflow-y:auto; margin-bottom:12px; min-height:0; }
    .tpl-row { display:flex; align-items:center; gap:6px; padding:8px 0; border-bottom:1px solid var(--c-border); }
    .tpl-row:last-child { border-bottom:none; }
    .tpl-row .tpl-num { font-size:11px; color:var(--c-text-muted); font-weight:700; width:20px; text-align:center; flex-shrink:0; }
    .tpl-row input {
      flex:1; border:1px solid transparent; background:transparent; color:var(--c-text);
      font-family:var(--font-main); font-size:15px; font-weight:600; padding:6px 10px;
      border-radius:6px; outline:none; min-width:0;
    }
    .tpl-row input:focus { border-color:var(--c-primary); background:var(--c-bg); }
    .tpl-row input::placeholder { color:var(--c-text-muted); font-weight:400; }
    .tpl-row .tpl-btns { display:flex; gap:1px; flex-shrink:0; }
    .tpl-row .tpl-btn {
      width:28px; height:28px; border-radius:6px;
      display:flex; align-items:center; justify-content:center;
      color:var(--c-text-muted); font-size:10px; transition:all var(--transition);
    }
    .tpl-row .tpl-btn:hover { background:var(--c-surface-2); color:var(--c-text); }
    .tpl-row .tpl-btn.danger:hover { background:rgba(239,68,68,0.1); color:var(--c-danger); }
    .tpl-row .tpl-btn:disabled { opacity:0.2; cursor:default; }
    .tpl-row .tpl-btn:disabled:hover { background:transparent; color:var(--c-text-muted); }
    .tpl-add-btn {
      display:flex; align-items:center; gap:6px; padding:9px 14px; border-radius:var(--radius-sm);
      font-size:14px; font-weight:600; color:var(--c-primary); background:rgba(45,212,191,0.08);
      transition:all var(--transition); margin-bottom:8px; flex-shrink:0;
    }
    .tpl-add-btn:hover { background:rgba(45,212,191,0.16); }
    .tpl-add-btn i { font-size:12px; }
    .tpl-hint { font-size:12px; color:var(--c-text-muted); margin-bottom:16px; line-height:1.5; flex-shrink:0; }
    .tpl-empty { text-align:center; padding:24px 0; color:var(--c-text-muted); font-size:13px; }
    .tpl-buttons { display:flex; justify-content:flex-end; gap:8px; flex-shrink:0; }
    .tpl-buttons button { padding:9px 20px; border-radius:var(--radius-sm); font-size:14px; font-weight:600; transition:all var(--transition); }
    .btn-tpl-cancel { color:var(--c-text-secondary); background:var(--c-surface-2); }
    .btn-tpl-cancel:hover { background:var(--c-border); }
    .btn-tpl-save { color:#0B1019; background:var(--c-primary); }
    .btn-tpl-save:hover { background:var(--c-primary-hover); }

    /* ── NEW NOTE DIALOG ──────────────────────────── */
    .newnote-overlay { display:none; position:fixed; inset:0; background:var(--c-overlay); z-index:1000; align-items:center; justify-content:center; }
    .newnote-overlay.active { display:flex; animation:fadeIn .15s ease; }
    .newnote-box { background:var(--c-surface); border-radius:var(--radius-md); padding:28px; max-width:460px; width:92%; max-height:85vh; display:flex; flex-direction:column; box-shadow:var(--shadow-lg); animation:scaleIn .2s ease; }
    .newnote-box h3 { font-size:17px; font-weight:700; margin-bottom:4px; flex-shrink:0; display:flex; align-items:center; gap:8px; }
    .newnote-box h3 i { color:var(--c-primary); font-size:15px; }
    .newnote-box .newnote-subtitle { font-size:13px; color:var(--c-text-secondary); margin-bottom:16px; line-height:1.4; flex-shrink:0; }
    .newnote-title-field { margin-bottom:18px; flex-shrink:0; }
    .newnote-title-field label { display:block; font-size:12px; font-weight:700; color:var(--c-text-muted); margin-bottom:6px; text-transform:uppercase; letter-spacing:.4px; }
    .newnote-title-field input {
      width:100%; padding:10px 14px; border:1px solid var(--c-border); border-radius:var(--radius-sm);
      font-size:16px; font-family:var(--font-main); font-weight:700; background:var(--c-bg);
      color:var(--c-text); outline:none;
    }
    .newnote-title-field input:focus { border-color:var(--c-primary); }
    .newnote-title-field input::placeholder { color:var(--c-text-muted); font-weight:400; }
    .newnote-sec-label { font-size:12px; font-weight:700; color:var(--c-text-muted); text-transform:uppercase; letter-spacing:.4px; margin-bottom:8px; flex-shrink:0; }
    .newnote-sections { overflow-y:auto; margin-bottom:12px; min-height:0; }
    .newnote-nosec { text-align:center; padding:18px 0; color:var(--c-text-muted); font-size:13px; font-style:italic; }
    .newnote-buttons { display:flex; justify-content:flex-end; gap:8px; flex-shrink:0; margin-top:4px; }
    .newnote-buttons button { padding:9px 20px; border-radius:var(--radius-sm); font-size:14px; font-weight:600; transition:all var(--transition); }
    .btn-newnote-cancel { color:var(--c-text-secondary); background:var(--c-surface-2); }
    .btn-newnote-cancel:hover { background:var(--c-border); }
    .btn-newnote-create { color:#0B1019; background:var(--c-primary); display:flex; align-items:center; gap:6px; }
    .btn-newnote-create:hover { background:var(--c-primary-hover); }

    .empty-list { text-align:center; padding:60px 30px; }
    .empty-list .ei { font-size:48px; opacity:0.15; margin-bottom:16px; }
    .empty-list h3 { font-family:var(--font-accent); font-size:18px; color:var(--c-text-secondary); margin-bottom:6px; font-weight:500; }
    .empty-list p { font-size:13px; color:var(--c-text-muted); line-height:1.7; max-width:260px; margin:0 auto; }

    .fab {
      position:fixed; bottom:20px; right:20px; z-index:50;
      width:52px; height:52px; border-radius:50%;
      background:var(--c-primary); color:#0B1019; font-size:20px;
      display:none; align-items:center; justify-content:center;
      box-shadow:0 4px 20px rgba(45,212,191,0.35); transition:all var(--transition);
    }
    .fab.visible { display:flex; }
    .fab:hover { background:var(--c-primary-hover); transform:scale(1.08); }

    /* ── EDITOR VIEW ───────────────────────────────── */
    .save-status { font-size:12px; display:flex; align-items:center; gap:4px; color:var(--c-text-muted); flex-shrink:0; font-weight:600; }
    .save-status.saving { color:var(--c-accent); }
    .save-status.saved { color:var(--c-primary); }
    .save-status.error { color:var(--c-danger); }
    .editor-body { flex:1; display:flex; flex-direction:column; overflow:hidden; background:var(--c-surface); }
    .note-title-wrap { padding:20px 20px 0; }
    #note-title { width:100%; border:none; outline:none; font-family:var(--font-main); font-size:24px; font-weight:800; color:var(--c-text); background:transparent; padding:0; }
    #note-title::placeholder { color:var(--c-text-muted); }
    .note-meta { padding:4px 20px 12px; font-size:12px; color:var(--c-text-muted); font-weight:500; }
    .editor-quill { flex:1; display:flex; flex-direction:column; overflow:hidden; position:relative; }
    .ql-toolbar.ql-snow { border:none !important; border-top:1px solid var(--c-border) !important; border-bottom:1px solid var(--c-border) !important; background:var(--c-surface-2); padding:5px 16px !important; flex-shrink:0; }
    .ql-container.ql-snow { border:none !important; flex:1; overflow-y:auto; font-family:var(--font-main); font-size:15px; position:relative; }
    .ql-editor { padding:16px 20px 60px !important; color:var(--c-text); line-height:1.75; min-height:100%; }
    .ql-editor.ql-blank::before { color:var(--c-text-muted) !important; font-style:normal !important; }
    .ql-editor h2 { margin-top:28px; margin-bottom:8px; padding-bottom:6px; border-bottom:2px solid rgba(45,212,191,0.15); }
    .ql-editor h2:first-child { margin-top:0; }
    .ql-editor h3 { margin-top:20px; margin-bottom:6px; }
    .ql-editor ol, .ql-editor ul { margin-bottom:10px; }
    .ql-editor p { margin-bottom:2px; }
    .ql-editor a { color:var(--c-primary) !important; text-decoration:underline; }
    .ql-editor img { max-width:100%; height:auto; border-radius:6px; margin:8px 0; }
    /* Image picker dialog */
    .btn-img-upload {
      display:flex; align-items:center; justify-content:center; gap:10px;
      width:100%; padding:18px 16px; border-radius:var(--radius-sm);
      border:2px dashed var(--c-border); background:var(--c-bg);
      color:var(--c-text); font-size:15px; font-weight:600; font-family:var(--font-main);
      cursor:pointer; transition:all var(--transition); margin-bottom:0;
    }
    .btn-img-upload:hover { border-color:var(--c-primary); background:rgba(45,212,191,0.05); color:var(--c-primary); }
    .btn-img-upload i { font-size:18px; color:var(--c-primary); }
    .img-divider {
      display:flex; align-items:center; gap:12px; margin:14px 0;
      color:var(--c-text-muted); font-size:12px; font-weight:600;
    }
    .img-divider::before, .img-divider::after { content:''; flex:1; height:1px; background:var(--c-border); }
    .img-url-row { display:flex; gap:8px; }
    .img-url-input {
      flex:1; padding:9px 12px; border:1px solid var(--c-border); border-radius:var(--radius-sm);
      font-size:14px; background:var(--c-bg); color:var(--c-text); outline:none; font-family:var(--font-main); min-width:0;
    }
    .img-url-input:focus { border-color:var(--c-primary); }
    .img-url-input::placeholder { color:var(--c-text-muted); }
    .img-url-btn { padding:9px 16px !important; flex-shrink:0; font-size:13px !important; }
    .img-status { font-size:12px; margin-top:8px; min-height:18px; font-weight:600; }
    /* Image resize overlay */
    .ql-editor img { cursor:pointer; }
    .img-resize-wrap {
      position:absolute; z-index:50; pointer-events:none;
      border:2px solid var(--c-primary);
      box-shadow:0 0 0 1px rgba(45,212,191,0.2);
    }
    .img-resize-wrap .img-handle {
      position:absolute; width:12px; height:12px; background:var(--c-primary);
      border:2px solid var(--c-surface); border-radius:2px; pointer-events:all; z-index:51;
    }
    .img-handle.h-se { bottom:-6px; right:-6px; cursor:nwse-resize; }
    .img-handle.h-sw { bottom:-6px; left:-6px; cursor:nesw-resize; }
    .img-handle.h-ne { top:-6px; right:-6px; cursor:nesw-resize; }
    .img-handle.h-nw { top:-6px; left:-6px; cursor:nwse-resize; }
    .img-resize-info {
      position:absolute; bottom:-28px; left:50%; transform:translateX(-50%);
      background:var(--c-surface); border:1px solid var(--c-border); border-radius:4px;
      padding:2px 8px; font-size:11px; font-weight:700; color:var(--c-text-muted);
      white-space:nowrap; pointer-events:none; box-shadow:var(--shadow-sm);
    }
    /* ── AI IMPORT OVERLAY ──────────────────────── */
    .import-overlay { display:none; position:fixed; inset:0; background:var(--c-overlay); z-index:1000; align-items:center; justify-content:center; }
    .import-overlay.active { display:flex; animation:fadeIn .15s ease; }
    .import-box { background:var(--c-surface); border-radius:var(--radius-md); padding:28px; max-width:520px; width:92%; max-height:88vh; display:flex; flex-direction:column; box-shadow:var(--shadow-lg); animation:scaleIn .2s ease; }
    .import-box h3 { font-size:17px; font-weight:700; margin-bottom:4px; display:flex; align-items:center; gap:8px; }
    .import-box h3 i { color:var(--c-primary); font-size:16px; }
    .import-box .import-subtitle { font-size:13px; color:var(--c-text-secondary); margin-bottom:18px; line-height:1.5; }
    .import-dropzone {
      border:2px dashed var(--c-border); border-radius:var(--radius-sm); padding:28px 20px;
      text-align:center; cursor:pointer; transition:all var(--transition); margin-bottom:16px; background:var(--c-bg);
    }
    .import-dropzone:hover, .import-dropzone.dragover { border-color:var(--c-primary); background:rgba(45,212,191,0.04); }
    .import-dropzone i.drop-icon { font-size:28px; color:var(--c-primary); display:block; margin-bottom:8px; }
    .import-dropzone .drop-label { font-size:14px; font-weight:600; color:var(--c-text-secondary); }
    .import-dropzone .drop-hint { font-size:12px; color:var(--c-text-muted); margin-top:4px; }
    .import-file-list { max-height:160px; overflow-y:auto; margin-bottom:14px; }
    .import-file-item {
      display:flex; align-items:center; gap:10px; padding:8px 12px; border-radius:var(--radius-sm);
      background:var(--c-bg); margin-bottom:6px; font-size:13px; transition:all var(--transition);
    }
    .import-file-item i.file-icon { color:var(--c-primary); font-size:14px; flex-shrink:0; }
    .import-file-item .file-name { flex:1; font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .import-file-item .file-size { color:var(--c-text-muted); font-size:11px; flex-shrink:0; }
    .import-file-item .file-status { flex-shrink:0; font-size:12px; font-weight:700; }
    .import-file-item .file-status.pending { color:var(--c-text-muted); }
    .import-file-item .file-status.processing { color:var(--c-primary); }
    .import-file-item .file-status.done { color:#22C55E; }
    .import-file-item .file-status.error { color:var(--c-danger); }
    .import-file-item .file-remove { width:24px; height:24px; border-radius:4px; display:flex; align-items:center; justify-content:center; color:var(--c-text-muted); font-size:10px; cursor:pointer; transition:all var(--transition); flex-shrink:0; }
    .import-file-item .file-remove:hover { background:rgba(239,68,68,0.1); color:var(--c-danger); }
    .import-progress-area { display:none; margin-bottom:14px; }
    .import-progress-area.active { display:block; }
    .import-progress-bar-wrap { height:6px; background:var(--c-surface-2); border-radius:3px; overflow:hidden; margin-bottom:8px; }
    .import-progress-bar { height:100%; background:var(--c-primary); border-radius:3px; width:0%; transition:width 0.4s ease; }
    .import-progress-text { font-size:12px; color:var(--c-text-muted); font-weight:600; }
    .import-log { max-height:100px; overflow-y:auto; margin-bottom:14px; display:none; }
    .import-log.active { display:block; }
    .import-log-line { font-size:12px; color:var(--c-text-secondary); padding:2px 0; line-height:1.5; }
    .import-log-line i { margin-right:4px; font-size:10px; }
    .import-log-line.success i { color:#22C55E; }
    .import-log-line.error i { color:var(--c-danger); }
    .import-buttons { display:flex; justify-content:flex-end; gap:8px; flex-shrink:0; margin-top:4px; }
    .import-buttons button { padding:9px 20px; border-radius:var(--radius-sm); font-size:14px; font-weight:600; transition:all var(--transition); }
    .btn-import-cancel { color:var(--c-text-secondary); background:var(--c-surface-2); }
    .btn-import-cancel:hover { background:var(--c-border); }
    .btn-import-start { color:#0B1019; background:var(--c-primary); display:flex; align-items:center; gap:6px; }
    .btn-import-start:hover { background:var(--c-primary-hover); }
    .btn-import-start:disabled { opacity:0.4; cursor:not-allowed; }
    .btn-import-start:disabled:hover { background:var(--c-primary); }

    /* Quill tooltip (edit existing links) */
    .ql-snow .ql-tooltip { background:var(--c-surface) !important; border:1px solid var(--c-border) !important; box-shadow:var(--shadow-md) !important; color:var(--c-text) !important; border-radius:var(--radius-sm) !important; padding:8px 14px !important; z-index:60; white-space:nowrap; }
    .ql-snow .ql-tooltip a.ql-preview { color:var(--c-primary) !important; font-size:13px !important; max-width:200px; overflow:hidden; text-overflow:ellipsis; display:inline-block; vertical-align:middle; }
    .ql-snow .ql-tooltip a.ql-action::after { color:var(--c-primary) !important; border-right:1px solid var(--c-border) !important; }
    .ql-snow .ql-tooltip a.ql-remove::before { color:var(--c-danger) !important; }
    .ql-snow .ql-tooltip input[type="text"] { font-size:14px !important; color:var(--c-text) !important; background:var(--c-bg) !important; border:1px solid var(--c-border) !important; border-radius:4px !important; padding:4px 8px !important; }
    .ql-snow .ql-tooltip.ql-editing a.ql-preview, .ql-snow .ql-tooltip.ql-editing a.ql-remove { display:none !important; }
    html.dark .ql-snow .ql-stroke { stroke:var(--c-text-secondary) !important; }
    html.dark .ql-snow .ql-fill { fill:var(--c-text-secondary) !important; }
    html.dark .ql-snow .ql-picker-label { color:var(--c-text-secondary) !important; }
    html.dark .ql-snow .ql-picker-options { background:var(--c-surface-2) !important; border-color:var(--c-border) !important; }
    html.dark .ql-snow .ql-picker-item { color:var(--c-text) !important; }
    html.dark .ql-snow .ql-active .ql-stroke { stroke:var(--c-primary) !important; }
    html.dark .ql-snow .ql-active .ql-fill { fill:var(--c-primary) !important; }
    html.dark .ql-snow button:hover .ql-stroke { stroke:var(--c-text) !important; }
    html.dark .ql-snow button:hover .ql-fill { fill:var(--c-text) !important; }

    /* ── DIALOG ─────────────────────────────────────── */
    .dialog-overlay { display:none; position:fixed; inset:0; background:var(--c-overlay); z-index:1000; align-items:center; justify-content:center; }
    .dialog-overlay.active { display:flex; animation:fadeIn .15s ease; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .dialog-box { background:var(--c-surface); border-radius:var(--radius-md); padding:28px; max-width:400px; width:90%; box-shadow:var(--shadow-lg); animation:scaleIn .2s ease; }
    @keyframes scaleIn { from{opacity:0;transform:scale(.95)} to{opacity:1;transform:scale(1)} }
    .dialog-box h3 { font-size:17px; font-weight:700; margin-bottom:8px; }
    .dialog-box p { font-size:14px; color:var(--c-text-secondary); margin-bottom:20px; line-height:1.5; }
    .dialog-box input[type="text"] { width:100%; padding:10px 14px; border:1px solid var(--c-border); border-radius:var(--radius-sm); font-size:16px; background:var(--c-bg); color:var(--c-text); margin-bottom:12px; outline:none; }
    .dialog-box input[type="text"]:focus { border-color:var(--c-primary); }
    .dialog-box label { display:block; margin-bottom:4px; }
    #dialog-input2 { margin-bottom:20px; }
    .dialog-buttons { display:flex; justify-content:flex-end; gap:8px; }
    .dialog-buttons button { padding:9px 20px; border-radius:var(--radius-sm); font-size:14px; font-weight:600; transition:all var(--transition); }
    .btn-dialog-cancel { color:var(--c-text-secondary); background:var(--c-surface-2); }
    .btn-dialog-cancel:hover { background:var(--c-border); }
    .btn-dialog-confirm { color:#0B1019; background:var(--c-primary); }
    .btn-dialog-confirm:hover { background:var(--c-primary-hover); }
    .btn-dialog-danger { color:#FFF; background:var(--c-danger); }
    .btn-dialog-danger:hover { background:var(--c-danger-hover); }
  </style>
</head>
<body>

  <!-- SETUP -->
  <div id="setup-screen">
    <div class="setup-card">
      <div class="setup-logo"><img src="https://pfst.cf2.poecdn.net/base/image/bbef7fb2fad7dca649ca8ee04dc8dadfb12deabbf00a9bbff9d3255e0006759d?w=1366&h=2048" alt="Jeffrey"></div>
      <h1>Jeffrey's Dietetics</h1>
      <p class="subtitle">Your dietitian knowledge hub</p>
      <div class="setup-tabs">
        <button class="setup-tab active" data-tab="demo">Demo Mode</button>
        <button class="setup-tab" data-tab="firebase">Firebase</button>
      </div>
      <div class="setup-panel active" id="panel-demo">
        <div class="demo-desc"><strong>Try Jeffrey's Dietetics instantly</strong> with in-memory storage. Perfect for exploring. Notes exist only in this session.<br><br>Switch to <strong>Firebase</strong> tab for cloud sync.</div>
        <button class="btn-demo" id="btn-start-demo"><i class="fas fa-play"></i> Launch Demo</button>
      </div>
      <div class="setup-panel" id="panel-firebase">
        <div class="demo-desc"><strong>Cloud sync enabled.</strong> Your notes are stored securely in Firebase and synced across all your devices.<br><br>Sign in with your Google account to get started.</div>
        <button class="btn-connect" id="btn-connect-firebase"><i class="fas fa-cloud"></i> Sign In with Google</button>
        <div class="setup-error" id="setup-error"></div>
      </div>
      <p class="setup-footer">Secure &middot; Private &middot; Organized</p>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="login-screen">
    <div class="login-card">
      <div class="setup-logo"><img src="https://pfst.cf2.poecdn.net/base/image/bbef7fb2fad7dca649ca8ee04dc8dadfb12deabbf00a9bbff9d3255e0006759d?w=1366&h=2048" alt="Jeffrey"></div>
      <h1>Jeffrey's Dietetics</h1>
      <p class="subtitle">Sign in to access your notes</p>
      <button class="btn-google" id="btn-google-signin">
        <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Sign in with Google
      </button>
      <button class="btn-back-setup" id="btn-back-setup">&larr; Back to setup</button>
    </div>
  </div>

  <!-- ═══════════════ MAIN APP ══════════════════════ -->
  <div id="app">

    <!-- VIEW: Categories -->
    <div class="view active" id="view-cats">
      <div class="navbar">
        <img class="nav-avatar" src="https://pfst.cf2.poecdn.net/base/image/bbef7fb2fad7dca649ca8ee04dc8dadfb12deabbf00a9bbff9d3255e0006759d?w=1366&h=2048" alt="Jeffrey">
        <span class="nav-title">Jeffrey's Dietetics</span>
        <span class="mode-chip" id="mode-chip" style="display:none">DEMO</span>
        <button class="btn-topbar" id="btn-signout" title="Sign out"><i class="fas fa-right-from-bracket"></i></button>
      </div>
      <div class="list-scroll" id="cats-list"></div>
    </div>

    <!-- VIEW: Specialties -->
    <div class="view" id="view-specs">
      <div class="navbar">
        <button class="btn-nav-back" id="back-to-cats"><i class="fas fa-arrow-left"></i> Back</button>
        <span class="nav-title" id="specs-title"></span>
      </div>
      <div class="list-scroll" id="specs-list"></div>
    </div>

    <!-- VIEW: Notes -->
    <div class="view" id="view-notes">
      <div class="navbar">
        <button class="btn-nav-back" id="back-to-specs"><i class="fas fa-arrow-left"></i> Back</button>
        <span class="nav-title" id="notes-title"></span>
        <button class="btn-topbar" id="btn-ai-import" title="AI Import"><i class="fas fa-wand-magic-sparkles"></i></button>
      </div>
      <div class="list-scroll" id="notes-list"></div>
    </div>

    <!-- VIEW: Editor -->
    <div class="view" id="view-editor">
      <div class="navbar">
        <button class="btn-nav-back" id="back-to-notes"><i class="fas fa-arrow-left"></i> Back</button>
        <span class="nav-title" id="editor-crumb"></span>
        <button class="btn-topbar" id="btn-editor-move" title="Move note"><i class="fas fa-arrow-right-arrow-left"></i></button>
        <div class="save-status" id="save-status"></div>
      </div>
      <div class="editor-body">
        <div class="note-title-wrap"><input type="text" id="note-title" placeholder="Untitled Note"></div>
        <div class="note-meta" id="note-meta"></div>
        <div class="editor-quill"><div id="quill-editor"></div></div>
      </div>
    </div>

    <!-- FAB -->
    <button class="fab" id="fab-add"><i class="fas fa-plus"></i></button>
  </div>

  <!-- AI IMPORT OVERLAY -->
  <div class="import-overlay" id="import-overlay">
    <div class="import-box">
      <h3><i class="fas fa-wand-magic-sparkles"></i> AI Import</h3>
      <p class="import-subtitle">Upload documents (PDF, images) and AI will extract the content into notes for this specialty.</p>
      <div class="import-dropzone" id="import-dropzone">
        <i class="fas fa-cloud-arrow-up drop-icon"></i>
        <div class="drop-label">Tap to choose files or drag &amp; drop</div>
        <div class="drop-hint">PDF, images &middot; up to 20 MB each</div>
      </div>
      <div class="import-file-list" id="import-file-list"></div>
      <div class="import-progress-area" id="import-progress-area">
        <div class="import-progress-bar-wrap"><div class="import-progress-bar" id="import-progress-bar"></div></div>
        <div class="import-progress-text" id="import-progress-text">Preparing…</div>
      </div>
      <div class="import-log" id="import-log"></div>
      <div class="import-buttons">
        <button class="btn-import-cancel" id="import-cancel">Cancel</button>
        <button class="btn-import-start" id="import-start" disabled><i class="fas fa-sparkles"></i> Import with AI</button>
      </div>
    </div>
  </div>

  <!-- NEW NOTE DIALOG -->
  <div class="newnote-overlay" id="newnote-overlay">
    <div class="newnote-box">
      <h3><i class="fas fa-file-circle-plus"></i> New Note</h3>
      <p class="newnote-subtitle" id="newnote-subtitle">Adjust the sections below, then create your note.</p>
      <div class="newnote-title-field">
        <label>Note Title</label>
        <input type="text" id="newnote-title" placeholder="e.g. Renal Nutrition in CKD">
      </div>
      <div class="newnote-sec-label" id="newnote-sec-label">Sections</div>
      <div class="newnote-sections" id="newnote-sections"></div>
      <button class="tpl-add-btn" id="newnote-add-sec"><i class="fas fa-plus"></i> Add Section</button>
      <div class="newnote-buttons">
        <button class="btn-newnote-cancel" id="newnote-cancel">Cancel</button>
        <button class="btn-newnote-create" id="newnote-create"><i class="fas fa-plus"></i> Create Note</button>
      </div>
    </div>
  </div>

  <!-- TEMPLATE EDITOR -->
  <div class="tpl-overlay" id="tpl-overlay">
    <div class="tpl-box">
      <h3 id="tpl-title">Edit Template</h3>
      <p class="tpl-subtitle" id="tpl-subtitle">Define sections that appear as headers in new notes.</p>
      <div class="tpl-sections" id="tpl-sections"></div>
      <button class="tpl-add-btn" id="tpl-add-btn"><i class="fas fa-plus"></i> Add Section</button>
      <div class="tpl-hint"><i class="fas fa-info-circle"></i> New notes will start with these sections as headers. You can rename each section freely.</div>
      <div class="tpl-buttons">
        <button class="btn-tpl-cancel" id="tpl-cancel">Cancel</button>
        <button class="btn-tpl-save" id="tpl-save">Save Template</button>
      </div>
    </div>
  </div>

  <!-- MOVE DIALOG -->
  <div class="move-overlay" id="move-overlay">
    <div class="move-box">
      <h3>Move Note</h3>
      <p class="move-subtitle" id="move-subtitle">Choose a destination for this note.</p>
      <div class="move-current" id="move-current"></div>
      <div class="move-field">
        <label>Category</label>
        <select id="move-cat-select"></select>
      </div>
      <div class="move-field" id="move-spec-field">
        <label id="move-spec-label">Specialty</label>
        <select id="move-spec-select"></select>
        <div class="move-empty" id="move-spec-empty" style="display:none"></div>
      </div>
      <div class="move-buttons">
        <button class="btn-move-cancel" id="move-cancel">Cancel</button>
        <button class="btn-move-confirm" id="move-confirm" disabled>Move Here</button>
      </div>
    </div>
  </div>

  <!-- DIALOG -->
  <div class="dialog-overlay" id="dialog-overlay">
    <div class="dialog-box" id="dialog-box">
      <h3 id="dialog-title"></h3>
      <p id="dialog-message"></p>
      <input type="text" id="dialog-input" style="display:none">
      <label id="dialog-input2-label" style="display:none;font-size:12px;font-weight:700;color:var(--c-text-muted);margin-bottom:4px;text-align:left"></label>
      <input type="text" id="dialog-input2" style="display:none">
      <div class="dialog-buttons" id="dialog-buttons"></div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
  <script>
    /* ── Dark mode ────────────────────────────────── */
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      e.matches ? document.documentElement.classList.add('dark') : document.documentElement.classList.remove('dark');
    });

    /* ═══ DATA LAYER ══════════════════════════════════ */
    class InMemoryStore {
      constructor() { this._d = { categories:{}, specialties:{}, notes:{} }; this._c = 0; this._l = {}; this._seed(); }
      _id() { return 'l'+(++this._c)+'_'+Date.now(); }
      _seed() {
        var now = new Date();
        /* Categories */
        var catClinical = this._id();
        this._d.categories[catClinical] = {name:'Clinical Dietetics',sublabel:'Specialty',order:0,id:catClinical,createdAt:now};
        var catFood = this._id();
        this._d.categories[catFood] = {name:'Food Science',sublabel:'Topic',order:1,id:catFood,createdAt:now};
        var catCuisine = this._id();
        this._d.categories[catCuisine] = {name:'Cuisine',sublabel:'Type',order:2,id:catCuisine,createdAt:now};

        /* Specialty: Respiratory under Clinical Dietetics */
        var specResp = this._id();
        this._d.specialties[specResp] = {name:'Respiratory',categoryId:catClinical,order:0,id:specResp,createdAt:now,template:['Introduction','Clinical Presentation','Medical Treatment','Assessment','Nutritional Intervention','Future Research']};

        /* ── Note 1: COPD ─────────────────────────────── */
        var n1 = this._id();
        this._d.notes[n1] = {id:n1,title:'Chronic Obstructive Pulmonary Disease',specialtyId:specResp,categoryId:catClinical,order:0,createdAt:new Date('2023-08-03T23:19:00'),updatedAt:new Date('2023-08-03T23:19:00'),
        content:
          '<h2>Introduction</h2>'+
          '<ul>'+
            '<li>Heterogeneous lung condition characterized by chronic respiratory symptoms due to abnormalities of the airway and/or alveoli that cause persistent, often progressive, airflow obstruction</li>'+
            '<li>Pulmonary cachexia syndrome in COPD may be caused by tissue hypoxia, disuse atrophy, malnutrition and change in metabolism</li>'+
            '<li>Risk factors:'+
              '<ul>'+
                '<li>Smoking, air pollution</li>'+
                '<li>Exposure to biomass</li>'+
                '<li>Small / ageing lung</li>'+
              '</ul>'+
            '</li>'+
          '</ul>'+
          '<p><strong>GOLD Classification of COPD Severity:</strong></p>'+
          '<ul>'+
            '<li>GOLD I (Mild): FEV\u2081 \u226580% predicted</li>'+
            '<li>GOLD II (Moderate): FEV\u2081 \u226550\u201380% predicted</li>'+
            '<li>GOLD III (Severe): FEV\u2081 \u226530\u2013&lt;50% predicted</li>'+
            '<li>GOLD IV (Very Severe): FEV\u2081 &lt;30% predicted</li>'+
          '</ul>'+
          '<h2>Clinical Presentation</h2>'+
          '<ol>'+
            '<li>Few complaints but extreme sedentary lifestyle</li>'+
            '<li>Exertional breathlessness</li>'+
            '<li>Chronic cough (worse in morning)</li>'+
            '<li>Regular sputum production</li>'+
            '<li>Frequent winter bronchitis</li>'+
            '<li>Wheeze</li>'+
            '<li>Peripheral edema (severe case)</li>'+
          '</ol>'+
          '<h2>Medical Treatment</h2>'+
          '<ol>'+
            '<li>Smoking cessation</li>'+
            '<li>Inhaled therapy'+
              '<ul>'+
                '<li>Short-acting bronchodilator</li>'+
                '<li>Inhaled corticosteroid</li>'+
                '<li>Combined therapy</li>'+
              '</ul>'+
            '</li>'+
            '<li>Oral corticosteroid (common after exacerbation &amp; cannot wean off)'+
              '<ul><li>May reduce lung function if &gt;60mg/d</li></ul>'+
            '</li>'+
            '<li>Oxygen therapy</li>'+
            '<li>Antibiotics'+
              '<ul>'+
                '<li>Long term can reduce exacerbation for 1 year</li>'+
                '<li>But increased antibiotic resistance</li>'+
              '</ul>'+
            '</li>'+
            '<li>Pulmonary rehabilitation</li>'+
          '</ol>'+
          '<h2>Assessment</h2>'+
          '<ol>'+
            '<li>Weight history (esp. BW loss &gt;3kg)</li>'+
            '<li>BMI range (20\u201325 for COPD NICE)'+
              '<ul><li>FFM is more important</li></ul>'+
            '</li>'+
            '<li>Oral intake</li>'+
            '<li>Handgrip strength</li>'+
            '<li>Glucocorticoid usage</li>'+
          '</ol>'+
          '<h2>Nutritional Intervention</h2>'+
          '<ol>'+
            '<li>Weight reduction for obese if dyspnea</li>'+
            '<li>Keep BMI above 21'+
              '<ul><li>Need exercise to increase FFM</li></ul>'+
            '</li>'+
            '<li>Energy requirement'+
              '<ul>'+
                '<li>30 kcal/kg for sedentary</li>'+
                '<li>May need 45 kcal/kg for weight gain</li>'+
              '</ul>'+
            '</li>'+
            '<li>Protein requirements'+
              '<ul>'+
                '<li>1.0\u20131.2 g/kg/d for elderly</li>'+
                '<li>1.2\u20131.5 g/kg/d for malnourished</li>'+
              '</ul>'+
            '</li>'+
            '<li>Increase fruit and vegetable intake'+
              '<ul>'+
                '<li>Provide antioxidants</li>'+
                '<li>Some meta-analysis supports this</li>'+
              '</ul>'+
            '</li>'+
          '</ol>'+
          '<h2>Future Research</h2>'+
          '<ul>'+
            '<li>PUFA and Vitamin D to reduce inflammation and preserve muscle</li>'+
          '</ul>'+
          '<p><em>Keywords: COPD</em></p>'
        };

        /* ── Note 2: Ventilator Setting ───────────────── */
        var n2 = this._id();
        this._d.notes[n2] = {id:n2,title:'Ventilator Setting',specialtyId:specResp,categoryId:catClinical,order:1,createdAt:new Date('2023-09-12T19:45:00'),updatedAt:new Date('2023-09-12T19:45:00'),
        content:
          '<h2>Primary Variables</h2>'+
          '<ul>'+
            '<li><strong>Volume Control (VC):</strong> Deliver fixed amount of O\u2082'+
              '<ul><li>Variable peak inspiratory pressure depends on patient\u2019s lung compliance and resistance</li></ul>'+
            '</li>'+
            '<li><strong>Pressure Control (PC):</strong> Deliver fixed pressure'+
              '<ul>'+
                '<li>Variable tidal volume</li>'+
                '<li>Good to prevent overinflation &amp; injury</li>'+
              '</ul>'+
            '</li>'+
          '</ul>'+
          '<h2>Primary Modes</h2>'+
          '<ul>'+
            '<li><strong>Assist/Control (A/C)</strong>'+
              '<ul>'+
                '<li>Delivers a minimum number of preset mandatory breaths by the ventilator</li>'+
                '<li>Patient can also trigger assisted breaths \u2014 machine will use positive pressure to assist</li>'+
                '<li>Keeps the patient\u2019s work of breathing requirement very low</li>'+
                '<li>Respiratory alkalosis if over-ventilated</li>'+
              '</ul>'+
            '</li>'+
            '<li><strong>Synchronous Intermittent Mandatory Ventilation (SIMV)</strong>'+
              '<ul>'+
                '<li>Delivers a preset minimum number of mandatory breaths</li>'+
                '<li>Also allows the patient to initiate spontaneous breaths in between the preset breaths</li>'+
                '<li>Indicated when a patient only needs partial ventilatory support</li>'+
                '<li>Helps patients maintain their respiratory muscle strength and avoid muscular atrophy</li>'+
              '</ul>'+
            '</li>'+
          '</ul>'+
          '<h2>Spontaneous Mode</h2>'+
          '<ul>'+
            '<li><strong>Continuous Positive Airway Pressure (CPAP)</strong>'+
              '<ul><li>Constant level of pressure above atmospheric pressure throughout the entire breathing cycle</li></ul>'+
            '</li>'+
            '<li><strong>Pressure Support Ventilation (PSV)</strong>'+
              '<ul>'+
                '<li>Spontaneous breaths are supported by the ventilator during the inspiratory phase of breathing</li>'+
                '<li>Overcome the airway resistance caused by the endotracheal tube</li>'+
              '</ul>'+
            '</li>'+
            '<li><strong>Volume Support (VS)</strong>'+
              '<ul><li>Delivers a supported breath to help reach a set tidal volume</li></ul>'+
            '</li>'+
          '</ul>'+
          '<h2>Other Modes</h2>'+
          '<ul>'+
            '<li><strong>Continuous Mandatory Ventilation (CMV)</strong>'+
              '<ul>'+
                '<li>Ventilator controls both the rate and tidal volume</li>'+
                '<li>Patients who are fully sedated and have been administered neuromuscular blocking agents</li>'+
              '</ul>'+
            '</li>'+
            '<li><strong>Airway Pressure Release Ventilation (APRV)</strong>'+
              '<ul>'+
                '<li>Two levels of continuous positive airway pressure are applied with an intermittent release phase for spontaneous breaths</li>'+
                '<li>To improve oxygenation and treat refractory hypoxemia</li>'+
              '</ul>'+
            '</li>'+
            '<li><strong>Mandatory Minutes Ventilation (MMV)</strong>'+
              '<ul><li>Increase mandatory breath when spontaneous breath reduced</li></ul>'+
            '</li>'+
            '<li><strong>Pressure Regulated Volume Control (PRVC)</strong>'+
              '<ul>'+
                '<li>Volume-controlled breaths with the lowest pressure possible by altering flow and inspiratory time</li>'+
                '<li>Can be patient-triggered or time-triggered</li>'+
              '</ul>'+
            '</li>'+
            '<li><strong>Adaptive Support Ventilation (ASV)</strong>'+
              '<ul><li>Changes the number of mandatory breaths and pressure support level according to how the patient is breathing</li></ul>'+
            '</li>'+
            '<li><strong>Adaptive Pressure Control (APC)</strong>'+
              '<ul><li>Uses variable inflation pressures to deliver a minimum targeted tidal volume</li></ul>'+
            '</li>'+
            '<li><strong>High Frequency Oscillatory Ventilation (HFOV)</strong>'+
              '<ul>'+
                '<li>Delivers very small tidal volumes at an extremely fast rate</li>'+
                '<li>Minimize the chances of a lung injury</li>'+
              '</ul>'+
            '</li>'+
          '</ul>'+
          '<h2>Ventilator Parameters</h2>'+
          '<p><strong>Tidal Volume</strong></p>'+
          '<ul><li>Amount of gas inhaled and exhaled from the lungs during normal breathing</li></ul>'+
          '<p><strong>Respiratory Rate (RR)</strong></p>'+
          '<ul>'+
            '<li>Breathing rate</li>'+
            '<li>Normal range: 10\u201320/min</li>'+
          '</ul>'+
          '<p><strong>Fraction of Inspired Oxygen (FiO\u2082)</strong></p>'+
          '<ul>'+
            '<li>Concentration of oxygen in inhaled gas</li>'+
            '<li>Aim to wean down as it may cause intoxication if prolonged &gt;60% FiO\u2082</li>'+
          '</ul>'+
          '<p><strong>Flow Rate</strong></p>'+
          '<ul>'+
            '<li>Rate that controls how fast a tidal volume is delivered by the ventilator</li>'+
            '<li>Normal range: 60 L/min, up to 120 L/min for obstruction</li>'+
          '</ul>'+
          '<p><strong>Inspiration-to-Expiration Ratio (I:E Ratio)</strong></p>'+
          '<ul>'+
            '<li>Normal range: 1:2\u20131:4</li>'+
            '<li>Larger I:E ratio may be delivered if a patient needs a longer expiratory time due to air trapping</li>'+
          '</ul>'+
          '<p><strong>Trigger Sensitivity</strong></p>'+
          '<ul>'+
            '<li>How much effort (negative pressure) the patient must generate to trigger a breath</li>'+
            '<li>Normal range: between \u22121 and \u22122 cmH\u2082O</li>'+
          '</ul>'+
          '<p><strong>Positive End Expiratory Pressure (PEEP)</strong></p>'+
          '<ul>'+
            '<li>Positive pressure provided during the expiratory phase</li>'+
            '<li>Prevent the closure of alveoli and allow increased time for oxygen exchange</li>'+
            '<li>Typically indicated in patients with refractory hypoxemia and those who have not responded well to a high FiO\u2082</li>'+
            '<li>Normal range: 4\u20136 cmH\u2082O</li>'+
          '</ul>'
        };

        /* ── Note 3: Long COVID ───────────────────────── */
        var n3 = this._id();
        this._d.notes[n3] = {id:n3,title:'Long COVID',specialtyId:specResp,categoryId:catClinical,order:2,createdAt:new Date('2023-07-28T07:34:00'),updatedAt:new Date('2023-07-28T07:34:00'),
        content:
          '<h2>Definition</h2>'+
          '<ul>'+
            '<li>Persistent after clearance of COVID virus</li>'+
            '<li>Usually 1 month after symptom onset, Dx or admission</li>'+
            '<li>Can persist &gt;2 months</li>'+
            '<li>Cannot be explained by alternative Dx</li>'+
          '</ul>'+
          '<h2>Clinical Presentation</h2>'+
          '<ul>'+
            '<li>Alopecia</li>'+
            '<li>Pneumonia</li>'+
            '<li>GI upset'+
              '<ul>'+
                '<li>Nausea</li>'+
                '<li>Diarrhea</li>'+
              '</ul>'+
            '</li>'+
            '<li>Myalgia / arthralgia</li>'+
            '<li>Neuropsychiatric manifestations'+
              '<ul>'+
                '<li>Poor sleep</li>'+
                '<li>Loss of taste and smell</li>'+
                '<li>Anxiety</li>'+
                '<li>Poor memory</li>'+
              '</ul>'+
            '</li>'+
            '<li>Fatigue</li>'+
            '<li>Respiratory'+
              '<ul>'+
                '<li>Cough</li>'+
                '<li>Sputum</li>'+
                '<li>SOB</li>'+
              '</ul>'+
            '</li>'+
          '</ul>'
        };

        /* ═══ Specialty: Nephrology under Clinical Dietetics ═══ */
        var specNeph = this._id();
        this._d.specialties[specNeph] = {name:'Nephrology',categoryId:catClinical,order:1,id:specNeph,createdAt:now,template:['Definition','Assessment','Intervention']};

        /* ── Note 4: Acute Kidney Injury ──────────────── */
        var n4 = this._id();
        this._d.notes[n4] = {id:n4,title:'Acute Kidney Injury',specialtyId:specNeph,categoryId:catClinical,order:0,createdAt:new Date('2023-06-20T00:36:00'),updatedAt:new Date('2023-06-20T00:36:00'),
        content:
          '<h2>Definition</h2>'+
          '<p>Any one of the following:</p>'+
          '<ul>'+
            '<li>Increased Cr &gt;= 26.5 \u00b5mol/L in 48h</li>'+
            '<li>Increased Cr for 1.5 times of baseline</li>'+
            '<li>Urine &lt; 0.5 ml/kg/h for 6 hours</li>'+
          '</ul>'+
          '<h2>Causes</h2>'+
          '<ol>'+
            '<li><strong>Prerenal disease</strong>'+
              '<ul>'+
                '<li>True volume depletion</li>'+
                '<li>Hypotension'+
                  '<ul><li>Shock</li><li>Post-treatment of severe hypertension</li></ul>'+
                '</li>'+
                '<li>Heart failure and cirrhosis</li>'+
                '<li>Nephrotic syndrome'+
                  '<ul><li>Decreased kidney perfusion</li><li>Reduced glomerular permeability</li><li>Excessive diuresis</li></ul>'+
                '</li>'+
                '<li>Selective kidney ischemia</li>'+
              '</ul>'+
            '</li>'+
            '<li><strong>Acute tubular necrosis (ATN)</strong>'+
              '<ul>'+
                '<li>Kidney ischemia</li>'+
                '<li>Sepsis (prerenal/cytokine/neutrophil)</li>'+
                '<li>Nephrotoxins'+
                  '<ul><li>Vancomycin / Cisplatin / Heme pigment</li></ul>'+
                '</li>'+
              '</ul>'+
            '</li>'+
          '</ol>'+
          '<h2>Presentation</h2>'+
          '<ol>'+
            '<li>Hyperglycemia'+
              '<ul><li>Peripheral insulin resistance</li><li>Accelerated hepatic gluconeogenesis caused by protein catabolism</li></ul>'+
            '</li>'+
            '<li>Hypertriglyceridemia'+
              '<ul><li>Inhibition of lipolysis</li></ul>'+
            '</li>'+
          '</ol>'+
          '<h2>Intervention</h2>'+
          '<ol>'+
            '<li>Protein requirement'+
              '<ul>'+
                '<li>If not on RRT: 0.8\u20131.0 g/kg/d</li>'+
                '<li>If on RRT: 1.0\u20131.5 g/kg/d</li>'+
                '<li>Up to 1.7 g/kg/d for CRRT or hypercatabolic</li>'+
              '</ul>'+
            '</li>'+
            '<li>Energy requirement'+
              '<ul><li>20\u201330 kcal/kg/d</li></ul>'+
            '</li>'+
            '<li>Weight reduction'+
              '<ul><li>10\u201315% weight loss</li></ul>'+
            '</li>'+
            '<li>Mediterranean diet</li>'+
          '</ol>'+
          '<p><em>Keywords: AKI</em></p>'
        };

        /* ── Note 5: CKD ──────────────────────────────── */
        var n5 = this._id();
        this._d.notes[n5] = {id:n5,title:'Chronic Kidney Disease (CKD)',specialtyId:specNeph,categoryId:catClinical,order:1,createdAt:new Date('2023-03-08T23:40:00'),updatedAt:new Date('2023-03-08T23:40:00'),
        content:
          '<h2>Assessment</h2>'+
          '<ol>'+
            '<li>Body weight trend</li>'+
            '<li>Edema</li>'+
            '<li>Biochemistry'+
              '<ul>'+
                '<li>RFT, eGFR (45\u201359 for &gt;70yo is normal)</li>'+
                '<li>Phosphate</li>'+
                '<li>Lipid profile</li>'+
                '<li>Albumin</li>'+
                '<li>CRP</li>'+
                '<li>Urinary protein loss</li>'+
                '<li>PTH</li>'+
              '</ul>'+
            '</li>'+
            '<li>Urine, BO</li>'+
            '<li>Diet history'+
              '<ul>'+
                '<li>Energy and protein</li>'+
                '<li>Salt</li>'+
                '<li>Fluid</li>'+
                '<li>Star fruit</li>'+
                '<li>High K / PO4 (if high)</li>'+
              '</ul>'+
            '</li>'+
          '</ol>'+
          '<h2>Intervention</h2>'+
          '<h3>Stage 1\u20133</h3>'+
          '<ol>'+
            '<li>Weight management</li>'+
            '<li>Protein ~0.8 g/kg</li>'+
            '<li>Glycemic control</li>'+
            '<li>Low salt</li>'+
            '<li>Encourage fluid intake</li>'+
          '</ol>'+
          '<h3>Stage 4</h3>'+
          '<ol>'+
            '<li>Protein intake 0.8 \u00d7 actual BW and IBW</li>'+
            '<li>Fluid intake: output + (500 to 1000 ml)</li>'+
            '<li>PO4 intake &lt;29 mmol/d (&lt;900 mg/d)</li>'+
            '<li>K intake &lt;40\u201370 mmol/d (1500\u20132700 mg/d)</li>'+
          '</ol>'+
          '<p><em>With keto analogue:</em><br>Protein intake: 0.6 \u00d7 actual BW and IBW</p>'
        };

        /* ── Note 6: CKD on HD ────────────────────────── */
        var n6 = this._id();
        this._d.notes[n6] = {id:n6,title:'CKD on HD',specialtyId:specNeph,categoryId:catClinical,order:2,createdAt:new Date('2023-03-09T09:58:00'),updatedAt:new Date('2023-03-09T09:58:00'),
        content:
          '<h2>Assessment</h2>'+
          '<ol>'+
            '<li>Body weight trend (aim &lt;2kg gain between session)</li>'+
            '<li>Edema</li>'+
            '<li>RFT, PO4 (check baseline and pre/post PD)</li>'+
            '<li>HD regimen (appetite before &amp; after)</li>'+
            '<li>UF, urine, BO</li>'+
            '<li>Diet history'+
              '<ul>'+
                '<li>Energy and protein</li>'+
                '<li>Salt</li>'+
                '<li>Fluid</li>'+
                '<li>Star fruit</li>'+
                '<li>High K / PO4 (if high)</li>'+
              '</ul>'+
            '</li>'+
          '</ol>'+
          '<h2>Intervention</h2>'+
          '<h3>Normal Electrolytes</h3>'+
          '<ol>'+
            '<li>Relax on mineral control + close monitor</li>'+
            '<li>Adequate protein (\u22651.2 g/kg)</li>'+
            '<li>Fluid intake 1\u20131.2 L/d (UF+300\u2013500 ml)</li>'+
            '<li>Reduce sodium</li>'+
          '</ol>'+
          '<p><strong><em>PLUS the following</em></strong></p>'+
          '<h3>Elevated K</h3>'+
          '<ol>'+
            '<li>Avoid TCM</li>'+
            '<li>Avoid herbal soup</li>'+
            '<li>Avoid strong tea and coffee</li>'+
          '</ol>'+
          '<h3>Elevated PO4</h3>'+
          '<ol>'+
            '<li>Reduce processed food</li>'+
            '<li>Take phosphate binder with meal</li>'+
          '</ol>'
        };

        /* ── Note 7: CKD on CAPD ─────────────────────── */
        var n7 = this._id();
        this._d.notes[n7] = {id:n7,title:'CKD on CAPD',specialtyId:specNeph,categoryId:catClinical,order:3,createdAt:new Date('2023-03-09T09:57:00'),updatedAt:new Date('2023-03-09T09:57:00'),
        content:
          '<h2>Assessment</h2>'+
          '<ol>'+
            '<li>Body weight trend</li>'+
            '<li>Edema</li>'+
            '<li>RFT, PO4</li>'+
            '<li>CAPD regimen (calorie)</li>'+
            '<li>UF, urine, BO</li>'+
            '<li>Diet history'+
              '<ul>'+
                '<li>Energy and protein</li>'+
                '<li>Salt</li>'+
                '<li>Fluid</li>'+
                '<li>Star fruit</li>'+
                '<li>High K / PO4 (if high)</li>'+
              '</ul>'+
            '</li>'+
          '</ol>'+
          '<h2>Intervention</h2>'+
          '<h3>Normal Electrolytes</h3>'+
          '<ol>'+
            '<li>Relax on mineral control + close monitor</li>'+
            '<li>Adequate protein (\u22651.2 g/kg)</li>'+
            '<li>Fluid intake 1\u20131.2 L/d (UF+300\u2013500 ml)</li>'+
            '<li>Reduce sodium</li>'+
          '</ol>'+
          '<p><strong><em>PLUS the following</em></strong></p>'+
          '<h3>Elevated K</h3>'+
          '<ol>'+
            '<li>Avoid TCM</li>'+
            '<li>Avoid herbal soup</li>'+
            '<li>Avoid strong tea and coffee</li>'+
          '</ol>'+
          '<h3>Elevated PO4</h3>'+
          '<ol>'+
            '<li>Reduce processed food</li>'+
            '<li>Take phosphate binder with meal</li>'+
          '</ol>'
        };

        /* ── Note 8: IgA Nephropathy ─────────────────── */
        var n8 = this._id();
        this._d.notes[n8] = {id:n8,title:'IgA Nephropathy (IgAN) / IgA Vasculitis (IgAV)',specialtyId:specNeph,categoryId:catClinical,order:4,createdAt:new Date('2023-03-09T09:58:00'),updatedAt:new Date('2023-03-09T09:58:00'),
        content:
          '<h2>Intervention</h2>'+
          '<p><em>If no other complication e.g. AKI:</em></p>'+
          '<ol>'+
            '<li>Weight control</li>'+
            '<li>Restrict dietary sodium intake &lt;2 g/d</li>'+
          '</ol>'
        };

        /* ── Note 9: Nephrotic Syndrome ───────────────── */
        var n9 = this._id();
        this._d.notes[n9] = {id:n9,title:'Nephrotic Syndrome',specialtyId:specNeph,categoryId:catClinical,order:5,createdAt:new Date('2023-03-09T09:58:00'),updatedAt:new Date('2023-03-09T09:58:00'),
        content:
          '<h2>Definition</h2>'+
          '<ul>'+
            '<li>Proteinuria (200 mg/mmol or \u22653+ dipstick)</li>'+
            '<li>Hypoalbuminemia (&lt;30 g/L) or edema</li>'+
          '</ul>'+
          '<h2>Intervention</h2>'+
          '<ol>'+
            '<li>Restrict dietary Na &lt;2 g/d (&lt;90 mmol/d)</li>'+
            '<li>Protein intake: 0.8\u20131 g/kg/d + 1 g/g protein loss (up to 5 g/d)</li>'+
            '<li>If eGFR &lt;60, limit protein to &lt;0.8 g/kg/d</li>'+
            '<li>Achieve normal BMI</li>'+
            '<li>Heart-protective diet</li>'+
          '</ol>'
        };

        /* ── Specialty: Pregnancy (order:2) ──────────────── */
        var specPreg = this._id();
        this._d.specialties[specPreg] = {name:'Pregnancy',categoryId:catClinical,order:2,id:specPreg,createdAt:now,template:['Introduction','Assessment','Intervention']};

        /* ── Note 10: Physiological changes during pregnancy ── */
        var n10 = this._id();
        this._d.notes[n10] = {id:n10,title:'Physiological changes during pregnancy',specialtyId:specPreg,categoryId:catClinical,order:0,createdAt:new Date('2025-09-24T18:27:00'),updatedAt:new Date('2025-09-24T18:27:00'),
        content:
          '<h2>Cardiovascular</h2>'+
          '<ul>'+
            '<li>Cardiac output increases 20% by 8 weeks gestation + HR increase 10-20 bpm</li>'+
            '<li>Blood pressure reduce in first and second trimester, but increases during the third</li>'+
            '<li>Cardiac output increases during labour</li>'+
          '</ul>'+
          '<h2>Urinary</h2>'+
          '<ul>'+
            '<li>Renal vasodilation occur -&gt; increase renal plasma flow'+
              '<ul>'+
                '<li>Reduced serum Ur and Cr</li>'+
                '<li>Increase renal size</li>'+
                '<li>Pelvis and calyceal system dilate due to mechanical compressive force on the ureter</li>'+
                '<li>Less reabsorption of glucose</li>'+
              '</ul>'+
            '</li>'+
          '</ul>'+
          '<h2>Endocrine</h2>'+
          '<ul>'+
            '<li>Increase hCG, estrogen and progesterone -&gt; increase nausea and vomiting'+
              '<ul><li>May lead to electrolytes imbalance, dehydration, weight loss, nutrient deficiency especially with hyperemesis gravidum</li></ul>'+
            '</li>'+
          '</ul>'+
          '<h2>Gastrointestinal</h2>'+
          '<ul>'+
            '<li>Mechanical changes in GI tract due to growing uterus</li>'+
            '<li>Stomach is displaced upwards -&gt; increase intra-gastric pressure</li>'+
            '<li>Constipation, heartburn and incontinence</li>'+
          '</ul>'+
          '<h2>Hematological</h2>'+
          '<ul>'+
            '<li>Plasma volume increases by 50% by week 34 of gestation</li>'+
            '<li>Hb, HCT and RBC decrease</li>'+
            '<li>Increase requirement of iron, folate and vitamin B12</li>'+
          '</ul>'+
          '<h2>Respiratory</h2>'+
          '<ul>'+
            '<li>Increase oxygen demand</li>'+
            '<li>SOB feeling without hypoxia, usually in the third trimester</li>'+
          '</ul>'+
          '<h2>Skeletal</h2>'+
          '<ul>'+
            '<li>Maternal bone turnover is low in the first trimester, but increase during the third trimester \u2234 fetal calcium requirement is the highest</li>'+
          '</ul>'
        };

        /* ── Note 11: Side effects in Pregnancy ─────────── */
        var n11 = this._id();
        this._d.notes[n11] = {id:n11,title:'Side effects in Pregnancy',specialtyId:specPreg,categoryId:catClinical,order:1,createdAt:new Date('2025-09-27T22:34:00'),updatedAt:new Date('2025-09-27T22:34:00'),
        content:
          '<h2>Nausea &amp; vomiting</h2>'+
          '<ul>'+
            '<li>70-80% experience during the first trimester</li>'+
            '<li>Commonly begin at 4-6 weeks</li>'+
            '<li>Peak at 8-12 weeks</li>'+
            '<li>Will lead to decreased in intake of fruits and veg while increasing white bread and soft drinks consumption</li>'+
            '<li>Hyperemesis gravidum (severe pregnancy induced vomiting)</li>'+
          '</ul>'+
          '<p><u>Causes</u></p>'+
          '<ul>'+
            '<li>Genetics x endocrine x GI factors</li>'+
            '<li>Stimulation of the CNS and relays the stimuli to the vomiting centre</li>'+
          '</ul>'+
          '<p><u>Treatment</u></p>'+
          '<ol>'+
            '<li>Refeeding precaution with lab'+
              '<ul><li>Thiamine 50mg/d</li><li>TDS if high carb diet</li><li>Up to 1000mg/d if signs of Wernicke\'s Encephalopathy</li></ul>'+
            '</li>'+
            '<li>Small &amp; frequent meals &amp; fluid throughout the day</li>'+
            '<li>Avoid high fat food</li>'+
            '<li>Increase protein intake \u2234 slower breakdown</li>'+
            '<li>Avoid cooked, odorous food, replace with cold food</li>'+
            '<li>Vitamin B6 10-40mg/d</li>'+
            '<li>Ginger may increase GI motility (cannot reduce episode of V)</li>'+
          '</ol>'+
          '<h2>Constipation</h2>'+
          '<ul>'+
            '<li>Passing of dry, hard bowel motions that may be infrequent or difficult to pass</li>'+
            '<li>Hx of constipation may find the symptoms become worse during pregnancy</li>'+
            '<li>Left untreated -&gt; affect pelvic floor muscle</li>'+
          '</ul>'+
          '<p><u>Causes</u></p>'+
          '<ul>'+
            '<li>Hormonal changes'+
              '<ul><li>Raised progesterone and decreased motilin (partly)</li></ul>'+
            '</li>'+
            '<li>Dehydration'+
              '<ul><li>Increased fluid requirement \u2234 increased blood volume by 150%</li><li>Increased intestinal water absorption</li></ul>'+
            '</li>'+
            '<li>Reduced physical activity</li>'+
          '</ul>'+
          '<p><u>Treatment</u></p>'+
          '<ol>'+
            '<li>Fibre-rich diet, aim &ge;28g/d</li>'+
            '<li>Eat kiwifruit 2pcs/d'+
              '<ul><li>Actinidin: proteolytic activity</li><li>Raphides: increase mucin production</li></ul>'+
            '</li>'+
            '<li>Eat prunes</li>'+
            '<li>Adequate fluid intake, &ge;9 cups fluid daily</li>'+
            '<li>Fibre supplement e.g bran, wheat fibre</li>'+
          '</ol>'+
          '<h2>UTI</h2>'+
          '<ul>'+
            '<li>Infections of kidney, ureters, urethra or bladder due to bacterial infection</li>'+
            '<li>Poses risk of complications to child and mother</li>'+
            '<li>Up to 40% risk of progression to pyelonephritis</li>'+
            '<li>Classified as'+
              '<ul><li>Asymptomatic bacteriuria: only present in urine</li><li>Symptomatic infection</li></ul>'+
            '</li>'+
          '</ul>'+
          '<p><u>Causes</u></p>'+
          '<ul>'+
            '<li>Expanded uterus -&gt; put pressure on the bladder and ureters</li>'+
            '<li>Urine is less acidic + more proteins, sugars and hormones</li>'+
            '<li>Dehydration</li>'+
          '</ul>'+
          '<p><u>Treatment</u></p>'+
          '<ol>'+
            '<li>Adequate fluid intake: +1.5L of fluid on top of usual intake for low intake</li>'+
            '<li>Minimize antibiotics use due to'+
              '<ul><li>Most are teratogenic</li><li>May affect microbiome of the foetus</li></ul>'+
            '</li>'+
            '<li>Cranberry'+
              '<ul><li>Decrease adhesion of bacteria to the cells lining in the urinary tract</li><li>Promotes the growth of bacteroidaceae and reduce Enterobacteriaceae to reduce UTI</li><li>Supplement maybe better options for GDM</li><li>Juice maybe better for patient with morning sickness syndrome</li></ul>'+
            '</li>'+
            '<li>D-mannose'+
              '<ul><li>Monosaccharide naturally found in many fruits and vegetables</li><li>May prevent E coli (90% case) from sticking to the wall of urinary system</li><li>Safe to use during pregnancy</li><li>Dose: Prevention: 2g/d or 1g BD; Treatment: 1.5g BD for 3 days then 1.5g/d for 10 days, or 1g TDS for 14 days</li></ul>'+
            '</li>'+
          '</ol>'
        };

        /* ── Note 12: Requirement in Pregnancy ──────────── */
        var n12 = this._id();
        this._d.notes[n12] = {id:n12,title:'Requirement in Pregnancy',specialtyId:specPreg,categoryId:catClinical,order:2,createdAt:new Date('2025-10-17T22:38:00'),updatedAt:new Date('2025-10-17T22:38:00'),
        content:
          '<h2>Weight gain ranges</h2>'+
          '<ul>'+
            '<li>Unless underweight, otherwise not recommend to gain &gt;2kg in the 1st trimester</li>'+
            '<li>And mostly came from fluid stores</li>'+
            '<li>Otherwise additional weight gain is adipose tissue</li>'+
            '<li>Pre-pregnancy BMI &lt;19.0: Total BW gain 13-16.7kg (Avg 0.52-0.67kg/wk)</li>'+
            '<li>Pre-pregnancy BMI 19.0-23.5: Total BW gain 11-16.4kg (Avg 0.44-0.66kg/wk)</li>'+
            '<li>Pre-pregnancy BMI &gt;23.5: Total BW gain 7.1-14.4kg (Avg 0.28-0.58kg/wk)</li>'+
          '</ul>'+
          '<h2>Energy requirement</h2>'+
          '<ul>'+
            '<li>1st trimester: 0 kcal (ELNA) / 0 (WHO)</li>'+
            '<li>2nd trimester: 340 kcal (ELNA) / 285 kcal (WHO)</li>'+
            '<li>3rd trimester: 452 kcal (ELNA) / 475 kcal (WHO)</li>'+
          '</ul>'+
          '<h2>Protein requirement</h2>'+
          '<ul>'+
            '<li>Usual recommendation: 60g/d (c/w 46g/d for non pregnant)</li>'+
            '<li>EAR: 0.88g/kg/d</li>'+
            '<li>RDA: 1.1g/kg/d</li>'+
            '<li>From one study: Early pregnancy (~16 weeks) 1.2g/kg/d; Late pregnancy (~36 weeks) 1.52g/kg/d</li>'+
            '<li>High maternal dietary protein &lt;-&gt; increase intra-uterine growth restriction and embryonic death</li>'+
            '<li>Higher protein diet may increase risk of overweight and obesity in the offspring</li>'+
          '</ul>'+
          '<h2>Carbohydrates requirement</h2>'+
          '<ul>'+
            '<li>45-64% of daily calories</li>'+
            '<li>1500kcal: 169-240g/d; 1800kcal: 203-288g/d; 2000kcal: 225-320g/d</li>'+
            '<li>Debating against lower carbohydrates diet</li>'+
          '</ul>'+
          '<h2>Fat requirement</h2>'+
          '<ul>'+
            '<li>20-35% of daily calories</li>'+
            '<li>High fat maternal diet may cause long term ramification on offspring (metabolic conditions, neural development)</li>'+
            '<li>Quality of dietary fat was strongly associated with GDM (alpha-linolenic acid, omega 3 fatty acid)</li>'+
          '</ul>'+
          '<h2>Fluid requirement</h2>'+
          '<ul>'+
            '<li>General: 9-12 cups per day</li>'+
            '<li>HKDH: 6-8 cups for 1st trimester; &ge;8 cups for 2nd &amp; 3rd trimester</li>'+
            '<li>ELNA: 10% more fluid than usual for 1st trimester; Extra liter than usual towards the end of pregnancy</li>'+
          '</ul>'+
          '<h2>Folate</h2>'+
          '<ul>'+
            '<li>Essential for healthy cell division &amp; DNA synthesis</li>'+
            '<li>Increased requirement \u2234 increased rate of maternal &amp; fetal cellular growth</li>'+
            '<li>Deficiency may cause neural tube defects</li>'+
            '<li>Usual requirement: at least 400mcg throughout pregnancy</li>'+
            '<li>High risk requirement: 1000mcg/d folate'+
              '<ul><li>+ &ge;2.6mcg Vit B12</li><li>No need high dose after first trimester</li><li>PMHx/FHx of NTD</li><li>Type 1/2 DM</li><li>BMI &gt;30</li><li>Smoker, alcohol overuse</li><li>Malabsorptive disease e.g. Crohn\'s, Coeliac, gastric bypass</li><li>Malnutrition &amp; eating disorder</li><li>MTHFR mutation</li></ul>'+
            '</li>'+
            '<li>Terminology: Folate (naturally occurring vit B9), Folic acid (synthetic), Folinic acid (5-formyl tetrahydrofolate, active metabolite with high bioavailability), 5-MTHF (active form)</li>'+
          '</ul>'+
          '<h2>Iodine</h2>'+
          '<ul>'+
            '<li>Essential for regulate metabolism and fetus nervous system</li>'+
            '<li>Increased requirement \u2234 transferred from mother to fetus + increase renal loss</li>'+
            '<li>Pregnancy requirement: 250-300ug/d (usual supplement: 150mcg/d)</li>'+
            '<li>Especially important in 14-16 weeks</li>'+
            '<li>Deficiency: urine iodine &lt;150ug/L; Suboptimal: affect learning ability</li>'+
          '</ul>'+
          '<h2>Iron</h2>'+
          '<ul>'+
            '<li>Prenatal supplement'+
              '<ul><li>Advantages: Decrease LBW risk, decrease maternal anaemia risk</li><li>Disadvantages: increases risk of high Hb (causes fetal growth restriction), GI problems, increased risk of GDM</li></ul>'+
            '</li>'+
            '<li>Pre-pregnancy iron storage &gt;300mg/L \u2234 absorb less than requirement</li>'+
            '<li>Pregnancy requirement: RDI 18mg/d; 1st tri 18.8mg/d; 2nd tri 22-23mg/d; 3rd tri 24-27mg/d</li>'+
            '<li>Aim supplemental iron to &lt;80mg/d</li>'+
            '<li>Iron bisglycinate is better tolerated</li>'+
          '</ul>'+
          '<h2>Zinc</h2>'+
          '<ul>'+
            '<li>Important for cell division and development</li>'+
            '<li>Deficiency compromise infant development + intra-uterine infection</li>'+
            '<li>Risk factors: Vegetarian, cereal-based diet high in phytate, high Fe supplement intake, GI malabsorption, smoking and alcohol abuse, acute trauma or infection</li>'+
            '<li>Pregnancy requirement: 11-12mg/d + 2-4mg/d</li>'+
            '<li>Notes: Eat with food; 1mg Cu for every 8-15mg Zn (supp.); Take 2h apart from Fe and Ca</li>'+
          '</ul>'+
          '<h2>Vitamin D</h2>'+
          '<ul>'+
            '<li>Deficiency causes: Maternal (preeclampsia, GDM); Infant (low birth weight, long term skeletal development, more allergies)</li>'+
            '<li>Risk factors: Limited sun exposure, excess body fat, malabsorption</li>'+
            '<li>Requirement in controversy (1mcg=40IU): 400-600IU or 10-15mcg/d (IOM); 10mcg/d (NICE); 2000IU (Endocrine Society); Upper limit 4000IU, better to be taken daily</li>'+
          '</ul>'+
          '<h2>Calcium requirement</h2>'+
          '<ul>'+
            '<li>Usually 1000mg/d, 1300mg/d for teenage</li>'+
            '<li>&ge;1000mg/d will reduce preeclampsia risk</li>'+
            '<li>Supplement: avoid &gt;600mg/d for long term \u2234 Heart</li>'+
          '</ul>'+
          '<h2>Choline requirement</h2>'+
          '<ul>'+
            '<li>For neurotransmitter synthesis, membrane signaling, lipid metabolism</li>'+
            '<li>Faster reaction time and better memory</li>'+
            '<li>Pregnancy requirement: 415-480mg/d</li>'+
            '<li>But most research is using double dose w/o side effect -&gt; maybe tolerate to 450-1000mg/d</li>'+
            '<li>Meat containing ~100mg per 3oz = 1 egg</li>'+
          '</ul>'+
          '<h2>Omega 3 requirement</h2>'+
          '<ul>'+
            '<li>Important for cell membrane especially eye and brain</li>'+
            '<li>Fetal DHA mainly determined by maternal diet</li>'+
            '<li>Benefits: Reduce harmful effect of oxidative stress; Resolve inflammation associated with asthma and IgE mediated allergy; Reduce preterm birth risk</li>'+
            '<li>Pregnancy requirement: 500-1000mg/d of long chain PUFA with &ge;200mg/d DHA included</li>'+
            '<li>Rich food contains 1700-2000mg in 4oz: Salmon, mackerel, tuna, anchovies</li>'+
          '</ul>'+
          '<h2>Vitamin B6</h2>'+
          '<ul>'+
            '<li>For myelin, haem &amp; neurotransmitter formation</li>'+
            '<li>Potential benefits (weak evidence): May reduce preeclampsia and preterm risk; May provide relief for nausea especially pyridoxal 5 phosphate (PLP) as active form'+
              '<ul><li>Potential mechanism: Inhibit histamine receptor, Inhibit muscarinic receptor of CNS, Indirectly act on vestibular system</li></ul>'+
            '</li>'+
            '<li>Pregnancy requirement: 1.9mg/d (RDA); 10mg/d (RCT to reduce nausea); Upper limit 100mg/d (IOM)</li>'+
            '<li>Overdose: photosensitivity, numbness; Check if &gt;50mg/d from supplement</li>'+
          '</ul>'+
          '<h2>Ginger</h2>'+
          '<ul>'+
            '<li>Key: gingerol, shogaol, galanolactone</li>'+
            '<li>Improve gastric emptying</li>'+
            '<li>Boost serotonin</li>'+
            '<li>May bind to 5HT receptor and inhibit nausea</li>'+
            '<li>Can be consumed in different form, but recommend DIY fresh ginger tea</li>'+
            '<li>Ginger root powder: 250mg QID x 4d (1 study)</li>'+
            '<li>Concern as an anticoagulant: close to labour, Hx of bleeding/clotting disorder, taking anticoagulant meds</li>'+
            '<li>Discourage to use large amount \u2234 Miscarriage'+
              '<ul><li>Longest study: 21 days only</li><li>No overdose (&lt;1000mg ginger powder)</li><li>Not later than 1st trimester</li></ul>'+
            '</li>'+
          '</ul>'+
          '<h2>Probiotics</h2>'+
          '<ul>'+
            '<li>Possible risk &gt; benefits</li>'+
            '<li>Taking at postpartum, by mother or infant is similar</li>'+
            '<li>Better take at 34-36 gestational week and keep for 3-6 months postnatal</li>'+
            '<li>Lactobacillus rhamnosus 2x10\u00B9\u2070 CFU for AD</li>'+
          '</ul>'
        };

        /* ── Note 13: Reason of weight control during pregnancy ── */
        var n13 = this._id();
        this._d.notes[n13] = {id:n13,title:'Reason of weight control during pregnancy',specialtyId:specPreg,categoryId:catClinical,order:3,createdAt:new Date('2025-10-18T08:29:00'),updatedAt:new Date('2025-10-18T08:29:00'),
        content:
          '<h2>Underweight</h2>'+
          '<ol>'+
            '<li>Infant mortality'+
              '<ul><li>Mortality risk: 3.9% (inadequate BW gain) vs 1.2% (adequate BW gain)</li><li>Underweight before pregnancy + inadequate weight gain -&gt; 6 times of risk</li></ul>'+
            '</li>'+
            '<li>Childhood obesity \u2234 ?underdeveloped part of the brain that controls food intake</li>'+
            '<li>Low birth weight (&lt;2.5kg/5.5lbs)</li>'+
          '</ol>'+
          '<h2>Overweight</h2>'+
          '<ol>'+
            '<li>GDM: 9 times risk with BMI &gt;30</li>'+
            '<li>Pre-eclampsia:'+
              '<ul><li>3 times risk with BMI &gt;30 \u2234 insulin resistance + inflammation</li><li>Even within normal BMI range, increases BMI also increase risk</li></ul>'+
            '</li>'+
            '<li>Caesarean: 2 times risk with obese BMI + increase complications + DVT</li>'+
            '<li>Miscarriage: 2 times risk of dying in the womb or before 1yo'+
              '<ul><li>\u2234 Probably more medical complications e.g. pre-eclampsia</li></ul>'+
            '</li>'+
            '<li>Neural tube defects: every one point of BMI higher = +7% risk'+
              '<ul><li>\u2234 Probably not enough folate to baby as mother\'s requirement is also high</li><li>\u2234 Probable other nutrients are competing with the folate to enter foetus</li></ul>'+
            '</li>'+
            '<li>Pre-term birth: increase 30% risk with overweight or obesity</li>'+
          '</ol>'+
          '<p>Weight change in the first trimester is more strongly affecting newborn size</p>'
        };

        /* ── Note 14: Pre-eclampsia ─────────────────────── */
        var n14 = this._id();
        this._d.notes[n14] = {id:n14,title:'Pre-eclampsia',specialtyId:specPreg,categoryId:catClinical,order:4,createdAt:new Date('2025-11-15T13:23:00'),updatedAt:new Date('2025-11-15T13:23:00'),
        content:
          '<h2>Diagnosis</h2>'+
          '<ul>'+
            '<li>New onset of HT (SBP&gt;140, DBP&gt;90)</li>'+
            '<li>Proteinuria</li>'+
          '</ul>'+
          '<h2>Possible mechanism</h2>'+
          '<ul>'+
            '<li>Disturbance in placental development</li>'+
            '<li>Followed by generalized inflammation and progressive endothelial damage</li>'+
          '</ul>'+
          '<h2>Risk factor</h2>'+
          '<ul>'+
            '<li>Chronic HT</li>'+
            '<li>Pre GDM</li>'+
            '<li>Maternal age</li>'+
            '<li>CKD</li>'+
            '<li>Higher prevalence if carrying genetic variant TTN leading to cardiomyopathy'+
              '<ul><li>Will lead to higher CVD risk to mother and infant</li></ul>'+
            '</li>'+
          '</ul>'+
          '<h2>Management</h2>'+
          '<ol>'+
            '<li>Anti-HT med if SBP&gt;160 or DBP&gt;110</li>'+
            '<li>Aspirin 75mg/d from 12 weeks to birth</li>'+
            '<li>Not recommend to restrict Na for prevention</li>'+
            '<li>Ca supplement in high risk group with baseline low Ca intake</li>'+
            '<li>Not recommend probiotics \u2234 current evidence harm &gt; benefits</li>'+
          '</ol>'
        };

        /* ── Note 15: T1DM in Pregnancy ─────────────────── */
        var n15 = this._id();
        this._d.notes[n15] = {id:n15,title:'T1DM in Pregnancy',specialtyId:specPreg,categoryId:catClinical,order:5,createdAt:new Date('2025-11-15T14:36:00'),updatedAt:new Date('2025-11-15T14:36:00'),
        content:
          '<h2>Preconception</h2>'+
          '<ul>'+
            '<li>Increased risk of: pre-eclampsia, retinopathy, macrosomia, severe hypoglycemia</li>'+
            '<li>Preconception target: A1c &lt;8</li>'+
            '<li>Reinforced education on carbs counting</li>'+
            '<li>Remind how to increase carbs intake</li>'+
          '</ul>'+
          '<h2>Pregnancy</h2>'+
          '<ul>'+
            '<li>Need week to week change in insulin requirement'+
              '<ul><li>0-4 weeks: little increase in IR</li><li>5-8 weeks: higher sensitivity</li><li>9-14 weeks: severe risk of hypoglycemia</li><li>14-28 weeks: increase in IR</li></ul>'+
            '</li>'+
            '<li>Longer action for insulin'+
              '<ul><li>No need for bolus insulin for 30g carbs snack</li><li>Otherwise may cause stacking and hypoglycemia</li></ul>'+
            '</li>'+
            '<li>Watch out for hypoglycemia'+
              '<ul><li>Symptomatic only when &lt;3.5mmol/L</li><li>Patient may count carbs more strictly and causing more insulin dose than usual</li></ul>'+
            '</li>'+
            '<li>Routine reminder of consistent carbs intake'+
              '<ul><li>Remove insulin to CHO ratio</li><li>Reinforce consistent time and amount</li><li>Aim meal 30-45g x 3 + snack 15-30g x 2</li><li>Minimum of 150g carbs</li></ul>'+
            '</li>'+
            '<li>Exercise'+
              '<ul><li>Recommend moderate intensity</li><li>15min walk post meal especially breakfast</li><li>Avoid HIIT</li><li>Aware of strenuous sexual activity</li></ul>'+
            '</li>'+
          '</ul>'+
          '<h2>First trimester</h2>'+
          '<ul>'+
            '<li>Focus on hypoglycemia management</li>'+
            '<li>Avoid swinging glucose level \u2234 High risk of miscarriages</li>'+
            '<li>Aim for higher target range</li>'+
            '<li>Bed time snack for sexual activity and fasting hypoglycemia</li>'+
            '<li>Deal with morning sickness</li>'+
          '</ul>'+
          '<h2>Second trimester</h2>'+
          '<ul>'+
            '<li>Pre-meal insulin 20mins before eating</li>'+
            '<li>A1c less than 6</li>'+
            '<li>Remind consistent carbs intake and quality</li>'+
            '<li>Mediterranean diet for weight gain</li>'+
            '<li>Most problematic weight gain usually before 20 weeks</li>'+
          '</ul>'+
          '<h2>Third trimester</h2>'+
          '<ul>'+
            '<li>Worst insulin resistance</li>'+
            '<li>Pre-meal insulin 40-45mins before eating</li>'+
            '<li>Aim for target to be met by the end of the insulin profile</li>'+
            '<li>Talk about planning hypos on the birth day</li>'+
            '<li>Educate on breastfeeding</li>'+
            '<li>Primed possible birth outcome'+
              '<ul><li>Infant likely to go NICU</li><li>Delay in lactogenesis</li><li>Vast changes in insulin requirement</li><li>Later higher risk of mastitis -&gt; see lactation consultant</li></ul>'+
            '</li>'+
          '</ul>'
        };

        /* ── Note 16: Recurrent miscarriage ─────────────── */
        var n16 = this._id();
        this._d.notes[n16] = {id:n16,title:'Recurrent miscarriage',specialtyId:specPreg,categoryId:catClinical,order:6,createdAt:new Date('2025-11-15T14:25:00'),updatedAt:new Date('2025-11-15T14:25:00'),
        content:
          '<h2>Introduction</h2>'+
          '<ul>'+
            '<li>Definition: &ge;2 pregnancy loss</li>'+
            '<li>Prevalence: ~5% of couples</li>'+
            '<li>Causes are along</li>'+
            '<li>Aim to empowering the couple rather than attributing blame</li>'+
          '</ul>'+
          '<h2>Risk factors</h2>'+
          '<ul>'+
            '<li>Hypothyroidism</li>'+
            '<li>Poor DM control</li>'+
            '<li>Underweight/overweight'+
              '<ul><li>Control weight gain rate for obese</li><li>Folate 1000mcg/d for obese</li></ul>'+
            '</li>'+
            '<li>Exposed to listeria/heavy metal</li>'+
            '<li>Excessive caffeine (&gt;300mg/d) or alcohol</li>'+
            '<li>Untreated coeliac disease</li>'+
            '<li>Vitamin D / niacin / folate deficiency</li>'+
          '</ul>'
        };

        /* ── Note 17: Perinatal Anxiety & Depression ────── */
        var n17 = this._id();
        this._d.notes[n17] = {id:n17,title:'Perinatal Anxiety & Depression',specialtyId:specPreg,categoryId:catClinical,order:7,createdAt:new Date('2025-11-15T14:02:00'),updatedAt:new Date('2025-11-15T14:02:00'),
        content:
          '<h2>Prevalence</h2>'+
          '<ul>'+
            '<li>Depression: 14% (1 in 7 women)</li>'+
            '<li>Anxiety: 20% (1 in 5 women)</li>'+
            '<li>More prevalent in lower income community &amp; infertility</li>'+
          '</ul>'+
          '<h2>Risk factors</h2>'+
          '<ul>'+
            '<li>Preconception: Difficult conception, IVF, financial worries, PCOS, Hx of depression/anxiety</li>'+
            '<li>Pregnancy: Physically ill, fatigue, hyperglycemia, multi-parity, smoking</li>'+
            '<li>Delivery: Mode of delivery, emergency C section, delivery not going to plan</li>'+
            '<li>Postpartum: Hormonal change, sleep deprivation, lactation, lack of support</li>'+
          '</ul>'+
          '<h2>Signs and symptoms</h2>'+
          '<ul>'+
            '<li>Feeling down, depressed or hopeless</li>'+
            '<li>Anhedonia</li>'+
            '<li>Early morning awakening (~90% occurrence)</li>'+
            '<li>Tearful</li>'+
            '<li>Irritable</li>'+
            '<li>Poor memory</li>'+
            '<li>Difficult concentrating</li>'+
            '<li>Pounding heart</li>'+
            '<li>Stomach cramps</li>'+
            '<li>Weight loss</li>'+
          '</ul>'+
          '<h2>Consequences</h2>'+
          '<ul>'+
            '<li>Mother:'+
              '<ul><li>Affect early mother-infant interactions</li><li>Increased risk of low mood 1 year PP</li><li>Reduced breastfeeding rates</li></ul>'+
            '</li>'+
            '<li>Infant:'+
              '<ul><li>Affect gestational age</li><li>Birth weight</li><li>Compromised cognitive, emotional and behavioral development</li><li>Increase incidence of infant diarrhea and serious illness</li></ul>'+
            '</li>'+
          '</ul>'+
          '<h2>Assessment</h2>'+
          '<ol>'+
            '<li>Body weight: LOA vs emotional eating</li>'+
            '<li>Biochemistry: Folate &amp; Vit B12, Vit D, Omega 3, Iron</li>'+
            '<li>Hx of PCOS, endometriosis, hypothyroidism</li>'+
            '<li>Family Hx of mental illness</li>'+
            '<li>Fertility</li>'+
            '<li>Stress</li>'+
            '<li>Sleep</li>'+
            '<li>Digestive health &lt;-&gt; gut dysbiosis</li>'+
            '<li>Mediterranean diet compliance</li>'+
          '</ol>'+
          '<h2>Intervention</h2>'+
          '<ol>'+
            '<li>Low glycemic index diet</li>'+
            '<li>Fish and PUFA intake</li>'+
            '<li>Ca</li>'+
            '<li>Vit D</li>'+
            '<li>Zn</li>'+
            '<li>Se (inconclusive)</li>'+
            '<li>Mediterranean diet</li>'+
          '</ol>'
        };

        /* ── Note 18: IBS in Pregnancy ──────────────────── */
        var n18 = this._id();
        this._d.notes[n18] = {id:n18,title:'IBS in Pregnancy',specialtyId:specPreg,categoryId:catClinical,order:8,createdAt:new Date('2025-11-20T21:04:00'),updatedAt:new Date('2025-11-20T21:04:00'),
        content:
          '<h2>Common problem</h2>'+
          '<ul>'+
            '<li>Appetite changes, food craving</li>'+
            '<li>Morning sickness</li>'+
            '<li>More reflux / heartburn</li>'+
            '<li>Constipation</li>'+
            '<li>Switching from IBS-C to IBS-D or vice versa</li>'+
            '<li>IBS-D: Malabsorption; Dehydration -&gt; ?preterm labour</li>'+
            '<li>IBS-C: Increase risk of hemorrhoid; Pelvic floor problem</li>'+
          '</ul>'+
          '<h2>Implication of low FODMAP diet</h2>'+
          '<ul>'+
            '<li>Better to finish elimination and re-challenge phase before conception'+
              '<ul><li>Higher nutrient deficiency risk</li><li>Lack of fibre for increased insulin resistance in pregnancy</li></ul>'+
            '</li>'+
          '</ul>'+
          '<h2>Intervention</h2>'+
          '<ol>'+
            '<li>7-14 Day gut journal'+
              '<ul><li>Maintain normal diet and record in real time</li><li>Write everything eaten and drunk (including supplement, gum, meds)</li><li>Specific condiment, cooking method</li><li>Food portion</li><li>Detail symptoms including start time, duration and severity (1-10) \u2014 The food trigger usually occur in large intestine -&gt; may take &ge;12h</li><li>Also record non diet factors: daily activities, stressors</li></ul>'+
            '</li>'+
            '<li>Reduce caffeine to 50-100mg/d (1 tea or coffee, &lt;200mg/d as in normal pregnancy; if constipation, may not need to restrict too much)</li>'+
            '<li>Reduce high fat food</li>'+
            '<li>Avoid spicy food</li>'+
            '<li>Avoid fruit juices</li>'+
            '<li>Avoid carbonated drinks</li>'+
            '<li>Avoid chewing gums</li>'+
            '<li>Avoid sweeteners ending in "ol"</li>'+
            '<li>Increase fluid intake &gt;2L/d</li>'+
            '<li>Slowly increase soluble fibre intake despite constipation/diarrhea (Psyllium, Flaxseed, Chia seed)</li>'+
            '<li>Modification of meal pattern, portion size and speed of eating</li>'+
            '<li>Increase exercise to 3 times per week -&gt; train bowel muscle</li>'+
            '<li>Simplified low FODMAP diet'+
              '<ul><li>To identify and restrict the very high FODMAP food only if consumed frequently</li><li>Create a tailored list of food to avoid</li><li>Not appropriate in clients with eating disorder</li></ul>'+
            '</li>'+
            '<li>Management of constipation'+
              '<ul><li>Adequate fibre 25-30g/d + fluid &gt;2L/d</li><li>Morning routine to allow adequate response to urges</li><li>Trial of 0.5 tbsp/d psyllium husk, oat bran or flaxseed and step up</li><li>Regular exercise 3 times/week</li><li>Increase fruits intake (high fructose and sorbitol choices)</li><li>Stool softener</li></ul>'+
            '</li>'+
            '<li>Management of diarrhea'+
              '<ul><li>To rule out organic disease e.g. viral infection</li><li>Stop additional Mg supplement</li><li>Increase electrolytes fluids</li><li>Avoid food high in excess fructose and polyol</li><li>Reduce lactose if lactose intolerance</li></ul>'+
            '</li>'+
          '</ol>'
        };

        /* ── Note 19: Cholestasis in Pregnancy ──────────── */
        var n19 = this._id();
        this._d.notes[n19] = {id:n19,title:'Cholestasis in Pregnancy',specialtyId:specPreg,categoryId:catClinical,order:9,createdAt:new Date('2025-11-20T21:38:00'),updatedAt:new Date('2025-11-20T21:38:00'),
        content:
          '<h2>Introduction</h2>'+
          '<ul>'+
            '<li>Reduction in bile flow</li>'+
            '<li>Occurs in ~1% of pregnant women</li>'+
            '<li>Recurrence rate is 45-90%</li>'+
            '<li>Could lead to preterm birth or stillbirth</li>'+
            '<li>Can pre-program metabolic disease in children even without obesity/DM</li>'+
          '</ul>'+
          '<h2>Signs and symptoms</h2>'+
          '<ul>'+
            '<li>Pruritis without skin rash (usually on palms/soles) with dLFT, worst at night</li>'+
            '<li>Pale stool</li>'+
            '<li>Dark urine</li>'+
            '<li>Abdominal pain</li>'+
            '<li>Nausea</li>'+
          '</ul>'+
          '<h2>Assessment</h2>'+
          '<ol>'+
            '<li>Weight gain rate</li>'+
            '<li>LFT, bilirubin</li>'+
            '<li>Vit A, D, E, K</li>'+
            '<li>Stool consistency and colour</li>'+
            '<li>Soy and fat intake</li>'+
          '</ol>'+
          '<h2>Dietetic intervention</h2>'+
          '<ol>'+
            '<li>Optimize liver health'+
              '<ul><li>Adequate fluid</li><li>Weight management</li><li>Decrease unhealthy fat intake</li><li>Decrease sugar intake</li></ul>'+
            '</li>'+
            '<li>Check fat soluble vitamin level \u2234 may reduce fat absorption (no bile -&gt; reduced micelle)</li>'+
            '<li>Adequate fibre intake</li>'+
            '<li>Ensure no excessive soy intake \u2234 high estrogen will increase risk</li>'+
            '<li>May use low fat diet until absorption recommences + increase other macronutrients</li>'+
            '<li>Consider MCT oil (but coconut oil could still lead to diarrhea)</li>'+
            '<li>?beta-carotene supplementation</li>'+
          '</ol>'
        };

        /* ── Note 20: Immunity of infant ────────────────── */
        var n20 = this._id();
        this._d.notes[n20] = {id:n20,title:'Immunity of infant',specialtyId:specPreg,categoryId:catClinical,order:10,createdAt:new Date('2025-11-20T23:10:00'),updatedAt:new Date('2025-11-20T23:10:00'),
        content:
          '<h2>Factors affecting infant immunity</h2>'+
          '<ol>'+
            '<li>Maternal immunity'+
              '<ul><li>Adequate nutrition to increase maternal immunity</li><li>Leading to high IgE in infants</li><li>Better maternal immunity lead to lower infection risk and reduce preterm risk</li></ul>'+
            '</li>'+
            '<li>Placentation'+
              '<ul><li>Adequate nutrition to enhance blood flow and therefore deliver of antibodies</li></ul>'+
            '</li>'+
            '<li>Maternal gut microbiota'+
              '<ul><li>Increase prebiotic intake will: Reduce infection risk, Improve nutrient absorption</li></ul>'+
            '</li>'+
            '<li>Inflammation will affect foetal immune development</li>'+
            '<li>Obesity-induced placental inflammation will alter nutrient transport and affect infant immunity development</li>'+
          '</ol>'+
          '<h2>Prevention of allergy</h2>'+
          '<ol>'+
            '<li>Regular consumption of allergen throughout pregnancy and breastfeeding'+
              '<ul><li>Allow infant to expose to circulating maternal antigen</li><li>Overall aim at least twice a week</li><li>Advise 3 days a week for fish and seafood</li><li>Choose an egg day</li><li>Unborn baby usually start producing IgE since 20 weeks of pregnancy</li></ul>'+
            '</li>'+
            '<li>Adequate omega 3 consumption'+
              '<ul><li>Modulate foetal, neonatal or infant\'s immune system</li><li>Protective against childhood allergy</li></ul>'+
            '</li>'+
            '<li>Avoid high dose folic acid supplement in late pregnancy'+
              '<ul><li>Stop high dose when entering second trimester</li></ul>'+
            '</li>'+
            '<li>Optimise maternal gut microbiota'+
              '<ul><li>Not strong evidence</li><li>Not recommend probiotics yet</li></ul>'+
            '</li>'+
          '</ol>'
        };

        /* ── Note 21: Bariatric surgery & pregnancy ─────── */
        var n21 = this._id();
        this._d.notes[n21] = {id:n21,title:'Bariatric surgery & pregnancy',specialtyId:specPreg,categoryId:catClinical,order:11,createdAt:new Date('2025-11-20T21:26:00'),updatedAt:new Date('2025-11-20T21:26:00'),
        content:
          '<h2>Introduction</h2>'+
          '<ul>'+
            '<li>Increased risk of: Perinatal mortality, congenital abnormalities, preterm birth, SGA for malabsorption procedures e.g. RYGB / gastric banding</li>'+
            '<li>If pregnant during the rapid weight loss phase, expect:'+
              '<ul><li>Maternal weight gain will be less than reference</li><li>Fundal height may be less than reference</li><li>Recommend addition foetal growth scans</li></ul>'+
            '</li>'+
          '</ul>'+
          '<h2>Assessment</h2>'+
          '<ul>'+
            '<li>Common nutrient deficiency post surgery:'+
              '<ul><li>Sleeve gastrectomy: Vit B12, Vit D, Iron</li><li>RYGB: Vit B12, Vit D, Iron, Vit K, Vit A, Folate</li><li>Biliopancreatic diversion: Vit B12, Vit D, Folate, Copper, Zinc, Vit E</li></ul>'+
            '</li>'+
            '<li>OGTT is not reliable after bariatric surgery -&gt; OGTT-induced dumping syndrome'+
              '<ul><li>Use A1c in the first antenatal visit to exclude pre-existing DM</li><li>A1c is not used for GDM screening \u2234 delayed diagnosis</li><li>At 24-28 weeks, use H\'stix before and after meal, daily for 1 week</li></ul>'+
            '</li>'+
            '<li>Diagnostic criteria: &gt;5.3mmol/L before meals; &gt;7.8mmol/L 1 hour after meal; &gt;6.4mmol/L 2 hours after meal</li>'+
          '</ul>'+
          '<h2>Dietetic intervention</h2>'+
          '<ul>'+
            '<li>Insulin therapy'+
              '<ul><li>Hypoglycemia management</li><li>Treat with glucose tablet or honey if severe</li><li>Follow up with low GI snacks</li></ul>'+
            '</li>'+
          '</ul>'
        };

        /* ── Note 22: Prevention of Autism ───────────────── */
        var n22 = this._id();
        this._d.notes[n22] = {id:n22,title:'Prevention of Autism',specialtyId:specPreg,categoryId:catClinical,order:12,createdAt:new Date('2025-11-21T18:11:00'),updatedAt:new Date('2025-11-21T18:11:00'),
        content:
          '<h2>Factors</h2>'+
          '<ol>'+
            '<li>U shape of folic acid</li>'+
            '<li>Enough omega 3</li>'+
            '<li>Vit D?</li>'+
            '<li>Gut microbiota</li>'+
            '<li>Aspartame: contain methanol, maybe cause of neurological complications</li>'+
            '<li>Zinc</li>'+
            '<li>Iron deficiency can cause double risk in the presence of other risk factors</li>'+
            '<li>Weight is unclear</li>'+
            '<li>Pesticides, esp in 1-7 weeks of pregnancy and postnatal in week 4-12 weeks</li>'+
            '<li>Smoking and alcohol is weak in evidence</li>'+
          '</ol>'
        };

        /* ── Note 23: Food myths for Pregnancy ──────────── */
        var n23 = this._id();
        this._d.notes[n23] = {id:n23,title:'Food myths for Pregnancy',specialtyId:specPreg,categoryId:catClinical,order:13,createdAt:new Date('2025-11-21T18:23:00'),updatedAt:new Date('2025-11-21T18:23:00'),
        content:
          '<h2>Listeria</h2>'+
          '<ul>'+
            '<li>Effective dose: &gt;1000 organism</li>'+
            '<li>Chance is actually very rare: 0.0000373%</li>'+
            '<li>Death rate 20%</li>'+
            '<li>Could lead to listeriosis -&gt; miscarriage, preterm or still birth</li>'+
            '<li>Higher risk in 3rd trimester</li>'+
            '<li>Pregnancy immune is weakened \u2234 increased progesterone</li>'+
            '<li>Symptoms occur from few days to 6 weeks</li>'+
            '<li>Only extreme case will spread to developing baby</li>'+
            '<li>Take-home: make sensible choices but don\'t stress</li>'+
          '</ul>'+
          '<p><u>Preventive measures</u>: Keep below 5\u00B0C; Consume within 2-3 days</p>'+
          '<p><u>Dietetic intervention</u></p>'+
          '<ol>'+
            '<li>Reduce high risk food:'+
              '<ul><li>Pate, prawns, raw seafood, processed meat/chicken</li><li>Soft cheese even with pasteurized milk \u2234 maturation process 10-12 days -&gt; use hard cheese</li><li>Soft serve: poor hygiene and cleaning -&gt; try hard ice cream</li><li>Spam / luncheon meat</li></ul>'+
            '</li>'+
            '<li>Fruits &amp; veg: wash with running water, discard bad/bruised fruits, use freshly prepared, choose frozen/canned options</li>'+
            '<li>Avoid raw seafood</li>'+
            '<li>Avoid seed sprouts \u2234 multiple infectious sources (thoroughly cooked to reduce risk)</li>'+
            '<li>Reheat to boiling steaming temperature</li>'+
            '<li>Cooked crustaceans</li>'+
            '<li>When eating out, avoid lukewarm food and salad bar</li>'+
            '<li>Store leftovers after cooled quickly within 2 hours</li>'+
          '</ol>'+
          '<h2>Heavy metals</h2>'+
          '<p><strong>Mercury</strong></p>'+
          '<ul>'+
            '<li>Common sources: seafood</li>'+
            '<li>Maternal symptoms:'+
              '<ul><li>Early: tingling of extremities &amp; face, change in taste</li><li>Common: peripheral vision, muscle strength, walking &amp; coordination</li></ul>'+
            '</li>'+
          '</ul>'+
          '<p><u>Dietetic intervention</u></p>'+
          '<ol>'+
            '<li>Eating fish 2-3 serves weekly</li>'+
            '<li>Avoid high risk fish: Shark, ray, sword fish; Barramundi, gem fish; Orange roughy; Ling, Southern blue fin tuna</li>'+
          '</ol>'+
          '<p><strong>Lead</strong></p>'+
          '<ul>'+
            '<li>Common to have excess level in pregnancy</li>'+
            '<li>Will impair IQ, developmental delay, behaviours</li>'+
            '<li>Common sources: pica, Fe deficiency, lead glazed pottery</li>'+
          '</ul>'+
          '<p><u>Dietetic intervention</u>: Ensure adequate Fe and Ca intake</p>'+
          '<h2>Beverages in pregnancy</h2>'+
          '<p><strong>Caffeine</strong></p>'+
          '<ul>'+
            '<li>FDA &amp; NHS: &lt;200mg/d</li>'+
            '<li>Canada &amp; Aus: &lt;300mg/d</li>'+
            '<li>But one research showed no safe level</li>'+
            '<li>Goal: reduce if baseline high intake, abstain if not frequent drinker</li>'+
          '</ul>'+
          '<p><strong>Alcohol</strong></p>'+
          '<ul>'+
            '<li>Alcohol fetal syndrome can occur even with 1 drink/week</li>'+
            '<li>Extra 6% risk of miscarriage for every drink per week</li>'+
            '<li>Abstain from alcohol!</li>'+
          '</ul>'+
          '<p><strong>Herbal tea</strong></p>'+
          '<ul>'+
            '<li>Safe to drink as tea but not as medicine</li>'+
            '<li>May ease morning sickness, acid reflux</li>'+
            '<li>Safe dose: &le;3 cups daily</li>'+
            '<li>Safe choices: Peppermint, Ginger, Echinacea</li>'+
            '<li>Dangerous choices: Liquorice, Evening primrose oil</li>'+
          '</ul>'+
          '<h2>Trending food in pregnancy</h2>'+
          '<p><strong>Fermented food</strong></p>'+
          '<ul>'+
            '<li>While gut microbiota is linked to baby health, food safety of fermented food is questionable</li>'+
            '<li>Need to aware of ingredient, procedure and brand</li>'+
            '<li>Advise: eat more prebiotics better to promote gut microbiota</li>'+
          '</ul>'+
          '<p><strong>Sweetener</strong></p>'+
          '<ul>'+
            '<li>Governments stated are safe to consume during pregnancy</li>'+
            '<li>One study showed daily drink 1 serve will increase preterm risk</li>'+
            '<li>Safer choices (animal study): Aspartame (cannot cross placenta); Stevia &amp; Sucralose (no research showed major pregnancy complications)</li>'+
            '<li>Unsuitable choice: Acesulfame K (increase baby preference for sweetness); Saccharin</li>'+
          '</ul>'+
          '<p><strong>Protein powder</strong></p>'+
          '<ul>'+
            '<li>Usually no need supplement to meet RDA</li>'+
            '<li>One study showed &gt;85g protein daily cause growth delay</li>'+
            '<li>Protein powder may also contains caffeine, sweetener and heavy metal</li>'+
          '</ul>'+
          '<h2>Diet pattern in pregnancy</h2>'+
          '<p><strong>Ketogenic diet</strong></p>'+
          '<ul>'+
            '<li>Not recommend. Mixed results</li>'+
            '<li>Need to sign a waiver if keen to follow</li>'+
            '<li>Look out for adequacy of: Folate, Fibre, Iodine, Thiamine, Calcium, Iron, Magnesium</li>'+
            '<li>Increased fluid requirement</li>'+
            '<li>Ketone body passing through placenta -&gt; Linked to lower cognition</li>'+
          '</ul>'+
          '<p><strong>Vegan diet</strong></p>'+
          '<ul>'+
            '<li>Iron requirement: 50mg/d (60-120mg/d for deficiency)</li>'+
            '<li>B12: 2.6mcg/d</li>'+
            '<li>Zn: need 16mg/d (50% higher with phytate) \u2014 May need supplement</li>'+
            '<li>Omega 3: algae supplement (400-600mg DHA)</li>'+
            '<li>Choline: need supplement \u2234 Plant source is low</li>'+
            '<li>Iodine: blanch cabbage, cauliflower, radish to improve iodine availability</li>'+
            '<li>Overall diet: 1-2 serves of dark green veg, 4-5 serves of other veg and fruits, 3-4 serves of soy and legumes, &ge;6 serves of whole grain, 1-2 serves of nuts</li>'+
          '</ul>'
        };
      }
      _fire(col) { if(this._l[col]) this._l[col](Object.values(this._d[col]).sort((a,b)=>a.order-b.order)); }
      onSnapshot(col,cb) { this._l[col]=cb; this._fire(col); return ()=>{ delete this._l[col]; }; }
      add(col,data) { const id=this._id(); this._d[col][id]={...data,id,createdAt:new Date()}; this._fire(col); return id; }
      update(col,id,data) { if(this._d[col][id]){Object.assign(this._d[col][id],data,{updatedAt:new Date()}); this._fire(col);} }
      remove(col,id) { delete this._d[col][id]; this._fire(col); }
      batchRemove(ops) { ops.forEach(o=>delete this._d[o.col][o.id]); new Set(ops.map(o=>o.col)).forEach(c=>this._fire(c)); }
    }
    class FirebaseStore {
      constructor(db,uid) { this.db=db; this.uid=uid; }
      _c(n) { return this.db.collection('users').doc(this.uid).collection(n); }
      onSnapshot(col,cb) { return this._c(col).orderBy('order').onSnapshot(s=>cb(s.docs.map(d=>({id:d.id,...d.data()})))); }
      async add(col,data) { const r=await this._c(col).add({...data,createdAt:firebase.firestore.FieldValue.serverTimestamp()}); return r.id; }
      async update(col,id,data) { await this._c(col).doc(id).update({...data,updatedAt:firebase.firestore.FieldValue.serverTimestamp()}); }
      async remove(col,id) { await this._c(col).doc(id).delete(); }
      async batchRemove(ops) { const b=this.db.batch(); ops.forEach(o=>b.delete(this._c(o.col).doc(o.id))); await b.commit(); }
    }

    /* ═══ APP ═════════════════════════════════════════ */
    let store=null, appMode=null;
    const S = { categories:[], specialties:{}, notes:{}, unsubs:[],
      currentCatId:null, currentSpecId:null, currentNoteId:null };

    const $=s=>document.querySelector(s);
    const quill = new Quill('#quill-editor',{
      theme:'snow', placeholder:'Start writing your notes\u2026',
      modules:{ toolbar:[
        [{header:[1,2,3,false]}],['bold','italic','underline','strike'],
        [{color:[]},{background:[]}],[{list:'ordered'},{list:'bullet'}],
        ['blockquote','code-block'],['link','image'],['clean']
      ]}
    });

    /* ── Custom link handler (prompt() is blocked in sandbox) ── */
    (function() {
      var toolbar = quill.getModule('toolbar');
      toolbar.addHandler('link', function(value) {
        if (value) {
          var range = quill.getSelection(true);
          if (!range || range.length === 0) {
            /* no text selected — ask user for both text and URL via generic dialog */
            showLinkDialog('', '', function(url) {
              if (url) {
                quill.insertText(range.index, url, 'link', url, 'user');
              }
            });
          } else {
            var existing = quill.getFormat(range).link || '';
            showLinkDialog(existing, '', function(url) {
              if (url) {
                quill.format('link', url, 'user');
              }
            });
          }
        } else {
          quill.format('link', false, 'user');
        }
      });

      toolbar.addHandler('image', function() {
        showImagePickerDialog();
      });
    })();

    function showLinkDialog(existingUrl, existingText, onDone) {
      var dlgO = document.getElementById('dialog-overlay');
      document.getElementById('dialog-title').textContent = existingUrl ? 'Edit Link' : 'Insert Link';
      document.getElementById('dialog-message').textContent = 'Enter the URL:';
      var inp = document.getElementById('dialog-input');
      var inp2 = document.getElementById('dialog-input2');
      var lbl2 = document.getElementById('dialog-input2-label');
      inp.style.display = 'block'; inp.value = existingUrl || 'https://'; inp.placeholder = 'https://example.com';
      lbl2.style.display = 'none'; inp2.style.display = 'none';
      var bc = document.getElementById('dialog-buttons'); bc.innerHTML = '';
      var can = document.createElement('button'); can.className = 'btn-dialog-cancel'; can.textContent = 'Cancel';
      can.onclick = function() { dlgO.classList.remove('active'); quill.focus(); };
      var con = document.createElement('button'); con.className = 'btn-dialog-confirm'; con.textContent = existingUrl ? 'Update' : 'Insert';
      con.onclick = function() { dlgO.classList.remove('active'); onDone(inp.value.trim()); quill.focus(); };
      bc.appendChild(can); bc.appendChild(con);
      dlgO.classList.add('active');
      setTimeout(function() { inp.focus(); inp.select(); }, 80);
    }

    /* Hidden file input for image uploads */
    var imgFileInput = document.createElement('input');
    imgFileInput.type = 'file';
    imgFileInput.accept = 'image/*';
    imgFileInput.style.display = 'none';
    document.body.appendChild(imgFileInput);

    function showImagePickerDialog() {
      var dlgO = document.getElementById('dialog-overlay');
      document.getElementById('dialog-title').textContent = 'Insert Image';
      document.getElementById('dialog-message').textContent = '';
      var inp = document.getElementById('dialog-input');
      var inp2 = document.getElementById('dialog-input2');
      var lbl2 = document.getElementById('dialog-input2-label');
      inp.style.display = 'none'; inp2.style.display = 'none'; lbl2.style.display = 'none';

      var msgEl = document.getElementById('dialog-message');
      msgEl.innerHTML = '';

      /* Upload button */
      var uploadBtn = document.createElement('button');
      uploadBtn.className = 'btn-img-upload';
      uploadBtn.innerHTML = '<i class="fas fa-cloud-arrow-up"></i> Upload from device';
      uploadBtn.onclick = function() {
        imgFileInput.value = '';
        imgFileInput.onchange = function() {
          if (!imgFileInput.files || !imgFileInput.files[0]) return;
          var file = imgFileInput.files[0];
          if (file.size > 5 * 1024 * 1024) {
            statusEl.textContent = 'Image too large (max 5 MB)';
            statusEl.style.color = 'var(--c-danger)';
            return;
          }
          statusEl.textContent = 'Reading image\u2026';
          statusEl.style.color = 'var(--c-primary)';
          var reader = new FileReader();
          reader.onload = function(e) {
            dlgO.classList.remove('active');
            var range = quill.getSelection(true);
            quill.insertEmbed(range.index, 'image', e.target.result, 'user');
            quill.setSelection(range.index + 1, 0, 'silent');
            quill.focus();
          };
          reader.onerror = function() {
            statusEl.textContent = 'Failed to read image';
            statusEl.style.color = 'var(--c-danger)';
          };
          reader.readAsDataURL(file);
        };
        imgFileInput.click();
      };
      msgEl.appendChild(uploadBtn);

      /* Divider */
      var divider = document.createElement('div');
      divider.className = 'img-divider';
      divider.innerHTML = '<span>or paste a URL</span>';
      msgEl.appendChild(divider);

      /* URL row */
      var urlRow = document.createElement('div');
      urlRow.className = 'img-url-row';
      var urlInp = document.createElement('input');
      urlInp.type = 'text'; urlInp.placeholder = 'https://example.com/photo.jpg';
      urlInp.className = 'img-url-input';
      var urlBtn = document.createElement('button');
      urlBtn.className = 'btn-dialog-confirm img-url-btn';
      urlBtn.textContent = 'Insert';
      urlBtn.onclick = function() {
        var u = urlInp.value.trim();
        if (u) {
          dlgO.classList.remove('active');
          var range = quill.getSelection(true);
          quill.insertEmbed(range.index, 'image', u, 'user');
          quill.setSelection(range.index + 1, 0, 'silent');
          quill.focus();
        }
      };
      urlInp.addEventListener('keydown', function(e) { if (e.key === 'Enter') urlBtn.click(); });
      urlRow.appendChild(urlInp);
      urlRow.appendChild(urlBtn);
      msgEl.appendChild(urlRow);

      /* Status line */
      var statusEl = document.createElement('div');
      statusEl.className = 'img-status';
      msgEl.appendChild(statusEl);

      var bc = document.getElementById('dialog-buttons'); bc.innerHTML = '';
      var can = document.createElement('button'); can.className = 'btn-dialog-cancel'; can.textContent = 'Cancel';
      can.onclick = function() { dlgO.classList.remove('active'); quill.focus(); };
      bc.appendChild(can);
      dlgO.classList.add('active');
    }

    function esc(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
    function getSublabel(cat) { return (cat && cat.sublabel) || 'Specialty'; }
    function pluralize(word, count) {
      if (count === 1) return word;
      const w = word.toLowerCase();
      if (w.endsWith('y') && !/[aeiou]y$/i.test(w)) return word.slice(0,-1)+'ies';
      if (w.endsWith('s')||w.endsWith('x')||w.endsWith('ch')||w.endsWith('sh')) return word+'es';
      return word+'s';
    }
    function stripHtml(html) {
      const tmp = document.createElement('div');
      tmp.innerHTML = html || '';
      return (tmp.textContent || tmp.innerText || '').replace(/\s+/g,' ').trim();
    }
    function fmtDate(d) {
      if(!d) return '';
      const dt = d instanceof Date ? d : (d.toDate ? d.toDate() : null);
      return dt ? dt.toLocaleDateString('en-US',{day:'numeric',month:'short',year:'numeric'}) : '';
    }
    function fmtDateLong(d) {
      if(!d) return '';
      const dt = d instanceof Date ? d : (d.toDate ? d.toDate() : null);
      return dt ? dt.toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '';
    }

    /* ── Views ────────────────────────────────────── */
    const views = ['view-cats','view-specs','view-notes','view-editor'];
    function showView(id) {
      views.forEach(v => $('#'+v).classList.remove('active'));
      $('#'+id).classList.add('active');
      const fab = $('#fab-add');
      if (id==='view-cats') { fab.classList.add('visible'); fab.title='New Category'; fab.onclick=()=>createCategory(); }
      else if (id==='view-specs') { const cat=S.categories.find(c=>c.id===S.currentCatId); fab.classList.add('visible'); fab.title='New '+getSublabel(cat); fab.onclick=()=>createSpecialty(); }
      else if (id==='view-notes') { fab.classList.add('visible'); fab.title='New Note'; fab.onclick=()=>createNote(); }
      else { fab.classList.remove('visible'); }
    }

    /* ── Dialog ───────────────────────────────────── */
    const dlg = $('#dialog-overlay');
    function showDialog(opts) {
      $('#dialog-title').textContent=opts.title||'';
      $('#dialog-message').textContent=opts.message||'';
      const inp=$('#dialog-input');
      const inp2=$('#dialog-input2');
      const lbl2=$('#dialog-input2-label');
      if(opts.input){inp.style.display='block';inp.value=opts.placeholder||'';} else{inp.style.display='none';}
      if(opts.input2){lbl2.style.display='block';lbl2.textContent=opts.input2label||'';inp2.style.display='block';inp2.value=opts.placeholder2||'';inp2.placeholder=opts.hint2||'';} else{lbl2.style.display='none';inp2.style.display='none';}
      const bc=$('#dialog-buttons'); bc.innerHTML='';
      const can=document.createElement('button'); can.className='btn-dialog-cancel'; can.textContent='Cancel'; can.onclick=()=>dlg.classList.remove('active');
      const con=document.createElement('button'); con.className=opts.confirmClass||'btn-dialog-confirm'; con.textContent=opts.confirmText||'OK';
      con.onclick=()=>{ dlg.classList.remove('active'); opts.onConfirm(opts.input?inp.value.trim():true, opts.input2?inp2.value.trim():''); };
      bc.appendChild(can); bc.appendChild(con);
      dlg.classList.add('active');
      if(opts.input) setTimeout(()=>{inp.focus();inp.select();},80);
    }
    dlg.addEventListener('click',e=>{ if(e.target===dlg) dlg.classList.remove('active'); });
    $('#dialog-input').addEventListener('keydown',e=>{ if(e.key==='Enter'){ if($('#dialog-input2').style.display!=='none'){$('#dialog-input2').focus();} else{const b=$('#dialog-box').querySelector('.btn-dialog-confirm,.btn-dialog-danger'); if(b)b.click();} }});
    $('#dialog-input2').addEventListener('keydown',e=>{ if(e.key==='Enter'){ const b=$('#dialog-box').querySelector('.btn-dialog-confirm,.btn-dialog-danger'); if(b)b.click(); }});

    /* ── Setup tabs ───────────────────────────────── */
    document.querySelectorAll('.setup-tab').forEach(t=>t.addEventListener('click',()=>{
      document.querySelectorAll('.setup-tab').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.setup-panel').forEach(x=>x.classList.remove('active'));
      t.classList.add('active'); $('#panel-'+t.dataset.tab).classList.add('active');
    }));

    /* ── Demo ─────────────────────────────────────── */
    $('#btn-start-demo').addEventListener('click',()=>{
      appMode='demo'; store=new InMemoryStore();
      $('#setup-screen').style.display='none'; $('#app').classList.add('active');
      $('#mode-chip').style.display='inline'; loadData(); showView('view-cats');
    });

    /* ── Firebase ─────────────────────────────────── */
    var FIREBASE_CONFIG = {
      apiKey: "AIzaSyAAlS2pDwWaMrzmklGyiyQ21hsk_79rfBg",
      authDomain: "dietetic-note.firebaseapp.com",
      projectId: "dietetic-note",
      storageBucket: "dietetic-note.firebasestorage.app",
      messagingSenderId: "327184138289",
      appId: "1:327184138289:web:e64ec5e88e92ed1bde9510"
    };
    $('#btn-connect-firebase').addEventListener('click',()=>{
      try{
        if(!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
        appMode='firebase'; $('#setup-screen').style.display='none'; $('#login-screen').style.display='flex';
        firebase.auth().onAuthStateChanged(u=>{
          if(u){ store=new FirebaseStore(firebase.firestore(),u.uid); $('#login-screen').style.display='none'; $('#app').classList.add('active'); $('#mode-chip').style.display='none'; loadData(); showView('view-cats'); }
          else{ $('#app').classList.remove('active'); $('#login-screen').style.display='flex'; S.unsubs.forEach(f=>f()); S.unsubs=[]; }
        });
      }catch(err){const e=$('#setup-error');e.textContent='Firebase error: '+err.message;e.classList.add('active');}
    });
    $('#btn-google-signin').addEventListener('click',async()=>{
      try{ await firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider()); }catch(e){ console.log('Auth:'+e.message); }
    });
    $('#btn-back-setup').addEventListener('click',()=>{ $('#login-screen').style.display='none'; $('#setup-screen').style.display='flex'; });
    $('#btn-signout').addEventListener('click',()=>{
      showDialog({ title:'Sign Out', message:appMode==='demo'?'Leave demo? Data will be lost.':'Sign out?',
        confirmText:appMode==='demo'?'Leave':'Sign Out', confirmClass:'btn-dialog-danger',
        onConfirm:()=>{ saveCurrentNote(); S.unsubs.forEach(f=>f()); S.unsubs=[]; S.categories=[]; S.specialties={}; S.notes={};
          S.currentCatId=null; S.currentSpecId=null; S.currentNoteId=null;
          $('#app').classList.remove('active'); showView('view-cats');
          if(appMode==='firebase') firebase.auth().signOut(); else $('#setup-screen').style.display='flex'; }
      });
    });

    /* ── Navigation ───────────────────────────────── */
    $('#back-to-cats').addEventListener('click',()=>showView('view-cats'));
    $('#back-to-specs').addEventListener('click',()=>showView('view-specs'));
    $('#back-to-notes').addEventListener('click',()=>{ saveCurrentNote(); S.currentNoteId=null; showView('view-notes'); });

    /* ── Load Data ────────────────────────────────── */
    function loadData() {
      S.unsubs.forEach(f=>f()); S.unsubs=[];
      S.unsubs.push(store.onSnapshot('categories',items=>{ S.categories=items; renderCats(); }));
      S.unsubs.push(store.onSnapshot('specialties',items=>{
        S.specialties={}; items.forEach(s=>{ if(!S.specialties[s.categoryId]) S.specialties[s.categoryId]=[]; S.specialties[s.categoryId].push(s); });
        renderCats(); renderSpecs(); renderNotes();
      }));
      S.unsubs.push(store.onSnapshot('notes',items=>{
        S.notes={}; items.forEach(n=>{ if(!S.notes[n.specialtyId]) S.notes[n.specialtyId]=[]; S.notes[n.specialtyId].push(n); });
        renderCats(); renderSpecs(); renderNotes();
        if(S.currentNoteId){ const all=Object.values(S.notes).flat(); if(!all.find(n=>n.id===S.currentNoteId)){S.currentNoteId=null; showView('view-notes');} }
      }));
    }

    /* Helper: get specialty name by ID */
    function getSpecName(specId) {
      for (const catId of Object.keys(S.specialties)) {
        const found = S.specialties[catId].find(sp => sp.id === specId);
        if (found) return found.name;
      }
      return '';
    }

    /* ═══ RENDER ══════════════════════════════════════ */
    function renderCats() {
      const el=$('#cats-list'); el.innerHTML='';
      if(S.categories.length===0){ el.innerHTML='<div class="empty-list"><div class="ei">📁</div><h3>No categories yet</h3><p>Tap + to create your first category.</p></div>'; return; }
      S.categories.forEach(cat=>{
        const specs=S.specialties[cat.id]||[];
        const totalNotes = specs.reduce((sum,sp)=>(S.notes[sp.id]||[]).length+sum,0);
        const row=document.createElement('div'); row.className='list-item';
        row.innerHTML=
          '<div class="li-icon cat-icon"><i class="fas fa-folder"></i></div>'+
          '<div class="li-body"><div class="li-name">'+esc(cat.name)+'</div><div class="li-meta">'+specs.length+' '+esc(pluralize(getSublabel(cat),specs.length).toLowerCase())+' &middot; '+totalNotes+' notes</div></div>'+
          '<span class="li-actions">'+
            '<button class="act-btn" data-a="ren" title="Rename"><i class="fas fa-pen"></i></button>'+
            '<button class="act-btn danger" data-a="del" title="Delete"><i class="fas fa-trash"></i></button>'+
          '</span>'+
          '<span class="li-arrow"><i class="fas fa-chevron-right"></i></span>';
        row.addEventListener('click',e=>{ if(e.target.closest('[data-a]')) return; S.currentCatId=cat.id; renderSpecs(); showView('view-specs'); });
        row.querySelector('[data-a="ren"]').addEventListener('click',()=>renameItem('categories',cat.id,cat.name));
        row.querySelector('[data-a="del"]').addEventListener('click',()=>deleteCategory(cat.id,cat.name));
        el.appendChild(row);
      });
    }

    function renderSpecs() {
      if(!S.currentCatId) return;
      const cat = S.categories.find(c=>c.id===S.currentCatId);
      if(!cat) return;
      const sub = getSublabel(cat);
      $('#specs-title').textContent=cat.name;
      const specs = S.specialties[S.currentCatId]||[];
      const el=$('#specs-list'); el.innerHTML='';
      if(specs.length===0){ el.innerHTML='<div class="empty-list"><div class="ei">🔖</div><h3>No '+esc(pluralize(sub,0).toLowerCase())+' yet</h3><p>Tap + to add a '+esc(sub.toLowerCase())+'.</p></div>'; return; }
      specs.forEach(spec=>{
        const nl=S.notes[spec.id]||[];
        const tplCount = Array.isArray(spec.template) ? spec.template.length : 0;
        const metaParts = [nl.length+' notes'];
        if(tplCount>0) metaParts.push(tplCount+' section'+(tplCount!==1?'s':''));
        const row=document.createElement('div'); row.className='list-item';
        row.innerHTML=
          '<div class="li-icon spec-icon"><i class="fas fa-bookmark"></i></div>'+
          '<div class="li-body"><div class="li-name">'+esc(spec.name)+'</div><div class="li-meta">'+metaParts.join(' &middot; ')+'</div></div>'+
          '<span class="li-actions">'+
            '<button class="act-btn" data-a="tpl" title="Edit Template"><i class="fas fa-table-columns"></i></button>'+
            '<button class="act-btn" data-a="ren" title="Rename"><i class="fas fa-pen"></i></button>'+
            '<button class="act-btn danger" data-a="del" title="Delete"><i class="fas fa-trash"></i></button>'+
          '</span>'+
          '<span class="li-arrow"><i class="fas fa-chevron-right"></i></span>';
        row.addEventListener('click',e=>{ if(e.target.closest('[data-a]')) return; S.currentSpecId=spec.id; renderNotes(); showView('view-notes'); });
        row.querySelector('[data-a="tpl"]').addEventListener('click',()=>openTemplateEditor(spec.id));
        row.querySelector('[data-a="ren"]').addEventListener('click',()=>renameItem('specialties',spec.id,spec.name));
        row.querySelector('[data-a="del"]').addEventListener('click',()=>deleteSpecialty(spec.id,spec.name));
        el.appendChild(row);
      });
    }

    function renderNotes() {
      if(!S.currentSpecId) return;
      const cat=S.categories.find(c=>c.id===S.currentCatId);
      let specObj=null;
      (S.specialties[S.currentCatId]||[]).forEach(sp=>{ if(sp.id===S.currentSpecId) specObj=sp; });
      if(!specObj) return;
      $('#notes-title').textContent=specObj.name;
      const nl=S.notes[S.currentSpecId]||[];
      const el=$('#notes-list'); el.innerHTML='';
      if(nl.length===0){ el.innerHTML='<div class="empty-list"><div class="ei">📝</div><h3>No notes yet</h3><p>Tap + to create a note.</p></div>'; return; }
      nl.forEach(note=>{
        const preview = stripHtml(note.content);
        const tagName = specObj ? specObj.name : '';
        const card=document.createElement('div'); card.className='note-card';
        card.innerHTML=
          '<div class="nc-title">'+esc(note.title||'Untitled Note')+'</div>'+
          '<div class="nc-row">'+
            (tagName ? '<span class="nc-tag">'+esc(tagName)+'</span>' : '')+
            '<span class="nc-date">'+fmtDate(note.updatedAt||note.createdAt)+'</span>'+
          '</div>'+
          (preview ? '<div class="nc-preview">'+esc(preview)+'</div>' : '')+
          '<span class="nc-actions">'+
            '<button class="act-btn" data-a="move" title="Move"><i class="fas fa-arrow-right-arrow-left"></i></button>'+
            '<button class="act-btn" data-a="ren" title="Rename"><i class="fas fa-pen"></i></button>'+
            '<button class="act-btn danger" data-a="del" title="Delete"><i class="fas fa-trash"></i></button>'+
          '</span>';
        card.addEventListener('click',e=>{ if(e.target.closest('[data-a]')) return; openNote(note.id); });
        card.querySelector('[data-a="move"]').addEventListener('click',()=>openMoveDialog(note.id,note.title));
        card.querySelector('[data-a="ren"]').addEventListener('click',()=>renameNote(note.id,note.title));
        card.querySelector('[data-a="del"]').addEventListener('click',()=>deleteNote(note.id,note.title));
        el.appendChild(card);
      });
    }

    /* ═══ CRUD ════════════════════════════════════════ */
    function createCategory() {
      showDialog({ title:'New Category', message:'Enter category name:', input:true, placeholder:'e.g. Clinical Dietetics',
        input2:true, input2label:'What do you call the 2nd layer?', placeholder2:'Specialty', hint2:'e.g. Specialty, Type, Topic',
        confirmText:'Create',
        onConfirm:(n,sub)=>{ if(n) store.add('categories',{name:n,sublabel:sub||'Specialty',order:S.categories.length}); }});
    }
    function createSpecialty() {
      const cat=S.categories.find(c=>c.id===S.currentCatId);
      const sub=getSublabel(cat);
      showDialog({ title:'New '+sub, message:'Enter '+sub.toLowerCase()+' name:', input:true, placeholder:'e.g. Renal Nutrition', confirmText:'Create',
        onConfirm:n=>{ if(n) store.add('specialties',{name:n,categoryId:S.currentCatId,order:(S.specialties[S.currentCatId]||[]).length}); }});
    }
    function createNote() { openNewNoteDialog(); }
    function deleteCategory(id,name) {
      showDialog({ title:'Delete Category', message:'Delete "'+name+'" and all contents?', confirmText:'Delete', confirmClass:'btn-dialog-danger',
        onConfirm:()=>{ const ops=[{col:'categories',id}]; (S.specialties[id]||[]).forEach(s=>{ ops.push({col:'specialties',id:s.id}); (S.notes[s.id]||[]).forEach(n=>ops.push({col:'notes',id:n.id})); }); store.batchRemove(ops); }});
    }
    function deleteSpecialty(id,name) {
      const cat=S.categories.find(c=>c.id===S.currentCatId);
      const sub=getSublabel(cat);
      showDialog({ title:'Delete '+sub, message:'Delete "'+name+'" and all notes?', confirmText:'Delete', confirmClass:'btn-dialog-danger',
        onConfirm:()=>{ const ops=[{col:'specialties',id}]; (S.notes[id]||[]).forEach(n=>ops.push({col:'notes',id:n.id})); store.batchRemove(ops); }});
    }
    function deleteNote(id,title) {
      showDialog({ title:'Delete Note', message:'Delete "'+(title||'Untitled Note')+'"?', confirmText:'Delete', confirmClass:'btn-dialog-danger',
        onConfirm:()=>{ store.remove('notes',id); if(S.currentNoteId===id){S.currentNoteId=null; showView('view-notes');} }});
    }
    function renameItem(col,id,cur) {
      if(col==='categories'){
        const catObj=S.categories.find(c=>c.id===id);
        const curSub=getSublabel(catObj);
        showDialog({ title:'Edit Category', message:'Category name:', input:true, placeholder:cur,
          input2:true, input2label:'2nd layer label:', placeholder2:curSub, hint2:'e.g. Specialty, Type, Topic',
          confirmText:'Save',
          onConfirm:(n,sub)=>{ if(n) store.update(col,id,{name:n,sublabel:sub||curSub}); }});
      } else {
        const cat=S.categories.find(c=>c.id===S.currentCatId);
        const sub=getSublabel(cat);
        showDialog({ title:'Rename '+sub, message:'Enter new name:', input:true, placeholder:cur, confirmText:'Rename',
          onConfirm:n=>{ if(n) store.update(col,id,{name:n}); }});
      }
    }
    function renameNote(id,cur) {
      showDialog({ title:'Rename Note', message:'Enter new title:', input:true, placeholder:cur||'Untitled Note', confirmText:'Rename',
        onConfirm:n=>{ if(!n)return; store.update('notes',id,{title:n}); if(S.currentNoteId===id) $('#note-title').value=n; }});
    }

    /* ═══ EDITOR ══════════════════════════════════════ */
    function openNote(noteId) {
      saveCurrentNote();
      S.currentNoteId=noteId;
      let noteData=null;
      for(const k of Object.keys(S.notes)){ const f=S.notes[k].find(n=>n.id===noteId); if(f){noteData=f;break;} }
      if(!noteData) return;
      const cat=S.categories.find(c=>c.id===S.currentCatId);
      let specObj=null; (S.specialties[S.currentCatId]||[]).forEach(sp=>{ if(sp.id===S.currentSpecId) specObj=sp; });
      $('#editor-crumb').innerHTML = (cat?esc(cat.name):'') + ' <span style="color:var(--c-text-muted);font-size:12px;font-family:var(--font-main)"> &rsaquo; ' + (specObj?esc(specObj.name):'') + '</span>';
      $('#note-title').value=noteData.title||'';
      $('#note-meta').textContent=noteData.updatedAt ? 'Last updated: '+fmtDateLong(noteData.updatedAt) : '';
      quill.root.innerHTML=noteData.content||'';
      showView('view-editor');
    }
    $('#back-to-notes').addEventListener('click',()=>{ saveCurrentNote(); S.currentNoteId=null; showView('view-notes'); });

    /* ── Auto-save ────────────────────────────────── */
    let saveTimer=null;
    function scheduleSave() { if(saveTimer) clearTimeout(saveTimer); $('#save-status').textContent=''; $('#save-status').className='save-status'; saveTimer=setTimeout(saveCurrentNote,1000); }
    async function saveCurrentNote() {
      if(!S.currentNoteId||!store) return;
      const title=$('#note-title').value.trim()||'Untitled Note';
      const content=quill.root.innerHTML;
      const ss=$('#save-status');
      ss.innerHTML='<i class="fas fa-circle-notch fa-spin"></i> Saving\u2026'; ss.className='save-status saving';
      try{ await store.update('notes',S.currentNoteId,{title,content});
        ss.innerHTML='<i class="fas fa-check"></i> Saved'; ss.className='save-status saved';
        setTimeout(()=>{ if(ss.classList.contains('saved')){ss.textContent='';ss.className='save-status';} },2000);
      }catch(e){ ss.innerHTML='<i class="fas fa-exclamation-circle"></i> Error'; ss.className='save-status error'; }
    }
    quill.on('text-change',scheduleSave);
    $('#note-title').addEventListener('input',scheduleSave);

    /* ═══ IMAGE RESIZE ═════════════════════════════════ */
    (function() {
      var qlContainer = document.querySelector('.ql-container');
      var wrap = null;     /* the overlay element */
      var activeImg = null; /* currently selected img */
      var startX, startY, startW, startH, ratio, handleType;
      var dragging = false;

      function createWrap() {
        wrap = document.createElement('div');
        wrap.className = 'img-resize-wrap';
        ['nw','ne','sw','se'].forEach(function(pos) {
          var h = document.createElement('div');
          h.className = 'img-handle h-' + pos;
          h.dataset.handle = pos;
          h.addEventListener('mousedown', onHandleDown);
          h.addEventListener('touchstart', onHandleDown, { passive: false });
          wrap.appendChild(h);
        });
        var info = document.createElement('div');
        info.className = 'img-resize-info';
        wrap.appendChild(info);
        qlContainer.appendChild(wrap);
      }

      function selectImage(img) {
        if (activeImg === img && wrap) return;
        deselectImage();
        activeImg = img;
        if (!wrap) createWrap();
        positionWrap();
        wrap.style.display = 'block';
      }

      function deselectImage() {
        activeImg = null;
        if (wrap) wrap.style.display = 'none';
      }

      function positionWrap() {
        if (!activeImg || !wrap) return;
        var contRect = qlContainer.getBoundingClientRect();
        var imgRect = activeImg.getBoundingClientRect();
        wrap.style.left = (imgRect.left - contRect.left + qlContainer.scrollLeft) + 'px';
        wrap.style.top = (imgRect.top - contRect.top + qlContainer.scrollTop) + 'px';
        wrap.style.width = imgRect.width + 'px';
        wrap.style.height = imgRect.height + 'px';
        var infoEl = wrap.querySelector('.img-resize-info');
        if (infoEl) infoEl.textContent = Math.round(imgRect.width) + ' × ' + Math.round(imgRect.height);
      }

      function getEventXY(e) {
        if (e.touches && e.touches.length > 0) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
        return { x: e.clientX, y: e.clientY };
      }

      function onHandleDown(e) {
        if (!activeImg) return;
        e.preventDefault();
        e.stopPropagation();
        dragging = true;
        handleType = e.currentTarget.dataset.handle;
        var pos = getEventXY(e);
        startX = pos.x;
        startY = pos.y;
        startW = activeImg.getBoundingClientRect().width;
        startH = activeImg.getBoundingClientRect().height;
        ratio = startH / startW;
        document.addEventListener('mousemove', onHandleMove);
        document.addEventListener('mouseup', onHandleUp);
        document.addEventListener('touchmove', onHandleMove, { passive: false });
        document.addEventListener('touchend', onHandleUp);
      }

      function onHandleMove(e) {
        if (!dragging || !activeImg) return;
        e.preventDefault();
        var pos = getEventXY(e);
        var dx = pos.x - startX;
        var dy = pos.y - startY;
        var newW = startW;

        if (handleType === 'se') newW = startW + dx;
        else if (handleType === 'sw') newW = startW - dx;
        else if (handleType === 'ne') newW = startW + dx;
        else if (handleType === 'nw') newW = startW - dx;

        newW = Math.max(40, Math.min(newW, qlContainer.clientWidth - 40));
        activeImg.style.width = Math.round(newW) + 'px';
        activeImg.style.height = 'auto';
        activeImg.removeAttribute('width');
        activeImg.removeAttribute('height');
        positionWrap();
      }

      function onHandleUp(e) {
        dragging = false;
        document.removeEventListener('mousemove', onHandleMove);
        document.removeEventListener('mouseup', onHandleUp);
        document.removeEventListener('touchmove', onHandleMove);
        document.removeEventListener('touchend', onHandleUp);
        if (activeImg) {
          positionWrap();
          scheduleSave();
        }
      }

      /* Click on image to select */
      quill.root.addEventListener('click', function(e) {
        if (e.target.tagName === 'IMG') {
          e.preventDefault();
          selectImage(e.target);
        } else {
          if (!dragging) deselectImage();
        }
      });

      /* Deselect when clicking toolbar or outside */
      document.querySelector('.ql-toolbar').addEventListener('mousedown', function() {
        if (!dragging) deselectImage();
      });

      /* Reposition on scroll */
      qlContainer.addEventListener('scroll', function() {
        if (activeImg && wrap && wrap.style.display !== 'none') positionWrap();
      });

      /* Deselect on text change if image removed */
      quill.on('text-change', function() {
        if (activeImg && !quill.root.contains(activeImg)) deselectImage();
        else if (activeImg && wrap && wrap.style.display !== 'none') {
          requestAnimationFrame(positionWrap);
        }
      });
    })();

    /* ═══ NEW NOTE DIALOG ══════════════════════════════ */
    (function() {
      var nnOverlay = $('#newnote-overlay');
      var nnTitleInput = $('#newnote-title');
      var nnSections = $('#newnote-sections');
      var nnSecLabel = $('#newnote-sec-label');
      var nnAddBtn = $('#newnote-add-sec');
      var nnCreateBtn = $('#newnote-create');
      var nnCancelBtn = $('#newnote-cancel');
      var nnSubs = $('#newnote-subtitle');
      var nnSecs = []; /* working copy of section names */

      function openNewNoteDialog() {
        var specs = S.specialties[S.currentCatId] || [];
        var specObj = specs.find(function(sp) { return sp.id === S.currentSpecId; });
        var template = (specObj && Array.isArray(specObj.template)) ? specObj.template : [];
        nnSecs = template.slice();

        nnTitleInput.value = '';

        if (template.length > 0) {
          nnSubs.textContent = 'Customize sections for this note, then tap Create.';
          nnSecLabel.style.display = '';
          nnAddBtn.style.display = '';
        } else {
          nnSubs.textContent = 'Enter a title and tap Create. You can add sections below if needed.';
          nnSecLabel.style.display = '';
          nnAddBtn.style.display = '';
        }

        renderNNRows();
        nnOverlay.classList.add('active');
        setTimeout(function() { nnTitleInput.focus(); }, 80);
      }
      /* expose to global createNote */
      window.openNewNoteDialog = openNewNoteDialog;

      function renderNNRows() {
        nnSections.innerHTML = '';
        if (nnSecs.length === 0) {
          nnSections.innerHTML = '<div class="newnote-nosec">No sections. The note will start blank.</div>';
          return;
        }
        nnSecs.forEach(function(name, i) {
          var row = document.createElement('div');
          row.className = 'tpl-row';
          var isFirst = i === 0;
          var isLast = i === nnSecs.length - 1;
          row.innerHTML =
            '<span class="tpl-num">' + (i + 1) + '</span>' +
            '<input type="text" value="' + esc(name) + '" placeholder="Section name">' +
            '<span class="tpl-btns">' +
              '<button class="tpl-btn" data-a="up" title="Move up"' + (isFirst ? ' disabled' : '') + '><i class="fas fa-chevron-up"></i></button>' +
              '<button class="tpl-btn" data-a="down" title="Move down"' + (isLast ? ' disabled' : '') + '><i class="fas fa-chevron-down"></i></button>' +
              '<button class="tpl-btn danger" data-a="rm" title="Remove"><i class="fas fa-xmark"></i></button>' +
            '</span>';

          var inp = row.querySelector('input');
          inp.addEventListener('input', function() { nnSecs[i] = inp.value; });

          row.querySelector('[data-a="up"]').addEventListener('click', function() {
            if (i > 0) { var tmp = nnSecs[i - 1]; nnSecs[i - 1] = nnSecs[i]; nnSecs[i] = tmp; renderNNRows(); }
          });
          row.querySelector('[data-a="down"]').addEventListener('click', function() {
            if (i < nnSecs.length - 1) { var tmp = nnSecs[i]; nnSecs[i] = nnSecs[i + 1]; nnSecs[i + 1] = tmp; renderNNRows(); }
          });
          row.querySelector('[data-a="rm"]').addEventListener('click', function() {
            nnSecs.splice(i, 1); renderNNRows();
          });

          nnSections.appendChild(row);
        });
      }

      nnAddBtn.addEventListener('click', function() {
        nnSecs.push('New Section');
        renderNNRows();
        var inputs = nnSections.querySelectorAll('input');
        var last = inputs[inputs.length - 1];
        if (last) { last.focus(); last.select(); }
      });

      nnCancelBtn.addEventListener('click', function() { nnOverlay.classList.remove('active'); });
      nnOverlay.addEventListener('click', function(e) { if (e.target === nnOverlay) nnOverlay.classList.remove('active'); });

      nnCreateBtn.addEventListener('click', function() {
        var title = nnTitleInput.value.trim() || 'Untitled Note';
        var cleanSecs = nnSecs.map(function(s) { return s.trim(); }).filter(function(s) { return s; });
        var content = '';
        if (cleanSecs.length > 0) {
          content = cleanSecs.map(function(sec) { return '<h2>' + esc(sec) + '</h2><p><br></p><p><br></p><p><br></p>'; }).join('');
        }
        var id = store.add('notes', {
          title: title,
          content: content,
          specialtyId: S.currentSpecId,
          categoryId: S.currentCatId,
          order: (S.notes[S.currentSpecId] || []).length,
          updatedAt: new Date()
        });
        nnOverlay.classList.remove('active');
        if (typeof id === 'string') openNote(id);
        else if (id && typeof id.then === 'function') id.then(function(rid) { openNote(rid); });
      });

      /* Enter on title input triggers create */
      nnTitleInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') nnCreateBtn.click();
      });
    })();

    /* ═══ MOVE NOTE ════════════════════════════════════ */
    let moveNoteId = null;
    const moveOverlay = $('#move-overlay');
    const moveCatSel = $('#move-cat-select');
    const moveSpecSel = $('#move-spec-select');
    const moveSpecEmpty = $('#move-spec-empty');
    const moveConfirmBtn = $('#move-confirm');

    function openMoveDialog(noteId, noteTitle) {
      moveNoteId = noteId;
      /* find note's current location */
      let noteCatId = S.currentCatId;
      let noteSpecId = S.currentSpecId;
      /* also search through data in case called from editor */
      for (const catId of Object.keys(S.specialties)) {
        for (const sp of S.specialties[catId]) {
          if ((S.notes[sp.id]||[]).find(n=>n.id===noteId)) {
            noteCatId = catId; noteSpecId = sp.id; break;
          }
        }
      }

      const curCat = S.categories.find(c=>c.id===noteCatId);
      let curSpec = null;
      (S.specialties[noteCatId]||[]).forEach(sp=>{ if(sp.id===noteSpecId) curSpec=sp; });

      /* subtitle */
      $('#move-subtitle').textContent = 'Move "' + (noteTitle||'Untitled Note') + '" to a new location.';
      /* current badge */
      const curBadge = $('#move-current');
      curBadge.innerHTML = '<i class="fas fa-location-dot"></i> Currently in: ' + esc((curCat?curCat.name:'')+ ' › '+(curSpec?curSpec.name:''));

      /* populate category dropdown */
      moveCatSel.innerHTML = '';
      S.categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat.id; opt.textContent = cat.name;
        if (cat.id === noteCatId) opt.selected = true;
        moveCatSel.appendChild(opt);
      });

      /* populate specialty dropdown for selected category */
      populateMoveSpecs(moveCatSel.value, noteSpecId);
      updateMoveConfirmState(noteCatId, noteSpecId);

      moveOverlay.classList.add('active');
    }

    function populateMoveSpecs(catId, preselectSpecId) {
      const cat = S.categories.find(c=>c.id===catId);
      const sub = getSublabel(cat);
      $('#move-spec-label').textContent = sub;

      const specs = S.specialties[catId] || [];
      moveSpecSel.innerHTML = '';
      moveSpecEmpty.style.display = 'none';
      moveSpecSel.style.display = 'block';

      if (specs.length === 0) {
        moveSpecSel.style.display = 'none';
        moveSpecEmpty.style.display = 'block';
        moveSpecEmpty.textContent = 'No ' + pluralize(sub, 0).toLowerCase() + ' in this category. Create one first.';
        moveConfirmBtn.disabled = true;
        return;
      }

      specs.forEach(sp => {
        const opt = document.createElement('option');
        opt.value = sp.id; opt.textContent = sp.name;
        if (sp.id === preselectSpecId) opt.selected = true;
        moveSpecSel.appendChild(opt);
      });
    }

    function updateMoveConfirmState(origCatId, origSpecId) {
      const selCat = moveCatSel.value;
      const selSpec = moveSpecSel.value;
      const specs = S.specialties[selCat] || [];
      /* disable if no specs, or if same location */
      if (specs.length === 0) { moveConfirmBtn.disabled = true; return; }
      moveConfirmBtn.disabled = (selCat === origCatId && selSpec === origSpecId);
    }

    moveCatSel.addEventListener('change', () => {
      populateMoveSpecs(moveCatSel.value, null);
      /* find original location of the note being moved */
      let origCatId = null, origSpecId = null;
      for (const catId of Object.keys(S.specialties)) {
        for (const sp of S.specialties[catId]) {
          if ((S.notes[sp.id]||[]).find(n=>n.id===moveNoteId)) {
            origCatId = catId; origSpecId = sp.id; break;
          }
        }
        if (origCatId) break;
      }
      updateMoveConfirmState(origCatId, origSpecId);
    });

    moveSpecSel.addEventListener('change', () => {
      let origCatId = null, origSpecId = null;
      for (const catId of Object.keys(S.specialties)) {
        for (const sp of S.specialties[catId]) {
          if ((S.notes[sp.id]||[]).find(n=>n.id===moveNoteId)) {
            origCatId = catId; origSpecId = sp.id; break;
          }
        }
        if (origCatId) break;
      }
      updateMoveConfirmState(origCatId, origSpecId);
    });

    $('#move-cancel').addEventListener('click', () => { moveOverlay.classList.remove('active'); moveNoteId = null; });
    moveOverlay.addEventListener('click', e => { if (e.target === moveOverlay) { moveOverlay.classList.remove('active'); moveNoteId = null; } });

    $('#move-confirm').addEventListener('click', async () => {
      if (!moveNoteId) return;
      const destCatId = moveCatSel.value;
      const destSpecId = moveSpecSel.value;
      if (!destCatId || !destSpecId) return;

      const destSpecs = S.specialties[destCatId] || [];
      const destNotes = S.notes[destSpecId] || [];

      try {
        await store.update('notes', moveNoteId, {
          categoryId: destCatId,
          specialtyId: destSpecId,
          order: destNotes.length
        });

        /* if currently viewing the editor for this note, update context */
        if (S.currentNoteId === moveNoteId) {
          S.currentCatId = destCatId;
          S.currentSpecId = destSpecId;
          /* refresh editor crumb */
          const cat = S.categories.find(c=>c.id===destCatId);
          const specObj = destSpecs.find(sp=>sp.id===destSpecId);
          $('#editor-crumb').innerHTML = (cat?esc(cat.name):'') + ' <span style="color:var(--c-text-muted);font-size:12px;font-family:var(--font-main)"> &rsaquo; ' + (specObj?esc(specObj.name):'') + '</span>';
        }
      } catch(err) {
        console.log('Move error: ' + (err.message || err));
      }

      moveOverlay.classList.remove('active');
      moveNoteId = null;
    });

    /* Editor move button */
    $('#btn-editor-move').addEventListener('click', () => {
      if (!S.currentNoteId) return;
      let noteData = null;
      for (const k of Object.keys(S.notes)) { const f = S.notes[k].find(n=>n.id===S.currentNoteId); if(f){noteData=f;break;} }
      openMoveDialog(S.currentNoteId, noteData ? noteData.title : $('#note-title').value);
    });

    /* ═══ TEMPLATE EDITOR ══════════════════════════════ */
    let tplSpecId = null;
    let tplSections = [];
    const tplOverlay = $('#tpl-overlay');

    function openTemplateEditor(specId) {
      tplSpecId = specId;
      let specObj = null;
      for (const catId of Object.keys(S.specialties)) {
        const found = (S.specialties[catId]||[]).find(function(sp){ return sp.id === specId; });
        if (found) { specObj = found; break; }
      }
      if (!specObj) return;

      const cat = S.categories.find(function(c){ return c.id === S.currentCatId; });
      const sub = getSublabel(cat);

      $('#tpl-title').textContent = 'Template for "' + specObj.name + '"';
      $('#tpl-subtitle').textContent = 'Define sections for new notes in this ' + sub.toLowerCase() + '. Each section becomes a header.';

      tplSections = Array.isArray(specObj.template) ? specObj.template.slice() : [];
      renderTplRows();
      tplOverlay.classList.add('active');
    }

    function renderTplRows() {
      var el = $('#tpl-sections');
      el.innerHTML = '';

      if (tplSections.length === 0) {
        el.innerHTML = '<div class="tpl-empty">No sections yet. Tap "Add Section" to start building your template.</div>';
        return;
      }

      tplSections.forEach(function(name, i) {
        var row = document.createElement('div');
        row.className = 'tpl-row';
        var isFirst = i === 0;
        var isLast = i === tplSections.length - 1;
        row.innerHTML =
          '<span class="tpl-num">' + (i + 1) + '</span>' +
          '<input type="text" value="' + esc(name) + '" placeholder="Section name">' +
          '<span class="tpl-btns">' +
            '<button class="tpl-btn" data-a="up" title="Move up"' + (isFirst ? ' disabled' : '') + '><i class="fas fa-chevron-up"></i></button>' +
            '<button class="tpl-btn" data-a="down" title="Move down"' + (isLast ? ' disabled' : '') + '><i class="fas fa-chevron-down"></i></button>' +
            '<button class="tpl-btn danger" data-a="rm" title="Remove"><i class="fas fa-xmark"></i></button>' +
          '</span>';

        var inp = row.querySelector('input');
        inp.addEventListener('input', function() { tplSections[i] = inp.value; });

        row.querySelector('[data-a="up"]').addEventListener('click', function() {
          if (i > 0) {
            var tmp = tplSections[i - 1];
            tplSections[i - 1] = tplSections[i];
            tplSections[i] = tmp;
            renderTplRows();
          }
        });
        row.querySelector('[data-a="down"]').addEventListener('click', function() {
          if (i < tplSections.length - 1) {
            var tmp = tplSections[i];
            tplSections[i] = tplSections[i + 1];
            tplSections[i + 1] = tmp;
            renderTplRows();
          }
        });
        row.querySelector('[data-a="rm"]').addEventListener('click', function() {
          tplSections.splice(i, 1);
          renderTplRows();
        });

        el.appendChild(row);
      });
    }

    $('#tpl-add-btn').addEventListener('click', function() {
      tplSections.push('New Section');
      renderTplRows();
      var inputs = $('#tpl-sections').querySelectorAll('input');
      var last = inputs[inputs.length - 1];
      if (last) { last.focus(); last.select(); }
    });

    $('#tpl-cancel').addEventListener('click', function() { tplOverlay.classList.remove('active'); tplSpecId = null; });
    tplOverlay.addEventListener('click', function(e) { if (e.target === tplOverlay) { tplOverlay.classList.remove('active'); tplSpecId = null; } });

    $('#tpl-save').addEventListener('click', async function() {
      if (!tplSpecId) return;
      var cleanSections = tplSections.map(function(s){ return s.trim(); }).filter(function(s){ return s; });
      try {
        await store.update('specialties', tplSpecId, { template: cleanSections });
      } catch(err) {
        console.log('Template save error: ' + (err.message || err));
      }
      tplOverlay.classList.remove('active');
      tplSpecId = null;
    });

    /* ═══ AI IMPORT ════════════════════════════════════ */
    (function() {
      var importOverlay = $('#import-overlay');
      var importDropzone = $('#import-dropzone');
      var importFileList = $('#import-file-list');
      var importProgressArea = $('#import-progress-area');
      var importProgressBar = $('#import-progress-bar');
      var importProgressText = $('#import-progress-text');
      var importLog = $('#import-log');
      var importStartBtn = $('#import-start');
      var importCancelBtn = $('#import-cancel');

      var importFiles = []; /* array of File objects */
      var importRunning = false;

      /* Hidden file input for import */
      var importFileInput = document.createElement('input');
      importFileInput.type = 'file';
      importFileInput.accept = '.pdf,image/*';
      importFileInput.multiple = true;
      importFileInput.style.display = 'none';
      document.body.appendChild(importFileInput);

      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      }

      function openImportDialog() {
        importFiles = [];
        importRunning = false;
        renderImportFiles();
        importProgressArea.classList.remove('active');
        importLog.classList.remove('active');
        importLog.innerHTML = '';
        importProgressBar.style.width = '0%';
        importStartBtn.disabled = true;
        importStartBtn.innerHTML = '<i class="fas fa-sparkles"></i> Import with AI';
        importCancelBtn.textContent = 'Cancel';
        importDropzone.style.display = '';
        importOverlay.classList.add('active');
      }

      function addImportFiles(fileListObj) {
        for (var i = 0; i < fileListObj.length; i++) {
          var f = fileListObj[i];
          if (f.size > 20 * 1024 * 1024) continue; /* skip > 20MB */
          /* avoid duplicates */
          var dup = false;
          for (var j = 0; j < importFiles.length; j++) {
            if (importFiles[j].name === f.name && importFiles[j].size === f.size) { dup = true; break; }
          }
          if (!dup) importFiles.push(f);
        }
        renderImportFiles();
        importStartBtn.disabled = importFiles.length === 0;
      }

      function renderImportFiles() {
        importFileList.innerHTML = '';
        importFiles.forEach(function(f, idx) {
          var item = document.createElement('div');
          item.className = 'import-file-item';
          var icon = f.type && f.type.indexOf('image') >= 0 ? 'fa-image' : 'fa-file-pdf';
          item.innerHTML =
            '<i class="fas ' + icon + ' file-icon"></i>' +
            '<span class="file-name">' + esc(f.name) + '</span>' +
            '<span class="file-size">' + formatFileSize(f.size) + '</span>' +
            '<span class="file-status pending" data-idx="' + idx + '"></span>' +
            (!importRunning ? '<span class="file-remove" data-rm="' + idx + '" title="Remove"><i class="fas fa-xmark"></i></span>' : '');
          if (!importRunning) {
            var rmBtn = item.querySelector('[data-rm]');
            if (rmBtn) {
              rmBtn.addEventListener('click', (function(capturedIdx) {
                return function() {
                  importFiles.splice(capturedIdx, 1);
                  renderImportFiles();
                  importStartBtn.disabled = importFiles.length === 0;
                };
              })(idx));
            }
          }
          importFileList.appendChild(item);
        });
      }

      function setFileStatus(idx, statusClass, text) {
        var el = importFileList.querySelector('[data-idx="' + idx + '"]');
        if (el) {
          el.className = 'file-status ' + statusClass;
          el.textContent = text;
        }
      }

      function addLogLine(text, type) {
        importLog.classList.add('active');
        var line = document.createElement('div');
        line.className = 'import-log-line ' + (type || '');
        var icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-circle-info';
        line.innerHTML = '<i class="fas ' + icon + '"></i> ' + esc(text);
        importLog.appendChild(line);
        importLog.scrollTop = importLog.scrollHeight;
      }

      /* Click dropzone to pick files */
      importDropzone.addEventListener('click', function() {
        if (importRunning) return;
        importFileInput.value = '';
        importFileInput.click();
      });
      importFileInput.addEventListener('change', function() {
        if (importFileInput.files && importFileInput.files.length > 0) addImportFiles(importFileInput.files);
      });

      /* Drag & drop */
      importDropzone.addEventListener('dragover', function(e) { e.preventDefault(); importDropzone.classList.add('dragover'); });
      importDropzone.addEventListener('dragleave', function() { importDropzone.classList.remove('dragover'); });
      importDropzone.addEventListener('drop', function(e) {
        e.preventDefault(); importDropzone.classList.remove('dragover');
        if (e.dataTransfer && e.dataTransfer.files) addImportFiles(e.dataTransfer.files);
      });

      /* Cancel */
      importCancelBtn.addEventListener('click', function() {
        importOverlay.classList.remove('active');
        importRunning = false;
      });
      importOverlay.addEventListener('click', function(e) {
        if (e.target === importOverlay && !importRunning) { importOverlay.classList.remove('active'); }
      });

      /* Open dialog from button */
      $('#btn-ai-import').addEventListener('click', function() { openImportDialog(); });

      /* ── Start import process ─────────────────────── */
      importStartBtn.addEventListener('click', async function() {
        if (importFiles.length === 0 || importRunning) return;
        importRunning = true;
        importStartBtn.disabled = true;
        importStartBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Importing…';
        importDropzone.style.display = 'none';
        importProgressArea.classList.add('active');
        renderImportFiles(); /* re-render to remove X buttons */

        var total = importFiles.length;
        var completed = 0;
        var specObj = null;
        (S.specialties[S.currentCatId] || []).forEach(function(sp) { if (sp.id === S.currentSpecId) specObj = sp; });
        var templateSections = (specObj && Array.isArray(specObj.template)) ? specObj.template : [];

        /* Build the system prompt for AI */
        var templateHint = '';
        if (templateSections.length > 0) {
          templateHint = '\n\nIMPORTANT: The target specialty uses these template sections: ' +
            templateSections.map(function(s, i) { return (i + 1) + '. ' + s; }).join(', ') +
            '. Please organize the extracted content under these section headers (use <h2> tags for each). If a section is not applicable, you may leave it with a brief "N/A" note.';
        }

        var systemPrompt =
          'You are a clinical dietetics note converter. Extract the content from the attached document and convert it into well-structured HTML for a notes app. ' +
          'Output ONLY valid JSON in this exact format: {"title":"<note title>","content":"<HTML content>"}\n' +
          'Guidelines:\n' +
          '- The title should be a concise, descriptive name for the document content.\n' +
          '- Use <h2> for major section headers, <h3> for sub-sections.\n' +
          '- Use <ul>/<ol> and <li> for lists.\n' +
          '- Use <p> for paragraphs.\n' +
          '- Use <strong> and <em> for emphasis.\n' +
          '- Preserve all clinical data, values, ranges, and references.\n' +
          '- Do NOT include any markdown code fences or explanations — ONLY the JSON object.' +
          templateHint;

        /* Register handler for AI responses */
        var currentResolve = null;
        var handlerName = 'import-handler-' + Date.now();

        window.Poe.registerHandler(handlerName, function(result) {
          var msg = result.responses[0];
          if (!msg) return;

          if (msg.status === 'incomplete') {
            /* Show streaming indicator */
            importProgressText.textContent = 'AI is reading document ' + (completed + 1) + ' of ' + total + '…';
          } else if (msg.status === 'complete') {
            if (currentResolve) currentResolve(msg.content);
          } else if (msg.status === 'error') {
            if (currentResolve) currentResolve(null);
          }
        });

        /* Process each file sequentially */
        for (var i = 0; i < importFiles.length; i++) {
          setFileStatus(i, 'processing', 'Processing…');
          importProgressBar.style.width = ((i / total) * 100) + '%';
          importProgressText.textContent = 'Processing document ' + (i + 1) + ' of ' + total + '…';

          try {
            var file = importFiles[i];
            /* Send to Claude with the file as attachment */
            var aiContent = await new Promise(function(resolve) {
              currentResolve = resolve;

              window.Poe.sendUserMessage(
                '@Claude-Sonnet-4.5 ' + systemPrompt + '\n\nPlease process the attached document.',
                {
                  handler: handlerName,
                  stream: true,
                  openChat: false,
                  attachments: [file],
                  parameters: {}
                }
              ).catch(function(err) {
                console.log('Poe API error: ' + JSON.stringify(err));
                resolve(null);
              });
            });

            if (!aiContent) {
              setFileStatus(i, 'error', 'Failed');
              addLogLine('Failed to process: ' + file.name, 'error');
              completed++;
              continue;
            }

            /* Parse the AI response */
            var parsed = null;
            try {
              /* Try to find JSON in the response (may have code fences) */
              var jsonStr = aiContent;
              var jsonMatch = aiContent.match(/\{[\s\S]*"title"[\s\S]*"content"[\s\S]*\}/);
              if (jsonMatch) jsonStr = jsonMatch[0];
              parsed = JSON.parse(jsonStr);
            } catch(parseErr) {
              /* Fallback: use filename as title and raw content */
              parsed = {
                title: file.name.replace(/\.[^.]+$/, ''),
                content: '<p>' + esc(aiContent.substring(0, 5000)) + '</p>'
              };
              addLogLine('Partial parse for: ' + file.name + ' — used fallback formatting.', 'error');
            }

            /* Create the note */
            var noteTitle = parsed.title || file.name.replace(/\.[^.]+$/, '');
            var noteContent = parsed.content || '';
            var existingNotes = S.notes[S.currentSpecId] || [];

            await store.add('notes', {
              title: noteTitle,
              content: noteContent,
              specialtyId: S.currentSpecId,
              categoryId: S.currentCatId,
              order: existingNotes.length + completed,
              updatedAt: new Date()
            });

            setFileStatus(i, 'done', 'Done ✓');
            addLogLine('Created note: "' + noteTitle + '"', 'success');
          } catch(fileErr) {
            setFileStatus(i, 'error', 'Error');
            addLogLine('Error with ' + importFiles[i].name + ': ' + (fileErr.message || fileErr), 'error');
          }

          completed++;
          importProgressBar.style.width = ((completed / total) * 100) + '%';
        }

        /* Done */
        importProgressText.textContent = 'Import complete! ' + completed + ' of ' + total + ' documents processed.';
        importStartBtn.innerHTML = '<i class="fas fa-check"></i> Done';
        importStartBtn.disabled = false;
        importStartBtn.onclick = function() {
          importOverlay.classList.remove('active');
          importRunning = false;
          importStartBtn.onclick = null;
        };
        importCancelBtn.textContent = 'Close';
        importRunning = false;
      });
    })();
  </script>
</body>
</html>
