<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" >
  <meta name="viewport" content="width=device-width, initial-scale=1.0" >
  <title>NutriNotes â€” Dietitian Knowledge Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" >
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin >
  <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;500;600;700&family=Lora:ital,wght@0,500;1,500&display=swap" rel="stylesheet" >
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" >
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" >
  <style>
    /* â”€â”€ CSS Custom Properties â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      --c-primary: #1C6E5A;
      --c-primary-hover: #24876E;
      --c-primary-light: #E0F2ED;
      --c-accent: #D0913A;
      --c-accent-hover: #BB7E2F;
      --c-danger: #C0392B;
      --c-danger-hover: #A93226;
      --c-bg: #F7F5F0;
      --c-surface: #FFFFFF;
      --c-surface-2: #EDE9E1;
      --c-text: #2C2C2C;
      --c-text-secondary: #6B6560;
      --c-text-muted: #9B9590;
      --c-border: #DDD8D0;
      --c-sidebar-bg: #1A2E28;
      --c-sidebar-text: #D4E4DE;
      --c-sidebar-hover: rgba(255,255,255,0.08);
      --c-sidebar-active: rgba(255,255,255,0.14);
      --c-sidebar-muted: #7A9990;
      --c-tree-line: rgba(255,255,255,0.1);
      --c-overlay: rgba(0,0,0,0.45);
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.1);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.15);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --font-main: 'Figtree', sans-serif;
      --font-accent: 'Lora', serif;
      --sidebar-w: 300px;
      --transition: 0.2s ease;
    }

    html.dark {
      --c-primary: #3BA99B;
      --c-primary-hover: #4BBFB0;
      --c-primary-light: #1A3330;
      --c-accent: #E4A94D;
      --c-accent-hover: #D09538;
      --c-bg: #0F1117;
      --c-surface: #191C24;
      --c-surface-2: #22262F;
      --c-text: #E4E2DE;
      --c-text-secondary: #A09B95;
      --c-text-muted: #6B665F;
      --c-border: #2E3038;
      --c-sidebar-bg: #0D1210;
      --c-sidebar-text: #C4D8D0;
      --c-sidebar-hover: rgba(255,255,255,0.06);
      --c-sidebar-active: rgba(255,255,255,0.12);
      --c-sidebar-muted: #5A7A70;
      --c-tree-line: rgba(255,255,255,0.07);
      --c-overlay: rgba(0,0,0,0.6);
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.3);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
    }

    /* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 16px; height: 100%; }
    body {
      font-family: var(--font-main);
      background: var(--c-bg);
      color: var(--c-text);
      height: 100vh;
      overflow: hidden;
      line-height: 1.6;
    }
    button { font-family: inherit; cursor: pointer; border: none; background: none; }
    input { font-family: inherit; font-size: 16px; }

    /* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--c-border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--c-text-muted); }

    /* â”€â”€ LOGIN SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(160deg, #0F1F1A 0%, #1A3D34 40%, #2D6B5A 100%);
      position: relative;
      overflow: hidden;
    }
    #login-screen::before {
      content: '';
      position: absolute;
      width: 600px; height: 600px;
      background: radial-gradient(circle, rgba(208,145,58,0.15) 0%, transparent 70%);
      top: -100px; right: -100px;
      pointer-events: none;
    }
    #login-screen::after {
      content: '';
      position: absolute;
      width: 400px; height: 400px;
      background: radial-gradient(circle, rgba(59,169,155,0.12) 0%, transparent 70%);
      bottom: -50px; left: -50px;
      pointer-events: none;
    }
    .login-card {
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: var(--radius-lg);
      padding: 48px 40px;
      text-align: center;
      max-width: 420px;
      width: 90%;
      animation: fadeInUp 0.6s ease-out;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(24px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .login-logo {
      font-size: 48px;
      margin-bottom: 8px;
    }
    .login-card h1 {
      font-family: var(--font-accent);
      font-size: 32px;
      color: #E0F2ED;
      margin-bottom: 4px;
      font-weight: 500;
    }
    .login-card .subtitle {
      color: rgba(255,255,255,0.5);
      font-size: 14px;
      margin-bottom: 36px;
      letter-spacing: 0.5px;
    }
    .btn-google {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: #FFFFFF;
      color: #333;
      font-size: 15px;
      font-weight: 600;
      padding: 12px 28px;
      border-radius: 50px;
      transition: all var(--transition);
      box-shadow: var(--shadow-md);
    }
    .btn-google:hover { transform: translateY(-1px); box-shadow: var(--shadow-lg); }
    .btn-google svg { width: 20px; height: 20px; }
    .login-footer {
      margin-top: 32px;
      font-size: 12px;
      color: rgba(255,255,255,0.3);
    }

    /* â”€â”€ MAIN APP LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #app {
      display: none;
      height: 100vh;
      overflow: hidden;
    }
    #app.active { display: flex; }

    /* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #sidebar {
      width: var(--sidebar-w);
      min-width: var(--sidebar-w);
      background: var(--c-sidebar-bg);
      display: flex;
      flex-direction: column;
      height: 100vh;
      transition: transform 0.3s ease;
      z-index: 100;
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 20px 12px;
      border-bottom: 1px solid var(--c-tree-line);
    }
    .sidebar-brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sidebar-brand span.icon { font-size: 22px; }
    .sidebar-brand h2 {
      font-family: var(--font-accent);
      font-size: 20px;
      font-weight: 500;
      color: var(--c-sidebar-text);
    }
    .btn-menu {
      display: none;
      color: var(--c-sidebar-muted);
      font-size: 18px;
      padding: 4px;
    }
    .sidebar-actions {
      padding: 12px 16px 8px;
    }
    .btn-new-category {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 9px 14px;
      border-radius: var(--radius-sm);
      background: rgba(255,255,255,0.06);
      color: var(--c-sidebar-text);
      font-size: 13px;
      font-weight: 500;
      transition: background var(--transition);
      border: 1px dashed rgba(255,255,255,0.12);
    }
    .btn-new-category:hover { background: rgba(255,255,255,0.1); }
    .btn-new-category i { font-size: 11px; opacity: 0.7; }

    /* Tree */
    #tree-container {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }
    .tree-item {
      display: flex;
      align-items: center;
      padding: 7px 16px;
      cursor: pointer;
      transition: background var(--transition);
      position: relative;
      gap: 6px;
      user-select: none;
    }
    .tree-item:hover { background: var(--c-sidebar-hover); }
    .tree-item.active { background: var(--c-sidebar-active); }
    .tree-item .arrow {
      width: 18px;
      text-align: center;
      font-size: 10px;
      color: var(--c-sidebar-muted);
      transition: transform 0.2s;
      flex-shrink: 0;
    }
    .tree-item .arrow.expanded { transform: rotate(90deg); }
    .tree-item .arrow.hidden { visibility: hidden; }
    .tree-item .item-icon {
      font-size: 13px;
      width: 20px;
      text-align: center;
      flex-shrink: 0;
    }
    .tree-item.level-0 .item-icon { color: var(--c-accent); }
    .tree-item.level-1 .item-icon { color: var(--c-primary); }
    .tree-item.level-2 .item-icon { color: var(--c-sidebar-muted); }
    .tree-item .item-name {
      flex: 1;
      font-size: 13px;
      color: var(--c-sidebar-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .tree-item.level-0 .item-name { font-weight: 600; font-size: 13.5px; }
    .tree-item.level-1 { padding-left: 34px; }
    .tree-item.level-1 .item-name { font-weight: 500; }
    .tree-item.level-2 { padding-left: 52px; }
    .tree-item .item-count {
      font-size: 11px;
      color: var(--c-sidebar-muted);
      background: rgba(255,255,255,0.06);
      padding: 1px 7px;
      border-radius: 10px;
      flex-shrink: 0;
    }
    .tree-item .item-actions {
      display: none;
      gap: 2px;
      flex-shrink: 0;
    }
    .tree-item:hover .item-actions { display: flex; }
    .tree-item:hover .item-count { display: none; }
    .tree-item .item-actions button {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--c-sidebar-muted);
      font-size: 11px;
      transition: all var(--transition);
    }
    .tree-item .item-actions button:hover {
      background: rgba(255,255,255,0.1);
      color: var(--c-sidebar-text);
    }
    .tree-item .item-actions button.danger:hover {
      background: rgba(192,57,43,0.2);
      color: #E74C3C;
    }
    .tree-children { overflow: hidden; }

    /* Sidebar footer */
    .sidebar-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--c-tree-line);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .user-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
      overflow: hidden;
    }
    .user-info img {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }
    .user-info span {
      font-size: 12px;
      color: var(--c-sidebar-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .btn-signout {
      font-size: 13px;
      color: var(--c-sidebar-muted);
      padding: 6px 8px;
      border-radius: var(--radius-sm);
      transition: all var(--transition);
    }
    .btn-signout:hover { background: rgba(255,255,255,0.08); color: var(--c-sidebar-text); }

    /* â”€â”€ MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }
    .main-header {
      display: flex;
      align-items: center;
      padding: 16px 28px;
      border-bottom: 1px solid var(--c-border);
      background: var(--c-surface);
      gap: 12px;
      flex-shrink: 0;
    }
    .btn-sidebar-toggle {
      display: none;
      font-size: 18px;
      color: var(--c-text-secondary);
      padding: 6px;
      border-radius: var(--radius-sm);
    }
    .btn-sidebar-toggle:hover { background: var(--c-surface-2); }
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--c-text-muted);
      flex: 1;
      overflow: hidden;
    }
    .breadcrumb span { white-space: nowrap; }
    .breadcrumb .sep { color: var(--c-border); font-size: 11px; }
    .breadcrumb .current { color: var(--c-text-secondary); font-weight: 500; }
    .save-status {
      font-size: 12px;
      color: var(--c-text-muted);
      display: flex;
      align-items: center;
      gap: 5px;
      flex-shrink: 0;
    }
    .save-status.saving { color: var(--c-accent); }
    .save-status.saved { color: var(--c-primary); }
    .save-status.error { color: var(--c-danger); }

    /* Empty state */
    #empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px;
    }
    #empty-state .empty-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.15;
    }
    #empty-state h3 {
      font-family: var(--font-accent);
      font-size: 22px;
      color: var(--c-text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }
    #empty-state p {
      color: var(--c-text-muted);
      font-size: 14px;
      max-width: 320px;
      line-height: 1.7;
    }

    /* Note editor area */
    #note-editor {
      display: none;
      flex: 1;
      flex-direction: column;
      overflow: hidden;
    }
    #note-editor.active { display: flex; }
    .note-title-wrap {
      padding: 24px 28px 0;
      background: var(--c-surface);
    }
    #note-title {
      width: 100%;
      border: none;
      outline: none;
      font-family: var(--font-accent);
      font-size: 28px;
      font-weight: 500;
      color: var(--c-text);
      background: transparent;
      padding: 0;
    }
    #note-title::placeholder { color: var(--c-text-muted); }
    .note-meta {
      padding: 6px 28px 16px;
      font-size: 12px;
      color: var(--c-text-muted);
      background: var(--c-surface);
    }
    .editor-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--c-surface);
    }

    /* Quill overrides */
    .ql-toolbar.ql-snow {
      border: none !important;
      border-top: 1px solid var(--c-border) !important;
      border-bottom: 1px solid var(--c-border) !important;
      background: var(--c-surface-2);
      padding: 6px 20px !important;
    }
    .ql-container.ql-snow {
      border: none !important;
      flex: 1;
      overflow-y: auto;
      font-family: var(--font-main);
      font-size: 15px;
    }
    .ql-editor {
      padding: 20px 28px 60px !important;
      color: var(--c-text);
      line-height: 1.75;
      min-height: 100%;
    }
    .ql-editor.ql-blank::before {
      color: var(--c-text-muted) !important;
      font-style: normal !important;
    }
    html.dark .ql-snow .ql-stroke { stroke: var(--c-text-secondary) !important; }
    html.dark .ql-snow .ql-fill { fill: var(--c-text-secondary) !important; }
    html.dark .ql-snow .ql-picker-label { color: var(--c-text-secondary) !important; }
    html.dark .ql-snow .ql-picker-options {
      background: var(--c-surface-2) !important;
      border-color: var(--c-border) !important;
    }
    html.dark .ql-snow .ql-picker-item { color: var(--c-text) !important; }
    .ql-snow .ql-picker-label { font-family: var(--font-main) !important; }

    /* â”€â”€ DIALOG MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dialog-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--c-overlay);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.15s ease;
    }
    .dialog-overlay.active { display: flex; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .dialog-box {
      background: var(--c-surface);
      border-radius: var(--radius-md);
      padding: 28px;
      max-width: 400px;
      width: 90%;
      box-shadow: var(--shadow-lg);
      animation: scaleIn 0.2s ease;
    }
    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .dialog-box h3 {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--c-text);
    }
    .dialog-box p {
      font-size: 14px;
      color: var(--c-text-secondary);
      margin-bottom: 20px;
      line-height: 1.5;
    }
    .dialog-box input[type="text"] {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--c-border);
      border-radius: var(--radius-sm);
      font-size: 15px;
      background: var(--c-bg);
      color: var(--c-text);
      margin-bottom: 20px;
      outline: none;
      transition: border-color var(--transition);
    }
    .dialog-box input[type="text"]:focus { border-color: var(--c-primary); }
    .dialog-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .dialog-buttons button {
      padding: 9px 20px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      transition: all var(--transition);
    }
    .btn-dialog-cancel {
      color: var(--c-text-secondary);
      background: var(--c-surface-2);
    }
    .btn-dialog-cancel:hover { background: var(--c-border); }
    .btn-dialog-confirm {
      color: #FFF;
      background: var(--c-primary);
    }
    .btn-dialog-confirm:hover { background: var(--c-primary-hover); }
    .btn-dialog-danger {
      color: #FFF;
      background: var(--c-danger);
    }
    .btn-dialog-danger:hover { background: var(--c-danger-hover); }

    /* â”€â”€ Loading spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .spinner {
      width: 20px; height: 20px;
      border: 2px solid var(--c-border);
      border-top-color: var(--c-primary);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin: 40px auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ CONFIG BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .config-banner {
      background: #FFF3CD;
      color: #856404;
      padding: 14px 20px;
      font-size: 13px;
      line-height: 1.5;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    html.dark .config-banner { background: #3D3015; color: #E4C76B; }
    .config-banner i { margin-top: 2px; flex-shrink: 0; }
    .config-banner code {
      background: rgba(0,0,0,0.08);
      padding: 1px 5px;
      border-radius: 3px;
      font-size: 12px;
    }

    /* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 768px) {
      #sidebar {
        position: fixed;
        top: 0; left: 0;
        height: 100vh;
        transform: translateX(-100%);
      }
      #sidebar.open { transform: translateX(0); }
      .sidebar-backdrop {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.4);
        z-index: 99;
      }
      .sidebar-backdrop.active { display: block; }
      .btn-sidebar-toggle, .btn-menu { display: block; }
      .note-title-wrap { padding: 20px 16px 0; }
      .note-meta { padding: 6px 16px 12px; }
      .ql-editor { padding: 16px 16px 60px !important; }
      .main-header { padding: 14px 16px; }
    }
  </style>
</head>
<body>
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="login-screen">
    <div class="login-card">
      <div class="login-logo">ğŸ¥¬</div>
      <h1>NutriNotes</h1>
      <p class="subtitle">Your dietitian knowledge hub</p>
      <button class="btn-google" id="btn-google-signin">
        <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Sign in with Google
      </button>
      <p class="login-footer">Secure cloud sync via Firebase</p>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="app">
    <!-- Sidebar backdrop (mobile) -->
    <div class="sidebar-backdrop" id="sidebar-backdrop"></div>

    <!-- Sidebar -->
    <aside id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <span class="icon">ğŸ¥¬</span>
          <h2>NutriNotes</h2>
        </div>
        <button class="btn-menu" id="btn-close-sidebar"><i class="fas fa-times"></i></button>
      </div>
      <div class="sidebar-actions">
        <button class="btn-new-category" id="btn-new-category">
          <i class="fas fa-plus"></i> New Category
        </button>
      </div>
      <div id="tree-container"></div>
      <div class="sidebar-footer">
        <div class="user-info">
          <img id="user-avatar" alt="avatar" >
          <span id="user-name"></span>
        </div>
        <button class="btn-signout" id="btn-signout" title="Sign out"><i class="fas fa-right-from-bracket"></i></button>
      </div>
    </aside>

    <!-- Main content -->
    <div id="main-content">
      <div class="main-header">
        <button class="btn-sidebar-toggle" id="btn-open-sidebar"><i class="fas fa-bars"></i></button>
        <div class="breadcrumb" id="breadcrumb">
          <span class="current">Select or create a note</span>
        </div>
        <div class="save-status" id="save-status"></div>
      </div>

      <!-- Empty state -->
      <div id="empty-state">
        <div class="empty-icon">ğŸ“</div>
        <h3>Welcome to NutriNotes</h3>
        <p>Create a category in the sidebar, add specialties, then start writing notes. Your three-tier hierarchy keeps everything organized.</p>
      </div>

      <!-- Note editor -->
      <div id="note-editor">
        <div class="note-title-wrap">
          <input type="text" id="note-title" placeholder="Untitled Note" >
        </div>
        <div class="note-meta" id="note-meta"></div>
        <div class="editor-wrap">
          <div id="quill-editor"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DIALOG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="dialog-overlay" id="dialog-overlay">
    <div class="dialog-box" id="dialog-box">
      <h3 id="dialog-title"></h3>
      <p id="dialog-message"></p>
      <input type="text" id="dialog-input" style="display:none" >
      <div class="dialog-buttons" id="dialog-buttons"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
  <script>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       âš ï¸  FIREBASE CONFIGURATION
       Replace the values below with your own Firebase
       project credentials:
       1. Go to https://console.firebase.google.com
       2. Create a project (or use an existing one)
       3. Go to Project Settings â†’ General â†’ Your Apps
          and register a Web App
       4. Copy the config object here
       5. Enable Authentication â†’ Sign-in method â†’ Google
       6. Create a Cloud Firestore database
       7. Set Firestore Rules (see README)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const firebaseConfig = {
      apiKey:            "YOUR_API_KEY",
      authDomain:        "YOUR_PROJECT.firebaseapp.com",
      projectId:         "YOUR_PROJECT_ID",
      storageBucket:     "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId:             "YOUR_APP_ID"
    };

    const NEEDS_CONFIG = firebaseConfig.apiKey === "YOUR_API_KEY";

    // â”€â”€ Initialize Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let db, auth;
    if (!NEEDS_CONFIG) {
      firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db   = firebase.firestore();
      db.enablePersistence({ synchronizeTabs: true }).catch(() => {});
    }

    // â”€â”€ Dark mode detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      e.matches ? document.documentElement.classList.add('dark') : document.documentElement.classList.remove('dark');
    });

    // â”€â”€ App State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const state = {
      user: null,
      categories: [],
      specialties: {},
      notes: {},
      selectedNoteId: null,
      selectedNoteData: null,
      expandedCats: new Set(),
      expandedSpecs: new Set(),
      unsubscribers: [],
    };

    // â”€â”€ DOM Elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const $ = (sel) => document.querySelector(sel);
    const loginScreen    = $('#login-screen');
    const appEl          = $('#app');
    const treeContainer  = $('#tree-container');
    const emptyState     = $('#empty-state');
    const noteEditor     = $('#note-editor');
    const noteTitle      = $('#note-title');
    const noteMeta       = $('#note-meta');
    const breadcrumb     = $('#breadcrumb');
    const saveStatusEl   = $('#save-status');
    const dialogOverlay  = $('#dialog-overlay');
    const dialogBox      = $('#dialog-box');
    const sidebarEl      = $('#sidebar');
    const backdropEl     = $('#sidebar-backdrop');

    // â”€â”€ Quill Editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const quill = new Quill('#quill-editor', {
      theme: 'snow',
      placeholder: 'Start writing your notesâ€¦',
      modules: {
        toolbar: [
          [{ header: [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ color: [] }, { background: [] }],
          [{ list: 'ordered' }, { list: 'bullet' }],
          ['blockquote', 'code-block'],
          ['link'],
          ['clean']
        ]
      }
    });

    // â”€â”€ Dialog Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showDialog({ title, message, input, placeholder, confirmText, confirmClass, onConfirm }) {
      $('#dialog-title').textContent = title || '';
      $('#dialog-message').textContent = message || '';
      const inp = $('#dialog-input');
      if (input) {
        inp.style.display = 'block';
        inp.value = placeholder || '';
        inp.setAttribute('placeholder', placeholder || '');
      } else {
        inp.style.display = 'none';
      }
      const btnContainer = $('#dialog-buttons');
      btnContainer.innerHTML = '';

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn-dialog-cancel';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.onclick = () => { dialogOverlay.classList.remove('active'); };

      const confirmBtn = document.createElement('button');
      confirmBtn.className = confirmClass || 'btn-dialog-confirm';
      confirmBtn.textContent = confirmText || 'OK';
      confirmBtn.onclick = () => {
        dialogOverlay.classList.remove('active');
        onConfirm(input ? inp.value.trim() : true);
      };

      btnContainer.appendChild(cancelBtn);
      btnContainer.appendChild(confirmBtn);
      dialogOverlay.classList.add('active');

      if (input) {
        setTimeout(() => { inp.focus(); inp.select(); }, 100);
      }
    }

    // â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $('#btn-google-signin').addEventListener('click', async () => {
      if (NEEDS_CONFIG) {
        showDialog({ title: 'Configuration Required', message: 'Please add your Firebase config to the source code before signing in.', confirmText: 'OK', onConfirm: () => {} });
        return;
      }
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
      } catch (err) {
        console.log('Auth error: ' + err.message);
      }
    });
    $('#btn-signout').addEventListener('click', () => {
      showDialog({
        title: 'Sign Out',
        message: 'Are you sure you want to sign out?',
        confirmText: 'Sign Out',
        confirmClass: 'btn-dialog-danger',
        onConfirm: () => { if (auth) auth.signOut(); }
      });
    });

    // â”€â”€ Auth State Listener â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (!NEEDS_CONFIG) {
      auth.onAuthStateChanged(user => {
        if (user) {
          state.user = user;
          loginScreen.style.display = 'none';
          appEl.classList.add('active');
          $('#user-avatar').src = user.photoURL || '';
          $('#user-name').textContent = user.displayName || user.email || '';
          loadData();
        } else {
          state.user = null;
          state.unsubscribers.forEach(fn => fn());
          state.unsubscribers = [];
          state.categories = [];
          state.specialties = {};
          state.notes = {};
          state.selectedNoteId = null;
          loginScreen.style.display = 'flex';
          appEl.classList.remove('active');
        }
      });
    }

    // â”€â”€ Firestore Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function userCol(path) {
      return db.collection('users').doc(state.user.uid).collection(path);
    }

    // â”€â”€ Load Data with Realtime Listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function loadData() {
      state.unsubscribers.forEach(fn => fn());
      state.unsubscribers = [];

      // Listen to categories
      const unsubCats = userCol('categories')
        .orderBy('order')
        .onSnapshot(snap => {
          state.categories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          renderTree();
        });
      state.unsubscribers.push(unsubCats);

      // Listen to specialties
      const unsubSpecs = userCol('specialties')
        .orderBy('order')
        .onSnapshot(snap => {
          state.specialties = {};
          snap.docs.forEach(d => {
            const data = { id: d.id, ...d.data() };
            if (!state.specialties[data.categoryId]) state.specialties[data.categoryId] = [];
            state.specialties[data.categoryId].push(data);
          });
          renderTree();
        });
      state.unsubscribers.push(unsubSpecs);

      // Listen to notes
      const unsubNotes = userCol('notes')
        .orderBy('order')
        .onSnapshot(snap => {
          state.notes = {};
          snap.docs.forEach(d => {
            const data = { id: d.id, ...d.data() };
            if (!state.notes[data.specialtyId]) state.notes[data.specialtyId] = [];
            state.notes[data.specialtyId].push(data);
          });
          renderTree();
          // If selected note was deleted, clear editor
          if (state.selectedNoteId) {
            const allNotes = Object.values(state.notes).flat();
            if (!allNotes.find(n => n.id === state.selectedNoteId)) {
              deselectNote();
            }
          }
        });
      state.unsubscribers.push(unsubNotes);
    }

    // â”€â”€ Render Tree â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderTree() {
      treeContainer.innerHTML = '';
      if (state.categories.length === 0) {
        treeContainer.innerHTML = '<div style="padding:24px 20px;text-align:center;color:var(--c-sidebar-muted);font-size:13px;">No categories yet.<br>Click "New Category" to start.</div>';
        return;
      }
      state.categories.forEach(cat => {
        const specs = state.specialties[cat.id] || [];
        const catExpanded = state.expandedCats.has(cat.id);

        // Category item
        const catItem = createTreeItem({
          level: 0,
          icon: catExpanded ? 'fa-folder-open' : 'fa-folder',
          name: cat.name,
          hasChildren: true,
          expanded: catExpanded,
          count: specs.length,
          onToggle: () => { toggleCat(cat.id); },
          onAdd: () => { addSpecialty(cat.id); },
          onRename: () => { renameItem('categories', cat.id, cat.name); },
          onDelete: () => { deleteCategory(cat.id, cat.name); },
        });
        treeContainer.appendChild(catItem);

        // Specialties (if expanded)
        if (catExpanded) {
          const specsWrap = document.createElement('div');
          specsWrap.className = 'tree-children';

          specs.forEach(spec => {
            const notesList = state.notes[spec.id] || [];
            const specExpanded = state.expandedSpecs.has(spec.id);

            const specItem = createTreeItem({
              level: 1,
              icon: 'fa-bookmark',
              name: spec.name,
              hasChildren: true,
              expanded: specExpanded,
              count: notesList.length,
              onToggle: () => { toggleSpec(spec.id); },
              onAdd: () => { addNote(spec.id, cat.id); },
              onRename: () => { renameItem('specialties', spec.id, spec.name); },
              onDelete: () => { deleteSpecialty(spec.id, spec.name); },
            });
            specsWrap.appendChild(specItem);

            // Notes (if expanded)
            if (specExpanded) {
              const notesWrap = document.createElement('div');
              notesWrap.className = 'tree-children';
              notesList.forEach(note => {
                const noteItem = createTreeItem({
                  level: 2,
                  icon: 'fa-file-lines',
                  name: note.title || 'Untitled Note',
                  hasChildren: false,
                  active: state.selectedNoteId === note.id,
                  onToggle: () => { selectNote(note.id); },
                  onRename: () => { renameNote(note.id, note.title); },
                  onDelete: () => { deleteNote(note.id, note.title); },
                });
                notesWrap.appendChild(noteItem);
              });
              specsWrap.appendChild(notesWrap);
            }
          });
          treeContainer.appendChild(specsWrap);
        }
      });
    }

    function createTreeItem(opts) {
      const div = document.createElement('div');
      div.className = `tree-item level-${opts.level}${opts.active ? ' active' : ''}`;

      // Arrow
      const arrow = document.createElement('span');
      arrow.className = `arrow fas fa-caret-right${opts.hasChildren ? (opts.expanded ? ' expanded' : '') : ' hidden'}`;
      div.appendChild(arrow);

      // Icon
      const icon = document.createElement('span');
      icon.className = `item-icon fas ${opts.icon}`;
      div.appendChild(icon);

      // Name
      const name = document.createElement('span');
      name.className = 'item-name';
      name.textContent = opts.name;
      div.appendChild(name);

      // Count badge
      if (opts.count !== undefined) {
        const count = document.createElement('span');
        count.className = 'item-count';
        count.textContent = opts.count;
        div.appendChild(count);
      }

      // Actions
      const actions = document.createElement('span');
      actions.className = 'item-actions';

      if (opts.onAdd) {
        const addBtn = document.createElement('button');
        addBtn.title = 'Add';
        addBtn.innerHTML = '<i class="fas fa-plus"></i>';
        addBtn.onclick = (e) => { e.stopPropagation(); opts.onAdd(); };
        actions.appendChild(addBtn);
      }
      if (opts.onRename) {
        const renameBtn = document.createElement('button');
        renameBtn.title = 'Rename';
        renameBtn.innerHTML = '<i class="fas fa-pen"></i>';
        renameBtn.onclick = (e) => { e.stopPropagation(); opts.onRename(); };
        actions.appendChild(renameBtn);
      }
      if (opts.onDelete) {
        const delBtn = document.createElement('button');
        delBtn.title = 'Delete';
        delBtn.className = 'danger';
        delBtn.innerHTML = '<i class="fas fa-trash"></i>';
        delBtn.onclick = (e) => { e.stopPropagation(); opts.onDelete(); };
        actions.appendChild(delBtn);
      }
      div.appendChild(actions);

      // Click handler
      div.addEventListener('click', () => { opts.onToggle(); });

      return div;
    }

    // â”€â”€ Toggle expand/collapse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleCat(id) {
      state.expandedCats.has(id) ? state.expandedCats.delete(id) : state.expandedCats.add(id);
      renderTree();
    }
    function toggleSpec(id) {
      state.expandedSpecs.has(id) ? state.expandedSpecs.delete(id) : state.expandedSpecs.add(id);
      renderTree();
    }

    // â”€â”€ CRUD: Category â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $('#btn-new-category').addEventListener('click', () => {
      showDialog({
        title: 'New Category',
        message: 'Enter a name for the top-level category:',
        input: true,
        placeholder: 'e.g. Clinical Dietetics',
        confirmText: 'Create',
        onConfirm: async (name) => {
          if (!name) return;
          try {
            await userCol('categories').add({
              name,
              order: state.categories.length,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          } catch (err) {
            console.log('Error creating category: ' + err.message);
          }
        }
      });
    });

    function deleteCategory(id, name) {
      showDialog({
        title: 'Delete Category',
        message: `Delete "${name}" and all its specialties and notes? This cannot be undone.`,
        confirmText: 'Delete',
        confirmClass: 'btn-dialog-danger',
        onConfirm: async () => {
          try {
            const batch = db.batch();
            // Delete all notes under this category's specialties
            const specs = state.specialties[id] || [];
            for (const spec of specs) {
              const notesList = state.notes[spec.id] || [];
              for (const note of notesList) {
                batch.delete(userCol('notes').doc(note.id));
              }
              batch.delete(userCol('specialties').doc(spec.id));
            }
            batch.delete(userCol('categories').doc(id));
            await batch.commit();
          } catch (err) {
            console.log('Error deleting category: ' + err.message);
          }
        }
      });
    }

    // â”€â”€ CRUD: Specialty â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function addSpecialty(categoryId) {
      showDialog({
        title: 'New Specialty',
        message: 'Enter a name for the specialty:',
        input: true,
        placeholder: 'e.g. Renal Nutrition',
        confirmText: 'Create',
        onConfirm: async (name) => {
          if (!name) return;
          try {
            const existingSpecs = state.specialties[categoryId] || [];
            await userCol('specialties').add({
              name,
              categoryId,
              order: existingSpecs.length,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            state.expandedCats.add(categoryId);
          } catch (err) {
            console.log('Error creating specialty: ' + err.message);
          }
        }
      });
    }

    function deleteSpecialty(id, name) {
      showDialog({
        title: 'Delete Specialty',
        message: `Delete "${name}" and all its notes? This cannot be undone.`,
        confirmText: 'Delete',
        confirmClass: 'btn-dialog-danger',
        onConfirm: async () => {
          try {
            const batch = db.batch();
            const notesList = state.notes[id] || [];
            for (const note of notesList) {
              batch.delete(userCol('notes').doc(note.id));
            }
            batch.delete(userCol('specialties').doc(id));
            await batch.commit();
          } catch (err) {
            console.log('Error deleting specialty: ' + err.message);
          }
        }
      });
    }

    // â”€â”€ CRUD: Note â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function addNote(specialtyId, categoryId) {
      const existingNotes = state.notes[specialtyId] || [];
      userCol('notes').add({
        title: 'Untitled Note',
        content: '',
        specialtyId,
        categoryId,
        order: existingNotes.length,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(docRef => {
        state.expandedSpecs.add(specialtyId);
        selectNote(docRef.id);
      }).catch(err => {
        console.log('Error creating note: ' + err.message);
      });
    }

    function deleteNote(id, title) {
      showDialog({
        title: 'Delete Note',
        message: `Delete "${title || 'Untitled Note'}"? This cannot be undone.`,
        confirmText: 'Delete',
        confirmClass: 'btn-dialog-danger',
        onConfirm: async () => {
          try {
            await userCol('notes').doc(id).delete();
            if (state.selectedNoteId === id) deselectNote();
          } catch (err) {
            console.log('Error deleting note: ' + err.message);
          }
        }
      });
    }

    function renameNote(id, currentTitle) {
      showDialog({
        title: 'Rename Note',
        message: 'Enter a new title:',
        input: true,
        placeholder: currentTitle || 'Untitled Note',
        confirmText: 'Rename',
        onConfirm: async (newName) => {
          if (!newName) return;
          try {
            await userCol('notes').doc(id).update({ title: newName, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
            if (state.selectedNoteId === id) noteTitle.value = newName;
          } catch (err) {
            console.log('Error renaming note: ' + err.message);
          }
        }
      });
    }

    // â”€â”€ Rename generic (categories / specialties) â”€â”€â”€â”€
    function renameItem(collection, id, currentName) {
      const label = collection === 'categories' ? 'Category' : 'Specialty';
      showDialog({
        title: `Rename ${label}`,
        message: `Enter a new name:`,
        input: true,
        placeholder: currentName,
        confirmText: 'Rename',
        onConfirm: async (newName) => {
          if (!newName) return;
          try {
            await userCol(collection).doc(id).update({ name: newName });
          } catch (err) {
            console.log('Error renaming: ' + err.message);
          }
        }
      });
    }

    // â”€â”€ Select / Deselect Note â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function selectNote(noteId) {
      // Save current note first
      saveCurrentNote();

      state.selectedNoteId = noteId;

      // Find note data from state
      let noteData = null;
      for (const specId of Object.keys(state.notes)) {
        const found = state.notes[specId].find(n => n.id === noteId);
        if (found) { noteData = found; break; }
      }
      if (!noteData) return;
      state.selectedNoteData = noteData;

      // Find parent names for breadcrumb
      let specName = '', catName = '';
      for (const catId of Object.keys(state.specialties)) {
        const spec = (state.specialties[catId] || []).find(s => s.id === noteData.specialtyId);
        if (spec) {
          specName = spec.name;
          const cat = state.categories.find(c => c.id === catId);
          catName = cat ? cat.name : '';
          break;
        }
      }

      breadcrumb.innerHTML = '';
      [catName, specName].forEach((txt, i) => {
        if (i > 0) {
          const sep = document.createElement('span');
          sep.className = 'sep';
          sep.innerHTML = '<i class="fas fa-chevron-right"></i>';
          breadcrumb.appendChild(sep);
        }
        const s = document.createElement('span');
        s.textContent = txt;
        breadcrumb.appendChild(s);
      });
      const sep2 = document.createElement('span');
      sep2.className = 'sep';
      sep2.innerHTML = '<i class="fas fa-chevron-right"></i>';
      breadcrumb.appendChild(sep2);
      const cur = document.createElement('span');
      cur.className = 'current';
      cur.textContent = noteData.title || 'Untitled Note';
      breadcrumb.appendChild(cur);

      noteTitle.value = noteData.title || '';

      const updatedAt = noteData.updatedAt ? noteData.updatedAt.toDate() : null;
      noteMeta.textContent = updatedAt
        ? `Last updated: ${updatedAt.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}`
        : '';

      quill.root.innerHTML = noteData.content || '';

      emptyState.style.display = 'none';
      noteEditor.classList.add('active');
      renderTree();
      closeSidebar();
    }

    function deselectNote() {
      state.selectedNoteId = null;
      state.selectedNoteData = null;
      noteEditor.classList.remove('active');
      emptyState.style.display = 'flex';
      breadcrumb.innerHTML = '<span class="current">Select or create a note</span>';
      saveStatusEl.textContent = '';
      renderTree();
    }

    // â”€â”€ Auto-Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let saveTimeout = null;
    function scheduleSave() {
      if (saveTimeout) clearTimeout(saveTimeout);
      saveStatusEl.textContent = '';
      saveStatusEl.className = 'save-status';
      saveTimeout = setTimeout(saveCurrentNote, 1200);
    }

    async function saveCurrentNote() {
      if (!state.selectedNoteId) return;
      const title = noteTitle.value.trim();
      const content = quill.root.innerHTML;
      if (content === '<p><br></p>') {
        // Quill default empty â€” treat as empty
      }
      saveStatusEl.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Savingâ€¦';
      saveStatusEl.className = 'save-status saving';
      try {
        await userCol('notes').doc(state.selectedNoteId).update({
          title: title || 'Untitled Note',
          content,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        saveStatusEl.innerHTML = '<i class="fas fa-check"></i> Saved';
        saveStatusEl.className = 'save-status saved';
        setTimeout(() => {
          if (saveStatusEl.classList.contains('saved')) {
            saveStatusEl.textContent = '';
            saveStatusEl.className = 'save-status';
          }
        }, 2000);
      } catch (err) {
        saveStatusEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Save failed';
        saveStatusEl.className = 'save-status error';
        console.log('Save error: ' + err.message);
      }
    }

    quill.on('text-change', scheduleSave);
    noteTitle.addEventListener('input', scheduleSave);

    // â”€â”€ Sidebar toggle (mobile) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openSidebar() {
      sidebarEl.classList.add('open');
      backdropEl.classList.add('active');
    }
    function closeSidebar() {
      sidebarEl.classList.remove('open');
      backdropEl.classList.remove('active');
    }
    $('#btn-open-sidebar').addEventListener('click', openSidebar);
    $('#btn-close-sidebar').addEventListener('click', closeSidebar);
    backdropEl.addEventListener('click', closeSidebar);

    // â”€â”€ Dialog close on overlay click â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    dialogOverlay.addEventListener('click', (e) => {
      if (e.target === dialogOverlay) dialogOverlay.classList.remove('active');
    });

    // â”€â”€ Handle Enter key in dialog input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $('#dialog-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const confirmBtn = dialogBox.querySelector('.btn-dialog-confirm, .btn-dialog-danger');
        if (confirmBtn) confirmBtn.click();
      }
    });

    // â”€â”€ Show config warning if not configured â”€â”€â”€â”€â”€â”€â”€â”€
    if (NEEDS_CONFIG) {
      loginScreen.style.display = 'none';
      appEl.classList.add('active');
      emptyState.innerHTML = `
        <div class="empty-icon">âš™ï¸</div>
        <h3>Firebase Setup Required</h3>
        <p style="max-width:440px">
          Open <strong>index.html</strong> and replace the <code>firebaseConfig</code> object
          with your own Firebase project credentials. Then reload the page.<br><br>
          <strong>Steps:</strong><br>
          1. Create a project at <a href="https://console.firebase.google.com" target="_blank" rel="noopener" style="color:var(--c-primary)">Firebase Console</a><br>
          2. Enable Google Sign-In under Authentication<br>
          3. Create a Firestore database<br>
          4. Copy your Web App config into this file
        </p>
      `;
      sidebarEl.style.display = 'none';
    }
  </script>
</body>
</html>
